<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Memory Consistency | A lifelong learner.</title>
<meta name="keywords" content="concurrency, memory">
<meta name="description" content="A Primer on Memory Consistency and Cache Coherence

ä¹¦ç±ä¿¡æ¯

é“¾æ¥

A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)


ä½œè€…
é¢˜æ/ä¸»é¢˜


æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ

å­¦ä¹ memory order


é˜…è¯»å‰é—®é¢˜
é˜…è¯»ä¸­é—®é¢˜
é˜…è¯»æ—¶çš„æ€è€ƒ
ä¸»è¦å†…å®¹
æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±
è¯„ä»·

ä¼˜ç‚¹
ç¼ºç‚¹



Chap1 Introduction to Consistency and Coherence
Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚">
<meta name="author" content="">
<link rel="canonical" href="https://egolearner.github.io/post/memory-consistency/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.7da7716a1f2d0725f74c6ae7f8d6adafc43aabe2b366b65bfbf433448e2a2001.css" integrity="sha256-fadxah8tByX3TGrn&#43;Natr8Q6q&#43;KzZrZb&#43;/QzRI4qIAE=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://egolearner.github.io/favicon.ico">
<link rel="apple-touch-icon" href="https://egolearner.github.io/apple-touch-icon.png">
<link rel="alternate" hreflang="zh-cn" href="https://egolearner.github.io/post/memory-consistency/">

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-GNS10MBB65"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-GNS10MBB65');
        }
      </script>
<meta name="twitter:title" content="Memory Consistency | A lifelong learner." />
<meta name="twitter:description" content="A Primer on Memory Consistency and Cache Coherence

ä¹¦ç±ä¿¡æ¯

é“¾æ¥

A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)


ä½œè€…
é¢˜æ/ä¸»é¢˜


æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ

å­¦ä¹ memory order


é˜…è¯»å‰é—®é¢˜
é˜…è¯»ä¸­é—®é¢˜
é˜…è¯»æ—¶çš„æ€è€ƒ
ä¸»è¦å†…å®¹
æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±
è¯„ä»·

ä¼˜ç‚¹
ç¼ºç‚¹



Chap1 Introduction to Consistency and Coherence
Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚" />
<meta property="og:title" content="Memory Consistency | A lifelong learner." />
<meta property="og:description" content="A Primer on Memory Consistency and Cache Coherence

ä¹¦ç±ä¿¡æ¯

é“¾æ¥

A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)


ä½œè€…
é¢˜æ/ä¸»é¢˜


æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ

å­¦ä¹ memory order


é˜…è¯»å‰é—®é¢˜
é˜…è¯»ä¸­é—®é¢˜
é˜…è¯»æ—¶çš„æ€è€ƒ
ä¸»è¦å†…å®¹
æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±
è¯„ä»·

ä¼˜ç‚¹
ç¼ºç‚¹



Chap1 Introduction to Consistency and Coherence
Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://egolearner.github.io/post/memory-consistency/" />
<meta property="article:section" content="post" />
  <meta property="article:published_time" content="2024-09-10T19:31:31&#43;08:00" />
  <meta property="article:modified_time" content="2024-09-10T19:31:31&#43;08:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://egolearner.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Memory Consistency",
      "item": "https://egolearner.github.io/post/memory-consistency/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Memory Consistency | A lifelong learner.",
  "name": "Memory Consistency",
  "description": "A Primer on Memory Consistency and Cache Coherence ä¹¦ç±ä¿¡æ¯ é“¾æ¥ A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com) ä½œè€… é¢˜æ/ä¸»é¢˜ æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ å­¦ä¹ memory order é˜…è¯»å‰é—®é¢˜ é˜…è¯»ä¸­é—®é¢˜ é˜…è¯»æ—¶çš„æ€è€ƒ ä¸»è¦å†…å®¹ æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç± è¯„ä»· ä¼˜ç‚¹ ç¼ºç‚¹ Chap1 Introduction to Consistency and Coherence Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚\n",
  "keywords": [
    "concurrency", "memory"
  ],
  "wordCount" : "6347",
  "inLanguage": "zh-cn",
  "datePublished": "2024-09-10T19:31:31+08:00",
  "dateModified": "2024-09-10T19:31:31+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://egolearner.github.io/post/memory-consistency/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "A lifelong learner.",
    "logo": {
      "@type": "ImageObject",
      "url": "https://egolearner.github.io/favicon.ico"
    }
  }
}
</script>
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-post kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'light';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://egolearner.github.io/" accesskey="h" title="A lifelong learner. (Alt + H)">A lifelong learner.</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://egolearner.github.io/" title="Home" class="active"
                >Home
                </a>
            </li>
            <li>
                <a href="https://egolearner.github.io/post/" title="Archives" class="active"
                >Archives
                </a>
            </li>
            <li>
                <a href="https://egolearner.github.io/tags/" title="Tags"
                >Tags
                </a>
            </li>
            <li>
                <a href="https://egolearner.github.io/categories/" title="Categories"
                >Categories
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">Memory Consistency</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>September 10, 2024</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://egolearner.github.io/tags/concurrency/">Concurrency</a><a href="https://egolearner.github.io/tags/memory/">Memory</a></span></span>

      
      
    </div>
  </header> 
  <div class="post-content"><h1 id="a-primer-on-memory-consistency-and-cache-coherence">A Primer on Memory Consistency and Cache Coherence<a hidden class="anchor" aria-hidden="true" href="#a-primer-on-memory-consistency-and-cache-coherence">Â¶</a></h1>
<ul>
<li>ä¹¦ç±ä¿¡æ¯
<ul>
<li>é“¾æ¥
<ul>
<li><a href="https://book.douban.com/subject/35125808/">A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)</a></li>
</ul>
</li>
<li>ä½œè€…</li>
<li>é¢˜æ/ä¸»é¢˜</li>
</ul>
</li>
<li>æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ
<ul>
<li>å­¦ä¹ memory order</li>
</ul>
</li>
<li>é˜…è¯»å‰é—®é¢˜</li>
<li>é˜…è¯»ä¸­é—®é¢˜</li>
<li>é˜…è¯»æ—¶çš„æ€è€ƒ</li>
<li>ä¸»è¦å†…å®¹</li>
<li>æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±</li>
<li>è¯„ä»·
<ul>
<li>ä¼˜ç‚¹</li>
<li>ç¼ºç‚¹</li>
</ul>
</li>
</ul>
<h2 id="chap1-introduction-to-consistency-and-coherence">Chap1 Introduction to Consistency and Coherence<a hidden class="anchor" aria-hidden="true" href="#chap1-introduction-to-consistency-and-coherence">Â¶</a></h2>
<p>Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚</p>
<p>Coherenceè‡³äºäºè®©å…±äº«å†…å­˜ç³»ç»Ÿçš„Cacheåƒå•æ ¸ç³»ç»Ÿä¸Šçš„Cacheä¸€æ ·é€æ˜ï¼Œä½¿ç”¨å°†ä¸€ä¸ªå¤„ç†å™¨çš„å†™å…¥å¹¿æ’­åˆ°å…¶ä»–å¤„ç†å™¨çš„æ–¹å¼ã€‚Consistencyå±äºå®šä¹‰å…±äº«å†…å­˜æ­£ç¡®æ€§çš„æ¶æ„è§„èŒƒï¼Œè€Œcoherenceæ˜¯æ”¯æ’‘consistencyæ¨¡å‹çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>å¯¹äºç‰¹å®šè¾“å…¥çš„å¤šçº¿ç¨‹ç¨‹åºï¼Œå†…å­˜æ¨¡å‹è§„å®šäº†dynamic loadå¯ä»¥è¿”å›çš„å€¼ï¼Œå¯é€‰çš„è§„å®šäº†å†…å­˜æœ€ç»ˆçš„å¯èƒ½çŠ¶æ€ã€‚é€šå¸¸å…è®¸å¤šçº¿ç¨‹ç¨‹åºæœ‰å¤šä¸ªæ­£ç¡®çš„è¡Œä¸ºã€‚</p>
<ul>
<li>Sequential Consistency(SC)ä¸­ï¼Œå¤šçº¿ç¨‹ç¨‹åºçœ‹èµ·æ¥åƒå…¶ä¸­æ¯ä¸ªçº¿ç¨‹çš„äº¤æ›¿æ‰§è¡Œï¼Œå°±åƒæ‰€æœ‰çº¿ç¨‹åœ¨å•æ ¸æœºå™¨ä¸Šåˆ†æ—¶å¤ç”¨ä¸€æ ·ã€‚</li>
<li>Total Store Order(TSO)ï¼Œåœ¨å°†ç»“æœå†™å…¥Cacheå‰ï¼Œä½¿ç”¨FIFOçš„write bufferæ¥ä¿å­˜committed storeçš„ç»“æœã€‚ç›¸æ¯”SCæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</li>
<li>Relaxed or Weak Modelï¼ŒåŠ¨æœºåœ¨äºå¤§éƒ¨åˆ†å¼ºæ¨¡å‹ä¸­çš„å†…å­˜é¡ºåºæ˜¯ä¸å¿…è¦çš„ã€‚ä¾‹å¦‚ï¼Œä¿®æ”¹10ä¸ªæ•°æ®é¡¹å’Œ1ä¸ªåŒæ­¥æ ‡è®°ï¼Œ10ä¸ªæ•°æ®é¡¹å…·ä½“çš„å†…å­˜é¡ºåºæ˜¯ä¸é‡è¦çš„ï¼Œåªéœ€è¦ä¿è¯åœ¨åŒæ­¥æ ‡è®°ä¹‹å‰ä¿®æ”¹å³å¯ã€‚</li>
</ul>
<p>åœ¨å¤šæ ¸åŒæ—¶è®¿é—®æ•°æ®çš„å¤šä¸ªå‰¯æœ¬ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªè®¿é—®æ˜¯å†™æ“ä½œæ—¶ä¼šæœ‰coherenceé—®é¢˜ã€‚ä½¿ç”¨coherenceåè®®æ¥é¿å…è®¿é—®åˆ°è¿‡æœŸæ•°æ®ã€‚é€šè¿‡å¹¿æ’­æ“ä½œä½¿å¾—ä¸€ä¸ªå¤„ç†å™¨çš„å†™æ“ä½œå¯¹å…¶ä»–å¤„ç†å™¨çš„Cacheå¯è§ã€‚ç›®å‰åŸºæœ¬æ˜¯åŒæ­¥å¹¿æ’­ï¼Œå¼‚æ­¥å¹¿æ’­æœºåˆ¶æ­£åœ¨å‡ºç°ã€‚</p>
<ul>
<li><input disabled="" type="checkbox"> Database Replication. Synthesis Lectures on Data Management</li>
<li><input disabled="" type="checkbox"> Quorum Systems: With Applications to Storage and Consensus. Synthesis Lectures on Distributed Computing Theory</li>
</ul>
<h2 id="chap2-coherence-åŸºç¡€">Chap2 Coherence åŸºç¡€<a hidden class="anchor" aria-hidden="true" href="#chap2-coherence-åŸºç¡€">Â¶</a></h2>
<p>åœ¨å¤šç§è§’è‰²è®¿é—®Cacheå’ŒMemoryæ—¶æœ‰coherenceé—®é¢˜ï¼Œå¦‚å¤„ç†å™¨ã€DMAã€å…¶ä»–è®¾å¤‡ã€‚</p>
<ul>
<li>
<p>Consistency-agnostic coherenceã€‚ä½¿ç”¨åŒæ­¥å†™ï¼Œå†™æ“ä½œåœ¨è¿”å›å‰å¯¹æ‰€æœ‰æ ¸å¯è§ï¼Œæä¾›çš„æ¥å£å’Œï¼ˆä¸å¸¦Cacheçš„ï¼‰atomic memory systemç›¸åŒã€‚</p>
<ul>
<li>single-writer-multiple-reader(SWMR)ä¸å˜å¼ã€‚
<ul>
<li>å¦ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨tokenå¯¹SWMRä¸å˜å¼æ¥è§£é‡Šã€‚tokenä¸ªæ•°å’Œæ ¸æ•°ç›¸ç­‰ï¼Œæ‹¿åˆ°æ‰€æœ‰tokenæ—¶ï¼Œå¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼›æ‹¿åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªtokenæ—¶ï¼Œå¯ä»¥æ‰§è¡Œè¯»æ“ä½œã€‚</li>
</ul>
</li>
<li>è¿˜è¦æ±‚ç»™å®šå†…å­˜çš„å€¼è¢«æ­£ç¡®çš„å¹¿æ’­ï¼Œå³æ•°æ®å€¼ä¸å˜å¼ï¼šæŸä¸ªepochå¼€å§‹æ—¶çš„å€¼ï¼Œç­‰äºä¸Šä¸€ä¸ªread-write epochç»“æŸæ—¶çš„å€¼ã€‚</li>
</ul>
<blockquote>
<p>Coherence invariants</p>
<ol>
<li>Single-Writer, Multiple-Read (SWMR) Invariant. For any memory location A, at any given time, there exists only a single core that may write to A (and can also read it) or some number of cores that may only read A.</li>
<li>Data-Value Invariant. The value of the memory location at the start of an epoch is the same as the value of the memory location at the end of the its last read-write epoch.</li>
</ol>
</blockquote>
</li>
<li>
<p>Consistency-directed coherenceã€‚å†™æ“ä½œå¼‚æ­¥å¹¿æ’­ï¼Œcoherenceåè®®ä¿è¯å†™æ“ä½œä»¥consistencyæ¨¡å‹å¼ºåˆ¶çš„é¡ºåºæœ€ç»ˆå¯è§ï¼Œç”¨ä»¥æ”¯æŒGP-GPUã€‚</p>
</li>
</ul>
<p>Coherenceçš„å•ä½ä¸ºcache blockï¼ˆä¾‹å¦‚cache lineï¼‰ã€‚</p>
<h2 id="chap3-memory-consistency-motivation-and-sequential-consistency">Chap3 Memory Consistency Motivation and Sequential Consistency<a hidden class="anchor" aria-hidden="true" href="#chap3-memory-consistency-motivation-and-sequential-consistency">Â¶</a></h2>
<p>Reorderçš„ç±»å‹</p>
<ul>
<li>Store-store reorderingã€‚å¦‚æœæ ¸æœ‰éFIFOçš„write bufferå¯èƒ½ä¼šå‡ºç°store-store reorderingï¼Œç¬¬ä¸€ä¸ªstore missè€Œç¬¬äºŒä¸ªstoreå‘½ä¸­cacheï¼Œæˆ–è€…ç¬¬äºŒä¸ªstoreå¯ä»¥å’Œæ›´æ—©çš„storeåˆå¹¶ã€‚</li>
<li>Load-load reorderingã€‚</li>
<li>Load-storeå’Œstore-load reorderingã€‚
<ul>
<li>store-load reorderingå¯èƒ½ç”±äºæœ¬åœ°è·³è¿‡äº†FIFOçš„write bufferã€‚</li>
</ul>
</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Core C1</th>
          <th style="text-align: left">Core C2</th>
          <th style="text-align: left">Comments</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">S1: x = NEW;</td>
          <td style="text-align: left">S2: y = NEW;</td>
          <td style="text-align: left">/* Initially, x = 0 &amp; y = 0 */</td>
      </tr>
      <tr>
          <td style="text-align: left">L1: r1 = y;</td>
          <td style="text-align: left">L2: r2 = x;</td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<p>å¤§å¤šæ•°å®é™…çš„ç¡¬ä»¶ï¼ŒåŒ…æ‹¬x86ï¼Œå…è®¸r1=0, r2=0ä½œä¸ºæœ€ç»ˆçš„ç»“æœï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†FIFOçš„write bufferæ¥æé«˜æ€§èƒ½ã€‚</p>
<p>memory modelæ˜¯å…±äº«å†…å­˜ä½¿ç”¨å…±äº«å†…å­˜æ‰§è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºå…è®¸çš„è¡Œä¸ºçš„è§„èŒƒã€‚</p>
<ul>
<li>Cache coherence does not equal memory consistency.</li>
<li>A memory consistency implementation can use cache coherence as a useful â€œblack box.â€</li>
</ul>
<h3 id="sequential-consistencysc">Sequential Consistency(SC)<a hidden class="anchor" aria-hidden="true" href="#sequential-consistencysc">Â¶</a></h3>
<p>SCæœ€æ—©ç”±Lamportå½¢å¼åŒ–ï¼Œå•æ ¸ä¸Šçš„SCå’ŒProgram Orderç›¸åŒï¼Œå¤šæ ¸ä¸Šçš„SCï¼Œå¦‚æœæ‰€æœ‰æ ¸ä¸Šçš„æ“ä½œä»¥æŸç§é¡ºåºæ‰§è¡Œï¼Œåºåˆ—ä¸­æ¯ä¸ªæ ¸çš„æ“ä½œå’ŒProgram Orderç›¸åŒã€‚SCä¸­ï¼Œmemory orderéµå¾ªæ¯ä¸ªæ ¸ä¸Šçš„Program Orderï¼Œè€Œå…¶ä»–çš„consistency modelå…è®¸ä¸éµå®ˆProgram Orderçš„memory orderã€‚</p>
<p>å®šä¹‰&lt;mä¸ºmemory order, &lt;pä¸ºprogram orderã€‚åœ¨SCä¸­ï¼Œmemory orderéµå®ˆprogram orderï¼Œå³op1 &lt;p op2æ„å‘³ç€op1 &lt;m op2ã€‚</p>
<p>3.5 SCçš„çš„è§„èŒƒåŒ–å®šä¹‰</p>
<p>L(a)å’ŒS(a)ä¸ºå¯¹å†…å­˜åœ°å€açš„loadå’Œstoreæ“ä½œã€‚&lt;pä¸ºæ¯ä¸ªæ ¸ä¸Šçš„total orderï¼Œ&lt;mä¸ºglobal memory orderã€‚</p>
<ol>
<li>æ‰€æœ‰çš„æ ¸å°†å®ƒä»¬çš„loadå’Œstoreæ’å…¥åˆ°&lt;mä¸­ï¼Œéµå®ˆå…¶program orderï¼Œæ— è®ºæ˜¯å¦æ˜¯ç›¸åŒçš„åœ°å€ã€‚å››ç§æƒ…å†µï¼š
<ol>
<li>If L(a) &lt;p L(b) â‡’ L(a) &lt;m L(b) /* Load â†’ Load */</li>
<li>If L(a) &lt;p S(b) â‡’ L(a) &lt;m S(b) /* Load â†’ Store */</li>
<li>If S(a) &lt;p S(b) â‡’ S(a) &lt;m S(b) /* Store â†’ Store */</li>
<li>If S(a) &lt;p L(b) â‡’ S(a) &lt;m L(b) /* Store â†’ Load */</li>
</ol>
</li>
<li>æ¯ä¸€ä¸ªloadå¾—åˆ°çš„å€¼ä¸ºä¾global memory orderåœ¨è¯¥loadä¹‹å‰å†™å…¥çš„å€¼ã€‚</li>
</ol>
<p>å¯¹äºåŸå­çš„read-modify-writeæ“ä½œï¼ˆå¦‚test-and-set)ï¼Œè¦æ±‚loadå’Œstoreæ“ä½œè¿ç»­ï¼Œä¸­é—´ä¸èƒ½æœ‰å…¶ä»–çš„å†…å­˜æ“ä½œï¼ˆæ— è®ºæ˜¯ç›¸åŒè¿˜æ˜¯ä¸åŒçš„åœ°å€ï¼‰ã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled.png">
<p>è¡¨ä¸­å®šä¹‰äº†SCå…è®¸çš„è¡Œä¸ºï¼Œå…¶ä¸­Operation 1åœ¨Operation 2ä¹‹å‰ï¼ŒXæ„å‘³ç€å¿…é¡»éµå®ˆprogram orderã€‚</p>
<p>ä¸€ä¸ªSCå®ç°åªå…è®¸SCæ‰§è¡Œï¼Œè¿™æ˜¯safetyå±æ€§(do no harm)ï¼ŒSCå®ç°è¿˜æœ‰livenesså±æ€§(do some good)ã€‚</p>
<p>3.6 SCçš„naiveå®ç°</p>
<ul>
<li>
<p>ä½¿ç”¨å•æ ¸æ¥æ‰§è¡Œå¤šçº¿ç¨‹ç¨‹åºï¼Œ åœ¨çº¿ç¨‹åˆ‡æ¢ä¹‹å‰æ‰€æœ‰pendingçš„å†…å­˜æ“ä½œå¿…é¡»å®Œæˆã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ä¸€ç»„æ ¸ã€å†…å­˜å’Œå†…å­˜å¼€å…³æ¥å®ç°ï¼Œå¼€å…³é€‰å–ä¸€ä¸ªæ ¸æ¥æ»¡è¶³å…¶å†…å­˜è®¿é—®è¯·æ±‚ï¼Œè¿™å®šä¹‰äº†memory order &lt;mã€‚</p>
<ul>
<li>è¯¥å®ç°ä¸­ä¸éœ€è¦cacheæˆ–è€…coherenceã€‚</li>
</ul>
  <img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-1.png">
</li>
</ul>
<p>3.7 å¸¦æœ‰cache coherenceçš„åŸºæœ¬å®ç°ï¼Œèƒ½å¤Ÿå¹¶è¡Œçš„æ‰§è¡Œä¸å†²çªçš„loadå’Œstoreæ“ä½œ</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-2.png">
<p>è¿™ä¸ªSCå®ç°ä¸­</p>
<ul>
<li>å……åˆ†åˆ©ç”¨äº†cacheçš„æ—¶å»¶å’Œå¸¦å®½ä¼˜åŠ¿ã€‚</li>
<li>å’Œå®ƒä½¿ç”¨çš„cache coherenceåè®®æœ‰ç›¸åŒçš„æ‰©å±•æ€§ã€‚</li>
<li>å°†å®ç°coreä»å®ç°coherenceçš„å¤æ‚åº¦è§£è€¦å¼€ã€‚</li>
</ul>
<p>3.8 ç»§ç»­ä¼˜åŒ–</p>
<ul>
<li>
<p>Non-Binding Prefetchingã€‚å¯¹å—Bçš„éç»‘å®šé¢„å–æ˜¯æŒ‡å‘coherentå†…å­˜ç³»ç»Ÿå‘è¯·æ±‚æ¥æ”¹å˜ä¸€ä¸ªæˆ–å¤šä¸ªcacheä¸­çš„coherenceçŠ¶æ€ã€‚é‡è¦çš„æ˜¯ï¼Œéç»‘å®šé¢„å–ä¸ä¼šä¿®æ”¹å¯„å­˜å™¨çš„çŠ¶æ€æˆ–è€…å—Bä¸­çš„æ•°æ®ï¼Œå¯¹memory consistency modelç›¸å½“äºno-opã€‚</p>
</li>
<li>
<p>Speculative Coresã€‚æ¨æµ‹æ‰§è¡Œåœ¨åˆ†æ”¯é¢„æµ‹å¤±è´¥æ—¶ï¼Œä¼šæ— æ•ˆåŒ–ä¹‹å‰çš„æ“ä½œï¼Œç§°ä¸ºsquashingï¼Œsquashedçš„loadå’Œstoreæ“ä½œçœ‹èµ·æ¥åƒéç»‘å®šé¢„å–ï¼Œä¸å½±å“SCã€‚å¯¹storeï¼Œå¯èƒ½ä¼šæå‰å‘èµ·GetMé¢„å–ï¼Œä½†åªæœ‰storeä¿è¯æäº¤æ—¶æ‰å†™å…¥cacheã€‚</p>
</li>
<li>
<p>Dynamically Scheduled Coresã€‚ä¹±åºæ‰§è¡Œï¼Œå¦‚å°†L2æåˆ°L1ä¹‹å‰æ‰§è¡Œï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æ£€æŸ¥é¢„æµ‹çš„æ­£ç¡®æ€§ã€‚</p>
<ul>
<li>åœ¨æ ¸æ¨æµ‹æ‰§è¡Œå®ŒL2ï¼Œä½†åœ¨æäº¤å‰ï¼Œæ£€æŸ¥æ˜¯å¦è„±ç¦»äº†cacheï¼Œç›‘å¬L2ç›¸å…³çš„å†…å­˜åœ°å€æ˜¯å¦æœ‰GetMè¯·æ±‚ã€‚</li>
<li>åœ¨æ ¸å‡†å¤‡æäº¤loadå‰ï¼Œé‡æ”¾æ¨æµ‹çš„loadï¼Œæ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒã€‚</li>
</ul>
  <aside>
  ğŸ’¡ Flashback to Quiz Question 1: In a system that maintains sequential consistency, a core must issue coherence requests in program order. True or false?
  Answer: False! A core may issue coherence requests in any order.
  </aside>
</li>
<li>
<p>Non-Binding Prefetching in Dynamically Scheduled Coresã€‚éç»‘å®šé¢„å–ä¸å½±å“SCã€‚</p>
<ul>
<li>SCè§„å®šäº†loadå’Œstoreï¼ˆçœ‹èµ·æ¥ï¼‰åº”ç”¨åˆ°coherent memoryçš„é¡ºåºï¼Œä½†æ²¡æœ‰è§„å®šcoherent activityçš„é¡ºåºã€‚</li>
</ul>
  <aside>
  ğŸ’¡ Flashback to Quiz Question 2: The memory consistency model specifies the legal orderings of coherence transactions. True or false?
  Answer: False!
  </aside>
</li>
<li>
<p>Multithreadingã€‚ä¸€ä¸ªæŒ‘æˆ˜æ˜¯ä¿è¯storeåœ¨å¯¹å…¶ä»–æ ¸ä¸Šçš„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œç›¸åŒæ ¸ä¸Šçš„T1çº¿ç¨‹ä¸èƒ½è¯»åˆ°T2çº¿ç¨‹å†™å…¥çš„å€¼ã€‚</p>
</li>
</ul>
<p>3.9 SCä¸‹çš„åŸå­æ“ä½œ</p>
<p>åŸå­çš„atomic-read-writeæ“ä½œå¯ä»¥å¦‚ä¸‹ä¼˜åŒ–ï¼šä¸€ä¸ªæ ¸ä»¥MçŠ¶æ€è·å–åˆ°cacheï¼Œç„¶ååªéœ€è¦loadå’Œstoreå®ƒçš„cacheå—ï¼Œæ²¡æœ‰ä»»ä½•çš„coherence messageæˆ–è€…é”æ€»çº¿ï¼Œåªè¦å®ƒç›´åˆ°storeä¹‹åæ‰æœåŠ¡ä»»ä½•çš„coherenceè¯·æ±‚ã€‚(ä¸ªäººç†è§£ï¼šå˜æˆMä¹‹åï¼Œåªè¦å®ƒä¸å“åº”coherenceè¯·æ±‚ï¼Œå…¶ä»–çš„æ ¸å°±æ²¡æ³•å¾—åˆ°Sæˆ–MçŠ¶æ€çš„cacheï¼Œå› æ­¤ä¸èƒ½è¯»ï¼Œä¹Ÿä¸èƒ½å†™ã€‚ï¼‰</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 3: To perform an atomic read-modify-write instruction (e.g., test-and-set), a core must always communicate with the other cores. True or false?
Answer: False!
</aside>
<p>æ›´è¿›ä¸€æ­¥çš„ä¼˜åŒ–ä¸ºæ¨æµ‹æ‰§è¡Œï¼Œå¦‚æœcacheçš„çŠ¶æ€å·²ç»ä¸ºSï¼ŒRMWçš„loadéƒ¨åˆ†å¯ä»¥é©¬ä¸Šæ¨æµ‹æ‰§è¡Œï¼ŒåŒæ—¶cacheæ§åˆ¶å™¨å‘èµ·ä¿®æ”¹ä¸ºMçŠ¶æ€ã€‚åœ¨cacheå˜ä¸ºMçŠ¶æ€åï¼Œå†æ‰§è¡Œå†™éƒ¨åˆ†ã€‚ä½¿ç”¨å’Œå‰é¢ç±»ä¼¼çš„æ–¹å¼æ¥æ£€æµ‹é¢„æµ‹å¤±è´¥ï¼Œå³cacheæ˜¯å¦è¢«å¼¹å‡ºã€‚</p>
<h2 id="chap4-total-store-order-and-the-x86-memory-model">Chap4 Total Store Order and the x86 Memory Model<a hidden class="anchor" aria-hidden="true" href="#chap4-total-store-order-and-the-x86-memory-model">Â¶</a></h2>
<p>åœ¨cacheè¿›å…¥read-write coherenceçŠ¶æ€ä¹‹å‰storeå¯ä»¥è¿›å…¥write bufferã€‚write bufferéšè—äº†store missçš„å»¶è¿Ÿã€‚</p>
<p>å¦‚æœä½¿ç”¨æ¿€è¿›çš„é¢„æµ‹SCå®ç°æ¥ä½¿å¾—write bufferé€æ˜çš„è¯ï¼Œå¤æ‚æ€§å¾ˆé«˜ï¼Œæ£€æµ‹violationå’Œå¤„ç†mis-speculationçš„åŠŸè€—å¾ˆé«˜ã€‚å› æ­¤å‡ºç° äº†TSOæ¨¡å‹ã€‚</p>
<p>TSO/X86çš„å½¢å¼åŒ–å®šä¹‰</p>
<ol>
<li>ç›¸æ¯”SCä¼šå‡ºç°Store-Loadçš„reorderï¼Œå¢åŠ äº†FIFOçš„write bufferã€‚</li>
<li>Loadè¯»åˆ°åŒä¸€åœ°å€ä¸Šä¸€æ¬¡Storeçš„å€¼ã€‚ä¼˜å…ˆæ˜¯æŒ‰ç…§program orderåœ¨ä¹‹å‰å†™å…¥çš„å€¼ï¼ˆä»write bufferè¯»ï¼‰ï¼Œå…¶æ¬¡æ˜¯æŒ‰ç…§memory orderåœ¨ä¹‹å‰å†™å…¥çš„å€¼ã€‚</li>
<li>æä¾›äº†FENCEæ¥ä¿è¯é¡ºåºã€‚
<ol>
<li>If S(a) &lt;p FENCE â‡’ S(a) &lt;m FENCE /* Store â†’ FENCE */</li>
<li>If FENCE &lt;p L(a) â‡’ FENCE &lt;m L(a) /* FENCE â†’ Load */</li>
</ol>
</li>
</ol>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-3.png">
<p>Bæ„å‘³ç€å¯¹ç›¸åŒåœ°å€éœ€è¦bypassingã€‚</p>
<p>AMDå’ŒInterlè¿˜æ²¡æœ‰æ­£å¼çš„è§„èŒƒè¡¨æ˜æ˜¯TSOï¼Œä½†æ˜¯æ‰€æœ‰çš„ä¾‹å­éƒ½ç¬¦åˆTSOã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-4.png">
<p>åœ¨4.4aä¸­</p>
<ul>
<li>Loadå’ŒStoreä»¥&lt;pç¦»å¼€æ ¸ã€‚</li>
<li>Loadè¦ä¹ˆä»write buffer bypasså€¼ï¼Œè¦ä¹ˆç­‰å¾…switchã€‚</li>
<li>Storeè¿›å…¥FIFO write bufferçš„å°¾éƒ¨ï¼Œå¦‚æœæ»¡äº†åˆ™stallã€‚</li>
<li>Switché€‰æ‹©æŸä¸ªæ ¸æ—¶ï¼Œè¦ä¹ˆæ‰§è¡ŒLoadï¼Œè¦ä¹ˆæ‰§è¡Œwrite bufferå¤´éƒ¨çš„storeã€‚</li>
</ul>
<p>4.4bä¸­ï¼Œä¹‹å‰è®¨è®ºçš„SCå®ç°ä¾ç„¶é€‚ç”¨ã€‚å¤§å¤šæ•°TSOå®ç°éƒ½æ˜¯åœ¨SCå®ç°ä¸Šæ’å…¥äº†write bufferã€‚</p>
<p>å¯¹å¤šçº¿ç¨‹çš„coreï¼Œä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸åº”è¯¥bypasså¦ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡çš„write bufferã€‚å¯ä»¥å®ç°ä¸ºæ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡çš„write bufferï¼Œæˆ–è€…å…±äº«çš„write bufferåŠ ä¸Šçº¿ç¨‹ä¸Šä¸‹æ–‡tagã€‚åè€…æ›´åŠ å¸¸è§ã€‚</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 4: In a TSO system with multithreaded cores, threads may bypass values out of the write buffer, regardless of which thread wrote the value. True or false? 
Answer: False! A thread may bypass values that it has written, but other threads may not see the value until the store is inserted into the memory order.
</aside>
<p>read-modify-writeå®ç°ã€‚æŒ‰ç…§TSOå®šä¹‰ï¼ŒRMWçš„loadä¸èƒ½è·³è¿‡ä¹‹å‰çš„loadã€‚å¦‚æœRMWçš„loadè·³è¿‡äº†ä¹‹å‰çš„storeï¼Œå› ä¸ºRMWæ˜¯åŸå­çš„ï¼Œå…¶storeä¹Ÿè¦è·³è¿‡ä¹‹å‰çš„storeï¼Œè€ŒTSOæ˜¯ä¸å…è®¸storeè·³è¿‡storeçš„ã€‚</p>
<p>RMWéœ€è¦ä¹‹å‰çš„storeæœ‰åºï¼Œå³éœ€è¦æ’å¹²write bufferã€‚ä¸ºäº†ä¿è¯RMWçš„storeé©¬ä¸Šåœ¨loadä¹‹åï¼Œéœ€è¦è·å¾—read-writeçš„coherenceæƒé™ã€‚ä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œåœ¨loadå’Œstoreä¹‹é—´ä¸èƒ½æ”¾å¼ƒcoherenceæƒé™ã€‚</p>
<p>æ›´å¤šçš„ä¼˜åŒ–æ˜¯å¯è¡Œçš„ã€‚write-bufferåœ¨æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶æ—¶ä¸éœ€è¦æ’å¹²</p>
<ul>
<li>
<p>åœ¨write-bufferä¸­çš„æ¯ä¸ªé¡¹åœ¨cacheä¸­æœ‰read-writeæƒé™ï¼Œå¹¶åœ¨RMWæäº¤å‰ä¿æŒread-writeæƒé™ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨MIPS R1000é£æ ¼çš„load speculationæ£€æŸ¥ã€‚</p>
<blockquote>
<p>åœ¨cache blockå¼¹å‡ºæ—¶çš„åœ°å€å¦‚æœå’Œload speculationçš„åœ°å€ç›¸åŒï¼Œä¼šä½¿å¾—loadå’Œä¹‹å‰çš„æŒ‡ä»¤éƒ½å¤±æ•ˆã€‚åœ¨Loadæäº¤æ—¶ï¼Œå®ƒä¸€ç›´ä¿æŒåœ¨cacheä¸­ï¼Œå€¼å¿…ç„¶ç›¸åŒã€‚</p>
</blockquote>
</li>
</ul>
<p>é€»è¾‘ä¸Šæ¥è¯´ï¼ŒRMWä¹‹å‰çš„loadå’Œstoreä½œä¸ºä¸€ä¸ªchunkæ•´ä½“æäº¤ã€‚</p>
<p>FENCEçš„è¯­ä¹‰æ˜¯FENCEä¹‹å‰çš„æŒ‡ä»¤å¿…é¡»æ’åºï¼ˆåº”è¯¥æ˜¯&lt;mï¼‰åœ¨ä¹‹åçš„æŒ‡ä»¤ä¹‹å‰ã€‚TSOä¸‹çš„FENCEä¸é¢‘ç¹ï¼Œæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œåœ¨æ’å¹²write bufferä¹‹åå†æ‰§è¡Œloadå°±è¶³å¤Ÿäº†ã€‚</p>
<p>SCæ˜¯TSOçš„å­é›†ã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-5.png">
<h2 id="chap5-relaxed-memory-consistency">Chap5 Relaxed Memory Consistency<a hidden class="anchor" aria-hidden="true" href="#chap5-relaxed-memory-consistency">Â¶</a></h2>
<p>5.1 åŠ¨æœº</p>
<p>RMOåªä¿æŒç¨‹åºå‘˜éœ€è¦çš„é¡ºåºã€‚</p>
<p>å¦‚æœæ“ä½œä¸ä¾èµ–è®¸å¤šLoadå’ŒStoreä¹‹é—´çš„é¡ºåºï¼Œä½¿ç”¨relaxing orderå¯ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚</p>
<p>ä¼˜åŒ–çš„æœºä¼šåŒ…æ‹¬</p>
<ul>
<li>ä½¿ç”¨éFIFOçš„write bufferï¼Œæ¥è·å¾—æ›´å¤šçš„å†™åˆå¹¶ã€‚</li>
<li>ä¸éœ€è¦åšå¤æ‚çš„core speculationï¼Œæœ¬èº«å°±å…è®¸ä¹±åºçš„loadã€‚</li>
<li>é€šè¿‡æ‰“å¼€coherenceé­”ç›’ï¼Œæ¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚å…è®¸ä¸€ç»„æ ¸è¯»åˆ°æœ€æ–°çš„å€¼ï¼Œè€Œå…¶ä»–çš„æ ¸è¯»åˆ°è€çš„å€¼ã€‚</li>
</ul>
<h3 id="example-relaxed-consistency-modelxc">eXample relaxed Consistency Model(XC)<a hidden class="anchor" aria-hidden="true" href="#example-relaxed-consistency-modelxc">Â¶</a></h3>
<p>XCä¸æ˜¯å®é™…çš„æ¨¡å‹ï¼Œå‡å®šå­˜åœ¨global memory orderï¼Œå’Œä¸å†ä½¿ç”¨çš„Alpha, SPARC RMOç›¸åŒã€‚</p>
<p>XCå¯¹ç›¸åŒåœ°å€çš„è®¿é—®ç»´æŠ¤TSOè§„åˆ™ã€‚</p>
<ul>
<li>ç›¸åŒåœ°å€çš„Load â†’ Load</li>
<li>ç›¸åŒåœ°å€çš„Load â†’ Store</li>
<li>ç›¸åŒåœ°å€çš„Store â†’ Store</li>
</ul>
<p>XCä¸­çš„Loadé©¬ä¸Šå°±èƒ½çœ‹åˆ°å¯¹è‡ªå·±æ ¸çš„æ›´æ–°ï¼ˆå°±åƒTSOçš„write buffer bypassing)ã€‚</p>
<p>XCçš„å½¢å¼åŒ–å®šä¹‰</p>
<ol>
<li>
<p>æ‰€æœ‰çš„æ ¸å°†load, storeå’ŒFENCEæ’å…¥&lt;mï¼Œå¹¶éµå¾ªä¸‹é¢çš„è§„åˆ™</p>
<ul>
<li>If L(a) &lt;p FENCE  â‡’ L(a) &lt;m FENCE                  /* Load â†’ FENCE */</li>
<li>If S(a) &lt;p FENCE  â‡’ S(a) &lt;m FENCE                  /* Store â†’ FENCE */</li>
<li>If FENCE &lt;p FENCE  â‡’ FENCE &lt;m FENCE                  /* FENCE â†’ FENCE */</li>
<li>If FENCE &lt;p L(a)  â‡’ FENCE &lt;m L(a)                  /* FENCE â†’ LOAD */</li>
<li>If FENCE &lt;p S(a)  â‡’ FENCE &lt;m S(a)                  /* FENCE â†’ STORE */</li>
</ul>
</li>
<li>
<p>æ‰€æœ‰çš„æ ¸å°†å¯¹ç›¸åŒåœ°å€çš„loadå’Œstoreæ’å…¥&lt;mï¼Œå¹¶éµå¾ªä¸‹é¢çš„è§„åˆ™</p>
<ul>
<li>If L(a) &lt;p Lâ€™(a) â‡’ L(a) &lt;m Lâ€™ (a)        /* Load â†’ Load to same address */</li>
<li>If L(a) &lt;p S(a) â‡’ L(a) &lt;m S(a)        /* Load â†’ Store to same address */</li>
<li>If S(a) &lt;p Sâ€™(a) â‡’ S(a) &lt;m Sâ€™ (a)        /* Store â†’ Store to same address */</li>
</ul>
</li>
<li>
<p>Loadå¾—åˆ°å¯¹ç›¸åŒåœ°å€çš„Storeçš„å€¼ã€‚</p>
<p>Value of L(a) = Value of MAX &lt;m {S(a) | S(a) &lt;m L(a) or S(a) &lt;p L(a)} /* Like TSO */</p>
</li>
</ol>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-6.png">
<ul>
<li>BæŒ‡å¯¹ç›¸åŒåœ°å€éœ€è¦bypassingã€‚</li>
<li>AæŒ‡å¯¹ç›¸åŒåœ°å€æ‰ä¿æŒé¡ºåºã€‚</li>
</ul>
<p>å®ç°XC</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-7.png">
<p>ç›¸æ¯”TSOï¼ŒåŠ ä¸Šäº†reorder unitã€‚</p>
<ul>
<li>Load, Store, FENCEä»¥&lt;pé¡ºåºè¿›å…¥reorderçš„å°¾éƒ¨</li>
<li>reorder unitéµå¾ªä¸€å®šè§„åˆ™è¿›è¡Œreorderï¼Œå°†æ“ä½œä»å°¾éƒ¨ç§»åŠ¨åˆ°å¤´éƒ¨ã€‚FENCEåˆ°è¾¾å¤´éƒ¨åè¢«ä¸¢å¼ƒã€‚</li>
<li>switché€‰å–æŸä¸ªcoreæ—¶ï¼Œæ‰§è¡Œreorderå¤´éƒ¨çš„storeæˆ–è€…loadã€‚</li>
</ul>
<p>ä½œè€…ä¹‹å‰é¢„æµ‹speculative coreä¼šé€æ¸å–ä»£relaxed modelï¼Œæ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œæ¥å£åˆæ›´åŠ ç®€å•ï¼Œä½†ä¸¤æ–¹é¢çš„åŸå› å¯¼è‡´æ²¡æœ‰å‘ç”Ÿï¼šå‚å•†çš„å†²é‡ï¼›ä½åŠŸè€—çš„åœºæ™¯åšä¸åˆ°é«˜speculativeã€‚</p>
<p>XCçš„åŸå­æŒ‡ä»¤</p>
<p>XCä¸­çš„RMWä¸éœ€è¦draining write bufferï¼Œåªéœ€è¦è·å–åˆ°read-writeæƒé™ï¼Œå¹¶åœ¨loadéƒ¨åˆ†å’Œstoreéƒ¨åˆ†ä¹‹é—´ä¸èƒ½æ”¾æ‰‹ã€‚</p>
<p>TSOä¸­çš„åŸå­RMWå°±è¶³ä»¥å®ç°é”ï¼Œè€Œåœ¨XCä¸­éœ€è¦å‰ååŠ ä¸ŠFENCEã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-8.png">
<p>XCä¸­çš„FENCEå®ç°</p>
<ul>
<li>å®ç°SCï¼Œå°†FENCEä½œä¸ºno-op</li>
<li>å°†FENCEå®ç°ä¸ºdrainä¹‹å‰çš„å†…å­˜æ“ä½œã€‚</li>
<li>ä¸drainï¼Œæ€ä¹ˆåšä¹¦é‡Œé¢æ²¡è®²ã€‚</li>
</ul>
<p>ä¸Šé¢æ‰€æœ‰çš„æƒ…å†µä¸­ï¼ŒFENCEéƒ½éœ€è¦çŸ¥é“FENCEå‰çš„æ“ä½œXiæ˜¯å¦ç»“æŸäº†ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹éå¸¸trickyã€‚</p>
<h3 id="sc-for-drfdata-race-free">SC for DRF(data race free)<a hidden class="anchor" aria-hidden="true" href="#sc-for-drfdata-race-free">Â¶</a></h3>
<p>ç”¨äºé«˜é˜¶è¯­è¨€åšæŠ½è±¡ï¼Œé™¤äº†æŒ‡å®šçš„åŒæ­¥æ“ä½œéœ€è¦ä¿æŒé¡ºåºå¤–ï¼Œå…¶ä»–çš„æ“ä½œå…è®¸åšreorderã€‚SC for DRFæ¦‚æ‹¬ä¸ºä¸‹é¢ä¸¤æ¡</p>
<ul>
<li>è¦ä¹ˆæœ‰data raceï¼Œæš´éœ²äº†ç±»ä¼¼XCçš„loadå’Œstoreçš„reordering</li>
<li>è¦ä¹ˆdata race freeï¼Œæ‰§è¡Œçœ‹èµ·æ¥å°±åƒSCã€‚</li>
</ul>
<p>SC for DRFå¯ä»¥è®©ç¨‹åºå‘˜ä½¿ç”¨SCæ¥è®ºè¯ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œè€Œä¸éœ€è¦è€ƒè™‘æ›´å¤æ‚çš„XCè§„åˆ™ï¼Œè€Œä¸”èƒ½ä»XCç›¸æ¯”SCçš„ç¡¬ä»¶æ€§èƒ½æé«˜æˆ–æ“ä½œç®€åŒ–ä¸­å—ç›Šã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-9.png">
<p>åœ¨HLLä¸­åªåœ¨å¿…è¦çš„åœ°æ–¹åŠ ä¸ŠåŒæ­¥ï¼Œå¦‚atomicå’Œsynchronizedï¼Œåœ¨low-level programæ ¹æ®ç¡¬ä»¶äº§ç”Ÿåˆé€‚çš„æŒ‡ä»¤ã€‚</p>
<p>Javaä¸­çš„å†…å­˜æ“ä½œéƒ½æ˜¯SCï¼ŒC++å…è®¸æ›´relaxedçš„æ¨¡å‹ã€‚</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 5: A programmer who writes properly synchronized code relative to the high-level language consistency model (e.g,. Java) does not need to consider the architectureâ€™s memory consistency model. True or false?
Answer: It depends. For typical application programmers, the answer is True, because their programs behave as expected (SC is expected). For the programmers of compilers and runtime systems, the answer is False.
</aside>
<p>ARMv7ä¼¼ä¹ä¸ä¿è¯total memory orderï¼ŒARMv8åˆ‡æ¢åˆ°äº†æä¾›total memory orderçš„multi-copy atomic memory orderã€‚</p>
<blockquote>
<p>write atomicity, store atomicity, multi-copy atomicityã€‚æ˜¯æŒ‡ä¸€ä¸ªæ ¸çš„storeåœ¨é€»è¾‘ä¸Šè¢«å…¶ä»–æ ¸åŒæ—¶å¯è§ã€‚
write atomicityèƒ½å¤Ÿæ¨å¯¼å‡ºcausalityï¼Œåä¹‹ä¸ç„¶ã€‚</p>
</blockquote>


  </div>

  <footer class="post-footer">
  </footer>
    <div class="comments-separator"></div>
</article>
    </main>
    
<footer class="footer">
  <span>&copy; 2024 <a href="https://egolearner.github.io/">A lifelong learner.</a></span><span style="display: inline-block; margin-left: 1em;">
    <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
  </span>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
    <path d="M12 6H0l6-6z" />
  </svg>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
    if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
      mybutton.style.visibility = "visible";
      mybutton.style.opacity = "1";
    } else {
      mybutton.style.visibility = "hidden";
      mybutton.style.opacity = "0";
    }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>




<script>
  
  
  (function() {
    const enableTocScroll = '' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

</body>

</html>
