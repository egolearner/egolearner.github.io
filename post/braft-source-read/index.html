<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>braft源码分析 - A lifelong learner.</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="egolearner" /><meta name="description" content="brat是百度开源的RAFT实现。 初始化 braft::add_service添加的服务 1 2 3 4 5 6 7 8 9 10 11 12 // 发送文件 if (0 != server-&amp;gt;AddService(file_service(), brpc::SERVER_DOESNT_OWN_SERVICE)) { // raf" />






<meta name="generator" content="Hugo 0.87.0 with theme even" />


<link rel="canonical" href="https://egolearner.github.io/post/braft-source-read/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="braft源码分析" />
<meta property="og:description" content="brat是百度开源的RAFT实现。 初始化 braft::add_service添加的服务 1 2 3 4 5 6 7 8 9 10 11 12 // 发送文件 if (0 != server-&gt;AddService(file_service(), brpc::SERVER_DOESNT_OWN_SERVICE)) { // raf" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://egolearner.github.io/post/braft-source-read/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-23T15:44:11+08:00" />
<meta property="article:modified_time" content="2022-10-23T15:44:11+08:00" />

<meta itemprop="name" content="braft源码分析">
<meta itemprop="description" content="brat是百度开源的RAFT实现。 初始化 braft::add_service添加的服务 1 2 3 4 5 6 7 8 9 10 11 12 // 发送文件 if (0 != server-&gt;AddService(file_service(), brpc::SERVER_DOESNT_OWN_SERVICE)) { // raf"><meta itemprop="datePublished" content="2022-10-23T15:44:11+08:00" />
<meta itemprop="dateModified" content="2022-10-23T15:44:11+08:00" />
<meta itemprop="wordCount" content="12633">
<meta itemprop="keywords" content="raft,braft," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="braft源码分析"/>
<meta name="twitter:description" content="brat是百度开源的RAFT实现。 初始化 braft::add_service添加的服务 1 2 3 4 5 6 7 8 9 10 11 12 // 发送文件 if (0 != server-&gt;AddService(file_service(), brpc::SERVER_DOESNT_OWN_SERVICE)) { // raf"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">A lifelong learner</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">A lifelong learner</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">braft源码分析</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-10-23 </span>
        <div class="post-category">
            <a href="/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"> 源码分析 </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#初始化">初始化</a></li>
        <li><a href="#选举阶段"><strong><strong>选举阶段</strong></strong></a>
          <ul>
            <li><a href="#pre_vote">pre_vote</a></li>
            <li><a href="#elect">elect</a></li>
          </ul>
        </li>
        <li><a href="#leader逻辑">leader逻辑</a>
          <ul>
            <li><a href="#成为leader">成为leader</a></li>
            <li><a href="#维护leader身份心跳">维护leader身份——心跳</a></li>
          </ul>
        </li>
        <li><a href="#状态机任务执行">状态机任务执行</a>
          <ul>
            <li><a href="#log持久化">log持久化</a></li>
            <li><a href="#同步follower">同步follower</a></li>
            <li><a href="#apply_log">apply_log</a></li>
          </ul>
        </li>
        <li><a href="#节点更新">节点更新</a>
          <ul>
            <li><a href="#追赶阶段"><strong>追赶阶段</strong></a></li>
            <li><a href="#联合选举阶段"><strong>联合选举阶段</strong></a></li>
            <li><a href="#新配置同步阶段"><strong>新配置同步阶段</strong></a></li>
            <li><a href="#清理阶段"><strong>清理阶段</strong></a></li>
          </ul>
        </li>
        <li><a href="#快照">快照</a>
          <ul>
            <li><a href="#打快照">打快照</a></li>
            <li><a href="#installsnapshot">InstallSnapshot</a></li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>brat是百度开源的RAFT实现。</p>
<h2 id="初始化">初始化</h2>
<p>braft::add_service添加的服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp">    <span class="c1">// 发送文件
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="n">file_service</span><span class="p">(),</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_DOESNT_OWN_SERVICE</span><span class="p">))</span> <span class="p">{</span>

    <span class="c1">// raft实现，pre_vote/request_vote/append_entries/install_snapshot/timeout_now
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">RaftServiceImpl</span><span class="p">(</span><span class="n">listen_address</span><span class="p">),</span> 
                <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 统计信息
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="k">new</span> <span class="n">RaftStatImpl</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// 命令行操作
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="k">new</span> <span class="n">CliServiceImpl</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>

</code></pre></td></tr></table>
</div>
</div><p><code>NodeImpl::init</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_vote_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span> <span class="o">+</span> <span class="n">options</span><span class="p">.</span><span class="n">max_clock_drift_ms</span><span class="p">));</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_election_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">));</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_stepdown_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">));</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_snapshot_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">snapshot_interval_s</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
    <span class="c1">// 启动执行队列
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_apply_queue_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                                       <span class="n">execute_applying_tasks</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// log storage and log manager init
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_log_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// 初始化fsm caller时创建了另外一个执行队列
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_fsm_caller</span><span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// commitment manager init
</span><span class="c1"></span>    <span class="n">_ballot_box</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BallotBox</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ballot_box_options</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// snapshot storage init and load
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_snapshot_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// if have log using conf in log, else using conf in options
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">_options</span><span class="p">.</span><span class="n">initial_conf</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// init meta and check term
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_meta_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// Now the raft node is started , have to acquire the lock to avoid race
</span><span class="c1"></span>    <span class="c1">// conditions
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="c1">// 只有一个节点时马上选举自己
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1u</span>
            <span class="o">&amp;&amp;</span> <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">_server_id</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// The group contains only this server which must be the LEADER, trigger
</span><span class="c1"></span>        <span class="c1">// the timer immediately.
</span><span class="c1"></span>        <span class="n">elect_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="选举阶段"><strong><strong>选举阶段</strong></strong></h2>
<p>选举超时处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_election_timeout</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>

    <span class="c1">// check state
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_FOLLOWER</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Trigger vote manually, or wait until follower lease expire.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_vote_triggered</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_follower_lease</span><span class="p">.</span><span class="n">expired</span><span class="p">())</span> <span class="p">{</span>

        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">triggered</span> <span class="o">=</span> <span class="n">_vote_triggered</span><span class="p">;</span>
    <span class="n">_vote_triggered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="c1">// Reset leader as the leader is uncerntain on election timeout.
</span><span class="c1"></span>    <span class="n">PeerId</span> <span class="n">empty_id</span><span class="p">;</span>
    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ERAFTTIMEDOUT</span><span class="p">,</span> <span class="s">&#34;Lost connection from leader %s&#34;</span><span class="p">,</span>
                                    <span class="n">_leader_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="c1">// 里面会根据情况情况回调on_start_following/on_stop_following
</span><span class="c1"></span>    <span class="n">reset_leader_id</span><span class="p">(</span><span class="n">empty_id</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="c1">// 发起预选举
</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">pre_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">,</span> <span class="n">triggered</span><span class="p">);</span>
    <span class="c1">// Don&#39;t touch any thing of *this ever after
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pre_vote">pre_vote</h3>
<p>Pre_vote 算法是 raft 作者在其博士论文中提出的，在节点发起一次选举时，会先发起一次 prevote 请求，判断是否能够赢得选举，赢得选举的条件与正常选举相同。如果可以，则增加 term 值，并发起正常的选举。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">pre_vote</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;*</span> <span class="n">lck</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">triggered</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 获取last log的term和id
</span><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">old_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
    <span class="c1">// get last_log_id outof node mutex
</span><span class="c1"></span>    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
    <span class="c1">// pre_vote need defense ABA after unlock&amp;lock
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">old_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">triggered</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>

    <span class="c1">// 向所有peer发送pre_vote请求
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iter</span> <span class="o">==</span> <span class="n">_server_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">OnPreVoteRPCDone</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnPreVoteRPCDone</span><span class="p">(</span>
                <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">version</span><span class="p">(),</span> <span class="k">this</span><span class="p">);</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="p">.</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">);</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// next term
</span><span class="c1"></span>        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_last_log_index</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_last_log_term</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">.</span><span class="n">term</span><span class="p">);</span>

        <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
        <span class="n">stub</span><span class="p">.</span><span class="n">pre_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 给自己投票
</span><span class="c1"></span>    <span class="n">grant_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_pre_vote_ctx</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>pre_vote请求处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">RaftServiceImpl</span><span class="o">::</span><span class="n">pre_vote</span><span class="p">(</span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">RpcController</span><span class="o">*</span> <span class="n">cntl_base</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                          <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
                          <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 获取node对象
</span><span class="c1"></span>    <span class="n">scoped_refptr</span><span class="o">&lt;</span><span class="n">NodeImpl</span><span class="o">&gt;</span> <span class="n">node_ptr</span> <span class="o">=</span> 
                        <span class="n">global_node_manager</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">group_id</span><span class="p">(),</span> <span class="n">peer_id</span><span class="p">);</span>
    <span class="n">NodeImpl</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node_ptr</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">handle_pre_vote_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">berror</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_pre_vote_request</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                                      <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>

    <span class="kt">bool</span> <span class="n">granted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ignore older term
</span><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// get last_log_id outof node mutex
</span><span class="c1"></span>        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
        <span class="c1">// pre_vote not need ABA check after unlock&amp;lock
</span><span class="c1"></span>
        <span class="kt">int64_t</span> <span class="n">votable_time</span> <span class="o">=</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">votable_time_from_now</span><span class="p">();</span>
        <span class="kt">bool</span> <span class="n">grantable</span> <span class="o">=</span> <span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">(),</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_term</span><span class="p">())</span>
                        <span class="o">&gt;=</span> <span class="n">last_log_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">grantable</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">granted</span> <span class="o">=</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_granted</span><span class="p">(</span><span class="n">granted</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_rejected_by_lease</span><span class="p">(</span><span class="n">rejected_by_lease</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_disrupted</span><span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_LEADER</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_previous_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>pre_vote响应处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_pre_vote_response</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">ctx_version</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">RequestVoteResponse</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// check response term，收到的term更大则放弃选举
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
                <span class="s">&#34;pre_vote_response.&#34;</span><span class="p">);</span>
        <span class="n">step_down</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 省略比较复杂的检查grant逻辑，涉及lease/disrupted_leader等
</span><span class="c1"></span>
    <span class="c1">// 预选举通过，开始正式的选举
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">elect_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="elect">elect</h3>
<p>预选举通过，开始正式的选举</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// in lock
</span><span class="c1"></span><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">elect_self</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;*</span> <span class="n">lck</span><span class="p">,</span> 
                          <span class="kt">bool</span> <span class="n">old_leader_stepped_down</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// cancel follower election timer
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_FOLLOWER</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_election_timer</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// reset leader_id before vote
</span><span class="c1"></span>    <span class="k">const</span> <span class="n">PeerId</span> <span class="n">old_leader</span> <span class="o">=</span> <span class="n">_leader_id</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">leader_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
    <span class="n">PeerId</span> <span class="n">empty_id</span><span class="p">;</span>
    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
    <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ERAFTTIMEDOUT</span><span class="p">,</span> <span class="s">&#34;A follower&#39;s leader_id is reset to NULL &#34;</span>
                                    <span class="s">&#34;as it begins to request_vote.&#34;</span><span class="p">);</span>
    <span class="n">reset_leader_id</span><span class="p">(</span><span class="n">empty_id</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

    <span class="c1">// 修改状态
</span><span class="c1"></span>    <span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_CANDIDATE</span><span class="p">;</span>
    <span class="c1">// term加1
</span><span class="c1"></span>    <span class="n">_current_term</span><span class="o">++</span><span class="p">;</span>
    <span class="n">_voted_id</span> <span class="o">=</span> <span class="n">_server_id</span><span class="p">;</span>

    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
               <span class="o">&lt;&lt;</span> <span class="s">&#34; term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; start vote_timer&#34;</span><span class="p">;</span>
    <span class="c1">// 启动vote定时器
</span><span class="c1"></span>    <span class="n">_vote_timer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
    <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_leader_stepped_down</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_disrupted_leader</span><span class="p">(</span><span class="n">DisruptedLeader</span><span class="p">(</span><span class="n">old_leader</span><span class="p">,</span> <span class="n">leader_term</span><span class="p">));</span>
        <span class="n">_follower_lease</span><span class="p">.</span><span class="n">expire</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">int64_t</span> <span class="n">old_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
    <span class="c1">// get last_log_id outof node mutex
</span><span class="c1"></span>    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
    <span class="c1">// vote need defense ABA after unlock&amp;lock
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">old_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// term changed cause by step_down
</span><span class="c1"></span>        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
                     <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_last_log_id</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
    <span class="c1">// 向peer发送vote请求
</span><span class="c1"></span>    <span class="n">request_peers_to_vote</span><span class="p">(</span><span class="n">peers</span><span class="p">,</span> <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">disrupted_leader</span><span class="p">());</span>

    <span class="c1">//TODO: outof lock
</span><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">_meta_storage</span><span class="o">-&gt;</span>
                    <span class="n">set_term_and_votedfor</span><span class="p">(</span><span class="n">_current_term</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">,</span> <span class="n">_v_group_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
                   <span class="o">&lt;&lt;</span> <span class="s">&#34; fail to set_term_and_votedfor itself when elect_self,&#34;</span>
                      <span class="s">&#34; error: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">status</span><span class="p">;</span>
        <span class="c1">// reset _voted_id to avoid inconsistent cases
</span><span class="c1"></span>        <span class="c1">// return immediately without granting _vote_ctx
</span><span class="c1"></span>        <span class="n">_voted_id</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 给自己投票
</span><span class="c1"></span>    <span class="n">grant_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_vote_ctx</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>request vote请求处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_request_vote_request</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                                          <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>

    <span class="c1">// 忽略一些disrupt逻辑
</span><span class="c1"></span>    <span class="kt">bool</span> <span class="n">disrupted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">previous_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// ignore older term
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ignore older term
</span><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// get last_log_id outof node mutex
</span><span class="c1"></span>        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>

        <span class="c1">// vote need ABA check after unlock&amp;lock
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">previous_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
                         <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">bool</span> <span class="n">log_is_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">(),</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_term</span><span class="p">())</span>
                          <span class="o">&gt;=</span> <span class="n">last_log_id</span><span class="p">);</span>
        <span class="kt">int64_t</span> <span class="n">votable_time</span> <span class="o">=</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">votable_time_from_now</span><span class="p">();</span>

        <span class="c1">// if the vote is rejected by lease, tell the candidate
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="n">log_is_ok</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// increase current term, change state to follower
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMREQUEST</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
                    <span class="s">&#34;request_vote_request.&#34;</span><span class="p">);</span>
            <span class="n">disrupted</span> <span class="o">=</span> <span class="p">(</span><span class="n">_state</span> <span class="o">&lt;=</span> <span class="n">STATE_TRANSFERRING</span><span class="p">);</span>
            <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// save
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">log_is_ok</span> <span class="o">&amp;&amp;</span> <span class="n">_voted_id</span><span class="p">.</span><span class="n">is_empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EVOTEFORCANDIDATE</span><span class="p">,</span> <span class="s">&#34;Raft node votes for some candidate, &#34;</span>
                    <span class="s">&#34;step down to restart election_timer.&#34;</span><span class="p">);</span>
            <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
            <span class="n">_voted_id</span> <span class="o">=</span> <span class="n">candidate_id</span><span class="p">;</span>
            <span class="c1">//TODO: outof lock
</span><span class="c1"></span>            <span class="c1">// 投票需要持久化存储
</span><span class="c1"></span>            <span class="n">status</span> <span class="o">=</span> <span class="n">_meta_storage</span><span class="o">-&gt;</span>
                    <span class="n">set_term_and_votedfor</span><span class="p">(</span><span class="n">_current_term</span><span class="p">,</span> <span class="n">candidate_id</span><span class="p">,</span> <span class="n">_v_group_id</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
                <span class="c1">// reset _voted_id to response set_granted(false)
</span><span class="c1"></span>                <span class="n">_voted_id</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> 
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_disrupted</span><span class="p">(</span><span class="n">disrupted</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_previous_term</span><span class="p">(</span><span class="n">previous_term</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_granted</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">==</span> <span class="n">_current_term</span> <span class="o">&amp;&amp;</span> <span class="n">_voted_id</span> <span class="o">==</span> <span class="n">candidate_id</span><span class="p">);</span>
    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_rejected_by_lease</span><span class="p">(</span><span class="n">rejected_by_lease</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>request vote响应处理逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_request_vote_response</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
                                            <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">ctx_version</span><span class="p">,</span>
                                            <span class="k">const</span> <span class="n">RequestVoteResponse</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BAIDU_SCOPED_LOCK</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>

    <span class="c1">// check state，状态不对直接忽略，比如已成为leader
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_CANDIDATE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// check response term，response term更大则停止选举
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
                <span class="s">&#34;request_vote_response.&#34;</span><span class="p">);</span>
        <span class="n">step_down</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="n">granted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="n">rejected_by_lease</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">disrupted</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_disrupted_leader</span><span class="p">(</span><span class="n">DisruptedLeader</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">previous_term</span><span class="p">()));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">peer_id</span> <span class="o">==</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">last_leader</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="n">_server_id</span><span class="p">);</span>
            <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">stop_grant_self_timer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// 如果获得多数支持，成为leader
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_vote_ctx</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">become_leader</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// If the follower rejected the vote because of lease, reserve it, and
</span><span class="c1"></span>        <span class="c1">// the candidate will try again after it disrupt the old leader.
</span><span class="c1"></span>        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 再次要求预留的peer投票
</span><span class="c1"></span>    <span class="n">retry_vote_on_reserved_peers</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">retry_vote_on_reserved_peers</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">pop_grantable_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">request_peers_to_vote</span><span class="p">(</span><span class="n">peers</span><span class="p">,</span> <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">disrupted_leader</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="leader逻辑">leader逻辑</h2>
<h3 id="成为leader">成为leader</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">become_leader</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 检查状态必须为候选者
</span><span class="c1"></span>    <span class="n">CHECK</span><span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_CANDIDATE</span><span class="p">);</span>
    <span class="c1">// cancel candidate vote timer
</span><span class="c1"></span>    <span class="n">_vote_timer</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

    <span class="c1">// 修改状态和leader_id
</span><span class="c1"></span>    <span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_LEADER</span><span class="p">;</span>
    <span class="n">_leader_id</span> <span class="o">=</span> <span class="n">_server_id</span><span class="p">;</span>

    <span class="n">_replicator_group</span><span class="p">.</span><span class="n">reset_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
    <span class="n">_follower_lease</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
    <span class="n">_leader_lease</span><span class="p">.</span><span class="n">on_leader_start</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
    <span class="c1">// 每个follower启动一个replicator
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iter</span> <span class="o">==</span> <span class="n">_server_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">_replicator_group</span><span class="p">.</span><span class="n">add_replicator</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// init commit manager
</span><span class="c1"></span>    <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">reset_pending_index</span><span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Register _conf_ctx to reject configuration changing before the first log
</span><span class="c1"></span>    <span class="c1">// is committed.
</span><span class="c1"></span>    <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">());</span>
    <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">flush</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">);</span>
    <span class="n">_stepdown_timer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>根据Raft论文，新leader登基之后需要提交一个no-op日志才能安全的提交之前任期的日志。在braft的实现中， <code>_conf_ctx.flush(_conf.conf, _conf.old_conf)</code> 会发起一次节点更新，在节点更新的日志成功提交后回调用户状态机的 <code>on_leader_start</code> 。braft使用节点更新日志替代了论文中的no-op日志。</p>
<p>Replicator启动逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">ReplicatorOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="n">ReplicatorId</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Replicator</span><span class="p">();</span>
    <span class="n">brpc</span><span class="o">::</span><span class="n">ChannelOptions</span> <span class="n">channel_opt</span><span class="p">;</span>
    <span class="c1">//channel_opt.connect_timeout_ms = *options.heartbeat_timeout_ms;
</span><span class="c1"></span>    <span class="n">channel_opt</span><span class="p">.</span><span class="n">timeout_ms</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// We don&#39;t need RPC timeout
</span><span class="c1"></span>    <span class="c1">// 创建发送channel
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_sending_channel</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_opt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// 记录到bthread local存储
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_on_error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_catchup_closure</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">());</span>
    <span class="c1">// Note: r-&gt;_id is unlock in _send_empty_entries, don&#39;t touch r ever after
</span><span class="c1"></span>    <span class="c1">// 发送no_op来宣示leader身份
</span><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="维护leader身份心跳">维护leader身份——心跳</h3>
<p>在Replicator::start里面开始了heartbeat_timer，它是个bthread_timer，在超时的时候会调用Replicator::_on_timedout，该函数会把对应的id设置为ETIMEDOUT。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_timedout</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bthread_id_t</span> <span class="n">id</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">arg</span> <span class="p">};</span>
    <span class="n">bthread_id_error</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ETIMEDOUT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>bthread_id_error会去调用_on_error，然后开始_send_heartbeat。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_error</span><span class="p">(</span><span class="n">bthread_id_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This error is issued in the TimerThread, start a new bthread to avoid
</span><span class="c1"></span>        <span class="c1">// blocking the caller.
</span><span class="c1"></span>        <span class="c1">// Unlock id to remove the context-switch out of the critical section
</span><span class="c1"></span>        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span><span class="p">;</span>
        <span class="n">bthread_t</span> <span class="n">tid</span><span class="p">;</span>
        <span class="c1">// 启动一个bthread来执行_send_heartbeat
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bthread_start_urgent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_send_heartbeat</span><span class="p">,</span>
                                 <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">value</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to start bthread&#34;</span><span class="p">;</span>
            <span class="n">_send_heartbeat</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>发送心跳</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span><span class="o">*</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_heartbeat</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bthread_id_t</span> <span class="n">id</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">arg</span> <span class="p">};</span>
    <span class="c1">// 从bthread local存储获取replicator
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// This replicator is stopped
</span><span class="c1"></span>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// id is unlock in _send_empty_entries;
</span><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="kt">bool</span> <span class="n">is_heartbeat</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl</span><span class="p">(</span><span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesRequest</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">response</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesResponse</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span>
                <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">is_heartbeat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">is_heartbeat</span><span class="p">);</span>
        <span class="c1">// _id is unlock in _install_snapshot
</span><span class="c1"></span>        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_heartbeat</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_heartbeat_in_fly</span> <span class="o">=</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">();</span>
        <span class="n">_heartbeat_counter</span><span class="o">++</span><span class="p">;</span>
        <span class="c1">// set RPC timeout for heartbeat, how long should timeout be is waiting to be optimized.
</span><span class="c1"></span>        <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="o">*</span><span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">APPENDING_ENTRIES</span><span class="p">;</span>
        <span class="n">_st</span><span class="p">.</span><span class="n">first_log_index</span> <span class="o">=</span> <span class="n">_next_index</span><span class="p">;</span>
        <span class="n">_st</span><span class="p">.</span><span class="n">last_log_index</span> <span class="o">=</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">CHECK</span><span class="p">(</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">_flying_append_entries_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FlyingAppendEntriesRpc</span><span class="p">(</span><span class="n">_next_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">()));</span>
        <span class="n">_append_entries_counter</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="p">(</span>
                <span class="n">is_heartbeat</span> <span class="o">?</span> <span class="nl">_on_heartbeat_returned</span> <span class="p">:</span> <span class="n">_on_rpc_returned</span><span class="p">,</span> 
                <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cntl</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
                <span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>

    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
    <span class="n">stub</span><span class="p">.</span><span class="n">append_entries</span><span class="p">(</span><span class="n">cntl</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> 
                        <span class="n">response</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">done</span><span class="p">);</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_id</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>append_entries请求处理逻辑，既包括心跳处理，也包括正常的请求处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_append_entries_request</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
                                             <span class="k">const</span> <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                                             <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
                                             <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">,</span>
                                             <span class="kt">bool</span> <span class="n">from_append_entries_cache</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
    <span class="n">entries</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">());</span>
    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>

    <span class="c1">// pre set term, to avoid get term in lock
</span><span class="c1"></span>    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>

    <span class="c1">// check stale term
</span><span class="c1"></span>    <span class="c1">// 让已被篡位的leader下台
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">saved_current_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">saved_current_term</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// check term and state to step down
</span><span class="c1"></span>    <span class="n">check_step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">server_id</span><span class="p">);</span>   

    <span class="c1">// 如果有两个相同term的leader，自己的term加一让两个leader都下台
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server_id</span> <span class="o">!=</span> <span class="n">_leader_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Increase the term by 1 and make both leaders step down to minimize the
</span><span class="c1"></span>        <span class="c1">// loss of split brain
</span><span class="c1"></span>        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ELEADERCONFLICT</span><span class="p">,</span> <span class="s">&#34;More than one leader in the same term.&#34;</span><span class="p">);</span> 
        <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">prev_log_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">prev_log_term</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_term</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">local_prev_log_term</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_term</span><span class="p">(</span><span class="n">prev_log_index</span><span class="p">);</span>
    <span class="c1">// 如果term不匹配，视是否允许乱序而报错或正常处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">local_prev_log_term</span> <span class="o">!=</span> <span class="n">prev_log_term</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="c1">// 心跳请求处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_last_log_index</span><span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">());</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_readonly</span><span class="p">(</span><span class="n">_node_readonly</span><span class="p">);</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="c1">// see the comments at FollowerStableClosure::run()
</span><span class="c1"></span>        <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">set_last_committed_index</span><span class="p">(</span>
                <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">(),</span>
                         <span class="n">prev_log_index</span><span class="p">));</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Parse request
</span><span class="c1"></span>    <span class="n">butil</span><span class="o">::</span><span class="n">IOBuf</span> <span class="n">data_buf</span><span class="p">;</span>
    <span class="n">data_buf</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">request_attachment</span><span class="p">());</span>
    <span class="kt">int64_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">prev_log_index</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">index</span><span class="o">++</span><span class="p">;</span>
        <span class="k">const</span> <span class="n">EntryMeta</span><span class="o">&amp;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ENTRY_TYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">LogEntry</span><span class="o">*</span> <span class="n">log_entry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry</span><span class="p">();</span>
            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">term</span><span class="p">();</span>
            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">EntryType</span><span class="p">)</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">();</span>
            <span class="c1">// 如果请求中peer不为空，也设置log_entry的peer/old_peer字段
</span><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">CHECK_NE</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">has_data_len</span><span class="p">())</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">data_len</span><span class="p">();</span>
                <span class="n">data_buf</span><span class="p">.</span><span class="n">cutn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">log_entry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// check out-of-order cache
</span><span class="c1"></span>    <span class="n">check_append_entries_cache</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

    <span class="n">FollowerStableClosure</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FollowerStableClosure</span><span class="p">(</span>
            <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span>
            <span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">);</span>
    <span class="c1">// 写入log，在回调中进行回包
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

    <span class="c1">// update configuration after _log_manager updated its memory status
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>心跳回包处理逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_heartbeat_returned</span><span class="p">(</span>
        <span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
        <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
        <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
        <span class="kt">int64_t</span> <span class="n">rpc_send_time</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl_guard</span><span class="p">(</span><span class="n">cntl</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span>  <span class="n">req_guard</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">res_guard</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
    <span class="k">const</span> <span class="kt">long</span> <span class="n">start_time_us</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">();</span>
    <span class="c1">// XXX bthread_id大概相当于pthread key
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">Failed</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 如果失败则再次启动定时器
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">);</span>
        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_consecutive_error_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// 如果心跳收到更高的term，则退位
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NodeImpl</span> <span class="o">*</span><span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
        <span class="c1">// Acquire a reference of Node here in case that Node is detroyed
</span><span class="c1"></span>        <span class="c1">// after _notify_on_caught_up.
</span><span class="c1"></span>        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Replicator=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is going to quit&#34;</span>
                  <span class="o">&lt;&lt;</span> <span class="s">&#34;, group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span><span class="p">;</span>
        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Leader receives higher term &#34;</span>
                <span class="s">&#34;heartbeat_response from peer:%s&#34;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_destroy</span><span class="p">();</span>
        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">increase_term_to</span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">status</span><span class="p">);</span>
        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">readonly</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">has_readonly</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">readonly</span><span class="p">();</span>
    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; readonly &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">readonly</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">rpc_send_time</span><span class="p">);</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">);</span>
    <span class="n">NodeImpl</span><span class="o">*</span> <span class="n">node_impl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="c1">// Check if readonly config changed
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">readonly</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_readonly_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="o">!</span><span class="n">readonly</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_readonly_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_impl</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="n">PeerId</span> <span class="n">peer_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">term</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">;</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
    <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">change_readonly_config</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">peer_id</span><span class="p">,</span> <span class="n">readonly</span><span class="p">);</span>
    <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="状态机任务执行">状态机任务执行</h2>
<p>用户代码会调用<code>NodeImpl::apply(const Task&amp; task)</code>，apply的实现中将任务加入<code>_apply_queue</code>队列。队列执行时最终会调用下面的函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">LogEntryAndClosure</span> <span class="n">tasks</span><span class="p">[],</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">g_apply_tasks_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">size</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
    <span class="n">entries</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">reject_new_user_logs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_node_readonly</span> <span class="o">||</span> <span class="n">_majority_nodes_readonly</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span> <span class="o">||</span> <span class="n">reject_new_user_logs</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 非leader或只读时设置错误，并回调用户的done
</span><span class="c1"></span>        <span class="n">st</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="s">&#34;is not leader&#34;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
                <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 检查ABA问题，有问题会设置错误和调用done
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">expected_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">expected_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">);</span>
        <span class="n">entries</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
        <span class="n">entries</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ENTRY_TYPE_DATA</span><span class="p">;</span>
        <span class="c1">// 加入投票箱
</span><span class="c1"></span>        <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span>
                                         <span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">,</span>
                                         <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// LeaderStableClosure在回调时会投票
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span>
                               <span class="k">new</span> <span class="n">LeaderStableClosure</span><span class="p">(</span>
                                        <span class="n">NodeId</span><span class="p">(</span><span class="n">_group_id</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">),</span>
                                        <span class="n">entries</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
                                        <span class="n">_ballot_box</span><span class="p">));</span>
    <span class="c1">// update _conf.first
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="log持久化">log持久化</h3>
<p>无论是leader还是follower都是调用LogManager来持久化日志，对于leader来说，持久化完成后进行投票；对于follower来说，持久化完成后回包。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_entries</span><span class="p">(</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="c1">// 检查是否存在冲突
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">check_and_resolve_conflict</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="c1">// release entries
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">entries</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Add ref for disk_thread
</span><span class="c1"></span>        <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ConfigurationEntry</span> <span class="nf">conf_entry</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]));</span>
            <span class="c1">// 对于修改peer的类型的日志，加入config manager，影响后续的投票。
</span><span class="c1"></span>            <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">conf_entry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">_first_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
        <span class="c1">// 插入内存
</span><span class="c1"></span>        <span class="n">_logs_in_memory</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_logs_in_memory</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">done</span><span class="o">-&gt;</span><span class="n">_entries</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">);</span>
    <span class="c1">// 刷盘
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_disk_queue</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;execq execute failed, ret: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; err: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">berror</span><span class="p">();</span>
    <span class="n">wakeup_all_waiter</span><span class="p">(</span><span class="n">lck</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">check_and_resolve_conflict</span><span class="p">(</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AsyncClosureGuard</span> <span class="nf">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 某些情况下leader会设置index
</span><span class="c1"></span>        <span class="c1">// Node is currently the leader and |entries| are from the user who
</span><span class="c1"></span>        <span class="c1">// don&#39;t know the correct indexes the logs should assign to. So we have
</span><span class="c1"></span>        <span class="c1">// to assign indexes to the appending entries
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">_last_log_index</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// follower逻辑
</span><span class="c1"></span>
        <span class="c1">// Node is currently a follower and |entries| are from the leader. We 
</span><span class="c1"></span>        <span class="c1">// should check and resolve the confliction between the local logs and
</span><span class="c1"></span>        <span class="c1">// |entries|
</span><span class="c1"></span>        <span class="c1">// 日志不连续性，报错
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">_last_log_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;There&#39;s gap between first_index=%&#34;</span> <span class="n">PRId64</span>
                                     <span class="s">&#34; and last_log_index=%&#34;</span> <span class="n">PRId64</span><span class="p">,</span>
                                     <span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">_last_log_index</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">applied_index</span> <span class="o">=</span> <span class="n">_applied_id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
        <span class="c1">// 如果最后一条日志已经apply过，直接返回
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">applied_index</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">_last_log_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 第一条日志正好对上，只需要更新_last_log_index
</span><span class="c1"></span>            <span class="c1">// Fast path
</span><span class="c1"></span>            <span class="n">_last_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Appending entries overlap the local ones. We should find if there
</span><span class="c1"></span>            <span class="c1">// is a conflicting index from which we should truncate the local
</span><span class="c1"></span>            <span class="c1">// ones.
</span><span class="c1"></span>            <span class="c1">// 找到第一个冲突的日志index
</span><span class="c1"></span>            <span class="n">size_t</span> <span class="n">conflicting_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(;</span> <span class="n">conflicting_index</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">conflicting_index</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">unsafe_get_term</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 如果存在冲突
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">conflicting_index</span> <span class="o">!=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">_last_log_index</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Truncate all the conflicting entries to make local logs
</span><span class="c1"></span>                    <span class="c1">// consensus with the leader.
</span><span class="c1"></span>                    <span class="c1">// truncate日志
</span><span class="c1"></span>                    <span class="n">unsafe_truncate_suffix</span><span class="p">(</span>
                            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">_last_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
            <span class="p">}</span>  <span class="c1">// else this is a duplicated AppendEntriesRequest, we have 
</span><span class="c1"></span>               <span class="c1">// nothing to do besides releasing all the entries
</span><span class="c1"></span>            
            <span class="c1">// Release all the entries before the conflicting_index and the rest
</span><span class="c1"></span>            <span class="c1">// would be append to _logs_in_memory and _log_storage after this
</span><span class="c1"></span>            <span class="c1">// function returns
</span><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conflicting_index</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="c1">// 不冲突的日志直接移除，已经持久化过了。
</span><span class="c1"></span>            <span class="n">entries</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> 
                           <span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">conflicting_index</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t reach here&#34;</span><span class="p">;</span>
    <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Impossible&#34;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>日志刷盘</p>
<p>在LogManager的构造函数中创建了一个执行队列。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">start_disk_thread</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">bthread</span><span class="o">::</span><span class="n">ExecutionQueueOptions</span> <span class="n">queue_options</span><span class="p">;</span>
    <span class="n">queue_options</span><span class="p">.</span><span class="n">bthread_attr</span> <span class="o">=</span> <span class="n">BTHREAD_ATTR_NORMAL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_disk_queue</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">queue_options</span><span class="p">,</span>
                                   <span class="n">disk_thread</span><span class="p">,</span>
                                   <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>disk_thread是负责刷盘的函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">disk_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">meta</span><span class="p">,</span>
                            <span class="n">bthread</span><span class="o">::</span><span class="n">TaskIterator</span><span class="o">&lt;</span><span class="n">StableClosure</span><span class="o">*&gt;&amp;</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">is_queue_stopped</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">LogManager</span><span class="o">*</span> <span class="n">log_manager</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">LogManager</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
    <span class="c1">// FIXME(chenzhangyi01): it&#39;s buggy
</span><span class="c1"></span>    <span class="n">LogId</span> <span class="n">last_id</span> <span class="o">=</span> <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">_disk_id</span><span class="p">;</span>
    <span class="n">StableClosure</span><span class="o">*</span> <span class="n">storage</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="n">AppendBatcher</span> <span class="nf">ab</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">storage</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">last_id</span><span class="p">,</span> <span class="n">log_manager</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// ^^^ Must iterate to the end to release to corresponding
</span><span class="c1"></span>                <span class="c1">//     even if some error has occurred
</span><span class="c1"></span>        <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">_entries</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// 组batch
</span><span class="c1"></span>            <span class="n">ab</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// 刷盘
</span><span class="c1"></span>            <span class="n">ab</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
            <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// 日志项为空的任务，是一些管理类的任务。如LastLogIdClosure, TruncatePrefixClosure, TruncateSuffixClosure, ResetClosure
</span><span class="c1"></span>            <span class="k">do</span> <span class="p">{</span>
                <span class="n">TruncatePrefixClosure</span><span class="o">*</span> <span class="n">tpc</span> <span class="o">=</span> 
                        <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">TruncatePrefixClosure</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">_log_storage</span><span class="o">-&gt;</span><span class="n">truncate_prefix</span><span class="p">(</span>
                                    <span class="n">tpc</span><span class="o">-&gt;</span><span class="n">first_index_kept</span><span class="p">());</span>
                    <span class="c1">// 命中一种即退出循环
</span><span class="c1"></span>                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">report_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;Failed operation on LogStorage&#34;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Must iterate to the end&#34;</span><span class="p">;</span>
    <span class="n">ab</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">set_disk_id</span><span class="p">(</span><span class="n">last_id</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面AppendBatcher::append会将日志加入队列，AppendBatcher::flush会调用LogManager::append_to_storage来写盘。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_to_storage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;*</span> <span class="n">to_append</span><span class="p">,</span> 
                                   <span class="n">LogId</span><span class="o">*</span> <span class="n">last_id</span><span class="p">,</span> <span class="n">IOMetric</span><span class="o">*</span> <span class="n">metric</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_has_error</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// 调用底层存储实现，默认为SegmentLogStorage
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">nappent</span> <span class="o">=</span> <span class="n">_log_storage</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">*</span><span class="n">to_append</span><span class="p">,</span> <span class="n">metric</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nappent</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">to_append</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">report_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to append entries&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">to_append</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">*</span><span class="n">to_append</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">to_append</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="同步follower">同步follower</h3>
<p>_send_entries 负责同步task到follower。在apply_task时会将任务写到log_manager里面，而在_send_entries实现中，会调用_prepare_entry来从log_manager获取entry。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_entries</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl</span><span class="p">(</span><span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesRequest</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">response</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesResponse</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_reset_next_index</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">EntryMeta</span> <span class="n">em</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">max_entries_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_max_entries_size</span> <span class="o">-</span> <span class="n">_flying_append_entries_size</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">prepare_entry_rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">max_entries_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_entries_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 从log_manager来准备entry
</span><span class="c1"></span>        <span class="n">prepare_entry_rc</span> <span class="o">=</span> <span class="n">_prepare_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">request_attachment</span><span class="p">());</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prepare_entry_rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">request</span><span class="o">-&gt;</span><span class="n">add_entries</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// _id is unlock in _wait_more
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_next_index</span> <span class="o">&lt;</span> <span class="n">_options</span><span class="p">.</span><span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">first_log_index</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">_reset_next_index</span><span class="p">();</span>
            <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nf">_wait_more_entries</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FlyingAppendEntriesRpc</span><span class="p">(</span><span class="n">_next_index</span><span class="p">,</span>
                                     <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">(),</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">()));</span>
    <span class="n">_append_entries_counter</span><span class="o">++</span><span class="p">;</span>
    <span class="n">_next_index</span> <span class="o">+=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
    <span class="n">_flying_append_entries_size</span> <span class="o">+=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
    
    <span class="n">g_send_entries_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>

    <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">APPENDING_ENTRIES</span><span class="p">;</span>
    <span class="n">_st</span><span class="p">.</span><span class="n">first_log_index</span> <span class="o">=</span> <span class="n">_min_flying_index</span><span class="p">();</span>
    <span class="n">_st</span><span class="p">.</span><span class="n">last_log_index</span> <span class="o">=</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="p">(</span>
                <span class="n">_on_rpc_returned</span><span class="p">,</span> <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cntl</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> 
                <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>
    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
    <span class="n">stub</span><span class="p">.</span><span class="n">append_entries</span><span class="p">(</span><span class="n">cntl</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> 
                        <span class="n">response</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">done</span><span class="p">);</span>
    <span class="n">_wait_more_entries</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>send_entries结果处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_rpc_returned</span><span class="p">(</span><span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
                     <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
                     <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
                     <span class="kt">int64_t</span> <span class="n">rpc_send_time</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl_guard</span><span class="p">(</span><span class="n">cntl</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span>  <span class="n">req_guard</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">res_guard</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
    <span class="k">const</span> <span class="kt">long</span> <span class="n">start_time_us</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">();</span>

    <span class="kt">bool</span> <span class="n">valid_rpc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">rpc_first_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">min_flying_index</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">();</span>
    <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">min_flying_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// 省略校验call_id是否匹配的逻辑
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">Failed</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fail, sleep.&#34;</span><span class="p">;</span>
        <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>

        <span class="c1">// If the follower crashes, any RPC to the follower fails immediately,
</span><span class="c1"></span>        <span class="c1">// so we need to block the follower for a while instead of looping until
</span><span class="c1"></span>        <span class="c1">// it comes back or be removed
</span><span class="c1"></span>        <span class="c1">// dummy_id is unlock in block
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
        <span class="c1">// 失败了block一段时间，有可能follower crash
</span><span class="c1"></span>        <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_block</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">,</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">ErrorCode</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_consecutive_error_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 如果响应中的term更大则退位
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">NodeImpl</span> <span class="o">*</span><span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Leader receives higher term &#34;</span>
                    <span class="s">&#34;%s from peer:%s&#34;</span><span class="p">,</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">GetTypeName</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
            <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">increase_term_to</span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">status</span><span class="p">);</span>
            <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// prev_log_index and prev_log_term doesn&#39;t match
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
        <span class="c1">// log index 不匹配则直接设置next_index
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// The peer contains less logs than leader
</span><span class="c1"></span>            <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
            <span class="c1">// 否则依次减1直到匹配(XXX 看下面的实现不是term不匹配导致的，那什么情况会走到这个逻辑？）
</span><span class="c1"></span>            <span class="c1">// The peer contains logs from old term which should be truncated,
</span><span class="c1"></span>            <span class="c1">// decrease _last_log_at_peer by one to test the right index to keep
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">BAIDU_LIKELY</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
                <span class="o">--</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span> 
                           <span class="o">&lt;&lt;</span> <span class="s">&#34; peer=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span>
                           <span class="o">&lt;&lt;</span> <span class="s">&#34; declares that log at index=0 doesn&#39;t match,&#34;</span>
                              <span class="s">&#34; which is not supposed to happen&#34;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// dummy_id is unlock in _send_heartbeat
</span><span class="c1"></span>        <span class="c1">// 用于更新log index信息
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; success&#34;</span><span class="p">;</span>
    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">rpc_send_time</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">entries_size</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">rpc_last_log_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="n">entries_size</span><span class="p">;</span>
    <span class="n">BRAFT_VLOG_IF</span><span class="p">(</span><span class="n">entries_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span>
                                    <span class="o">&lt;&lt;</span> <span class="s">&#34; replicated logs in [&#34;</span> 
                                    <span class="o">&lt;&lt;</span> <span class="n">min_flying_index</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, &#34;</span> 
                                    <span class="o">&lt;&lt;</span> <span class="n">rpc_last_log_index</span>
                                    <span class="o">&lt;&lt;</span> <span class="s">&#34;] to peer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">entries_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 检查是否通过投票
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">ballot_box</span><span class="o">-&gt;</span><span class="n">commit_at</span><span class="p">(</span>
                <span class="n">min_flying_index</span><span class="p">,</span> <span class="n">rpc_last_log_index</span><span class="p">,</span>
                <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// A rpc is marked as success, means all request before it are success,
</span><span class="c1"></span>    <span class="c1">// erase them sequentially.
</span><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
           <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">log_index</span> <span class="o">&lt;=</span> <span class="n">rpc_first_index</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_flying_append_entries_size</span> <span class="o">-=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">entries_size</span><span class="p">;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="c1">// dummy_id is unlock in _send_entries
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_timeout_now</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 再次调用send
</span><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_entries</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="apply_log">apply_log</h3>
<p>在log被持久化到多数节点上时，BallotBox::commit_at会调用下列函数向队列添加COMMITED任务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">on_committed</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ApplyTask</span> <span class="n">t</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMMITTED</span><span class="p">;</span>
    <span class="n">t</span><span class="p">.</span><span class="n">committed_index</span> <span class="o">=</span> <span class="n">committed_index</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_queue_id</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>队列执行函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">meta</span><span class="p">,</span> <span class="n">bthread</span><span class="o">::</span><span class="n">TaskIterator</span><span class="o">&lt;</span><span class="n">ApplyTask</span><span class="o">&gt;&amp;</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">FSMCaller</span><span class="o">*</span> <span class="n">caller</span> <span class="o">=</span> <span class="p">(</span><span class="n">FSMCaller</span><span class="o">*</span><span class="p">)</span><span class="n">meta</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">is_queue_stopped</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">caller</span><span class="o">-&gt;</span><span class="n">do_shutdown</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int64_t</span> <span class="n">max_committed_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">size_t</span>  <span class="n">batch_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_fsm_caller_commit_batch</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMMITTED</span> <span class="o">&amp;&amp;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span> <span class="o">&gt;</span> <span class="n">max_committed_index</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">max_committed_index</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">;</span>
                <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">max_committed_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">caller</span><span class="o">-&gt;</span><span class="n">_cur_task</span> <span class="o">=</span> <span class="n">COMMITTED</span><span class="p">;</span>
                <span class="c1">// 出现连续的COMMITED任务超过commit_batch，或者出现了别的类型的任务时调用do_committed
</span><span class="c1"></span>                <span class="n">caller</span><span class="o">-&gt;</span><span class="n">do_committed</span><span class="p">(</span><span class="n">max_committed_index</span><span class="p">);</span>
                <span class="n">max_committed_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">g_commit_tasks_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span><span class="p">;</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_fsm_caller_commit_batch</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">COMMITTED</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span> <span class="o">&gt;</span> <span class="n">max_committed_index</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">max_committed_index</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">;</span>
                    <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">SNAPSHOT_SAVE</span><span class="p">:</span>
                <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>do_commited实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">do_committed</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_error</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int64_t</span> <span class="n">last_applied_index</span> <span class="o">=</span> <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">load</span><span class="p">(</span>
                                        <span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>

    <span class="c1">// We can tolerate the disorder of committed_index
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">last_applied_index</span> <span class="o">&gt;=</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Closure</span><span class="o">*&gt;</span> <span class="n">closure</span><span class="p">;</span>
    <span class="kt">int64_t</span> <span class="n">first_closure_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_closure_queue</span><span class="o">-&gt;</span><span class="n">pop_closure_until</span><span class="p">(</span><span class="n">committed_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">closure</span><span class="p">,</span>
                                                  <span class="o">&amp;</span><span class="n">first_closure_index</span><span class="p">));</span>

    <span class="n">IteratorImpl</span> <span class="nf">iter_impl</span><span class="p">(</span><span class="n">_fsm</span><span class="p">,</span> <span class="n">_log_manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">closure</span><span class="p">,</span> <span class="n">first_closure_index</span><span class="p">,</span>
                 <span class="n">last_applied_index</span><span class="p">,</span> <span class="n">committed_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_applying_index</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter_impl</span><span class="p">.</span><span class="n">is_good</span><span class="p">();)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ENTRY_TYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 配置变更
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">old_peers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// Joint stage is not supposed to be noticeable by end users.
</span><span class="c1"></span>                    <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_configuration_committed</span><span class="p">(</span>
                            <span class="n">Configuration</span><span class="p">(</span><span class="o">*</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">),</span>
                            <span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 其他任务执行回调
</span><span class="c1"></span>            <span class="c1">// For other entries, we have nothing to do besides flush the
</span><span class="c1"></span>            <span class="c1">// pending tasks and run this closure to notify the caller that the
</span><span class="c1"></span>            <span class="c1">// entries before this one were successfully committed and applied.
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">done</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">iter_impl</span><span class="p">.</span><span class="n">done</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">iter_impl</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Iterator</span> <span class="nf">iter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_impl</span><span class="p">);</span>
        <span class="c1">// 执行用户逻辑来apply
</span><span class="c1"></span>        <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_apply</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
        <span class="c1">// Try move to next in case that we pass the same log twice.
</span><span class="c1"></span>        <span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">has_error</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">set_error</span><span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">error</span><span class="p">());</span>
        <span class="n">iter_impl</span><span class="p">.</span><span class="n">run_the_rest_closure_with_error</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">last_index</span> <span class="o">=</span> <span class="n">iter_impl</span><span class="p">.</span><span class="n">index</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">last_term</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_term</span><span class="p">(</span><span class="n">last_index</span><span class="p">);</span>
    <span class="n">LogId</span> <span class="nf">last_applied_id</span><span class="p">(</span><span class="n">last_index</span><span class="p">,</span> <span class="n">last_term</span><span class="p">);</span>
    <span class="c1">// 记录applied index
</span><span class="c1"></span>    <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">committed_index</span><span class="p">,</span> <span class="n">butil</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
    <span class="n">_last_applied_term</span> <span class="o">=</span> <span class="n">last_term</span><span class="p">;</span>
    <span class="c1">// 注意：applied index并没有持久化保存，只在内存中保存。
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">set_applied_id</span><span class="p">(</span><span class="n">last_applied_id</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="节点更新">节点更新</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">unsafe_register_conf_change</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">old_conf</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
                                           <span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 非leader报错
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_TRANSFERRING</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EBUSY</span><span class="p">,</span> <span class="s">&#34;Is transferring leadership&#34;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="s">&#34;Not leader&#34;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// check concurrent conf change
</span><span class="c1"></span>    <span class="c1">// 如果在更新conf，则报错
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EBUSY</span><span class="p">,</span> <span class="s">&#34;Doing another configuration change&#34;</span><span class="p">);</span>
            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Return immediately when the new peers equals to current configuration
</span><span class="c1"></span>    <span class="c1">// conf不变直接返回
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">new_conf</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">old_conf</span><span class="p">,</span> <span class="n">new_conf</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="追赶阶段"><strong>追赶阶段</strong></h3>
<p>如果新的节点配置相对于当前有新增的一个或者多个节点，leader对应的Replicator, 向把最新的snapshot再这个这些中安装，然后开始同步之后的日志。等到所有的新节点数据都追的差不多，就开始进入一下一阶段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">old_conf</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
                                       <span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="c1">// 设置状态为追赶阶段
</span><span class="c1"></span>    <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_CATCHING_UP</span><span class="p">;</span>
   <span class="c1">// diff得到节点变化
</span><span class="c1"></span>    <span class="n">new_conf</span><span class="p">.</span><span class="n">diffs</span><span class="p">(</span><span class="n">old_conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">removing</span><span class="p">);</span>
    <span class="c1">// 没有新增节点进入下一阶段
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">adding</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">next_stage</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">adding</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_adding_peers</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">iter</span>
            <span class="o">=</span> <span class="n">_adding_peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">_adding_peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 创建replicator
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_replicator_group</span><span class="p">.</span><span class="n">add_replicator</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">OnCaughtUp</span><span class="o">*</span> <span class="n">caught_up</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnCaughtUp</span><span class="p">(</span>
                <span class="n">_node</span><span class="p">,</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_current_term</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_version</span><span class="p">);</span>
        <span class="n">timespec</span> <span class="n">due_time</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">milliseconds_from_now</span><span class="p">(</span>
                <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">get_catchup_timeout_ms</span><span class="p">());</span>
        <span class="c1">// 对新增节点，等待新节点数据追的差不多，默认margin为1000
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_replicator_group</span><span class="p">.</span><span class="n">wait_caughtup</span><span class="p">(</span>
            <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">catchup_margin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">due_time</span><span class="p">,</span> <span class="n">caught_up</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="n">caught_up</span><span class="p">;</span>
            <span class="k">return</span> <span class="nf">on_caughtup</span><span class="p">(</span><span class="n">_version</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">ReplicatorGroup</span><span class="o">::</span><span class="n">wait_caughtup</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> 
                                   <span class="kt">int64_t</span> <span class="n">max_margin</span><span class="p">,</span> <span class="k">const</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">due_time</span><span class="p">,</span>
                                   <span class="n">CatchupClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="p">,</span> <span class="n">ReplicatorIdAndStatus</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">_rmap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
    <span class="n">ReplicatorId</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
    <span class="c1">// 找replicator
</span><span class="c1"></span>    <span class="n">Replicator</span><span class="o">::</span><span class="n">wait_for_caught_up</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">max_margin</span><span class="p">,</span> <span class="n">due_time</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">wait_for_caught_up</span><span class="p">(</span><span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> 
                                    <span class="kt">int64_t</span> <span class="n">max_margin</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">due_time</span><span class="p">,</span>
                                    <span class="n">CatchupClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">done</span><span class="o">-&gt;</span><span class="n">_max_margin</span> <span class="o">=</span> <span class="n">max_margin</span><span class="p">;</span>
    <span class="c1">// 已经追上
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_is_catchup</span><span class="p">(</span><span class="n">max_margin</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">due_time</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">_has_timer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="c1">// 创建定时器
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bthread_timer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">_timer</span><span class="p">,</span>
                              <span class="o">*</span><span class="n">due_time</span><span class="p">,</span>
                              <span class="n">_on_catch_up_timedout</span><span class="p">,</span>
                              <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;Duplicated call&#34;</span><span class="p">);</span>
            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_catchup_closure</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="c1">// success
</span><span class="c1"></span>    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> 
            <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>caughtup回调</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">on_caughtup</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
                           <span class="kt">int64_t</span> <span class="n">version</span><span class="p">,</span> <span class="k">const</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">&amp;</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">BAIDU_SCOPED_LOCK</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="c1">// CHECK _state and _current_term to avoid ABA problem
</span><span class="c1"></span>    <span class="c1">// leader退位处理
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span> <span class="o">||</span> <span class="n">term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// if leader stepped down, reset() has already been called in step_down(),
</span><span class="c1"></span>        <span class="c1">// so nothing needs to be done here
</span><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 成功追上
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>  <span class="c1">// Caught up successfully
</span><span class="c1"></span>        <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">on_caughtup</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Retry if this peer is still alive
</span><span class="c1"></span>    <span class="c1">// 如果超时再次重试
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">error_code</span><span class="p">()</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span> 
            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">()</span>
                <span class="o">-</span> <span class="n">_replicator_group</span><span class="p">.</span><span class="n">last_rpc_send_timestamp</span><span class="p">(</span><span class="n">peer</span><span class="p">))</span>
                    <span class="o">&lt;=</span> <span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">OnCaughtUp</span><span class="o">*</span> <span class="n">caught_up</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnCaughtUp</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">_replicator_group</span><span class="p">.</span><span class="n">wait_caughtup</span><span class="p">(</span>
                    <span class="n">peer</span><span class="p">,</span> <span class="n">_options</span><span class="p">.</span><span class="n">catchup_margin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">due_time</span><span class="p">,</span> <span class="n">caught_up</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
                <span class="o">&lt;&lt;</span> <span class="s">&#34; wait_caughtup failed, peer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">peer</span><span class="p">;</span>
            <span class="k">delete</span> <span class="n">caught_up</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 发起重试失败，则彻底失败
</span><span class="c1"></span>    <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">on_caughtup</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">on_caughtup</span><span class="p">(</span>
        <span class="kt">int64_t</span> <span class="n">version</span><span class="p">,</span> <span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 检查必须为追赶阶段
</span><span class="c1"></span>    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">STAGE_CATCHING_UP</span><span class="p">,</span> <span class="n">_stage</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_adding_peers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
        <span class="c1">// add的节点为空则进入下一阶段
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_adding_peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next_stage</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Fail
</span><span class="c1"></span>    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">err</span><span class="p">(</span><span class="n">ECATCHUP</span><span class="p">,</span> <span class="s">&#34;Peer %s failed to catch up&#34;</span><span class="p">,</span>
                      <span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
    <span class="c1">// 失败重置
</span><span class="c1"></span>    <span class="n">reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="联合选举阶段"><strong>联合选举阶段</strong></h3>
<p>leader会将旧节点配置和新节点配置写入Log, 在这个阶段之后直到下一个阶段之前，所有的选举和日志同步都需要在<strong>新老节点之间达到多数。</strong></p>
<p>变更节点大于1时，进入联合选举阶段；如果这次只变更了一个节点, 则直接进入下一阶段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">next_stage</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">is_busy</span><span class="p">());</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">_stage</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">STAGE_CATCHING_UP</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_nchanges</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_JOINT</span><span class="p">;</span>
            <span class="n">Configuration</span> <span class="nf">old_conf</span><span class="p">(</span><span class="n">_old_peers</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">old_conf</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// Skip joint consensus since only one peer has been changed here. Make
</span><span class="c1"></span>        <span class="c1">// it a one-stage change to be compitible with the legacy
</span><span class="c1"></span>        <span class="c1">// implementation.
</span><span class="c1"></span>    <span class="k">case</span> <span class="nl">STAGE_JOINT</span><span class="p">:</span>
        <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_STABLE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它会生成一个类型为ENTRY_TYPE_CONFIGURATION的logEntry，将entry的peers设置为新配置，old_peers设置为旧配置。然后把这个任务添加到投票箱里面，并调用LogManager::append_entries把entry append到内存并持久化。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
                                          <span class="k">const</span> <span class="n">Configuration</span><span class="o">*</span> <span class="n">old_conf</span><span class="p">,</span>
                                          <span class="kt">bool</span> <span class="n">leader_start</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">());</span>
    <span class="n">LogEntry</span><span class="o">*</span> <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry</span><span class="p">();</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
    <span class="c1">// 产生一个配置变更的日志项
</span><span class="c1"></span>    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">new_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">entry</span><span class="o">-&gt;</span><span class="n">old_peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">list_peers</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">old_peers</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ConfigurationChangeDone</span><span class="o">*</span> <span class="n">configuration_change_done</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">ConfigurationChangeDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">leader_start</span><span class="p">,</span> <span class="n">_leader_lease</span><span class="p">.</span><span class="n">lease_epoch</span><span class="p">());</span>
    <span class="c1">// Use the new_conf to deal the quorum of this very log
</span><span class="c1"></span>    <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">new_conf</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span> <span class="n">configuration_change_done</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
    <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
    <span class="c1">// append 日志项
</span><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span>
                                 <span class="k">new</span> <span class="n">LeaderStableClosure</span><span class="p">(</span>
                                        <span class="n">NodeId</span><span class="p">(</span><span class="n">_group_id</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">),</span>
                                        <span class="mi">1u</span><span class="p">,</span> <span class="n">_ballot_box</span><span class="p">));</span>
    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果entry type是ENTRY_TYPE_CONFIGURATION的话就把这个配置append到_config_manager里面。之后会调用LogManager::check_and_set_configuration把_conf设置为刚刚放进去的新配置（其中old_conf为之前的配置）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_entries</span><span class="p">(</span>
            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Add ref for disk_thread
</span><span class="c1"></span>        <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ConfigurationEntry</span> <span class="nf">conf_entry</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]));</span>
            <span class="c1">// 对于修改peer的类型的日志，加入config manager，影响后续的投票。
</span><span class="c1"></span>            <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">conf_entry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在这个时间点之后，产生的任务，在放到投票箱的时候_conf.stable会返回false，然后将第二个参数设置为_conf.old_conf。因此这个时间点之后产生的任务需要新旧两个配置共同决定是否提交，也就是JOINT状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span>
                                         <span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">,</span>
                                         <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>在投票阶段，新旧配置同时达到多数才通过。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">Ballot</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">conf</span><span class="p">,</span> <span class="k">const</span> <span class="n">Configuration</span><span class="o">*</span> <span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_peers</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_peers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 设置
</span><span class="c1"></span>    <span class="n">_quorum</span> <span class="o">=</span> <span class="n">_peers</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">_old_peers</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_old_peers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 设置
</span><span class="c1"></span>    <span class="n">_old_quorum</span> <span class="o">=</span> <span class="n">_old_peers</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Ballot</span><span class="o">::</span><span class="n">PosHint</span> <span class="n">Ballot</span><span class="o">::</span><span class="n">grant</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> <span class="n">PosHint</span> <span class="n">hint</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">UnfoundPeerId</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter</span><span class="p">;</span>
    <span class="n">iter</span> <span class="o">=</span> <span class="n">find_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">_peers</span><span class="p">,</span> <span class="n">hint</span><span class="p">.</span><span class="n">pos0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">_peers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">iter</span><span class="o">-&gt;</span><span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="c1">// 新配置计数
</span><span class="c1"></span>            <span class="o">--</span><span class="n">_quorum</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">hint</span><span class="p">.</span><span class="n">pos0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">_old_peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">hint</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">iter</span> <span class="o">=</span> <span class="n">find_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">_old_peers</span><span class="p">,</span> <span class="n">hint</span><span class="p">.</span><span class="n">pos1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">_old_peers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">iter</span><span class="o">-&gt;</span><span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="c1">// 旧配置计数
</span><span class="c1"></span>            <span class="o">--</span><span class="n">_old_quorum</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">hint</span><span class="p">.</span><span class="n">pos1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">hint</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">granted</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_quorum</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_old_quorum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ConfigurationChangeDone回调时，进入下一阶段。</p>
<h3 id="新配置同步阶段"><strong>新配置同步阶段</strong></h3>
<p>当联合选举日志正式被新旧集群接受之后，leader将新节点配置写入log，之后所有的log和选举只需要在新集群中达成一致。 等待日志提交到<strong>新集群</strong>中的多数节点中之后， 正式完成节点变更。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp">    <span class="k">case</span> <span class="nl">STAGE_JOINT</span><span class="p">:</span>
        <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_STABLE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>和联合选举阶段调用相同的实现，只是old_conf为NULL。</p>
<h3 id="清理阶段"><strong>清理阶段</strong></h3>
<p>leader会将多余的Replicator(如果有)关闭，特别如果当leader本身已经从节点配置中被移除，这时候leader会执行stepdown并且唤醒一个合适的节点触发选举。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">case</span> <span class="nl">STAGE_STABLE</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">should_step_down</span> <span class="o">=</span> 
                <span class="n">_new_peers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_server_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">_new_peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">st</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">::</span><span class="n">OK</span><span class="p">();</span>
            <span class="n">reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">should_step_down</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 退位
</span><span class="c1"></span>                <span class="n">_node</span><span class="o">-&gt;</span><span class="n">step_down</span><span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_current_term</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
                        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="p">(</span><span class="n">ELEADERREMOVED</span><span class="p">,</span> <span class="s">&#34;This node was removed&#34;</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="快照">快照</h2>
<h3 id="打快照">打快照</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_snapshot_executor</span><span class="o">-&gt;</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 创建writer，默认为LocalSnapshotWriter，使用临时文件路径来初始化
</span><span class="c1"></span>    <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">();</span>
    <span class="n">_saving_snapshot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">SaveSnapshotDone</span><span class="o">*</span> <span class="n">snapshot_save_done</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SaveSnapshotDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_fsm_caller</span><span class="o">-&gt;</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">snapshot_save_done</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">SaveSnapshotClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ApplyTask</span> <span class="n">task</span><span class="p">;</span>
    <span class="n">task</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNAPSHOT_SAVE</span><span class="p">;</span>
    <span class="n">task</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="c1">// 加入队列等待执行
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_queue_id</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>FSMCaller处理到打快照的任务时，执行下面的函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">do_snapshot_save</span><span class="p">(</span><span class="n">SaveSnapshotClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>

    <span class="kt">int64_t</span> <span class="n">last_applied_index</span> <span class="o">=</span> <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>

    <span class="c1">// 设置meta信息
</span><span class="c1"></span>    <span class="n">SnapshotMeta</span> <span class="n">meta</span><span class="p">;</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">set_last_included_index</span><span class="p">(</span><span class="n">last_applied_index</span><span class="p">);</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">set_last_included_term</span><span class="p">(</span><span class="n">_last_applied_term</span><span class="p">);</span>
    <span class="n">ConfigurationEntry</span> <span class="n">conf_entry</span><span class="p">;</span>
    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_configuration</span><span class="p">(</span><span class="n">last_applied_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_entry</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
            <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span> 
        <span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">add_peers</span><span class="p">()</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">to_string</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">old_conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
            <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">old_conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span> 
        <span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">add_old_peers</span><span class="p">()</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">to_string</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// 将meta保存到writer对象中
</span><span class="c1"></span>    <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">done</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;snapshot_storage create SnapshotWriter failed&#34;</span><span class="p">);</span>
        <span class="n">done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 调用用户的snapshot save实现
</span><span class="c1"></span>    <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在用户的snapshot save实现中，会回调SaveSnapshotClosure::Run，来完成snapshot meta信息的保存。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">SaveSnapshotDone</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 启动bthread来避免阻塞状态机
</span><span class="c1"></span>    <span class="c1">// Avoid blocking FSMCaller
</span><span class="c1"></span>    <span class="c1">// This continuation of snapshot saving is likely running inplace where the
</span><span class="c1"></span>    <span class="c1">// on_snapshot_save is called (in the FSMCaller thread) and blocks all the
</span><span class="c1"></span>    <span class="c1">// following on_apply. As blocking is not necessary and the continuation is
</span><span class="c1"></span>    <span class="c1">// not important, so we start a bthread to do this.
</span><span class="c1"></span>    <span class="n">bthread_t</span> <span class="n">tid</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_start_urgent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">continue_run</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to start bthread&#34;</span><span class="p">;</span>
        <span class="n">continue_run</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="n">SaveSnapshotDone</span><span class="o">::</span><span class="n">continue_run</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SaveSnapshotDone</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">SaveSnapshotDone</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SaveSnapshotDone</span><span class="o">&gt;</span> <span class="n">self_guard</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="c1">// Must call on_snapshot_save_done to clear _saving_snapshot
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_se</span><span class="o">-&gt;</span><span class="n">on_snapshot_save_done</span><span class="p">(</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_meta</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_writer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;node call on_snapshot_save_done failed&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//user done, need set error
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的continue_run调用下面的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">on_snapshot_save_done</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">&amp;</span> <span class="n">st</span><span class="p">,</span> <span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">&amp;</span> <span class="n">meta</span><span class="p">,</span> <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">error_code</span><span class="p">();</span>
    <span class="c1">// InstallSnapshot can break SaveSnapshot, check InstallSnapshot when SaveSnapshot
</span><span class="c1"></span>    <span class="c1">// because upstream Snapshot maybe newer than local Snapshot.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 如果leader发送的snapshot更新，忽略本地的snapshot
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">_last_snapshot_index</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ESTALE</span><span class="p">;</span>
            <span class="n">writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">ESTALE</span><span class="p">,</span> <span class="s">&#34;Installing snapshot is older than local snapshot&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">writer</span><span class="o">-&gt;</span><span class="n">save_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">writer</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;Fail to do snapshot&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 默认调用LocalSnapshotStorage，保存snapshot meta信息到文件，将snapshot目录从临时路径重命名为最终路径
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fail to close writer&#34;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_last_snapshot_index</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">();</span>
        <span class="n">_last_snapshot_term</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_term</span><span class="p">();</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
        <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">set_snapshot</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">);</span>
        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">report_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to save snapshot&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">_saving_snapshot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="n">_running_jobs</span><span class="p">.</span><span class="n">signal</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>set_snapshot更新LogManager的状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">set_snapshot</span><span class="p">(</span><span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">*</span> <span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Configuration</span> <span class="n">conf</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">peers_size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">conf</span><span class="p">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">Configuration</span> <span class="n">old_conf</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">old_peers_size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">old_conf</span><span class="p">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">old_peers</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">ConfigurationEntry</span> <span class="n">entry</span><span class="p">;</span>
    <span class="n">entry</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">LogId</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">(),</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">());</span>
    <span class="n">entry</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
    <span class="n">entry</span><span class="p">.</span><span class="n">old_conf</span> <span class="o">=</span> <span class="n">old_conf</span><span class="p">;</span>
    <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">set_snapshot</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
    <span class="kt">int64_t</span> <span class="n">term</span> <span class="o">=</span> <span class="n">unsafe_get_term</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">());</span>

    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_but_one_snapshot_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
    <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">();</span>
    <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_last_snapshot_id</span> <span class="o">&gt;</span> <span class="n">_applied_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_applied_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// NOTICE: not to update disk_id here as we are not sure if this node really
</span><span class="c1"></span>    <span class="c1">// has these logs on disk storage. Just leave disk_id as it was, which can keep
</span><span class="c1"></span>    <span class="c1">// these logs in memory all the time until they are flushed to disk. By this 
</span><span class="c1"></span>    <span class="c1">// way we can avoid some corner cases which failed to get logs.
</span><span class="c1"></span>
    <span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 如果term等于0，说明last_included_index大于last_index（一般发生在follower处），
</span><span class="c1"></span>        <span class="c1">// 则把缓存和文件里面的log entry从前面截断到last_included_index
</span><span class="c1"></span>        <span class="c1">// last_included_index is larger than last_index
</span><span class="c1"></span>        <span class="c1">// FIXME: what if last_included_index is less than first_index?
</span><span class="c1"></span>        <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
        <span class="n">truncate_prefix</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 如果term等于 meta-&gt;last_included_term，说明log entry里面还存在着这条记录，
</span><span class="c1"></span>        <span class="c1">// 先不着急截断，把它截断到上一个快照处(如果有的话)。
</span><span class="c1"></span>        <span class="c1">// Truncating log to the index of the last snapshot.
</span><span class="c1"></span>        <span class="c1">// We don&#39;t truncate log before the latest snapshot immediately since
</span><span class="c1"></span>        <span class="c1">// some log around last_snapshot_index is probably needed by some
</span><span class="c1"></span>        <span class="c1">// followers
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">last_but_one_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We have last snapshot index
</span><span class="c1"></span>            <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">last_but_one_snapshot_id</span><span class="p">;</span>
            <span class="n">truncate_prefix</span><span class="p">(</span><span class="n">last_but_one_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 其他情况对应index上的term不等于meta-&gt;last_included_term，
</span><span class="c1"></span>        <span class="c1">// 则可能是follower处正在安装快照，这种情况，直接reset，
</span><span class="c1"></span>        <span class="c1">// 让_first_log_index指向last_included_index，
</span><span class="c1"></span>        <span class="c1">// _last_log_index指向last_included_index-1，把entries清空。
</span><span class="c1"></span>        <span class="c1">// TODO: check the result of reset.
</span><span class="c1"></span>        <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
        <span class="n">reset</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Cannot reach here&#34;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="installsnapshot">InstallSnapshot</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_entries</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_reset_next_index</span><span class="p">();</span>
        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在_send_entries实现中，如果要发送的entry在log_manager中不存在（已经合入snapshot并在本地清理了日志），_fill_common_fields返回非0值，此时会调用_install_snapshot来安装快照。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_install_snapshot</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// pre-set replicator state to INSTALLING_SNAPSHOT, so replicator could be
</span><span class="c1"></span>    <span class="c1">// blocked if something is wrong, such as throttled for a period of time 
</span><span class="c1"></span>    <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">INSTALLING_SNAPSHOT</span><span class="p">;</span>

    <span class="c1">// 返回最新的快照reader，默认实现为LocalSnapshotReader
</span><span class="c1"></span>    <span class="n">_reader</span> <span class="o">=</span> <span class="n">_options</span><span class="p">.</span><span class="n">snapshot_storage</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_reader</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to open snapshot&#34;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="c1">// 生成copy的uri，格式为 remote://host:port/reader_id_number
</span><span class="c1"></span>    <span class="c1">// 通过reader id可以区分不同的读者
</span><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">_reader</span><span class="o">-&gt;</span><span class="n">generate_uri_for_copy</span><span class="p">();</span>
    <span class="n">SnapshotMeta</span> <span class="n">meta</span><span class="p">;</span>
    <span class="c1">// report error on failure
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_reader</span><span class="o">-&gt;</span><span class="n">load_meta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">e</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to load meta from &#34;</span> <span class="o">+</span> <span class="n">snapshot_path</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">;</span>
    <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_max_retry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstallSnapshotRequest</span><span class="p">();</span>
    <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstallSnapshotResponse</span><span class="p">();</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">);</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_group_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span><span class="p">);</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_server_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">server_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_peer_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
    <span class="c1">// 设置meta和uri
</span><span class="c1"></span>    <span class="n">request</span><span class="o">-&gt;</span><span class="n">mutable_meta</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>

    <span class="n">_install_snapshot_in_fly</span> <span class="o">=</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">();</span>
    <span class="n">_install_snapshot_counter</span><span class="o">++</span><span class="p">;</span>
    <span class="n">_st</span><span class="p">.</span><span class="n">last_log_included</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">();</span>
    <span class="n">_st</span><span class="p">.</span><span class="n">last_term_included</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_term</span><span class="p">();</span>
    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="o">&lt;</span>
                <span class="n">ReplicatorId</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span><span class="p">,</span>
                <span class="n">InstallSnapshotRequest</span><span class="o">*</span><span class="p">,</span> <span class="n">InstallSnapshotResponse</span><span class="o">*&gt;</span><span class="p">(</span>
                    <span class="n">_on_install_snapshot_returned</span><span class="p">,</span> <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
    <span class="n">stub</span><span class="p">.</span><span class="n">install_snapshot</span><span class="p">(</span><span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_id</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>follower的处理逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_install_snapshot_request</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                                    <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
                                    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// check stale term
</span><span class="c1"></span>    <span class="c1">// 让过期的leader退位
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">check_step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">server_id</span><span class="p">);</span>

    <span class="c1">// 如果接收到了另一个peer的install snapshot请求，term加1，让两个leader都退位
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server_id</span> <span class="o">!=</span> <span class="n">_leader_id</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Increase the term by 1 and make both leaders step down to minimize the
</span><span class="c1"></span>        <span class="c1">// loss of split brain
</span><span class="c1"></span>        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ELEADERCONFLICT</span><span class="p">,</span> <span class="s">&#34;More than one leader in the same term.&#34;</span><span class="p">);</span> 
        <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">clear_append_entries_cache</span><span class="p">();</span>
    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">_snapshot_executor</span><span class="o">-&gt;</span><span class="n">install_snapshot</span><span class="p">(</span>
            <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>install_snapshot实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">install_snapshot</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
                                        <span class="k">const</span> <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
                                        <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
                                        <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
    <span class="n">SnapshotMeta</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">();</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DownloadingSnapshot</span><span class="o">&gt;</span> <span class="n">ds</span><span class="p">(</span><span class="k">new</span> <span class="n">DownloadingSnapshot</span><span class="p">);</span>
    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span> <span class="o">=</span> <span class="n">cntl</span><span class="p">;</span>
    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>
    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
    <span class="c1">// 启动bthread来开始copy。
</span><span class="c1"></span>    <span class="c1">// 如果已经存在任务，视index新旧取消原任务或忽略新任务
</span><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">register_downloading_snapshot</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="c1">//    ^^^ DON&#39;T access request, response, done and cntl after this point
</span><span class="c1"></span>    <span class="c1">//        as the retry snapshot will replace this one.
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Release done first as this RPC might be replaced by the retry one
</span><span class="c1"></span>    <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
    <span class="c1">// 等待copy的bthread执行完成
</span><span class="c1"></span>    <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">join</span><span class="p">();</span>
    <span class="c1">// 加载下载的snapshot
</span><span class="c1"></span>    <span class="k">return</span> <span class="nf">load_downloading_snapshot</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">meta</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>LocalSnapshotCopier创建及初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">SnapshotCopier</span><span class="o">*</span> <span class="n">LocalSnapshotStorage</span><span class="o">::</span><span class="n">start_to_copy_from</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LocalSnapshotCopier</span><span class="o">*</span> <span class="n">copier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSnapshotCopier</span><span class="p">();</span>
    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_storage</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_filter_before_copy_remote</span> <span class="o">=</span> <span class="n">_filter_before_copy_remote</span><span class="p">;</span>
    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_fs</span> <span class="o">=</span> <span class="n">_fs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_throttle</span> <span class="o">=</span> <span class="n">_snapshot_throttle</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="c1">// 解析leader的ip:port以及reader_id
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">copier</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to init copier from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">uri</span>
                   <span class="o">&lt;&lt;</span> <span class="s">&#34; path: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_path</span><span class="p">;</span>
        <span class="k">delete</span> <span class="n">copier</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">copier</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>拷贝实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">LocalSnapshotCopier</span><span class="o">::</span><span class="n">copy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// 加载remote meta信息，具体实现为将远程的meta文件读取到内存的IOBuf，然后进行解析
</span><span class="c1"></span>        <span class="n">load_meta_table</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// 根据开关，允许对和本地snapshot中文件名和校验和相同的文件跳过下载
</span><span class="c1"></span>        <span class="n">filter</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">files</span><span class="p">;</span>
        <span class="n">_remote_snapshot</span><span class="p">.</span><span class="n">list_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="p">);</span>
        <span class="c1">// 逐个拷贝文件
</span><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">files</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 通过文件操作RPC，将文件分段拷贝过来。
</span><span class="c1"></span>            <span class="n">copy_file</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">_writer</span> <span class="o">&amp;&amp;</span> <span class="n">_writer</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">error_code</span><span class="p">(),</span> <span class="n">error_cstr</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// set_error for copier only when failed to close writer and copier was 
</span><span class="c1"></span>        <span class="c1">// ok before this moment 
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">_writer</span><span class="p">,</span> <span class="n">_filter_before_copy_remote</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to close writer&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">_writer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">_reader</span> <span class="o">=</span> <span class="n">_storage</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在snapshot下载完成后，调用SnapshotExecutor::load_downloading_snapshot来加载</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">load_downloading_snapshot</span><span class="p">(</span><span class="n">DownloadingSnapshot</span><span class="o">*</span> <span class="n">ds</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">&amp;</span> <span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
    <span class="n">SnapshotReader</span><span class="o">*</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">get_reader</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">(),</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span>
                            <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">error_cstr</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
    <span class="n">_cur_copier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reader</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">EINTERNAL</span><span class="p">,</span> 
                           <span class="s">&#34;Fail to copy snapshot from %s&#34;</span><span class="p">,</span>
                            <span class="n">ds</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// The owner of ds is on_snapshot_load_done
</span><span class="c1"></span>    <span class="n">ds_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
    <span class="n">_loading_snapshot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="c1">//                ^ After this point, this installing cannot be interrupted
</span><span class="c1"></span>    <span class="n">_loading_snapshot_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="p">;</span>
    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="n">InstallSnapshotDone</span><span class="o">*</span> <span class="n">install_snapshot_done</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">InstallSnapshotDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">reader</span><span class="p">);</span>
    <span class="c1">// 调用用户的snapshot load实现
</span><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">_fsm_caller</span><span class="o">-&gt;</span><span class="n">on_snapshot_load</span><span class="p">(</span><span class="n">install_snapshot_done</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">install_snapshot_done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHOSTDOWN</span><span class="p">,</span> <span class="s">&#34;This raft node is down&#34;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">install_snapshot_done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Leader对InstallSnapshot响应的处理逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_install_snapshot_returned</span><span class="p">(</span>
            <span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
            <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
            <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
    <span class="kt">bool</span> <span class="n">succ</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 关闭reader
</span><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">);</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_throttle</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_throttle</span><span class="o">-&gt;</span><span class="n">finish_one_task</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// 如果失败会在后续的_send_entries中再次调用InstallSnapshot
</span><span class="c1"></span>    <span class="c1">// We don&#39;t retry installing the snapshot explicitly. 
</span><span class="c1"></span>    <span class="c1">// dummy_id is unlock in _send_entries
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_block</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">(),</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">ErrorCode</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_timeout_now</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// dummy_id is unlock in _send_entries
</span><span class="c1"></span>    <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_entries</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/baidu/braft/blob/master/docs/cn/server.md">braft/server.md at master · baidu/braft (github.com)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/169840204">braft源码分析（一）选举和心跳保持部分 - 知乎 (zhihu.com)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/169904153">braft源码分析（二）日志复制、配置变更和快照 - 知乎 (zhihu.com)</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">egolearner</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-10-23
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/raft/">raft</a>
          <a href="/tags/braft/">braft</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/diskann/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">论文笔记：DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/polardb-serverless/">
            <span class="next-text nav-default">论文笔记：PolarDB Serverless</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://egolearner.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>egolearner</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>








</body>
</html>
