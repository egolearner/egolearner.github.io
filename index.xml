<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>A lifelong learner.</title>
    <link>https://egolearner.github.io/</link>
    <description>Recent content on A lifelong learner.</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Tue, 10 Sep 2024 19:31:31 +0800</lastBuildDate><atom:link href="https://egolearner.github.io/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Memory Consistency</title>
      <link>https://egolearner.github.io/post/memory-consistency/</link>
      <pubDate>Tue, 10 Sep 2024 19:31:31 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/memory-consistency/</guid>
      <description>&lt;h1 id=&#34;a-primer-on-memory-consistency-and-cache-coherence&#34;&gt;A Primer on Memory Consistency and Cache Coherence&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;ä¹¦ç±ä¿¡æ¯
&lt;ul&gt;
&lt;li&gt;é“¾æ¥
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://book.douban.com/subject/35125808/&#34;&gt;A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ä½œè€…&lt;/li&gt;
&lt;li&gt;é¢˜æ/ä¸»é¢˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ
&lt;ul&gt;
&lt;li&gt;å­¦ä¹ memory order&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;é˜…è¯»å‰é—®é¢˜&lt;/li&gt;
&lt;li&gt;é˜…è¯»ä¸­é—®é¢˜&lt;/li&gt;
&lt;li&gt;é˜…è¯»æ—¶çš„æ€è€ƒ&lt;/li&gt;
&lt;li&gt;ä¸»è¦å†…å®¹&lt;/li&gt;
&lt;li&gt;æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±&lt;/li&gt;
&lt;li&gt;è¯„ä»·
&lt;ul&gt;
&lt;li&gt;ä¼˜ç‚¹&lt;/li&gt;
&lt;li&gt;ç¼ºç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;chap1-introduction-to-consistency-and-coherence&#34;&gt;Chap1 Introduction to Consistency and Coherence&lt;/h2&gt;
&lt;p&gt;Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="a-primer-on-memory-consistency-and-cache-coherence">A Primer on Memory Consistency and Cache Coherence</h1>
<ul>
<li>ä¹¦ç±ä¿¡æ¯
<ul>
<li>é“¾æ¥
<ul>
<li><a href="https://book.douban.com/subject/35125808/">A Primer on Memory Consistency and Cache Coherence (è±†ç“£) (douban.com)</a></li>
</ul>
</li>
<li>ä½œè€…</li>
<li>é¢˜æ/ä¸»é¢˜</li>
</ul>
</li>
<li>æˆ‘ä¸ºä»€ä¹ˆè¯»è¿™æœ¬ä¹¦ï¼Ÿ
<ul>
<li>å­¦ä¹ memory order</li>
</ul>
</li>
<li>é˜…è¯»å‰é—®é¢˜</li>
<li>é˜…è¯»ä¸­é—®é¢˜</li>
<li>é˜…è¯»æ—¶çš„æ€è€ƒ</li>
<li>ä¸»è¦å†…å®¹</li>
<li>æœ¬æ–‡æåˆ°çš„å…¶ä»–ä¹¦ç±</li>
<li>è¯„ä»·
<ul>
<li>ä¼˜ç‚¹</li>
<li>ç¼ºç‚¹</li>
</ul>
</li>
</ul>
<h2 id="chap1-introduction-to-consistency-and-coherence">Chap1 Introduction to Consistency and Coherence</h2>
<p>Consistencyçš„å®šä¹‰æä¾›äº†loadå’Œstoreçš„è§„åˆ™ä»¥åŠå®ƒä»¬å¦‚ä½•ä½œç”¨äºå†…å­˜ã€‚</p>
<p>Coherenceè‡³äºäºè®©å…±äº«å†…å­˜ç³»ç»Ÿçš„Cacheåƒå•æ ¸ç³»ç»Ÿä¸Šçš„Cacheä¸€æ ·é€æ˜ï¼Œä½¿ç”¨å°†ä¸€ä¸ªå¤„ç†å™¨çš„å†™å…¥å¹¿æ’­åˆ°å…¶ä»–å¤„ç†å™¨çš„æ–¹å¼ã€‚Consistencyå±äºå®šä¹‰å…±äº«å†…å­˜æ­£ç¡®æ€§çš„æ¶æ„è§„èŒƒï¼Œè€Œcoherenceæ˜¯æ”¯æ’‘consistencyæ¨¡å‹çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>å¯¹äºç‰¹å®šè¾“å…¥çš„å¤šçº¿ç¨‹ç¨‹åºï¼Œå†…å­˜æ¨¡å‹è§„å®šäº†dynamic loadå¯ä»¥è¿”å›çš„å€¼ï¼Œå¯é€‰çš„è§„å®šäº†å†…å­˜æœ€ç»ˆçš„å¯èƒ½çŠ¶æ€ã€‚é€šå¸¸å…è®¸å¤šçº¿ç¨‹ç¨‹åºæœ‰å¤šä¸ªæ­£ç¡®çš„è¡Œä¸ºã€‚</p>
<ul>
<li>Sequential Consistency(SC)ä¸­ï¼Œå¤šçº¿ç¨‹ç¨‹åºçœ‹èµ·æ¥åƒå…¶ä¸­æ¯ä¸ªçº¿ç¨‹çš„äº¤æ›¿æ‰§è¡Œï¼Œå°±åƒæ‰€æœ‰çº¿ç¨‹åœ¨å•æ ¸æœºå™¨ä¸Šåˆ†æ—¶å¤ç”¨ä¸€æ ·ã€‚</li>
<li>Total Store Order(TSO)ï¼Œåœ¨å°†ç»“æœå†™å…¥Cacheå‰ï¼Œä½¿ç”¨FIFOçš„write bufferæ¥ä¿å­˜committed storeçš„ç»“æœã€‚ç›¸æ¯”SCæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚</li>
<li>Relaxed or Weak Modelï¼ŒåŠ¨æœºåœ¨äºå¤§éƒ¨åˆ†å¼ºæ¨¡å‹ä¸­çš„å†…å­˜é¡ºåºæ˜¯ä¸å¿…è¦çš„ã€‚ä¾‹å¦‚ï¼Œä¿®æ”¹10ä¸ªæ•°æ®é¡¹å’Œ1ä¸ªåŒæ­¥æ ‡è®°ï¼Œ10ä¸ªæ•°æ®é¡¹å…·ä½“çš„å†…å­˜é¡ºåºæ˜¯ä¸é‡è¦çš„ï¼Œåªéœ€è¦ä¿è¯åœ¨åŒæ­¥æ ‡è®°ä¹‹å‰ä¿®æ”¹å³å¯ã€‚</li>
</ul>
<p>åœ¨å¤šæ ¸åŒæ—¶è®¿é—®æ•°æ®çš„å¤šä¸ªå‰¯æœ¬ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªè®¿é—®æ˜¯å†™æ“ä½œæ—¶ä¼šæœ‰coherenceé—®é¢˜ã€‚ä½¿ç”¨coherenceåè®®æ¥é¿å…è®¿é—®åˆ°è¿‡æœŸæ•°æ®ã€‚é€šè¿‡å¹¿æ’­æ“ä½œä½¿å¾—ä¸€ä¸ªå¤„ç†å™¨çš„å†™æ“ä½œå¯¹å…¶ä»–å¤„ç†å™¨çš„Cacheå¯è§ã€‚ç›®å‰åŸºæœ¬æ˜¯åŒæ­¥å¹¿æ’­ï¼Œå¼‚æ­¥å¹¿æ’­æœºåˆ¶æ­£åœ¨å‡ºç°ã€‚</p>
<ul>
<li><input disabled="" type="checkbox"> Database Replication. Synthesis Lectures on Data Management</li>
<li><input disabled="" type="checkbox"> Quorum Systems: With Applications to Storage and Consensus. Synthesis Lectures on Distributed Computing Theory</li>
</ul>
<h2 id="chap2-coherence-åŸºç¡€">Chap2 Coherence åŸºç¡€</h2>
<p>åœ¨å¤šç§è§’è‰²è®¿é—®Cacheå’ŒMemoryæ—¶æœ‰coherenceé—®é¢˜ï¼Œå¦‚å¤„ç†å™¨ã€DMAã€å…¶ä»–è®¾å¤‡ã€‚</p>
<ul>
<li>
<p>Consistency-agnostic coherenceã€‚ä½¿ç”¨åŒæ­¥å†™ï¼Œå†™æ“ä½œåœ¨è¿”å›å‰å¯¹æ‰€æœ‰æ ¸å¯è§ï¼Œæä¾›çš„æ¥å£å’Œï¼ˆä¸å¸¦Cacheçš„ï¼‰atomic memory systemç›¸åŒã€‚</p>
<ul>
<li>single-writer-multiple-reader(SWMR)ä¸å˜å¼ã€‚
<ul>
<li>å¦ä¸€ç§æ–¹å¼ï¼Œä½¿ç”¨tokenå¯¹SWMRä¸å˜å¼æ¥è§£é‡Šã€‚tokenä¸ªæ•°å’Œæ ¸æ•°ç›¸ç­‰ï¼Œæ‹¿åˆ°æ‰€æœ‰tokenæ—¶ï¼Œå¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼›æ‹¿åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªtokenæ—¶ï¼Œå¯ä»¥æ‰§è¡Œè¯»æ“ä½œã€‚</li>
</ul>
</li>
<li>è¿˜è¦æ±‚ç»™å®šå†…å­˜çš„å€¼è¢«æ­£ç¡®çš„å¹¿æ’­ï¼Œå³æ•°æ®å€¼ä¸å˜å¼ï¼šæŸä¸ªepochå¼€å§‹æ—¶çš„å€¼ï¼Œç­‰äºä¸Šä¸€ä¸ªread-write epochç»“æŸæ—¶çš„å€¼ã€‚</li>
</ul>
<blockquote>
<p>Coherence invariants</p>
<ol>
<li>Single-Writer, Multiple-Read (SWMR) Invariant. For any memory location A, at any given time, there exists only a single core that may write to A (and can also read it) or some number of cores that may only read A.</li>
<li>Data-Value Invariant. The value of the memory location at the start of an epoch is the same as the value of the memory location at the end of the its last read-write epoch.</li>
</ol>
</blockquote>
</li>
<li>
<p>Consistency-directed coherenceã€‚å†™æ“ä½œå¼‚æ­¥å¹¿æ’­ï¼Œcoherenceåè®®ä¿è¯å†™æ“ä½œä»¥consistencyæ¨¡å‹å¼ºåˆ¶çš„é¡ºåºæœ€ç»ˆå¯è§ï¼Œç”¨ä»¥æ”¯æŒGP-GPUã€‚</p>
</li>
</ul>
<p>Coherenceçš„å•ä½ä¸ºcache blockï¼ˆä¾‹å¦‚cache lineï¼‰ã€‚</p>
<h2 id="chap3-memory-consistency-motivation-and-sequential-consistency">Chap3 Memory Consistency Motivation and Sequential Consistency</h2>
<p>Reorderçš„ç±»å‹</p>
<ul>
<li>Store-store reorderingã€‚å¦‚æœæ ¸æœ‰éFIFOçš„write bufferå¯èƒ½ä¼šå‡ºç°store-store reorderingï¼Œç¬¬ä¸€ä¸ªstore missè€Œç¬¬äºŒä¸ªstoreå‘½ä¸­cacheï¼Œæˆ–è€…ç¬¬äºŒä¸ªstoreå¯ä»¥å’Œæ›´æ—©çš„storeåˆå¹¶ã€‚</li>
<li>Load-load reorderingã€‚</li>
<li>Load-storeå’Œstore-load reorderingã€‚
<ul>
<li>store-load reorderingå¯èƒ½ç”±äºæœ¬åœ°è·³è¿‡äº†FIFOçš„write bufferã€‚</li>
</ul>
</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Core C1</th>
          <th style="text-align: left">Core C2</th>
          <th style="text-align: left">Comments</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">S1: x = NEW;</td>
          <td style="text-align: left">S2: y = NEW;</td>
          <td style="text-align: left">/* Initially, x = 0 &amp; y = 0 */</td>
      </tr>
      <tr>
          <td style="text-align: left">L1: r1 = y;</td>
          <td style="text-align: left">L2: r2 = x;</td>
          <td style="text-align: left"></td>
      </tr>
  </tbody>
</table>
<p>å¤§å¤šæ•°å®é™…çš„ç¡¬ä»¶ï¼ŒåŒ…æ‹¬x86ï¼Œå…è®¸r1=0, r2=0ä½œä¸ºæœ€ç»ˆçš„ç»“æœï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†FIFOçš„write bufferæ¥æé«˜æ€§èƒ½ã€‚</p>
<p>memory modelæ˜¯å…±äº«å†…å­˜ä½¿ç”¨å…±äº«å†…å­˜æ‰§è¡Œçš„å¤šçº¿ç¨‹ç¨‹åºå…è®¸çš„è¡Œä¸ºçš„è§„èŒƒã€‚</p>
<ul>
<li>Cache coherence does not equal memory consistency.</li>
<li>A memory consistency implementation can use cache coherence as a useful â€œblack box.â€</li>
</ul>
<h3 id="sequential-consistencysc">Sequential Consistency(SC)</h3>
<p>SCæœ€æ—©ç”±Lamportå½¢å¼åŒ–ï¼Œå•æ ¸ä¸Šçš„SCå’ŒProgram Orderç›¸åŒï¼Œå¤šæ ¸ä¸Šçš„SCï¼Œå¦‚æœæ‰€æœ‰æ ¸ä¸Šçš„æ“ä½œä»¥æŸç§é¡ºåºæ‰§è¡Œï¼Œåºåˆ—ä¸­æ¯ä¸ªæ ¸çš„æ“ä½œå’ŒProgram Orderç›¸åŒã€‚SCä¸­ï¼Œmemory orderéµå¾ªæ¯ä¸ªæ ¸ä¸Šçš„Program Orderï¼Œè€Œå…¶ä»–çš„consistency modelå…è®¸ä¸éµå®ˆProgram Orderçš„memory orderã€‚</p>
<p>å®šä¹‰&lt;mä¸ºmemory order, &lt;pä¸ºprogram orderã€‚åœ¨SCä¸­ï¼Œmemory orderéµå®ˆprogram orderï¼Œå³op1 &lt;p op2æ„å‘³ç€op1 &lt;m op2ã€‚</p>
<p>3.5 SCçš„çš„è§„èŒƒåŒ–å®šä¹‰</p>
<p>L(a)å’ŒS(a)ä¸ºå¯¹å†…å­˜åœ°å€açš„loadå’Œstoreæ“ä½œã€‚&lt;pä¸ºæ¯ä¸ªæ ¸ä¸Šçš„total orderï¼Œ&lt;mä¸ºglobal memory orderã€‚</p>
<ol>
<li>æ‰€æœ‰çš„æ ¸å°†å®ƒä»¬çš„loadå’Œstoreæ’å…¥åˆ°&lt;mä¸­ï¼Œéµå®ˆå…¶program orderï¼Œæ— è®ºæ˜¯å¦æ˜¯ç›¸åŒçš„åœ°å€ã€‚å››ç§æƒ…å†µï¼š
<ol>
<li>If L(a) &lt;p L(b) â‡’ L(a) &lt;m L(b) /* Load â†’ Load */</li>
<li>If L(a) &lt;p S(b) â‡’ L(a) &lt;m S(b) /* Load â†’ Store */</li>
<li>If S(a) &lt;p S(b) â‡’ S(a) &lt;m S(b) /* Store â†’ Store */</li>
<li>If S(a) &lt;p L(b) â‡’ S(a) &lt;m L(b) /* Store â†’ Load */</li>
</ol>
</li>
<li>æ¯ä¸€ä¸ªloadå¾—åˆ°çš„å€¼ä¸ºä¾global memory orderåœ¨è¯¥loadä¹‹å‰å†™å…¥çš„å€¼ã€‚</li>
</ol>
<p>å¯¹äºåŸå­çš„read-modify-writeæ“ä½œï¼ˆå¦‚test-and-set)ï¼Œè¦æ±‚loadå’Œstoreæ“ä½œè¿ç»­ï¼Œä¸­é—´ä¸èƒ½æœ‰å…¶ä»–çš„å†…å­˜æ“ä½œï¼ˆæ— è®ºæ˜¯ç›¸åŒè¿˜æ˜¯ä¸åŒçš„åœ°å€ï¼‰ã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled.png">
<p>è¡¨ä¸­å®šä¹‰äº†SCå…è®¸çš„è¡Œä¸ºï¼Œå…¶ä¸­Operation 1åœ¨Operation 2ä¹‹å‰ï¼ŒXæ„å‘³ç€å¿…é¡»éµå®ˆprogram orderã€‚</p>
<p>ä¸€ä¸ªSCå®ç°åªå…è®¸SCæ‰§è¡Œï¼Œè¿™æ˜¯safetyå±æ€§(do no harm)ï¼ŒSCå®ç°è¿˜æœ‰livenesså±æ€§(do some good)ã€‚</p>
<p>3.6 SCçš„naiveå®ç°</p>
<ul>
<li>
<p>ä½¿ç”¨å•æ ¸æ¥æ‰§è¡Œå¤šçº¿ç¨‹ç¨‹åºï¼Œ åœ¨çº¿ç¨‹åˆ‡æ¢ä¹‹å‰æ‰€æœ‰pendingçš„å†…å­˜æ“ä½œå¿…é¡»å®Œæˆã€‚</p>
</li>
<li>
<p>ä½¿ç”¨ä¸€ç»„æ ¸ã€å†…å­˜å’Œå†…å­˜å¼€å…³æ¥å®ç°ï¼Œå¼€å…³é€‰å–ä¸€ä¸ªæ ¸æ¥æ»¡è¶³å…¶å†…å­˜è®¿é—®è¯·æ±‚ï¼Œè¿™å®šä¹‰äº†memory order &lt;mã€‚</p>
<ul>
<li>è¯¥å®ç°ä¸­ä¸éœ€è¦cacheæˆ–è€…coherenceã€‚</li>
</ul>
  <img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-1.png">
</li>
</ul>
<p>3.7 å¸¦æœ‰cache coherenceçš„åŸºæœ¬å®ç°ï¼Œèƒ½å¤Ÿå¹¶è¡Œçš„æ‰§è¡Œä¸å†²çªçš„loadå’Œstoreæ“ä½œ</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-2.png">
<p>è¿™ä¸ªSCå®ç°ä¸­</p>
<ul>
<li>å……åˆ†åˆ©ç”¨äº†cacheçš„æ—¶å»¶å’Œå¸¦å®½ä¼˜åŠ¿ã€‚</li>
<li>å’Œå®ƒä½¿ç”¨çš„cache coherenceåè®®æœ‰ç›¸åŒçš„æ‰©å±•æ€§ã€‚</li>
<li>å°†å®ç°coreä»å®ç°coherenceçš„å¤æ‚åº¦è§£è€¦å¼€ã€‚</li>
</ul>
<p>3.8 ç»§ç»­ä¼˜åŒ–</p>
<ul>
<li>
<p>Non-Binding Prefetchingã€‚å¯¹å—Bçš„éç»‘å®šé¢„å–æ˜¯æŒ‡å‘coherentå†…å­˜ç³»ç»Ÿå‘è¯·æ±‚æ¥æ”¹å˜ä¸€ä¸ªæˆ–å¤šä¸ªcacheä¸­çš„coherenceçŠ¶æ€ã€‚é‡è¦çš„æ˜¯ï¼Œéç»‘å®šé¢„å–ä¸ä¼šä¿®æ”¹å¯„å­˜å™¨çš„çŠ¶æ€æˆ–è€…å—Bä¸­çš„æ•°æ®ï¼Œå¯¹memory consistency modelç›¸å½“äºno-opã€‚</p>
</li>
<li>
<p>Speculative Coresã€‚æ¨æµ‹æ‰§è¡Œåœ¨åˆ†æ”¯é¢„æµ‹å¤±è´¥æ—¶ï¼Œä¼šæ— æ•ˆåŒ–ä¹‹å‰çš„æ“ä½œï¼Œç§°ä¸ºsquashingï¼Œsquashedçš„loadå’Œstoreæ“ä½œçœ‹èµ·æ¥åƒéç»‘å®šé¢„å–ï¼Œä¸å½±å“SCã€‚å¯¹storeï¼Œå¯èƒ½ä¼šæå‰å‘èµ·GetMé¢„å–ï¼Œä½†åªæœ‰storeä¿è¯æäº¤æ—¶æ‰å†™å…¥cacheã€‚</p>
</li>
<li>
<p>Dynamically Scheduled Coresã€‚ä¹±åºæ‰§è¡Œï¼Œå¦‚å°†L2æåˆ°L1ä¹‹å‰æ‰§è¡Œï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æ£€æŸ¥é¢„æµ‹çš„æ­£ç¡®æ€§ã€‚</p>
<ul>
<li>åœ¨æ ¸æ¨æµ‹æ‰§è¡Œå®ŒL2ï¼Œä½†åœ¨æäº¤å‰ï¼Œæ£€æŸ¥æ˜¯å¦è„±ç¦»äº†cacheï¼Œç›‘å¬L2ç›¸å…³çš„å†…å­˜åœ°å€æ˜¯å¦æœ‰GetMè¯·æ±‚ã€‚</li>
<li>åœ¨æ ¸å‡†å¤‡æäº¤loadå‰ï¼Œé‡æ”¾æ¨æµ‹çš„loadï¼Œæ£€æŸ¥ç»“æœæ˜¯å¦ç›¸åŒã€‚</li>
</ul>
  <aside>
  ğŸ’¡ Flashback to Quiz Question 1: In a system that maintains sequential consistency, a core must issue coherence requests in program order. True or false?
  Answer: False! A core may issue coherence requests in any order.
  </aside>
</li>
<li>
<p>Non-Binding Prefetching in Dynamically Scheduled Coresã€‚éç»‘å®šé¢„å–ä¸å½±å“SCã€‚</p>
<ul>
<li>SCè§„å®šäº†loadå’Œstoreï¼ˆçœ‹èµ·æ¥ï¼‰åº”ç”¨åˆ°coherent memoryçš„é¡ºåºï¼Œä½†æ²¡æœ‰è§„å®šcoherent activityçš„é¡ºåºã€‚</li>
</ul>
  <aside>
  ğŸ’¡ Flashback to Quiz Question 2: The memory consistency model specifies the legal orderings of coherence transactions. True or false?
  Answer: False!
  </aside>
</li>
<li>
<p>Multithreadingã€‚ä¸€ä¸ªæŒ‘æˆ˜æ˜¯ä¿è¯storeåœ¨å¯¹å…¶ä»–æ ¸ä¸Šçš„çº¿ç¨‹å¯è§ä¹‹å‰ï¼Œç›¸åŒæ ¸ä¸Šçš„T1çº¿ç¨‹ä¸èƒ½è¯»åˆ°T2çº¿ç¨‹å†™å…¥çš„å€¼ã€‚</p>
</li>
</ul>
<p>3.9 SCä¸‹çš„åŸå­æ“ä½œ</p>
<p>åŸå­çš„atomic-read-writeæ“ä½œå¯ä»¥å¦‚ä¸‹ä¼˜åŒ–ï¼šä¸€ä¸ªæ ¸ä»¥MçŠ¶æ€è·å–åˆ°cacheï¼Œç„¶ååªéœ€è¦loadå’Œstoreå®ƒçš„cacheå—ï¼Œæ²¡æœ‰ä»»ä½•çš„coherence messageæˆ–è€…é”æ€»çº¿ï¼Œåªè¦å®ƒç›´åˆ°storeä¹‹åæ‰æœåŠ¡ä»»ä½•çš„coherenceè¯·æ±‚ã€‚(ä¸ªäººç†è§£ï¼šå˜æˆMä¹‹åï¼Œåªè¦å®ƒä¸å“åº”coherenceè¯·æ±‚ï¼Œå…¶ä»–çš„æ ¸å°±æ²¡æ³•å¾—åˆ°Sæˆ–MçŠ¶æ€çš„cacheï¼Œå› æ­¤ä¸èƒ½è¯»ï¼Œä¹Ÿä¸èƒ½å†™ã€‚ï¼‰</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 3: To perform an atomic read-modify-write instruction (e.g., test-and-set), a core must always communicate with the other cores. True or false?
Answer: False!
</aside>
<p>æ›´è¿›ä¸€æ­¥çš„ä¼˜åŒ–ä¸ºæ¨æµ‹æ‰§è¡Œï¼Œå¦‚æœcacheçš„çŠ¶æ€å·²ç»ä¸ºSï¼ŒRMWçš„loadéƒ¨åˆ†å¯ä»¥é©¬ä¸Šæ¨æµ‹æ‰§è¡Œï¼ŒåŒæ—¶cacheæ§åˆ¶å™¨å‘èµ·ä¿®æ”¹ä¸ºMçŠ¶æ€ã€‚åœ¨cacheå˜ä¸ºMçŠ¶æ€åï¼Œå†æ‰§è¡Œå†™éƒ¨åˆ†ã€‚ä½¿ç”¨å’Œå‰é¢ç±»ä¼¼çš„æ–¹å¼æ¥æ£€æµ‹é¢„æµ‹å¤±è´¥ï¼Œå³cacheæ˜¯å¦è¢«å¼¹å‡ºã€‚</p>
<h2 id="chap4-total-store-order-and-the-x86-memory-model">Chap4 Total Store Order and the x86 Memory Model</h2>
<p>åœ¨cacheè¿›å…¥read-write coherenceçŠ¶æ€ä¹‹å‰storeå¯ä»¥è¿›å…¥write bufferã€‚write bufferéšè—äº†store missçš„å»¶è¿Ÿã€‚</p>
<p>å¦‚æœä½¿ç”¨æ¿€è¿›çš„é¢„æµ‹SCå®ç°æ¥ä½¿å¾—write bufferé€æ˜çš„è¯ï¼Œå¤æ‚æ€§å¾ˆé«˜ï¼Œæ£€æµ‹violationå’Œå¤„ç†mis-speculationçš„åŠŸè€—å¾ˆé«˜ã€‚å› æ­¤å‡ºç° äº†TSOæ¨¡å‹ã€‚</p>
<p>TSO/X86çš„å½¢å¼åŒ–å®šä¹‰</p>
<ol>
<li>ç›¸æ¯”SCä¼šå‡ºç°Store-Loadçš„reorderï¼Œå¢åŠ äº†FIFOçš„write bufferã€‚</li>
<li>Loadè¯»åˆ°åŒä¸€åœ°å€ä¸Šä¸€æ¬¡Storeçš„å€¼ã€‚ä¼˜å…ˆæ˜¯æŒ‰ç…§program orderåœ¨ä¹‹å‰å†™å…¥çš„å€¼ï¼ˆä»write bufferè¯»ï¼‰ï¼Œå…¶æ¬¡æ˜¯æŒ‰ç…§memory orderåœ¨ä¹‹å‰å†™å…¥çš„å€¼ã€‚</li>
<li>æä¾›äº†FENCEæ¥ä¿è¯é¡ºåºã€‚
<ol>
<li>If S(a) &lt;p FENCE â‡’ S(a) &lt;m FENCE /* Store â†’ FENCE */</li>
<li>If FENCE &lt;p L(a) â‡’ FENCE &lt;m L(a) /* FENCE â†’ Load */</li>
</ol>
</li>
</ol>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-3.png">
<p>Bæ„å‘³ç€å¯¹ç›¸åŒåœ°å€éœ€è¦bypassingã€‚</p>
<p>AMDå’ŒInterlè¿˜æ²¡æœ‰æ­£å¼çš„è§„èŒƒè¡¨æ˜æ˜¯TSOï¼Œä½†æ˜¯æ‰€æœ‰çš„ä¾‹å­éƒ½ç¬¦åˆTSOã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-4.png">
<p>åœ¨4.4aä¸­</p>
<ul>
<li>Loadå’ŒStoreä»¥&lt;pç¦»å¼€æ ¸ã€‚</li>
<li>Loadè¦ä¹ˆä»write buffer bypasså€¼ï¼Œè¦ä¹ˆç­‰å¾…switchã€‚</li>
<li>Storeè¿›å…¥FIFO write bufferçš„å°¾éƒ¨ï¼Œå¦‚æœæ»¡äº†åˆ™stallã€‚</li>
<li>Switché€‰æ‹©æŸä¸ªæ ¸æ—¶ï¼Œè¦ä¹ˆæ‰§è¡ŒLoadï¼Œè¦ä¹ˆæ‰§è¡Œwrite bufferå¤´éƒ¨çš„storeã€‚</li>
</ul>
<p>4.4bä¸­ï¼Œä¹‹å‰è®¨è®ºçš„SCå®ç°ä¾ç„¶é€‚ç”¨ã€‚å¤§å¤šæ•°TSOå®ç°éƒ½æ˜¯åœ¨SCå®ç°ä¸Šæ’å…¥äº†write bufferã€‚</p>
<p>å¯¹å¤šçº¿ç¨‹çš„coreï¼Œä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸åº”è¯¥bypasså¦ä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡çš„write bufferã€‚å¯ä»¥å®ç°ä¸ºæ¯ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡çš„write bufferï¼Œæˆ–è€…å…±äº«çš„write bufferåŠ ä¸Šçº¿ç¨‹ä¸Šä¸‹æ–‡tagã€‚åè€…æ›´åŠ å¸¸è§ã€‚</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 4: In a TSO system with multithreaded cores, threads may bypass values out of the write buffer, regardless of which thread wrote the value. True or false? 
Answer: False! A thread may bypass values that it has written, but other threads may not see the value until the store is inserted into the memory order.
</aside>
<p>read-modify-writeå®ç°ã€‚æŒ‰ç…§TSOå®šä¹‰ï¼ŒRMWçš„loadä¸èƒ½è·³è¿‡ä¹‹å‰çš„loadã€‚å¦‚æœRMWçš„loadè·³è¿‡äº†ä¹‹å‰çš„storeï¼Œå› ä¸ºRMWæ˜¯åŸå­çš„ï¼Œå…¶storeä¹Ÿè¦è·³è¿‡ä¹‹å‰çš„storeï¼Œè€ŒTSOæ˜¯ä¸å…è®¸storeè·³è¿‡storeçš„ã€‚</p>
<p>RMWéœ€è¦ä¹‹å‰çš„storeæœ‰åºï¼Œå³éœ€è¦æ’å¹²write bufferã€‚ä¸ºäº†ä¿è¯RMWçš„storeé©¬ä¸Šåœ¨loadä¹‹åï¼Œéœ€è¦è·å¾—read-writeçš„coherenceæƒé™ã€‚ä¸ºäº†ä¿è¯åŸå­æ€§ï¼Œåœ¨loadå’Œstoreä¹‹é—´ä¸èƒ½æ”¾å¼ƒcoherenceæƒé™ã€‚</p>
<p>æ›´å¤šçš„ä¼˜åŒ–æ˜¯å¯è¡Œçš„ã€‚write-bufferåœ¨æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶æ—¶ä¸éœ€è¦æ’å¹²</p>
<ul>
<li>
<p>åœ¨write-bufferä¸­çš„æ¯ä¸ªé¡¹åœ¨cacheä¸­æœ‰read-writeæƒé™ï¼Œå¹¶åœ¨RMWæäº¤å‰ä¿æŒread-writeæƒé™ã€‚</p>
</li>
<li>
<p>ä½¿ç”¨MIPS R1000é£æ ¼çš„load speculationæ£€æŸ¥ã€‚</p>
<blockquote>
<p>åœ¨cache blockå¼¹å‡ºæ—¶çš„åœ°å€å¦‚æœå’Œload speculationçš„åœ°å€ç›¸åŒï¼Œä¼šä½¿å¾—loadå’Œä¹‹å‰çš„æŒ‡ä»¤éƒ½å¤±æ•ˆã€‚åœ¨Loadæäº¤æ—¶ï¼Œå®ƒä¸€ç›´ä¿æŒåœ¨cacheä¸­ï¼Œå€¼å¿…ç„¶ç›¸åŒã€‚</p>
</blockquote>
</li>
</ul>
<p>é€»è¾‘ä¸Šæ¥è¯´ï¼ŒRMWä¹‹å‰çš„loadå’Œstoreä½œä¸ºä¸€ä¸ªchunkæ•´ä½“æäº¤ã€‚</p>
<p>FENCEçš„è¯­ä¹‰æ˜¯FENCEä¹‹å‰çš„æŒ‡ä»¤å¿…é¡»æ’åºï¼ˆåº”è¯¥æ˜¯&lt;mï¼‰åœ¨ä¹‹åçš„æŒ‡ä»¤ä¹‹å‰ã€‚TSOä¸‹çš„FENCEä¸é¢‘ç¹ï¼Œæ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œåœ¨æ’å¹²write bufferä¹‹åå†æ‰§è¡Œloadå°±è¶³å¤Ÿäº†ã€‚</p>
<p>SCæ˜¯TSOçš„å­é›†ã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-5.png">
<h2 id="chap5-relaxed-memory-consistency">Chap5 Relaxed Memory Consistency</h2>
<p>5.1 åŠ¨æœº</p>
<p>RMOåªä¿æŒç¨‹åºå‘˜éœ€è¦çš„é¡ºåºã€‚</p>
<p>å¦‚æœæ“ä½œä¸ä¾èµ–è®¸å¤šLoadå’ŒStoreä¹‹é—´çš„é¡ºåºï¼Œä½¿ç”¨relaxing orderå¯ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚</p>
<p>ä¼˜åŒ–çš„æœºä¼šåŒ…æ‹¬</p>
<ul>
<li>ä½¿ç”¨éFIFOçš„write bufferï¼Œæ¥è·å¾—æ›´å¤šçš„å†™åˆå¹¶ã€‚</li>
<li>ä¸éœ€è¦åšå¤æ‚çš„core speculationï¼Œæœ¬èº«å°±å…è®¸ä¹±åºçš„loadã€‚</li>
<li>é€šè¿‡æ‰“å¼€coherenceé­”ç›’ï¼Œæ¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚å…è®¸ä¸€ç»„æ ¸è¯»åˆ°æœ€æ–°çš„å€¼ï¼Œè€Œå…¶ä»–çš„æ ¸è¯»åˆ°è€çš„å€¼ã€‚</li>
</ul>
<h3 id="example-relaxed-consistency-modelxc">eXample relaxed Consistency Model(XC)</h3>
<p>XCä¸æ˜¯å®é™…çš„æ¨¡å‹ï¼Œå‡å®šå­˜åœ¨global memory orderï¼Œå’Œä¸å†ä½¿ç”¨çš„Alpha, SPARC RMOç›¸åŒã€‚</p>
<p>XCå¯¹ç›¸åŒåœ°å€çš„è®¿é—®ç»´æŠ¤TSOè§„åˆ™ã€‚</p>
<ul>
<li>ç›¸åŒåœ°å€çš„Load â†’ Load</li>
<li>ç›¸åŒåœ°å€çš„Load â†’ Store</li>
<li>ç›¸åŒåœ°å€çš„Store â†’ Store</li>
</ul>
<p>XCä¸­çš„Loadé©¬ä¸Šå°±èƒ½çœ‹åˆ°å¯¹è‡ªå·±æ ¸çš„æ›´æ–°ï¼ˆå°±åƒTSOçš„write buffer bypassing)ã€‚</p>
<p>XCçš„å½¢å¼åŒ–å®šä¹‰</p>
<ol>
<li>
<p>æ‰€æœ‰çš„æ ¸å°†load, storeå’ŒFENCEæ’å…¥&lt;mï¼Œå¹¶éµå¾ªä¸‹é¢çš„è§„åˆ™</p>
<ul>
<li>If L(a) &lt;p FENCE  â‡’ L(a) &lt;m FENCE                  /* Load â†’ FENCE */</li>
<li>If S(a) &lt;p FENCE  â‡’ S(a) &lt;m FENCE                  /* Store â†’ FENCE */</li>
<li>If FENCE &lt;p FENCE  â‡’ FENCE &lt;m FENCE                  /* FENCE â†’ FENCE */</li>
<li>If FENCE &lt;p L(a)  â‡’ FENCE &lt;m L(a)                  /* FENCE â†’ LOAD */</li>
<li>If FENCE &lt;p S(a)  â‡’ FENCE &lt;m S(a)                  /* FENCE â†’ STORE */</li>
</ul>
</li>
<li>
<p>æ‰€æœ‰çš„æ ¸å°†å¯¹ç›¸åŒåœ°å€çš„loadå’Œstoreæ’å…¥&lt;mï¼Œå¹¶éµå¾ªä¸‹é¢çš„è§„åˆ™</p>
<ul>
<li>If L(a) &lt;p Lâ€™(a) â‡’ L(a) &lt;m Lâ€™ (a)        /* Load â†’ Load to same address */</li>
<li>If L(a) &lt;p S(a) â‡’ L(a) &lt;m S(a)        /* Load â†’ Store to same address */</li>
<li>If S(a) &lt;p Sâ€™(a) â‡’ S(a) &lt;m Sâ€™ (a)        /* Store â†’ Store to same address */</li>
</ul>
</li>
<li>
<p>Loadå¾—åˆ°å¯¹ç›¸åŒåœ°å€çš„Storeçš„å€¼ã€‚</p>
<p>Value of L(a) = Value of MAX &lt;m {S(a) | S(a) &lt;m L(a) or S(a) &lt;p L(a)} /* Like TSO */</p>
</li>
</ol>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-6.png">
<ul>
<li>BæŒ‡å¯¹ç›¸åŒåœ°å€éœ€è¦bypassingã€‚</li>
<li>AæŒ‡å¯¹ç›¸åŒåœ°å€æ‰ä¿æŒé¡ºåºã€‚</li>
</ul>
<p>å®ç°XC</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-7.png">
<p>ç›¸æ¯”TSOï¼ŒåŠ ä¸Šäº†reorder unitã€‚</p>
<ul>
<li>Load, Store, FENCEä»¥&lt;pé¡ºåºè¿›å…¥reorderçš„å°¾éƒ¨</li>
<li>reorder unitéµå¾ªä¸€å®šè§„åˆ™è¿›è¡Œreorderï¼Œå°†æ“ä½œä»å°¾éƒ¨ç§»åŠ¨åˆ°å¤´éƒ¨ã€‚FENCEåˆ°è¾¾å¤´éƒ¨åè¢«ä¸¢å¼ƒã€‚</li>
<li>switché€‰å–æŸä¸ªcoreæ—¶ï¼Œæ‰§è¡Œreorderå¤´éƒ¨çš„storeæˆ–è€…loadã€‚</li>
</ul>
<p>ä½œè€…ä¹‹å‰é¢„æµ‹speculative coreä¼šé€æ¸å–ä»£relaxed modelï¼Œæ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œæ¥å£åˆæ›´åŠ ç®€å•ï¼Œä½†ä¸¤æ–¹é¢çš„åŸå› å¯¼è‡´æ²¡æœ‰å‘ç”Ÿï¼šå‚å•†çš„å†²é‡ï¼›ä½åŠŸè€—çš„åœºæ™¯åšä¸åˆ°é«˜speculativeã€‚</p>
<p>XCçš„åŸå­æŒ‡ä»¤</p>
<p>XCä¸­çš„RMWä¸éœ€è¦draining write bufferï¼Œåªéœ€è¦è·å–åˆ°read-writeæƒé™ï¼Œå¹¶åœ¨loadéƒ¨åˆ†å’Œstoreéƒ¨åˆ†ä¹‹é—´ä¸èƒ½æ”¾æ‰‹ã€‚</p>
<p>TSOä¸­çš„åŸå­RMWå°±è¶³ä»¥å®ç°é”ï¼Œè€Œåœ¨XCä¸­éœ€è¦å‰ååŠ ä¸ŠFENCEã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-8.png">
<p>XCä¸­çš„FENCEå®ç°</p>
<ul>
<li>å®ç°SCï¼Œå°†FENCEä½œä¸ºno-op</li>
<li>å°†FENCEå®ç°ä¸ºdrainä¹‹å‰çš„å†…å­˜æ“ä½œã€‚</li>
<li>ä¸drainï¼Œæ€ä¹ˆåšä¹¦é‡Œé¢æ²¡è®²ã€‚</li>
</ul>
<p>ä¸Šé¢æ‰€æœ‰çš„æƒ…å†µä¸­ï¼ŒFENCEéƒ½éœ€è¦çŸ¥é“FENCEå‰çš„æ“ä½œXiæ˜¯å¦ç»“æŸäº†ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹éå¸¸trickyã€‚</p>
<h3 id="sc-for-drfdata-race-free">SC for DRF(data race free)</h3>
<p>ç”¨äºé«˜é˜¶è¯­è¨€åšæŠ½è±¡ï¼Œé™¤äº†æŒ‡å®šçš„åŒæ­¥æ“ä½œéœ€è¦ä¿æŒé¡ºåºå¤–ï¼Œå…¶ä»–çš„æ“ä½œå…è®¸åšreorderã€‚SC for DRFæ¦‚æ‹¬ä¸ºä¸‹é¢ä¸¤æ¡</p>
<ul>
<li>è¦ä¹ˆæœ‰data raceï¼Œæš´éœ²äº†ç±»ä¼¼XCçš„loadå’Œstoreçš„reordering</li>
<li>è¦ä¹ˆdata race freeï¼Œæ‰§è¡Œçœ‹èµ·æ¥å°±åƒSCã€‚</li>
</ul>
<p>SC for DRFå¯ä»¥è®©ç¨‹åºå‘˜ä½¿ç”¨SCæ¥è®ºè¯ç¨‹åºçš„æ­£ç¡®æ€§ï¼Œè€Œä¸éœ€è¦è€ƒè™‘æ›´å¤æ‚çš„XCè§„åˆ™ï¼Œè€Œä¸”èƒ½ä»XCç›¸æ¯”SCçš„ç¡¬ä»¶æ€§èƒ½æé«˜æˆ–æ“ä½œç®€åŒ–ä¸­å—ç›Šã€‚</p>
<img src="/images/A-Primer-on-Memory-Consistency-and-Cache-Coherence-044baf0ff63e42afa375411c9470a616/Untitled-9.png">
<p>åœ¨HLLä¸­åªåœ¨å¿…è¦çš„åœ°æ–¹åŠ ä¸ŠåŒæ­¥ï¼Œå¦‚atomicå’Œsynchronizedï¼Œåœ¨low-level programæ ¹æ®ç¡¬ä»¶äº§ç”Ÿåˆé€‚çš„æŒ‡ä»¤ã€‚</p>
<p>Javaä¸­çš„å†…å­˜æ“ä½œéƒ½æ˜¯SCï¼ŒC++å…è®¸æ›´relaxedçš„æ¨¡å‹ã€‚</p>
<aside>
ğŸ’¡ Flashback to Quiz Question 5: A programmer who writes properly synchronized code relative to the high-level language consistency model (e.g,. Java) does not need to consider the architectureâ€™s memory consistency model. True or false?
Answer: It depends. For typical application programmers, the answer is True, because their programs behave as expected (SC is expected). For the programmers of compilers and runtime systems, the answer is False.
</aside>
<p>ARMv7ä¼¼ä¹ä¸ä¿è¯total memory orderï¼ŒARMv8åˆ‡æ¢åˆ°äº†æä¾›total memory orderçš„multi-copy atomic memory orderã€‚</p>
<blockquote>
<p>write atomicity, store atomicity, multi-copy atomicityã€‚æ˜¯æŒ‡ä¸€ä¸ªæ ¸çš„storeåœ¨é€»è¾‘ä¸Šè¢«å…¶ä»–æ ¸åŒæ—¶å¯è§ã€‚
write atomicityèƒ½å¤Ÿæ¨å¯¼å‡ºcausalityï¼Œåä¹‹ä¸ç„¶ã€‚</p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>Quotient Filter</title>
      <link>https://egolearner.github.io/post/quotient-filter/</link>
      <pubDate>Sun, 04 Aug 2024 23:44:31 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/quotient-filter/</guid>
      <description>&lt;p&gt;quotient filter(QF)ä¸å­˜å‚¨åŸå§‹çš„keyï¼Œè€Œæ˜¯å­˜å‚¨åŸå§‹keyçš„æŒ‡çº¹ï¼Œå› æ­¤åœ¨æŒ‡çº¹å†²çªæ—¶ï¼Œæ— æ³•åŒºåˆ†keyæ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œæ­¤æ—¶ä¹Ÿä¼šfalse positiveã€‚è®ºæ–‡ä¸­ç¡¬å†²çªå®šä¹‰ä¸ºæŒ‡çº¹å†²çªï¼Œè½¯å†²çªå®šä¹‰ä¸ºæŒ‡çº¹ä¸åŒä½†æ˜¯å•†ç›¸åŒã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>quotient filter(QF)ä¸å­˜å‚¨åŸå§‹çš„keyï¼Œè€Œæ˜¯å­˜å‚¨åŸå§‹keyçš„æŒ‡çº¹ï¼Œå› æ­¤åœ¨æŒ‡çº¹å†²çªæ—¶ï¼Œæ— æ³•åŒºåˆ†keyæ˜¯å¦çœŸçš„å­˜åœ¨ï¼Œæ­¤æ—¶ä¹Ÿä¼šfalse positiveã€‚è®ºæ–‡ä¸­ç¡¬å†²çªå®šä¹‰ä¸ºæŒ‡çº¹å†²çªï¼Œè½¯å†²çªå®šä¹‰ä¸ºæŒ‡çº¹ä¸åŒä½†æ˜¯å•†ç›¸åŒã€‚</p>
<p>ç›¸æ¯”bloom filterçš„ä¼˜åŠ¿</p>
<ul>
<li>cacheå‹å¥½ã€‚</li>
<li>æ”¯æŒæ‰©å®¹ã€‚</li>
<li>æ”¯æŒåˆå¹¶ã€‚</li>
<li>æ”¯æŒåˆ é™¤ã€‚</li>
</ul>
<h2 id="åŸç†">åŸç†</h2>
<p>quotient filteråº•å±‚å®ç°ä½¿ç”¨äº†hash tableã€‚Quotientingå°†æŒ‡çº¹åˆ†ä¸ºå•†å’Œä½™æ•°ä¸¤éƒ¨åˆ†ï¼Œå•†ä¸ºæŒ‡çº¹çš„é«˜qä½ï¼Œä½™æ•°ä¸ºæŒ‡çº¹çš„ä½rä½ã€‚å•†ç”¨äºå®šä½åˆ°hashè¡¨çš„bucketï¼Œè€Œä½™æ•°åˆ™ä½œä¸ºhashè¡¨çš„å€¼å­˜å‚¨èµ·æ¥ã€‚æ³¨æ„ï¼Œé€šè¿‡å°†å•†å’Œä½™æ•°ç»“åˆèµ·æ¥èƒ½å¤Ÿé‡å»ºhashï¼Œè€Œä¸éœ€è¦ä½¿ç”¨åŸå§‹çš„keyé‡æ–°å“ˆå¸Œï¼Œè¿™ä¹Ÿæ˜¯quotient filteræ”¯æŒæ‰©å®¹å’Œåˆå¹¶ç­‰æ“ä½œçš„å…³é”®æ‰€åœ¨ã€‚</p>
<p>åœ¨hashè¡¨å†²çªï¼ˆå³ä¸åŒkeyçš„æŒ‡çº¹çš„å•†ç›¸åŒï¼‰æ—¶ï¼Œä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•æ¥å­˜å‚¨ã€‚ä½¿ç”¨çº¿æ€§æ¨æµ‹æ³•æ—¶ï¼Œç›¸åŒå•†çš„æŒ‡çº¹çš„ä½™æ•°éƒ¨åˆ†è¿ç»­å­˜å‚¨ã€‚quotienté™„åŠ äº†é¢å¤–çš„çº¦æŸæ¥åŠ å¿«æ£€ç´¢ï¼Œè¦æ±‚ä½™æ•°ä»å°åˆ°å¤§æ’åºã€‚æ’åºæœ‰ä¸‰ä¸ªä½œç”¨</p>
<ol>
<li>æ£€ç´¢æ—¶åªéœ€è¦æ‰«æåˆ°â‰¥ä½™æ•°çš„æ¡¶å°±å¯ä»¥åœæ­¢æ‰«æï¼›</li>
<li>åœ¨åˆå¹¶QFæ—¶å¯ä»¥æœ‰åºåˆå¹¶ï¼›</li>
<li>æ‰©å®¹æ—¶æ•ˆç‡æ›´é«˜ã€‚æ‰©å®¹æ—¶å¢åŠ å•†çš„ä½æ•°ï¼Œå°†ä½™æ•°çš„é«˜ä½ç§»è‡³å•†çš„ä½ä½ã€‚ä½™æ•°çš„æœ‰åºæ€§ä¿è¯äº†é¡ºåºæ‰«ææ—¶æ–°çš„å•†å’Œæ–°çš„ä½™æ•°éƒ½æ˜¯é€’å¢çš„ã€‚</li>
</ol>
<p>ç›¸åŒå•†çš„æŒ‡çº¹çš„ä½™æ•°æ„æˆäº†ä¸€ä¸ªrunï¼Œç”±äºå†²çªçš„å­˜åœ¨ï¼Œä¸€ä¸ªrunçš„å®é™…å­˜å‚¨ä½ç½®å’Œæ­£å¼ä½ç½®ï¼ˆæ ¹æ®å•†å®šä½åˆ°çš„bucketï¼‰ä¼šä¸åŒã€‚ run æŒ‡çš„æ˜¯ä¸€æ®µå•†ç›¸åŒçš„è¿ç»­è®°å½•çš„ä½™æ•°ï¼Œå¦‚ä¸‹å›¾ cã€dã€e çš„å•†å‡ä¸º 3ï¼›cluster æŒ‡å¤šä¸ªè¿ç»­çš„ runï¼Œå¹¶ä¸”é¦–ä¸ª run ä»å•†å¯¹åº”çš„ä½ç½®å¼€å§‹ï¼Œè€Œåç»­çš„ run å¹¶ä¸æ˜¯ä»å•†å¯¹åº”çš„ä½ç½®å¼€å§‹çš„ã€‚å¦‚å›¾ä¸­æ ‡å‡ºçš„ clusterï¼Œé¦–ä¸ª run ä» 3 å¼€å§‹ï¼Œå’Œå•†ç›¸åŒï¼Œç¬¬äºŒä¸ª run ä» 6 å¼€å§‹ï¼Œè€Œä½™æ•°ä¸º 4ï¼Œç¬¬ä¸‰ä¸ª run ä» 7 å¼€å§‹ï¼Œè€Œä½™æ•°ä¸º 6ã€‚</p>
<p>å…¶ä¸­åœ¨å­˜å‚¨ä½™æ•°çš„åŒæ—¶ï¼Œè¿˜ä¼šåœ¨æ¯ä¸ªå“ˆå¸Œæ¡¶ä¸­å¢è®¾ 3 ä¸ªå…ƒä¿¡æ¯ä½<code>is_occupied</code>ã€<code>is_continuation</code>å’Œ<code>is_shifted</code>ã€‚<code>is_occupied</code>è¡¨ç¤ºè¿‡æ»¤å™¨ä¸­æ˜¯å¦æœ‰å’Œä½™æ•°å¯¹åº”çš„å•†ï¼Œå…¶ä¸ä¸‹æ ‡æ‰€å¯¹åº”çš„å•†ç›¸åŒï¼Œå¦‚ cã€dã€e çš„å•†å‡ä¸º 3ï¼Œå› æ­¤ä¸‹æ ‡ä¸º 3 çš„å“ˆå¸Œæ¡¶<code>is_occupied</code>ä½æ˜¯ 1ã€‚<code>is_continuation</code>è¡¨ç¤ºå½“å‰å“ˆå¸Œæ¡¶ä¸­çš„ä½™æ•°ï¼Œæ˜¯å¦å’Œå·¦è¾¹ç›¸é‚»çš„å…ƒç´ å±äºä¸€ä¸ª runï¼Œå¦‚ä¸‹æ ‡ 4 çš„å“ˆå¸Œæ¡¶ä¸­ä½™æ•°ï¼Œä¸ä¸‹æ ‡ 3 çš„å“ˆå¸Œæ¡¶ä¸­ä½™æ•°å±äºä¸€ä¸ª runï¼Œå› æ­¤<code>is_continuation</code>ä¸º 1ã€‚<code>is_shifted</code>è¡¨ç¤ºä½™æ•°å­˜å‚¨çš„ä½ç½®æ˜¯å¦å’Œä½™æ•°å¯¹åº”çš„å•†è¡¨ç¤ºçš„ä¸‹æ ‡æœ‰åç§»ï¼Œå¦‚ c å­˜å‚¨çš„ä½ç½®ä¸ c å¯¹åº”çš„å•†è¡¨ç¤ºçš„ä¸‹æ ‡å‡ä¸º 3ï¼Œå› æ­¤<code>is_shifted</code>ä¸º 0ï¼›è€Œ f å­˜å‚¨çš„ä½ç½®ä¸º 6ï¼Œf å¯¹åº”çš„å•†è¡¨ç¤ºçš„ä¸‹æ ‡ä¸º 4ï¼Œå› æ­¤<code>is_shifted</code>ä¸º 1ã€‚</p>
<img src="/static/quotient%20filter%205cc6b128afa041a3ae2a565a9479ea03/Untitled.png">
<p>ä¸Šå›¾ç»™å‡ºäº†ä¸€ä¸ªç¤ºä¾‹ï¼Œåˆ†åˆ«æ˜¯ç­‰ä»·çš„ä½¿ç”¨å¼€é“¾å’Œä½¿ç”¨çº¿æ€§æ¢æµ‹ç»“åˆå…ƒä¿¡æ¯bitä½çš„hashè¡¨ç¤ºã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/Quotient_filter">Quotient filter - Wikipedia</a></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">is_occupied</th>
          <th style="text-align: left">is_continuation</th>
          <th style="text-align: left">is_shifted</th>
          <th style="text-align: left">meaning</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">Empty Slot</td>
      </tr>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Slot is holding start of run that has been shifted from its canonical slot.</td>
      </tr>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">not used.</td>
      </tr>
      <tr>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Slot is holding continuation of run that has been shifted from its canonical slot.</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">Slot is holding start of run that is in its canonical slot.This is also the start of the cluster.</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Slot is holding start of run that has been shifted from its canonical slot.Also the run for which this is the canonical slot exists but is shifted right.</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">0</td>
          <td style="text-align: left">not used.</td>
      </tr>
      <tr>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">1</td>
          <td style="text-align: left">Slot is holding continuation of run that has been shifted from its canonical slot.Also the run for which this is the canonical slot exists but is shifted right.</td>
      </tr>
  </tbody>
</table>
<h2 id="å®ç°">å®ç°</h2>
<p>ä¸‹æ–‡ä¸­çš„ä»£ç å‡æ¥è‡ª <a href="https://github.com/vedantk/quotient-filter">https://github.com/vedantk/quotient-filter</a> ã€‚</p>
<h3 id="å®šä½runçš„èµ·å§‹ä¸‹æ ‡">å®šä½runçš„èµ·å§‹ä¸‹æ ‡</h3>
<p>fqä¸ºè¦æŸ¥æ‰¾çš„å•†ã€‚ç”±äºå‰é¢çš„å•†å¯èƒ½æŒ¤å äº†fqçš„ä½ç½®ï¼Œfqä¸ä¸€å®šåœ¨æ­£å¼çš„ä½ç½®ã€‚</p>
<ol>
<li>ç¬¬1ä¸ªå¾ªç¯å‘å·¦æŸ¥æ‰¾ï¼Œæ‰¾åˆ°clusterçš„èµ·å§‹ä½ç½®ã€‚clusterèµ·å§‹ä½ç½®çš„is-shiftedä½ä¸€å®šä¸º0.</li>
<li>ç¬¬2.1ä¸ªå¾ªç¯è·³è¿‡å…¶ä»–çš„runï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªæ²¡æœ‰è®¾ç½®is-continuationçš„ä¸‹æ ‡ã€‚</li>
<li>ç¬¬2.2ä¸ªå¾ªç¯æ‰¾åˆ°ä¸‹ä¸€ä¸ªrunï¼Œå³è®¾ç½®äº†is-occupiedçš„ä¸‹æ ‡ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Find the start index of the run for fq (given that the run exists). */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">uint64_t</span> <span class="nf">find_run_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">quotient_filter</span> <span class="o">*</span><span class="n">qf</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">fq</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* Find the start of the cluster. */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="nf">is_shifted</span><span class="p">(</span><span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">b</span> <span class="o">=</span> <span class="nf">decr</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Find the start of the run for fq. */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">fq</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="o">=</span> <span class="nf">incr</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nf">is_continuation</span><span class="p">(</span><span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">b</span> <span class="o">=</span> <span class="nf">incr</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">is_occupied</span><span class="p">(</span><span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">b</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æŸ¥æ‰¾">æŸ¥æ‰¾</h3>
<ol>
<li>è®¡ç®—å•†fqå’Œä½™æ•°frï¼ŒT_fqä¸ºfqå¤„å­˜å‚¨çš„å€¼ã€‚</li>
<li>å¦‚æœis-occupiedä½æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä¸€å®šä¸å­˜åœ¨ã€‚</li>
<li>æ‰¾åˆ°runçš„èµ·å§‹ä½ç½®ï¼Œä¾æ¬¡æ‰«ærunä¸­çš„å…ƒç´ ï¼Œå¦‚æœä½™æ•°ç›¸åŒï¼Œåˆ™å¯èƒ½å­˜åœ¨ã€‚å¦‚æœä½™æ•°å¤§äºfrï¼Œåˆ™ä¸€å®šä¸å­˜åœ¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-elm" data-lang="elm"><span class="line"><span class="cl"><span class="nv">bool</span> <span class="nv">qf_may_contain</span><span class="p">(</span><span class="nv">struct</span> <span class="nv">quotient_filter</span> <span class="nf">*</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="nv">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="nv">fq</span> <span class="nf">=</span> <span class="nv">hash_to_quotient</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">hash</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="nv">fr</span> <span class="nf">=</span> <span class="nv">hash_to_remainder</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">hash</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="kt">T_fq</span> <span class="nf">=</span> <span class="nv">get_elem</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">fq</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">/*</span> <span class="kt">If</span> <span class="nv">this</span> <span class="nv">quotient</span> <span class="nv">has</span> <span class="nv">no</span> <span class="nv">run</span><span class="p">,</span> <span class="nv">give</span> <span class="nv">up</span><span class="nf">.</span> <span class="nf">*/</span>
</span></span><span class="line"><span class="cl">	<span class="kr">if</span> <span class="p">(</span><span class="err">!</span><span class="nv">is_occupied</span><span class="p">(</span><span class="kt">T_fq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">return</span> <span class="nv">false</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">/*</span> <span class="kt">Scan</span> <span class="nv">the</span> <span class="nv">sorted</span> <span class="nv">run</span> <span class="nv">for</span> <span class="nv">the</span> <span class="nv">target</span> <span class="nv">remainder</span><span class="nf">.</span> <span class="nf">*/</span>
</span></span><span class="line"><span class="cl">	<span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="nv">s</span> <span class="nf">=</span> <span class="nv">find_run_index</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">fq</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nv">uint</span><span class="mi">64</span><span class="nv">_t</span> <span class="nv">rem</span> <span class="nf">=</span> <span class="nv">get_remainder</span><span class="p">(</span><span class="nv">get_elem</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">s</span><span class="p">))</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">		<span class="kr">if</span> <span class="p">(</span><span class="nv">rem</span> <span class="nf">==</span> <span class="nv">fr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">return</span> <span class="nv">true</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="kr">else</span> <span class="kr">if</span> <span class="p">(</span><span class="nv">rem</span> <span class="nf">&gt;</span> <span class="nv">fr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">return</span> <span class="nv">false</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nv">s</span> <span class="nf">=</span> <span class="nv">incr</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">s</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="nv">while</span> <span class="p">(</span><span class="nv">is_continuation</span><span class="p">(</span><span class="nv">get_elem</span><span class="p">(</span><span class="nv">qf</span><span class="p">,</span> <span class="nv">s</span><span class="p">)))</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">	<span class="nv">return</span> <span class="nv">false</span><span class="err">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ’å…¥">æ’å…¥</h3>
<p>å…ƒä¿¡æ¯å˜æ›´æƒ…å†µï¼š</p>
<ul>
<li>æ¡¶fq çš„<code>is_occupied</code>éœ€ç½®ä¸º 1</li>
<li>è‹¥å…ƒç´ å¹¶ä¸æ˜¯ run å†…çš„é¦–ä¸ªå…ƒç´ ï¼Œåˆ™éœ€è¦å°†å…ƒç´  remainder çš„<code>is_continuation</code>ç½®ä¸º 1ï¼Œå¦åˆ™å°†å½“å‰ run å¼€å§‹çš„<code>is_continuation</code>ç½®ä¸º 1ï¼ˆå› ä¸ºæ·»åŠ å®Œæˆåï¼Œå½“å‰ run çš„å¼€å§‹å˜æˆäº†å»¶ç»­ï¼‰</li>
<li>å‘åç§»åŠ¨å·²æœ‰ remainder æ—¶<code>is_shifted</code>å‡ä¼šç½® 1ï¼Œ<code>is_occupied</code>ä¿æŒåœ¨åŸæœ‰çš„ quotient å¤„</li>
</ul>
<p>å…·ä½“æ­¥éª¤</p>
<ol>
<li>è®¡ç®—ä½™æ•°fqï¼Œå•†frï¼ŒT_fqä¸ºfqå¤„çš„å€¼ã€‚</li>
<li>ç¬¬13è¡Œä¸ºæœ€åŸºæœ¬çš„æƒ…å†µï¼Œä½ç½®ä¸ºç©ºï¼Œå³3ä¸ªä½éƒ½æ²¡æœ‰è®¾ç½®ï¼Œæ­¤æ—¶è®¾ç½®is-occupiedä½ï¼Œå¹¶å¡«å……ä½™æ•°å°±å¤§åŠŸå‘Šæˆäº†ã€‚</li>
<li>19è¡Œåˆ¤æ–­å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡is-occupiedä½ï¼Œ åˆ™è¿›è¡Œè®¾ç½®ã€‚</li>
<li>26è¡Œåˆ¤æ–­å¦‚æœå·²ç»è®¾ç½®è¿‡is-occupiedä½ï¼Œåˆ™éœ€è¦æ‰¾åˆ°frçš„æ’å…¥ä½ç½®ï¼Œå³å·²æœ‰ä½™æ•°ä¸­&gt;frçš„ç¬¬ä¸€ä¸ªä½ç½®ã€‚38è¡Œä¸­frä¸ºrunçš„æ–°headæ—¶ï¼ŒåŸæœ‰headéœ€è¦è®¾ç½®is-continuationä½ï¼Œå¦åˆ™44è¡Œè®¾ç½®æ–°å…ƒç´ çš„is-continuationä½ã€‚</li>
<li>åé¢è°ƒç”¨insert_intoæ¥å°†entryæ’å…¥åˆ°QFä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">qf_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">quotient_filter</span> <span class="o">*</span><span class="n">qf</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">qf</span><span class="o">-&gt;</span><span class="n">qf_entries</span> <span class="o">&gt;=</span> <span class="n">qf</span><span class="o">-&gt;</span><span class="n">qf_max_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">fq</span> <span class="o">=</span> <span class="nf">hash_to_quotient</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">fr</span> <span class="o">=</span> <span class="nf">hash_to_remainder</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">T_fq</span> <span class="o">=</span> <span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">fq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">fr</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Special-case filling canonical slots to simplify insert_into(). */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">is_empty_element</span><span class="p">(</span><span class="n">T_fq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">set_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="nf">set_occupied</span><span class="p">(</span><span class="n">entry</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="o">++</span><span class="n">qf</span><span class="o">-&gt;</span><span class="n">qf_entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">is_occupied</span><span class="p">(</span><span class="n">T_fq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">set_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">fq</span><span class="p">,</span> <span class="nf">set_occupied</span><span class="p">(</span><span class="n">T_fq</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">find_run_index</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">fq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">s</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">is_occupied</span><span class="p">(</span><span class="n">T_fq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* Move the cursor to the insert position in the fq run. */</span>
</span></span><span class="line"><span class="cl">		<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">uint64_t</span> <span class="n">rem</span> <span class="o">=</span> <span class="nf">get_remainder</span><span class="p">(</span><span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">==</span> <span class="n">fr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rem</span> <span class="o">&gt;</span> <span class="n">fr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">s</span> <span class="o">=</span> <span class="nf">incr</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nf">is_continuation</span><span class="p">(</span><span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* The old start-of-run becomes a continuation. */</span>
</span></span><span class="line"><span class="cl">			<span class="kt">uint64_t</span> <span class="n">old_head</span> <span class="o">=</span> <span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">set_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="nf">set_continuation</span><span class="p">(</span><span class="n">old_head</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* The new element becomes a continuation. */</span>
</span></span><span class="line"><span class="cl">			<span class="n">entry</span> <span class="o">=</span> <span class="nf">set_continuation</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Set the shifted bit if we can&#39;t use the canonical slot. */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">fq</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">entry</span> <span class="o">=</span> <span class="nf">set_shifted</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">insert_into</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">++</span><span class="n">qf</span><span class="o">-&gt;</span><span class="n">qf_entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>insert_intoéœ€è¦å°†eltå†™åˆ°sæŒ‡å®šçš„æ¡¶ã€‚</p>
<ol>
<li>åœ¨å¾ªç¯ä¸­è¯»å–så½“å‰çš„å€¼prevï¼Œå¦‚æœéç©ºçš„è¯ï¼Œéœ€è¦è®¾ç½®is-shiftedæ ‡è®°ï¼Œå¹¶æ ¹æ®æ˜¯å¦is-occupiedæ ‡è®°ï¼Œè®¾ç½®currçš„is-occupiedä½ï¼Œæ¸…ç†prevçš„is-occupiedä½ã€‚</li>
<li>æ›´æ–°sçš„æ¡¶ä¸ºcurrã€‚</li>
<li>é‡å¤1å’Œ2ç›´åˆ°é‡åˆ°ä¸€ä¸ªç©ºæ¡¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Insert elt into QF[s], shifting over elements as necessary. */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">insert_into</span><span class="p">(</span><span class="k">struct</span> <span class="n">quotient_filter</span> <span class="o">*</span><span class="n">qf</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">s</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">elt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">uint64_t</span> <span class="n">curr</span> <span class="o">=</span> <span class="n">elt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">empty</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">prev</span> <span class="o">=</span> <span class="nf">get_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">empty</span> <span class="o">=</span> <span class="nf">is_empty_element</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* Fix up `is_shifted&#39; and `is_occupied&#39;. */</span>
</span></span><span class="line"><span class="cl">			<span class="n">prev</span> <span class="o">=</span> <span class="nf">set_shifted</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">is_occupied</span><span class="p">(</span><span class="n">prev</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">curr</span> <span class="o">=</span> <span class="nf">set_occupied</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="n">prev</span> <span class="o">=</span> <span class="nf">clr_occupied</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">set_elem</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">curr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">curr</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">s</span> <span class="o">=</span> <span class="nf">incr</span><span class="p">(</span><span class="n">qf</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<p><a href="https://zhuanlan.zhihu.com/p/624438262">Quotient Filter å„ç±»æ“ä½œåˆ†æ - çŸ¥ä¹ (zhihu.com)</a></p>
<p><a href="http://dept.cs.williams.edu/~jannen/teaching/s20/cs333/meetings/Filters-slides.pdf">http://dept.cs.williams.edu/~jannen/teaching/s20/cs333/meetings/Filters-slides.pdf</a></p>
<p><a href="https://en.wikipedia.org/wiki/Quotient_filter">https://en.wikipedia.org/wiki/Quotient_filter</a></p>
<p><a href="https://www.gakhov.com/articles/quotient-filters.html">https://www.gakhov.com/articles/quotient-filters.html</a></p>
<p><a href="https://systemdesign.one/quotient-filter-explained/#variants-of-quotientfilter">https://systemdesign.one/quotient-filter-explained/#variants-of-quotientfilter</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>simple-sqliteæºç ç¬”è®°</title>
      <link>https://egolearner.github.io/post/simple-sqlite-source-read/</link>
      <pubDate>Thu, 08 Dec 2022 08:29:57 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/simple-sqlite-source-read/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;https://github.com/madushadhanushka/simple-sqlite&#34;&gt;https://github.com/madushadhanushka/simple-sqlite&lt;/a&gt; æ˜¯ä»sqlite 2.5.0 æŠ½å–å‡ºçš„æ ¸å¿ƒé€»è¾‘ï¼Œé€‚åˆç”¨æ¥å­¦ä¹ sqliteçš„åç«¯å®ç°ï¼Œå¦‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å¦‚ä½•å®ç°page buffer&lt;/li&gt;
&lt;li&gt;å¦‚ä½•å®ç°åŸºäºç£ç›˜çš„Bæ ‘&lt;/li&gt;
&lt;li&gt;å¦‚ä½•é€šè¿‡rollback journalingæ¥å®ç°äº‹åŠ¡æ”¯æŒå’Œcrash recovery&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;page-buffer-bool&#34;&gt;page buffer bool&lt;/h2&gt;
&lt;h3 id=&#34;pageå’Œpagerå®ç°&#34;&gt;pageå’Œpagerå®ç°&lt;/h3&gt;
&lt;p&gt;å…ˆçœ‹pageçš„å®ç°ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p><a href="https://github.com/madushadhanushka/simple-sqlite">https://github.com/madushadhanushka/simple-sqlite</a> æ˜¯ä»sqlite 2.5.0 æŠ½å–å‡ºçš„æ ¸å¿ƒé€»è¾‘ï¼Œé€‚åˆç”¨æ¥å­¦ä¹ sqliteçš„åç«¯å®ç°ï¼Œå¦‚</p>
<ol>
<li>å¦‚ä½•å®ç°page buffer</li>
<li>å¦‚ä½•å®ç°åŸºäºç£ç›˜çš„Bæ ‘</li>
<li>å¦‚ä½•é€šè¿‡rollback journalingæ¥å®ç°äº‹åŠ¡æ”¯æŒå’Œcrash recovery</li>
</ol>
<h2 id="page-buffer-bool">page buffer bool</h2>
<h3 id="pageå’Œpagerå®ç°">pageå’Œpagerå®ç°</h3>
<p>å…ˆçœ‹pageçš„å®ç°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// page size å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SQLITE_PAGE_SIZE 1024
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// é¡µå·ã€‚0 ä»£è¡¨ &#34;not a page&#34;, æ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªé¡µä»1å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Each in-memory image of a page begins with the following header.
</span></span></span><span class="line"><span class="cl"><span class="cm">** This header is only visible to this pager module.  The client
</span></span></span><span class="line"><span class="cl"><span class="cm">** code that calls pager sees only the data that follows the header.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">PgHdr</span> <span class="n">PgHdr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">PgHdr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">;</span>                 <span class="cm">/* The pager to which this page belongs */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">;</span>                     <span class="cm">/* The page number for this page */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pNextHash</span><span class="p">,</span> <span class="o">*</span><span class="n">pPrevHash</span><span class="p">;</span>  <span class="cm">/* Hash collision chain for PgHdr.pgno */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nRef</span><span class="p">;</span>                      <span class="cm">/* Number of users of this page */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pNextFree</span><span class="p">,</span> <span class="o">*</span><span class="n">pPrevFree</span><span class="p">;</span>  <span class="cm">/* Freelist of pages where nRef==0 */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pNextAll</span><span class="p">,</span> <span class="o">*</span><span class="n">pPrevAll</span><span class="p">;</span>    <span class="cm">/* A list of all pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">inJournal</span><span class="p">;</span>                <span class="cm">/* TRUE if has been written to journal */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">inCkpt</span><span class="p">;</span>                   <span class="cm">/* TRUE if written to the checkpoint journal */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">dirty</span><span class="p">;</span>                    <span class="cm">/* TRUE if we need to write back changes */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* SQLITE_PAGE_SIZE bytes of page data follow this header */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Pager.nExtra bytes of local data follow the page data */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ä¸ªpageçš„å¤§å°ä¸ºSQLITE_PAGE_SIZEã€‚PgHdræ˜¯pageå‰é¢çš„ä¸€æ®µå†…å­˜ï¼Œç”¨äºç°¿è®°ä¸€äº›ä¿¡æ¯ï¼Œå¦‚æ˜¯å¦æ˜¯è„é¡µ(dirty)ï¼Œæ˜¯å¦å·²å†™å…¥journalæˆ–checkpointæ–‡ä»¶(inJournal, inCkpt)ï¼Œé¡µå·ï¼ˆpgnoï¼‰ï¼Œå¼•ç”¨æ•°(nRef)ç­‰ã€‚æ­¤å¤–è¿˜è®°å½•ä¸€äº›åŒé“¾è¡¨çš„next/prevæŒ‡é’ˆï¼ŒpNextHashè®°å½•å“ˆå¸Œè¡¨çš„å†²çªé“¾ï¼ŒpNextFreeè®°å½•ç©ºé—²é¡µï¼ŒpNextAllè®°å½•æ‰€æœ‰é¡µã€‚</p>
<p>åœ¨å†…å­˜ä¸­å¸ƒå±€å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="o">|</span>    <span class="k">sizeof</span><span class="p">(</span><span class="n">PgHdr</span><span class="p">)</span>   <span class="o">|</span>        <span class="n">SQLITE_PAGE_SIZE</span>     <span class="o">|</span>   <span class="n">Pager</span><span class="p">.</span><span class="n">nExtra</span>      <span class="o">|</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŒ‰ç…§ä¸Šé¢çš„å¸ƒå±€ï¼Œå®šä¹‰äº†å¦‚ä¸‹çš„å®æ¥åšå†…å­˜åœ°å€çš„è½¬æ¢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Convert a pointer to a PgHdr into a pointer to its data
</span></span></span><span class="line"><span class="cl"><span class="cm">** and back again.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define PGHDR_TO_DATA(P)  ((void*)(&amp;(P)[1]))
</span></span></span><span class="line"><span class="cl"><span class="cp">#define DATA_TO_PGHDR(D)  (&amp;((PgHdr*)(D))[-1])
</span></span></span><span class="line"><span class="cl"><span class="cp">#define PGHDR_TO_EXTRA(P) ((void*)&amp;((char*)(&amp;(P)[1]))[SQLITE_PAGE_SIZE])
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬çœ‹PGHDR_TO_DATAçš„å®ç°ã€‚æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œ <code>PgHdr* P = init xxx;</code> æŠŠPå½“ä½œä¸€ä¸ªæ•°ç»„ï¼ŒP[1] ç›¸å½“äº P + sizeof(PgHdr)ï¼ŒæŒ‡å‘äº†pageçš„å†…å­˜ï¼Œ&amp;P[1]çš„ç±»å‹ä»ç„¶ä¸ºPgHdr*ï¼Œ å†å°†å…¶è½¬ä¸ºvoid* ç±»å‹ã€‚sqliteå®ç°æ—¶å¤§é‡é‡‡ç”¨äº†ç±»ä¼¼çš„æŠ€å·§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** A open page cache is an instance of the following structure.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Pager</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">zFilename</span><span class="p">;</span>            <span class="cm">/* Name of the database file */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">zJournal</span><span class="p">;</span>             <span class="cm">/* Name of the journal file */</span>
</span></span><span class="line"><span class="cl">  <span class="n">OsFile</span> <span class="n">fd</span><span class="p">,</span> <span class="n">jfd</span><span class="p">;</span>             <span class="cm">/* File descriptors for database and journal */</span>
</span></span><span class="line"><span class="cl">  <span class="n">OsFile</span> <span class="n">cpfd</span><span class="p">;</span>                <span class="cm">/* File descriptor for the checkpoint journal */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// pageä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">dbSize</span><span class="p">;</span>                 <span class="cm">/* Number of pages in the file */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">origDbSize</span><span class="p">;</span>             <span class="cm">/* dbSize before the current change */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">ckptSize</span><span class="p">,</span> <span class="n">ckptJSize</span><span class="p">;</span>    <span class="cm">/* Size of database and journal at ckpt_begin() */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nExtra</span><span class="p">;</span>                 <span class="cm">/* Add this many bytes to each in-memory page */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç”¨äºåšä¸€äº›Bæ ‘çš„æ¸…ç†å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xDestructor</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span> <span class="cm">/* Call this routine when freeing pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nPage</span><span class="p">;</span>                  <span class="cm">/* Total number of in-memory pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nRef</span><span class="p">;</span>                   <span class="cm">/* Number of in-memory pages with PgHdr.nRef&gt;0 */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">mxPage</span><span class="p">;</span>                 <span class="cm">/* Maximum number of pages to hold in cache */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nHit</span><span class="p">,</span> <span class="n">nMiss</span><span class="p">,</span> <span class="n">nOvfl</span><span class="p">;</span>     <span class="cm">/* Cache hits, missing, and LRU overflows */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">journalOpen</span><span class="p">;</span>             <span class="cm">/* True if journal file descriptors is valid */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">ckptOpen</span><span class="p">;</span>                <span class="cm">/* True if the checkpoint journal is open */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">ckptInUse</span><span class="p">;</span>               <span class="cm">/* True we are in a checkpoint */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">noSync</span><span class="p">;</span>                  <span class="cm">/* Do not sync the journal if true */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">state</span><span class="p">;</span>                   <span class="cm">/* SQLITE_UNLOCK, _READLOCK or _WRITELOCK */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">errMask</span><span class="p">;</span>                 <span class="cm">/* One of several kinds of errors */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">tempFile</span><span class="p">;</span>                <span class="cm">/* zFilename is a temporary file */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">readOnly</span><span class="p">;</span>                <span class="cm">/* True for a read-only database */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">needSync</span><span class="p">;</span>                <span class="cm">/* True if an fsync() is needed on the journal */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">dirtyFile</span><span class="p">;</span>               <span class="cm">/* True if database file has changed in any way */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="o">*</span><span class="n">aInJournal</span><span class="p">;</span>             <span class="cm">/* One bit for each page in the database file */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="o">*</span><span class="n">aInCkpt</span><span class="p">;</span>                <span class="cm">/* One bit for each page in the database */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pFirst</span><span class="p">,</span> <span class="o">*</span><span class="n">pLast</span><span class="p">;</span>      <span class="cm">/* List of free pages */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pAll</span><span class="p">;</span>                <span class="cm">/* List of all pages */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç”¨äºæ ¹æ®é¡µå·å¿«é€Ÿå®šä½åˆ°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">aHash</span><span class="p">[</span><span class="n">N_PG_HASH</span><span class="p">];</span>    <span class="cm">/* Hash table to map page number of PgHdr */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Pagerè¡¨ç¤ºpage cacheå®ç°ï¼Œæˆå‘˜æ¯”è¾ƒå¤šï¼Œä½†éƒ½æœ‰æ³¨é‡Šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sqlitepager_open</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">**</span><span class="n">ppPager</span><span class="p">,</span>         <span class="cm">/* Return the Pager structure here */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zFilename</span><span class="p">,</span>   <span class="cm">/* Name of the database file to open */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">mxPage</span><span class="p">,</span>              <span class="cm">/* Max number of in-memory cache pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nExtra</span>               <span class="cm">/* Extra bytes append to each in-memory page */</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>sqlitepager_openç”¨äºåˆ›å»ºä¸€ä¸ªPagerï¼Œå…¶å®ç°ç¨é•¿ï¼Œä½†é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ‰“å¼€æ•°æ®åº“æ–‡ä»¶ï¼Œç„¶ååšæˆå‘˜çš„åˆå§‹åŒ–ã€‚è¿™é‡Œä¸ä»‹ç»å…¶å…·ä½“å®ç°ã€‚å‚æ•°ä¸­çš„mxPageæ§åˆ¶å†…å­˜ä¸­çš„æœ€å¤§é¡µæ•°ï¼ŒnExtraæ˜¯ä¸Šé¢çš„pageéƒ¨å±€ä¸­æœ€åé¢å¤–åˆ†é…çš„ä¸€æ®µå†…å­˜ã€‚</p>
<p>pager_lookupç”¨äºåœ¨å†…å­˜ä¸­æ ¹æ®é¡µå·æ¥æŸ¥è¯¢é¡µï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œä¸ä¼šä»ç£ç›˜ä¸­åŠ è½½ã€‚ä¸»è¦é€»è¾‘å°±æ˜¯åœ¨å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Find a page in the hash table given its page number.  Return
</span></span></span><span class="line"><span class="cl"><span class="cm">** a pointer to the page or NULL if not found.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="n">PgHdr</span> <span class="o">*</span><span class="nf">pager_lookup</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aHash</span><span class="p">[</span><span class="n">pgno</span> <span class="o">%</span> <span class="n">N_PG_HASH</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">!=</span><span class="n">pgno</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pNextHash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pager_getå’Œpager_lookupçš„ä¸åŒåœ¨äºï¼Œåœ¨æ²¡æœ‰å‘½ä¸­ç¼“å­˜æ—¶ä¼šä»ç£ç›˜ä¸­åŠ è½½ã€‚åœ¨æ²¡æœ‰è¶…è¿‡å†…å­˜é¡µæ•°é™åˆ¶æˆ–è€…è¶…è¿‡äº†ä½†æ²¡æœ‰ç©ºé—²é¡µæ—¶ï¼Œä¼šmallocæ–°çš„å†…å­˜ï¼›å¦åˆ™ä»ç©ºé—²é¡µä¸­é‡ç”¨pageï¼Œå¦‚æœæ‰€æœ‰çš„ç©ºé—²é¡µéƒ½æ˜¯è„é¡µï¼Œæ‰§è¡Œåˆ·ç›˜ï¼Œè¿™æ ·æ‰€æœ‰çš„ç©ºé—²é¡µéƒ½ä¸æ˜¯è„é¡µäº†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqlitepager_get</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">ppPage</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Make sure we have not hit any critical errors.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span> 
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">pgno</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PAGER_ERR_FULL</span><span class="p">)</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pager_errcode</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* If this is the first page accessed, then get a read lock
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** on the database file.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">sqliteOsReadLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">)</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">ppPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_BUSY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SQLITE_READLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* If a journal file exists, try to play it back.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// nRef == 0ï¼Œåˆå­˜åœ¨journalæ–‡ä»¶ï¼Œè¯´æ˜æ˜¯å´©æºƒåé‡å¯ï¼Œéœ€è¦ä»journalæ–‡ä»¶æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">sqliteOsFileExists</span><span class="p">(</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">zJournal</span><span class="p">)</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Search for page in cache */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span> <span class="o">=</span> <span class="n">pager_lookup</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ²¡æœ‰å‘½ä¸­ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The requested page is not in the page cache. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nMiss</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰è¶…è¿‡å†…å­˜ä¸Šé™ï¼Œæˆ–è€…æ²¡æœ‰ç©ºé—²é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nPage</span><span class="o">&lt;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">mxPage</span> <span class="o">||</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pFirst</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* Create a new page */</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å†…å­˜åˆ†é…å’Œæˆ‘ä»¬ä¸Šé¢çš„åˆ†ææ˜¯ä¸€è‡´çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pPg</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pPg</span><span class="p">)</span> <span class="o">+</span> <span class="n">SQLITE_PAGE_SIZE</span> <span class="o">+</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nExtra</span>  <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">memset</span><span class="p">(</span><span class="n">pPg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pPg</span><span class="p">)</span> <span class="o">+</span> <span class="n">SQLITE_PAGE_SIZE</span> <span class="o">+</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nExtra</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span> <span class="o">=</span> <span class="n">pPager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextAll</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pAll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pAll</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pAll</span><span class="o">-&gt;</span><span class="n">pPrevAll</span> <span class="o">=</span> <span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPrevAll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pAll</span> <span class="o">=</span> <span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nPage</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* Recycle an older page.  First locate the page to be recycled.
</span></span></span><span class="line"><span class="cl"><span class="cm">      ** Try to find one that is not dirty and is near the head of
</span></span></span><span class="line"><span class="cl"><span class="cm">      ** of the free list */</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pFirst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å½“å‰æ²¡æœ‰ä»»ä½•å¼•ç”¨çš„é¡µä¸ºfreeé¡µï¼Œä½†ä»ç„¶å¯èƒ½ä¸ºè„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">while</span><span class="p">(</span> <span class="n">pPg</span> <span class="o">&amp;&amp;</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">pPg</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// å¦‚æœæ‰¾ä¸åˆ°å¯ç”¨çš„ç©ºé—²é¡µï¼Œåˆ™å°†æ‰€æœ‰çš„ä¿®æ”¹åŒæ­¥ç£ç›˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// ä¹‹æ‰€ä»¥åŒæ­¥æ‰€æœ‰çš„é¡µè€ŒéåªåŒæ­¥ä¸€ä¸ªé¡µï¼Œæ˜¯å› ä¸ºé˜²æ­¢çŸ­æœŸåç»­å‡ºç°éœ€è¦åŒæ­¥çš„æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">syncAllPages</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="n">sqlitepager_rollback</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="o">*</span><span class="n">ppPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">SQLITE_IOERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">pPg</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pFirst</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="cm">/* Unlink the old page from the free list and the hash table
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// çœç•¥freeé“¾ï¼Œhashé“¾çš„ç»´æŠ¤é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nOvfl</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span> <span class="o">=</span> <span class="n">pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æ˜¯å¦åœ¨journalæˆ–checkpointä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pgno</span><span class="o">&lt;=</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">origDbSize</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">=</span> <span class="p">(</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="p">[</span><span class="n">pgno</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">pgno</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)))</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInCkpt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pgno</span><span class="o">&lt;=</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">ckptSize</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInCkpt</span><span class="p">[</span><span class="n">pgno</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">pgno</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">)))</span><span class="o">!=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">nRef</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">REFINFO</span><span class="p">(</span><span class="n">pPg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»´æŠ¤hashé“¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">h</span> <span class="o">=</span> <span class="n">pager_hash</span><span class="p">(</span><span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextHash</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aHash</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aHash</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextHash</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextHash</span><span class="o">-&gt;</span><span class="n">pPrevHash</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextHash</span><span class="o">-&gt;</span><span class="n">pPrevHash</span> <span class="o">=</span> <span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="n">sqlitepager_pagecount</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯¹äºç£ç›˜ä¸Šæ²¡æœ‰çš„é¡µï¼Œç½®0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pgno</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">memset</span><span class="p">(</span><span class="n">PGHDR_TO_DATA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqliteOsSeek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="n">pgno</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä»ç£ç›˜è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsRead</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">PGHDR_TO_DATA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nExtra</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">memset</span><span class="p">(</span><span class="n">PGHDR_TO_EXTRA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nExtra</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The requested page is in the page cache. */</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nHit</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_ref</span><span class="p">(</span><span class="n">pPg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">ppPage</span> <span class="o">=</span> <span class="n">PGHDR_TO_DATA</span><span class="p">(</span><span class="n">pPg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>sqliteå¯¹pageå®ç°äº†å¼•ç”¨è®¡æ•°ï¼Œå¼•ç”¨è®¡æ•°å˜ä¸º0æ—¶åŠ å…¥ç©ºé—²é“¾ï¼Œå˜ä¸ºé0æ—¶ä»ç©ºé—²é“¾ç§»é™¤ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">page_ref</span><span class="p">(</span><span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The page is currently on the freelist.  Remove it. */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPrevFree</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPrevFree</span><span class="o">-&gt;</span><span class="n">pNextFree</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pFirst</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextFree</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextFree</span><span class="o">-&gt;</span><span class="n">pPrevFree</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPrevFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pLast</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPrevFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">nRef</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">REFINFO</span><span class="p">(</span><span class="n">pPg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="äº‹åŠ¡åŠcrash-recoveryå®ç°">äº‹åŠ¡åŠcrash recoveryå®ç°</h3>
<p>sqlite 3.7.0å®ç°äº†wal journalï¼Œä¹‹å‰é‡‡ç”¨çš„æ˜¯rollback journalingã€‚æ‰€è°“rollback journalingï¼Œæ˜¯æŒ‡åœ¨ä¿®æ”¹pageå‰ï¼Œå…ˆå°†pageçš„å†…å®¹å¤‡ä»½åˆ°journalæ–‡ä»¶ä¸­ï¼Œç„¶åå†ä¿®æ”¹å†…å­˜ä¸­çš„pageï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æˆåŠŸåˆ·æ–°åˆ°ç£ç›˜åå†ç§»é™¤journalæ–‡ä»¶ã€‚å¦‚æœäº‹åŠ¡åœ¨æˆåŠŸæäº¤ä¹‹å‰å‡ºç°crashï¼Œåœ¨é‡å¯æ—¶sqliteä¼šä»journalæ–‡ä»¶æ¢å¤pageï¼Œä½¿æ•°æ®åº“æ¢å¤äº‹åŠ¡æäº¤å‰çš„çŠ¶æ€ã€‚</p>
<p>åœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œéœ€è¦è°ƒç”¨<code>sqlitepager_begin</code> ï¼Œä¼šåˆ›å»ºjournalæ–‡ä»¶å’Œç»´æŠ¤journalç›¸å…³çš„æ ‡è®°ä½ï¼Œè®°å½•å½“å‰æ–‡ä»¶çš„é¡µæ•°ç”¨äºå›æ»šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqlitepager_begin</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span> <span class="o">=</span> <span class="n">DATA_TO_PGHDR</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">==</span><span class="n">SQLITE_READLOCK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†™é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWriteLock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”¨äºè®°å½•å“ªäº›é¡µå·²ç»å†™å…¥journalæ–‡ä»¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span>  <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span>  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="o">/</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">memset</span><span class="p">(</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="o">/</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å¼€journalæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsOpenExclusive</span><span class="p">(</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">zJournal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">journalOpen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">needSync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dirtyFile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SQLITE_WRITELOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_pagecount</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®°å½•ä¹‹å‰çš„pageä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">origDbSize</span> <span class="o">=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†™å…¥magicå’Œä¹‹å‰çš„pageé¡µæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="n">aJournalMagic</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aJournalMagic</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Pgno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_unwritelock</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_FULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ä¿®æ”¹pageå‰ï¼Œéœ€è¦è°ƒç”¨<code>sqlitepager_write</code> ï¼Œå°†pageå†…å®¹å¤‡ä»½åˆ°journalæ–‡ä»¶ä¸­ï¼Œå¹¶è®¾ç½®dirtyæ ‡è®°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqlitepager_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span> <span class="o">=</span> <span class="n">DATA_TO_PGHDR</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Check for errors
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span> <span class="p">){</span> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pager_errcode</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_PERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Mark the page as dirty.  If the page has already been written
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** to the journal then we can return right away.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">||</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">ckptInUse</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dirtyFile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* If we get this far, it means that the page needs to be
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** written to the transaction journal or the ckeckpoint journal
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** or both.
</span></span></span><span class="line"><span class="cl"><span class="cm">  **
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** First check to see that the transaction journal exists and
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** create it if it does not.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">!=</span><span class="n">SQLITE_UNLOCK</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è°ƒç”¨sqlitepager_beginï¼Œå¦‚æœä¹‹å‰å·²ç»è°ƒç”¨è¿‡ï¼Œç›¸å½“äºç©ºæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_begin</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dirtyFile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">==</span><span class="n">SQLITE_WRITELOCK</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">journalOpen</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* The transaction journal now exists and we have a write lock on the
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** main database file.  Write the current page to the transaction 
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** journal if it is not there already.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæ²¡æœ‰å¤‡ä»½åˆ°journalä¸”åœ¨æ–‡ä»¶åŸæœ‰èŒƒå›´å†…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span> <span class="o">&lt;=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">origDbSize</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†™å…¥é¡µå·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Pgno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å†™å…¥pageå†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="n">pData</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="o">!=</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="p">[</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">needSync</span> <span class="o">=</span> <span class="o">!</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">noSync</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Update the database size and return.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨äº‹åŠ¡å›æ»šæ—¶ï¼Œè°ƒç”¨<code>sqlitepager_rollback</code> ï¼Œä»journalæ–‡ä»¶æ¢å¤å¤‡ä»½çš„pageå†…å®¹ã€‚å¯¹äºjournalæ–‡ä»¶ä¸­æ‰€æœ‰å®Œæ•´çš„é¡µï¼Œå°†å…¶è¯»å‡ºåå†™å…¥æ•°æ®åº“æ–‡ä»¶çš„ç›¸åº”é¡µï¼Œå¹¶æ›´æ–°åˆ°å­˜åœ¨çš„pageç¼“å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqlitepager_rollback</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span><span class="o">!=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span><span class="o">!=</span><span class="n">PAGER_ERR_FULL</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">&gt;=</span><span class="n">SQLITE_WRITELOCK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pager_playback</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pager_errcode</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">!=</span><span class="n">SQLITE_WRITELOCK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å›æ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_playback</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span> <span class="o">|=</span> <span class="n">PAGER_ERR_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¾ç½®é¡µæ•°ä¸º-1ï¼Œåé¢æœ‰éœ€è¦ä¼šè‡ªåŠ¨è·å–å®é™…çš„é¡µæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">pager_playback</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nRec</span><span class="p">;</span>                <span class="cm">/* Number of Records */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>                   <span class="cm">/* Loop counter */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">mxPg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>           <span class="cm">/* Size of the original file in pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aMagic</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aJournalMagic</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Figure out how many records are in the journal.  Abort early if
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** the journal is empty.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">journalOpen</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqliteOsSeek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsFileSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nRec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">end_playback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ ¡éªŒè‡³å°‘éœ€è¦å­˜å‚¨ä¸€ä¸ªå®Œæ•´çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">nRec</span> <span class="o">=</span> <span class="p">(</span><span class="n">nRec</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aMagic</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Pgno</span><span class="p">)))</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PageRecord</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">nRec</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">end_playback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Read the beginning of the journal and truncate the
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** database file back to its original size.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ ¡éªŒmagic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsRead</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="n">aMagic</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">aMagic</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">aMagic</span><span class="p">,</span><span class="n">aJournalMagic</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aMagic</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_PROTOCOL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">end_playback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¯»å–æœ€å¤§é¡µæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsRead</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mxPg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mxPg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">end_playback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ä¸¢å¼ƒæœ€åä¸å®Œæ•´çš„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsTruncate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">mxPg</span><span class="o">*</span><span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">end_playback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ¢å¤é¡µæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">=</span> <span class="n">mxPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="cm">/* Copy original pages out of the journal and back into the database file.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">nRec</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_playback_one_page</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">end_playback</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pager_unwritelock</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span> <span class="o">|=</span> <span class="n">PAGER_ERR_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_unwritelock</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">pager_playback_one_page</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">OsFile</span> <span class="o">*</span><span class="n">jfd</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span><span class="p">;</span>              <span class="cm">/* An existing page in the cache */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PageRecord</span> <span class="n">pgRec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¯»é¡µå·å’Œpageå†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsRead</span><span class="p">(</span><span class="n">jfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgRec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pgRec</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Sanity checking on the page */</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pgRec</span><span class="p">.</span><span class="n">pgno</span><span class="o">&gt;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">||</span> <span class="n">pgRec</span><span class="p">.</span><span class="n">pgno</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Playback the page.  Update the in-memory copy of the page
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** at the same time, if there is one.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæœ‰ç¼“å­˜çš„è¯ï¼Œä¹Ÿæ›´æ–°åˆ°ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pPg</span> <span class="o">=</span> <span class="n">pager_lookup</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgRec</span><span class="p">.</span><span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">memcpy</span><span class="p">(</span><span class="n">PGHDR_TO_DATA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="n">pgRec</span><span class="p">.</span><span class="n">aData</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">memset</span><span class="p">(</span><span class="n">PGHDR_TO_EXTRA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">nExtra</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å†™å…¥æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsSeek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="n">pgRec</span><span class="p">.</span><span class="n">pgno</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">pgRec</span><span class="p">.</span><span class="n">aData</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>äº‹åŠ¡æäº¤æ—¶éœ€è¦è°ƒç”¨<code>sqlitepager_commit</code> ï¼Œåˆ·ç›˜å¹¶é‡Šæ”¾å†™é”ã€‚çœ‹å®ç°ä¼šå…ˆåŒæ­¥journalæ–‡ä»¶ï¼Œç„¶åå°†å†…å­˜ä¸­çš„pageå†™å…¥ç£ç›˜å¹¶åŒæ­¥æ•°æ®åº“æ–‡ä»¶ã€‚åœ¨é‡Šæ”¾å†™é”æ—¶ä¼šåˆ é™¤journalæ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqlitepager_commit</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span><span class="o">==</span><span class="n">PAGER_ERR_FULL</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_rollback</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_FULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">errMask</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_errcode</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">!=</span><span class="n">SQLITE_WRITELOCK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">journalOpen</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dirtyFile</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰ä¿®æ”¹ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* Exit early (without doing the time-consuming sqliteOsSync() calls)
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** if there have been no changes to the database file. */</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_unwritelock</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åŒæ­¥journalæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">needSync</span> <span class="o">&amp;&amp;</span> <span class="n">sqliteOsSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">jfd</span><span class="p">)</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">commit_abort</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å†™æ‰€æœ‰çš„è„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">pPg</span><span class="o">=</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">pAll</span><span class="p">;</span> <span class="n">pPg</span><span class="p">;</span> <span class="n">pPg</span><span class="o">=</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pNextAll</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsSeek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">commit_abort</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteOsWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">PGHDR_TO_DATA</span><span class="p">(</span><span class="n">pPg</span><span class="p">),</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">commit_abort</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åŒæ­¥æ•°æ®åº“æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">noSync</span> <span class="o">&amp;&amp;</span> <span class="n">sqliteOsSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPager</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">)</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">commit_abort</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é‡Šæ”¾å†™é”æ—¶ä¼šåˆ é™¤journalæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">pager_unwritelock</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">dbSize</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/* Jump here if anything goes wrong during the commit process.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl"><span class="nl">commit_abort</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_rollback</span><span class="p">(</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_FULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸäº›æƒ…å†µä¸‹è„é¡µæœ‰å¯èƒ½æ•´é¡µè¢«ä¸¢å¼ƒï¼Œæ¯”å¦‚åœ¨Bæ ‘åˆ é™¤æ—¶å¯èƒ½pageè¢«åˆå¹¶åˆ°ç›¸é‚»çš„é¡µï¼Œè¿™æ—¶å¯ä»¥è°ƒç”¨<code>sqlitepager_dont_write</code> æ¥å‡å°‘äº‹åŠ¡æäº¤æ—¶çš„å†™ç›˜é‡ï¼Œé€šè¿‡å»æ‰è„é¡µæ ‡è®°ä½¿å¾—äº‹åŠ¡æäº¤æ—¶ä¸éœ€è¦åˆ·æ–°è¿™ä¸ªé¡µåˆ°ç£ç›˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sqlitepager_dont_write</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPg</span> <span class="o">=</span> <span class="n">pager_lookup</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPg</span> <span class="o">&amp;&amp;</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æŸäº›æƒ…å†µä¸‹ï¼Œåœ¨å†™æ•°æ®é¡µæ—¶å¯èƒ½ä¹‹å‰çš„æ•°æ®ä¸éœ€è¦å¤‡ä»½åˆ°journalæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚é‡ç”¨ä¹‹å‰é‡Šæ”¾çš„ç£ç›˜é¡µæ—¶ï¼Œè¿™æ—¶å¯ä»¥è°ƒç”¨<code>sqlitepager_dont_rollback</code> ï¼Œå…¶ä¸»è¦é€»è¾‘ä¸ºè®¾ç½®åœ¨journalæ–‡ä»¶ä¸­çš„æ ‡å¿—ä½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">sqlitepager_dont_rollback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PgHdr</span> <span class="o">*</span><span class="n">pPg</span> <span class="o">=</span> <span class="n">DATA_TO_PGHDR</span><span class="p">(</span><span class="n">pData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span> <span class="o">=</span> <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">state</span><span class="o">!=</span><span class="n">SQLITE_WRITELOCK</span> <span class="o">||</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">journalOpen</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span> <span class="o">&lt;=</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">origDbSize</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="o">!=</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInJournal</span><span class="p">[</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åªè®¾ç½®æ ‡å¿—ä½ï¼Œä½†ä¸å†™å…¥journalæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inJournal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">ckptInUse</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPager</span><span class="o">-&gt;</span><span class="n">aInCkpt</span><span class="p">[</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">pPg</span><span class="o">-&gt;</span><span class="n">pgno</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPg</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bæ ‘å®ç°">Bæ ‘å®ç°</h2>
<p>è¿™ä¸ªç‰ˆæœ¬çš„sqliteçš„è¡¨å’Œç´¢å¼•éƒ½ä½¿ç”¨äº†Bæ ‘å®ç°ï¼Œè¿˜æ²¡æœ‰å®ç°B+æ ‘ã€‚</p>
<p>ä¸€ä¸ªæ‰“å¼€çš„æ•°æ®åº“ç”¨ä¸‹é¢çš„ç»“æ„ä½“è¡¨ç¤º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Btree</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">;</span>        <span class="cm">/* The page cache */</span>
</span></span><span class="line"><span class="cl">  <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCursor</span><span class="p">;</span>    <span class="cm">/* A list of all open cursors */</span>
</span></span><span class="line"><span class="cl">  <span class="n">PageOne</span> <span class="o">*</span><span class="n">page1</span><span class="p">;</span>       <span class="cm">/* First page of the database */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">inTrans</span><span class="p">;</span>           <span class="cm">/* True if a transaction is in progress */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">inCkpt</span><span class="p">;</span>            <span class="cm">/* True if there is a checkpoint on the transaction */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">readOnly</span><span class="p">;</span>          <span class="cm">/* True if the underlying file is readonly */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Hash</span> <span class="n">locks</span><span class="p">;</span>           <span class="cm">/* Key: root page number.  Data: lock count */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ•°æ®åº“æ–‡ä»¶çš„ç¬¬1ä¸ªpageï¼Œç”¨<code>PageOne</code> æ¥è¡¨ç¤ºï¼Œå…¶ä¸­åŒ…å«æ ‡è¯†æ•°æ®åº“æ–‡ä»¶çš„magic numberï¼Œä»¥åŠç©ºé—²é¡µçš„ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">PageOne</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ** This file contains an SQLite 2.1 database **
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">char</span> <span class="n">zMagic</span><span class="p">[</span><span class="n">MAGIC_SIZE</span><span class="p">];</span> <span class="cm">/* String that identifies the file as a database */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 0xdae37528
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">iMagic</span><span class="p">;</span>              <span class="cm">/* Integer to verify correct byte order */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">freeList</span><span class="p">;</span>           <span class="cm">/* First free page in a list of all free pages */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nFree</span><span class="p">;</span>               <span class="cm">/* Number of pages on the free list */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">aMeta</span><span class="p">[</span><span class="n">SQLITE_N_BTREE_META</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* User defined integers */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€ä¸ªæ•°æ®åº“æ–‡ä»¶ä¸­å¯ä»¥åŒ…å«å¤šä¸ªBæ ‘ï¼Œè¿™äº›Bæ ‘å­˜å‚¨åœ¨ç¬¬2ä¸ªæˆ–è€…é¡µå·æ›´å¤§çš„pageä¸­ã€‚</p>
<h3 id="ç©ºé—²é¡µè¡¨">ç©ºé—²é¡µè¡¨</h3>
<p>PageOne.freeListæŒ‡å‘ç¬¬ä¸€ä¸ªå­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µã€‚ç©ºé—²é¡µä¿¡æ¯ä½¿ç”¨<code>FreelistInfo</code> å­˜å‚¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FreelistInfo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nFree</span><span class="p">;</span>  <span class="c1">// ç©ºé—²é¡µçš„ä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Pgno</span> <span class="n">aFree</span><span class="p">[(</span><span class="n">OVERFLOW_SIZE</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Pgno</span><span class="p">)];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µä½¿ç”¨overflowé¡µçš„æ ¼å¼å­˜å‚¨ï¼Œä½¿ç”¨OverflowPage.iNextæŒ‡å‘ä¸‹ä¸€ä¸ªå­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µï¼Œè¿™äº›ç©ºé—²é¡µä¿¡æ¯æ„æˆäº†ä¸€ä¸ªé“¾è¡¨ã€‚FreelistInfoå­˜å‚¨åœ¨OverflowPage.aPayloadå¤„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#define OVERFLOW_SIZE (SQLITE_PAGE_SIZE-sizeof(Pgno))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">OverflowPage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">aPayload</span><span class="p">[</span><span class="n">OVERFLOW_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ ä¸€ä¸ªé¡µåˆ°ç©ºé—²é¡µè¡¨çš„å®ç°å¦‚ä¸‹ã€‚å¦‚æœå­˜åœ¨ä¸æ»¡çš„å­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µï¼Œåˆ™è¿½åŠ åˆ°å…¶ä¸­ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Add a page of the database file to the freelist.  Either pgno or
</span></span></span><span class="line"><span class="cl"><span class="cm">** pPage but not both may be 0. 
</span></span></span><span class="line"><span class="cl"><span class="cm">**
</span></span></span><span class="line"><span class="cl"><span class="cm">** sqlitepager_unref() is NOT called for pPage.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">freePage</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PageOne</span> <span class="o">*</span><span class="n">pPage1</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">OverflowPage</span> <span class="o">*</span><span class="n">pOvfl</span> <span class="o">=</span> <span class="p">(</span><span class="n">OverflowPage</span><span class="o">*</span><span class="p">)</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">needUnref</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pMemPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pgno</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pOvfl</span><span class="o">!=</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pgno</span> <span class="o">=</span> <span class="n">sqlitepager_pagenumber</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pgno</span><span class="o">&gt;</span><span class="mi">2</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pPage1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¡æ•°åŠ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">OverflowPage</span> <span class="o">*</span><span class="n">pFreeIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pFreeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">FreelistInfo</span> <span class="o">*</span><span class="n">pInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreelistInfo</span><span class="o">*</span><span class="p">)</span><span class="n">pFreeIdx</span><span class="o">-&gt;</span><span class="n">aPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å¦‚æœæœ‰ç©ºé—²ç©ºé—´ï¼Œåˆ™å†™å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">aFree</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">aFree</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pFreeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">aFree</span><span class="p">[</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pFreeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// å–æ¶ˆpgnoé¡µçš„è„é¡µæ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="n">sqlitepager_dont_write</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pFreeIdx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¿è¡Œåˆ°è¿™é‡Œæ„å‘³ç€æ‰€æœ‰çš„å­˜å‚¨ç©ºé—²é¡µä¿¡æ¯çš„é¡µéƒ½å·²å†™æ»¡ï¼Œéœ€è¦ç”¨å½“å‰é¡µæ¥å­˜å‚¨ç©ºé—²é¡µä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pOvfl</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pgno</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgno</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">needUnref</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">needUnref</span> <span class="p">)</span> <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç»´æŠ¤é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">=</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span> <span class="o">=</span> <span class="n">pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// memsetä¹Ÿä¿è¯äº†FreelistInfo.nFree == 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">memset</span><span class="p">(</span><span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">aPayload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OVERFLOW_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pMemPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">MemPage</span><span class="o">*</span><span class="p">)</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pMemPage</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pMemPage</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pMemPage</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pMemPage</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">needUnref</span> <span class="p">)</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ç©ºé—²é¡µè¡¨åˆ†é…ä¸€ä¸ªé¡µçš„å®ç°å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">allocatePage</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">**</span><span class="n">ppPage</span><span class="p">,</span> <span class="n">Pgno</span> <span class="o">*</span><span class="n">pPgno</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">PageOne</span> <span class="o">*</span><span class="n">pPage1</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæœ‰ç©ºé—²é¡µï¼Œä»ç©ºé—²é¡µåˆ†é…ï¼›å¦åˆ™ä»ç£ç›˜åŠ è½½ï¼Œåˆ†é…ä¸€ä¸ªæ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">OverflowPage</span> <span class="o">*</span><span class="n">pOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">FreelistInfo</span> <span class="o">*</span><span class="n">pInfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pPage1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreelistInfo</span><span class="o">*</span><span class="p">)</span><span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">aPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è¿™ä¸ªç©ºé—²é¡µä¿¡æ¯é¡µåªçš„ç©ºé—²é¡µä¸º0ï¼ŒæŠŠè¿™ä¸ªé¡µæœ¬èº«åˆ†é…å‡ºå»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">pPgno</span> <span class="o">=</span> <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPage1</span><span class="o">-&gt;</span><span class="n">freeList</span> <span class="o">=</span> <span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">ppPage</span> <span class="o">=</span> <span class="p">(</span><span class="n">MemPage</span><span class="o">*</span><span class="p">)</span><span class="n">pOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä»ä¸­æ‹¿ä¸€ä¸ªé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">pPgno</span> <span class="o">=</span> <span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">aFree</span><span class="p">[</span><span class="n">pInfo</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="o">*</span><span class="n">pPgno</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">ppPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// è®¾ç½®ç©ºé—²é¡µçš„å†…å®¹ä¸éœ€è¦å›æ»š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">sqlitepager_dont_rollback</span><span class="p">(</span><span class="o">*</span><span class="n">ppPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="o">*</span><span class="n">ppPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pPgno</span> <span class="o">=</span> <span class="n">sqlitepager_pagecount</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»Pageråˆ†é…ä¸€ä¸ªæ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="o">*</span><span class="n">pPgno</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="n">ppPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="o">*</span><span class="n">ppPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bæ ‘èŠ‚ç‚¹é¡µå®ç°">Bæ ‘èŠ‚ç‚¹é¡µå®ç°</h3>
<p>èŠ‚ç‚¹ä½¿ç”¨ä¸‹é¢çš„ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">MemPage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">aDisk</span><span class="p">[</span><span class="n">SQLITE_PAGE_SIZE</span><span class="p">];</span>  <span class="cm">/* Page data stored on disk */</span>
</span></span><span class="line"><span class="cl">    <span class="n">PageHdr</span> <span class="n">hdr</span><span class="p">;</span>                   <span class="cm">/* Overlay page header */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">isInit</span><span class="p">;</span>                    <span class="cm">/* True if auxiliary data is initialized */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pParent</span><span class="p">;</span>              <span class="cm">/* The parent of this page.  NULL for root */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç©ºé—²å­—èŠ‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">nFree</span><span class="p">;</span>                     <span class="cm">/* Number of free bytes in u.aDisk[] */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å­˜å‚¨çš„cellä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">nCell</span><span class="p">;</span>                     <span class="cm">/* Number of entries on this page */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ˜¯å¦å·²ç»overfullï¼Œå³è¶…å‡ºpage size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int</span> <span class="n">isOverfull</span><span class="p">;</span>                <span class="cm">/* Some apCell[] points outside u.aDisk[] */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ’åºçš„Cellåˆ—è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Cell</span> <span class="o">*</span><span class="n">apCell</span><span class="p">[</span><span class="n">MX_CELL</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>       <span class="cm">/* All data entires in sorted order */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define EXTRA_SIZE (sizeof(MemPage)-SQLITE_PAGE_SIZE)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>MemPage.uå¯¹åº”ç£ç›˜ä¸Šçš„pageï¼Œä¹‹åçš„æ•°æ®åªåœ¨å†…å­˜ä¸­å­˜å‚¨ã€‚åœ¨åˆ›å»ºPageræ—¶ï¼Œä¼šè®¾ç½®Pager.nExtra = EXTRA_SIZEä»¥ä¾¿åœ¨åˆ›å»ºå†…å­˜ä¸­çš„é¡µæ—¶åˆ†é…è¶³å¤Ÿçš„å†…å­˜ã€‚</p>
<p>æ¯ä¸ªèŠ‚ç‚¹çš„KVå’Œå·¦å­æŒ‡é’ˆï¼Œä½¿ç”¨Cellç»“æ„æ¥è¡¨ç¤ºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">CellHdr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">leftChild</span><span class="p">;</span> <span class="cm">/* Child page that comes before this cell */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="n">nKey</span><span class="p">;</span>       <span class="cm">/* Number of bytes in the key */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="n">iNext</span><span class="p">;</span>      <span class="cm">/* Index in MemPage.u.aDisk[] of next cell in sorted order */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">nKeyHi</span><span class="p">;</span>      <span class="cm">/* Upper 8 bits of key size for keys larger than 64K bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">nDataHi</span><span class="p">;</span>     <span class="cm">/* Upper 8 bits of data size when the size is more than 64K */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="n">nData</span><span class="p">;</span>      <span class="cm">/* Number of bytes of data */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define NKEY(h)  (h.nKey + h.nKeyHi*65536)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define NDATA(h) (h.nData + h.nDataHi*65536)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Cellçš„æœ€å°å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MIN_CELL_SIZE  (sizeof(CellHdr)+4)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ä¸€ä¸ªé¡µä¸­æœ€å¤šå¯ä»¥å­˜å¤šå°‘ä¸ªCell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MX_CELL ((SQLITE_PAGE_SIZE-sizeof(PageHdr))/MIN_CELL_SIZE)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define USABLE_SPACE  (SQLITE_PAGE_SIZE - sizeof(PageHdr))
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ä¸ä½¿ç”¨overflowé¡µæ—¶Cellçš„æœ€å¤§å­—èŠ‚æ•°ï¼Œä¿è¯ä¸€ä¸ªpageè‡³å°‘å¯ä»¥å­˜4ä¸ªCell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define MX_LOCAL_PAYLOAD ((USABLE_SPACE/4-(sizeof(CellHdr)+sizeof(Pgno)))&amp;~3)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">Cell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">CellHdr</span> <span class="n">h</span><span class="p">;</span>                        <span class="cm">/* The cell header */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">aPayload</span><span class="p">[</span><span class="n">MX_LOCAL_PAYLOAD</span><span class="p">];</span>  <span class="cm">/* Key and data */</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç¬¬ä¸€ä¸ªoverflowé¡µçš„é¡µå·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Pgno</span> <span class="n">ovfl</span><span class="p">;</span>                        <span class="cm">/* The first overflow page */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cellç”±CellHdrå’Œpayloadæ•°æ®ä»¥åŠç¬¬ä¸€ä¸ªoverflowé¡µçš„é¡µå·æ„æˆã€‚è™½ç„¶Cellçš„ç»“æ„ä½“çš„é•¿åº¦æ˜¯å›ºå®šçš„ï¼Œä½†å®é™…Cellæ˜¯å˜é•¿çš„ï¼Œé€šè¿‡CellHdræ¥ç¡®å®šCellçš„å®é™…é•¿åº¦ã€‚payloadè‡³å°‘4ä¸ªå­—èŠ‚ï¼Œæœ€å¤šMX_LOCAL_PAYLOADä¸ªå­—èŠ‚ï¼Œå¦‚æœpayloadéœ€è¦çš„ç©ºé—´å¤§äºMX_LOCAL_PAYLOADæ—¶ä¼šåˆ†é…overflowé¡µã€‚</p>
<p>CellHdræè¿°äº†keyå’Œvalueçš„é•¿åº¦ï¼Œéƒ½ä½¿ç”¨äº†24ä¸ªbitè¡¨ç¤ºï¼Œä¸ºäº†èŠ‚çœç©ºé—´æ‹†åˆ†ä¸ºé«˜ä½8bitçš„nKeyHiå’Œ16 bitçš„nKeyï¼ˆå¦‚æœä¸è¿™ä¹ˆæ‹†åˆ†çš„è¯è¦å ç”¨32ä¸ªbitï¼‰ï¼Œå®šä¹‰äº†NKEYå’ŒNDATAå®æ¥å¾—åˆ°Kå’ŒVçš„é•¿åº¦ã€‚CellHdr.leftChildæŒ‡å‘äº†å·¦å­æ ‘çš„é¡µå·ï¼Œå…¶ä¸­å­˜å‚¨çš„keyéƒ½å°äºè¿™ä¸ªCellçš„keyã€‚</p>
<p>åˆ†é…ä¸€ä¸ªCellçš„å®ç°å¦‚ä¸‹ï¼Œå¦‚æœç©ºé—´ä¸è¶³ï¼Œä¼šåˆ†é…overflowé¡µæ¥å­˜å‚¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">fillInCell</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span>              <span class="cm">/* The whole Btree.  Needed to allocate pages */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Cell</span> <span class="o">*</span><span class="n">pCell</span><span class="p">,</span>             <span class="cm">/* Populate this Cell structure */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pKey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nKey</span><span class="p">,</span>    <span class="cm">/* The key */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">,</span><span class="kt">int</span> <span class="n">nData</span>    <span class="cm">/* The data */</span>
</span></span><span class="line"><span class="cl"><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">OverflowPage</span> <span class="o">*</span><span class="n">pOvfl</span><span class="p">,</span> <span class="o">*</span><span class="n">pPrior</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">spaceLeft</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">nPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="o">*</span><span class="n">pSpace</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¾ç½®size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">nKey</span> <span class="o">=</span> <span class="n">nKey</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">nKeyHi</span> <span class="o">=</span> <span class="n">nKey</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">nData</span> <span class="o">=</span> <span class="n">nData</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">nDataHi</span> <span class="o">=</span> <span class="n">nData</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">iNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">pNext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pCell</span><span class="o">-&gt;</span><span class="n">ovfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pSpace</span> <span class="o">=</span> <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">aPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">spaceLeft</span> <span class="o">=</span> <span class="n">MX_LOCAL_PAYLOAD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPayload</span> <span class="o">=</span> <span class="n">pKey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pKey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">nPayload</span> <span class="o">=</span> <span class="n">nKey</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPrior</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">nPayload</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">spaceLeft</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// åˆ†é…ä¸€ä¸ªoverflowé¡µï¼Œé¡µå·è®¾ç½®åˆ°pCell-&gt;ovflæˆ–è€…pOvfl-&gt;iNextä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">allocatePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="p">(</span><span class="n">MemPage</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pOvfl</span><span class="p">,</span> <span class="n">pNext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">pNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pPrior</span> <span class="p">)</span> <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pPrior</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">clearCell</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pCell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPrior</span> <span class="o">=</span> <span class="n">pOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">spaceLeft</span> <span class="o">=</span> <span class="n">OVERFLOW_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pSpace</span> <span class="o">=</span> <span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">aPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pNext</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="n">nPayload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">n</span><span class="o">&gt;</span><span class="n">spaceLeft</span> <span class="p">)</span> <span class="n">n</span> <span class="o">=</span> <span class="n">spaceLeft</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŒåŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">memcpy</span><span class="p">(</span><span class="n">pSpace</span><span class="p">,</span> <span class="n">pPayload</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">nPayload</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">nPayload</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pData</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// keyå†™å®Œåæ¥ç€å†™value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pPayload</span> <span class="o">=</span> <span class="n">pData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">nPayload</span> <span class="o">=</span> <span class="n">nData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPayload</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">spaceLeft</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pSpace</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">pNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPrior</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pPrior</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡Šæ”¾Cellæ¶‰åŠåˆ°ä¸¤ä¸ªå‡½æ•°ã€‚<code>clearCell</code> è´Ÿè´£é‡Šæ”¾Cellåˆ†é…çš„overflowé¡µã€‚<code>dropCell</code> è´Ÿè´£å°†Celléæº¢å‡ºçš„å†…å­˜åŠ å…¥ç©ºé—²é“¾è¡¨ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">clearCell</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="n">Cell</span> <span class="o">*</span><span class="n">pCell</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">OverflowPage</span> <span class="o">*</span><span class="n">pOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">ovfl</span><span class="p">,</span> <span class="n">nextOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">NKEY</span><span class="p">(</span><span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="n">NDATA</span><span class="p">(</span><span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">MX_LOCAL_PAYLOAD</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">ovfl</span> <span class="o">=</span> <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">ovfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">ovfl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">ovfl</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é‡Šæ”¾overflowé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">ovfl</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nextOvfl</span> <span class="o">=</span> <span class="n">pOvfl</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">freePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pOvfl</span><span class="p">,</span> <span class="n">ovfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pOvfl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ovfl</span> <span class="o">=</span> <span class="n">nextOvfl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">dropCell</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">idx</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="o">&lt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sz</span><span class="o">==</span><span class="n">cellSize</span><span class="p">(</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é‡Šæ”¾Cellæœ¬èº«å çš„ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">freeSpace</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="p">),</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">idx</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">/</span>
</span></span><span class="line"><span class="cl"><span class="o">**</span> <span class="n">Most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">effort</span> <span class="n">here</span> <span class="n">is</span> <span class="n">involved</span> <span class="n">in</span> <span class="n">coalesing</span> <span class="n">adjacent</span>
</span></span><span class="line"><span class="cl"><span class="o">**</span> <span class="n">free</span> <span class="n">blocks</span> <span class="n">into</span> <span class="n">a</span> <span class="n">single</span> <span class="n">big</span> <span class="n">free</span> <span class="n">block</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="n">freeSpace</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">pFBlk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">pNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">size</span> <span class="o">==</span> <span class="n">ROUNDUP</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">start</span> <span class="o">==</span> <span class="n">ROUNDUP</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">idx</span> <span class="o">=</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">idx</span><span class="o">!=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="o">&lt;</span><span class="n">start</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pFBlk</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">==</span> <span class="n">start</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">==</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå¯ä»¥å’Œä¸‹ä¸€ä¸ªåŒºé—´åˆå¹¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">pNext</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">+=</span> <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">iSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">=</span> <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pNew</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">start</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ£€æŸ¥æ˜¯å¦å¯ä»¥å’Œåé¢çš„åŒºé—´åˆå¹¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">idx</span> <span class="o">!=</span> <span class="n">end</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNext</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">iSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">=</span> <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€ä¸ªMemPageé€»è¾‘ä¸Šæ¥è¯´ç”±å¤šä¸ªæ’åºçš„Cellç»„æˆï¼Œä½†åœ¨ç‰©ç†å­˜å‚¨æ—¶å³ä¸ä¿è¯æœ‰åºä¹Ÿä¸ä¿è¯è¿ç»­ã€‚ç”±äºæ’å…¥æ•°æ®æ—¶ä¸ä¸€å®šæœ‰åºï¼Œå› æ­¤è¦ä¿è¯ç‰©ç†å­˜å‚¨æœ‰åºéœ€è¦ç§»åŠ¨æ•°æ®è€Œå¯¼è‡´é¢å¤–çš„å¼€é”€ï¼Œå› æ­¤å®ç°æ—¶å¹¶ä¸ä¼šç§»åŠ¨æ•°æ®ï¼Œä½†é€šè¿‡CellHdr.iNextæ„æˆäº†ä¸€ä¸ªæœ‰åºçš„Cellé“¾è¡¨ã€‚ç”±äºåˆ é™¤æ•°æ®æ—¶ä¹Ÿä¸ä¼šç§»åŠ¨æ•°æ®ï¼Œå› æ­¤Cellä¹‹é—´å¯èƒ½æœ‰ç©ºæ´ï¼Œè¿™äº›ç©ºæ´ä½¿ç”¨FreeBlkè¡¨ç¤ºï¼Œå¹¶é€šè¿‡FreeBlk.iNextæ„æˆäº†ä¸€ä¸ªé“¾è¡¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">FreeBlk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="n">iSize</span><span class="p">;</span>      <span class="cm">/* Number of bytes in this block of free space */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="n">iNext</span><span class="p">;</span>      <span class="cm">/* Index in MemPage.u.aDisk[] of the next free block */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»ç£ç›˜åŠ è½½pageåï¼Œé€šè¿‡initPageç»´æŠ¤å†…å­˜ä¸­çš„è¾…åŠ©ä¿¡æ¯ï¼Œå°†æ‰€æœ‰CellåŠ è½½åˆ°å†…å­˜ä¸­çš„apCellæ•°ç»„ï¼Œè®¡ç®—æ€»çš„ç©ºé—²å­—èŠ‚æ•°ä¿¡æ¯ã€‚initPageåï¼Œå¯ä»¥é€šè¿‡apCelléšæœºè®¿é—®ä¸€ä¸ªCellï¼Œè€Œä¸éœ€è¦é€šè¿‡Cellé“¾è¡¨é¡ºåºè®¿é—®ã€‚åœ¨æ’å…¥æ—¶ï¼Œæ–°çš„Cellå¯èƒ½è¶…å‡ºpage sizeï¼Œåœ¨çŸ­æš‚çš„æ—¶é—´å†…apCellä¼šæœ‰æŒ‡å‘aDiskå¤–çš„Cellã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">initPage</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgnoThis</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">*</span><span class="n">pParent</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>           <span class="cm">/* An index into pPage-&gt;u.aDisk[] */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Cell</span> <span class="o">*</span><span class="n">pCell</span><span class="p">;</span>       <span class="cm">/* A pointer to a Cell in pPage-&gt;u.aDisk[] */</span>
</span></span><span class="line"><span class="cl">  <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">pFBlk</span><span class="p">;</span>    <span class="cm">/* A pointer to a free block in pPage-&gt;u.aDisk[] */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>            <span class="cm">/* The size of a Cell in bytes */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">freeSpace</span><span class="p">;</span>     <span class="cm">/* Amount of free space on the page */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="o">==</span><span class="n">pParent</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pParent</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="o">=</span> <span class="n">pParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¢åŠ å¼•ç”¨è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sqlitepager_ref</span><span class="p">(</span><span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">freeSpace</span> <span class="o">=</span> <span class="n">USABLE_SPACE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">idx</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">idx</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‰©ä½™ç©ºé—´å­˜ä¸ä¸‹ä¸€ä¸ªCell  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">&gt;</span><span class="n">SQLITE_PAGE_SIZE</span><span class="o">-</span><span class="n">MIN_CELL_SIZE</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// èµ·å§‹åœ°å€åœ¨PageHdrå†…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PageHdr</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰4å­—èŠ‚å¯¹é½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">!=</span><span class="n">ROUNDUP</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pCell</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">sz</span> <span class="o">=</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">pCell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¶…è¿‡äº†page size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">+</span><span class="n">sz</span> <span class="o">&gt;</span> <span class="n">SQLITE_PAGE_SIZE</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">freeSpace</span> <span class="o">-=</span> <span class="n">sz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è½½åˆ°cellæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">idx</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">idx</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">&gt;</span><span class="n">SQLITE_PAGE_SIZE</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">FreeBlk</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="n">PageHdr</span><span class="p">)</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pFBlk</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»´æŠ¤ç©ºé—²byteæ•°ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">+=</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">pFBlk</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* As a special case, an uninitialized root page appears to be
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** an empty database */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">!=</span><span class="n">freeSpace</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">page_format_error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">page_format_error</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bæ ‘æ“ä½œ">Bæ ‘æ“ä½œ</h2>
<h3 id="åˆ›å»ºbæ ‘">åˆ›å»ºBæ ‘</h3>
<p>å…ˆçœ‹åˆ›å»ºæ•°æ®åº“çš„å®ç°ã€‚å¦‚æœå·²ç»è‡³å°‘æœ‰2ä¸ªé¡µï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦åˆ™åˆ›å»º2ä¸ªé¡µï¼Œå¹¶åˆå§‹åŒ–ç¬¬1ä¸ªé¡µä¸ºPageOneï¼Œå¯¹ç¬¬2ä¸ªé¡µè°ƒç”¨zeroPageæ¥é‡ç½®ä¸ºä¸€ä¸ªåŒ…å«0é¡¹çš„Bæ ‘èŠ‚ç‚¹é¡µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">newDatabase</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">PageOne</span> <span class="o">*</span><span class="n">pP1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">sqlitepager_pagecount</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pP1</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">strcpy</span><span class="p">(</span><span class="n">pP1</span><span class="o">-&gt;</span><span class="n">zMagic</span><span class="p">,</span> <span class="n">zMagicHeader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pP1</span><span class="o">-&gt;</span><span class="n">iMagic</span> <span class="o">=</span> <span class="n">MAGIC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">zeroPage</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>sqliteBtreeCreateTable</code> è¦åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œåˆ†é…ä¸€ä¸ªé¡µä½œä¸ºæ ¹é¡µï¼Œè¿”å›é¡µå·ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeCreateTable</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">piTable</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">pgnoRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>  <span class="cm">/* Must start a transaction first */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_READONLY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæœ‰ç©ºé—²çš„ï¼Œç”¨ç©ºé—²çš„ï¼Œå¦åˆ™åˆ†é…ä¸€ä¸ªæ–°page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">allocatePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pRoot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgnoRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pRoot</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">zeroPage</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ä¸åœ¨ä½¿ç”¨ä¸­å°±è°ƒunref
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pRoot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è¿”å›æ ¹æ‰€åœ¨çš„é¡µå·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">*</span><span class="n">piTable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pgnoRoot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cursoræ“ä½œ">Cursoræ“ä½œ</h3>
<p>Cursorç”¨äºBæ ‘çš„éå†æˆ–è€…å®šä½ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ã€‚mPageæŒ‡å‘å½“å‰çš„pageï¼ŒidxæŒ‡å‘å½“å‰çš„é¡¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** A cursor is a pointer to a particular entry in the BTree.
</span></span></span><span class="line"><span class="cl"><span class="cm">** The entry is identified by its MemPage and the index in
</span></span></span><span class="line"><span class="cl"><span class="cm">** MemPage.apCell[] of the entry.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">BtCursor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">;</span>               <span class="cm">/* The Btree to which this cursor belongs */</span>
</span></span><span class="line"><span class="cl">  <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pNext</span><span class="p">,</span> <span class="o">*</span><span class="n">pPrev</span><span class="p">;</span>  <span class="cm">/* Forms a linked list of all cursors */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">pgnoRoot</span><span class="p">;</span>            <span class="cm">/* The root page of this tree */</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">;</span>           <span class="cm">/* Page that contains the entry */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>                  <span class="cm">/* Index of the entry in pPage-&gt;apCell[] */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">wrFlag</span><span class="p">;</span>                <span class="cm">/* True if writable */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">bSkipNext</span><span class="p">;</span>             <span class="cm">/* sqliteBtreeNext() is no-op if true */</span>
</span></span><span class="line"><span class="cl">  <span class="n">u8</span> <span class="n">iMatch</span><span class="p">;</span>                <span class="cm">/* compare result from last sqliteBtreeMoveto() */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è°ƒç”¨<code>sqliteBtreeCursor</code> åˆ›å»ºä¸€ä¸ªCursor</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeCursor</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iTable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wrFlag</span><span class="p">,</span> <span class="n">BtCursor</span> <span class="o">**</span><span class="n">ppCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ptr</span> <span class="n">nLock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å¼€PageOneï¼Œå¹¶è·å–ä¸€ä¸ªæ•°æ®åº“è¯»é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">lockBtree</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">ppCur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">wrFlag</span> <span class="o">&amp;&amp;</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">ppCur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_READONLY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span> <span class="o">=</span> <span class="n">sqliteMalloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pCur</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_NOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">create_cursor_exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¾ç½®rooté¡µå·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pgnoRoot</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pgno</span><span class="p">)</span><span class="n">iTable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å–å½“å‰é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pgnoRoot</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">create_cursor_exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆå§‹åŒ–pageåœ¨å†…å­˜ä¸­çš„é¢å¤–è¾…åŠ©ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">initPage</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pgnoRoot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">create_cursor_exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">nLock</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span><span class="n">sqliteHashFind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iTable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// nLock &lt; 0è¯´æ˜å·²è¢«åˆ«äººä¸Šäº†å†™é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// nLock &gt; 0 è¯´æ˜å·²è¢«åˆ«äººä¸Šäº†è¯»é”ï¼Œå¦‚æœwrFlagä¸ºtrueï¼Œåˆ™è·å–å†™é”å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">nLock</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">nLock</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wrFlag</span><span class="p">)</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_LOCKED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="n">create_cursor_exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å†™é”ä¸ºè´Ÿï¼Œè¯»é”ä¸ºæ­£ï¼Œ0å³NULLè¡¨ç¤ºæ²¡æœ‰é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">nLock</span> <span class="o">=</span> <span class="n">wrFlag</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">nLock</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqliteHashInsert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">locks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iTable</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">nLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span> <span class="o">=</span> <span class="n">pBt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">wrFlag</span> <span class="o">=</span> <span class="n">wrFlag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç»´æŠ¤cursoré“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pNext</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pCursor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pNext</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pNext</span><span class="o">-&gt;</span><span class="n">pPrev</span> <span class="o">=</span> <span class="n">pCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPrev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pCursor</span> <span class="o">=</span> <span class="n">pCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">ppCur</span> <span class="o">=</span> <span class="n">pCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">create_cursor_exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">ppCur</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="p">)</span> <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqliteFree</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlockBtreeIfUnused</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™ä¸ªç‰ˆæœ¬çš„Cursoræ”¯æŒçš„æ“ä½œä¸ºFirst, Last, Next, Movetoï¼Œåˆ†åˆ«æŒ‡å‘ç¬¬ä¸€ä¸ªã€æœ€åä¸€ä¸ªã€ä¸‹ä¸€ä¸ªã€æŒ‡å®šçš„keyã€‚</p>
<p><code>sqliteBtreeFirst</code> å…ˆå°†CursoræŒ‡å‘rootï¼Œç„¶åæ²¿ç€å·¦å­æŒ‡é’ˆä¸æ–­ç§»åŠ¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeFirst</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pRes</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToRoot</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToLeftmost</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">moveToRoot</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è½½å…¥pageï¼Œå¹¶ä¿®æ”¹cursoræŒ‡å‘çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pgnoRoot</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pNew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">initPage</span><span class="p">(</span><span class="n">pNew</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pgnoRoot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é‡ç½®idxä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">moveToLeftmost</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ²¿ç€æœ€å·¦çš„childæŒ‡é’ˆä¸æ–­ç§»åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">pgno</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToChild</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">moveToChild</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newPgno</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pNewPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è½½å…¥pageï¼Œå¹¶ä¿®æ”¹cursoræŒ‡å‘çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">newPgno</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pNewPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">initPage</span><span class="p">(</span><span class="n">pNewPage</span><span class="p">,</span> <span class="n">newPgno</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pNewPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>sqliteBtreeNext</code> ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªKVã€‚å¦‚æœè¿™ä¸€å±‚è¿˜æ²¡éå†å®Œï¼Œå…ˆå°†idxæŒ‡å‘ä¸‹ä¸€ä¸ªCellï¼Œç„¶åç§»åŠ¨åˆ°è¯¥Cellä¸‹å±‚çš„æœ€å·¦èŠ‚ç‚¹ã€‚å¦åˆ™å‘ä¸Šå±‚å›æº¯ï¼Œç”±äºé‡‡ç”¨çš„æ˜¯Bæ ‘å®ç°ï¼Œå›æº¯åˆ°ä¸Šå±‚çš„æœ‰æ•ˆèŠ‚ç‚¹å°±å¯ä»¥è¿”å›äº†ï¼Œå› ä¸ºä¸­é—´èŠ‚ç‚¹ä¹Ÿå­˜å‚¨ç€æ•°æ®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeNext</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pRes</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ä¹‹å‰çš„æ“ä½œå·²ç»æŒ‡å‘äº†ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">&amp;&amp;</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">&lt;</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// idx + 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å·²ç»éå†å®Œè¿™ä¸ªpage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">&gt;=</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå­˜åœ¨å³å­æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ç§»åŠ¨åˆ°å³å­æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToChild</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ç§»åŠ¨åˆ°å³å­æ ‘ä¸‹çš„æœ€å·¦èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToLeftmost</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// pParent == 0 è¯´æ˜æ•´ä¸ªæ ‘å·²éå†å®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ç§»åŠ¨åˆ°parent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToParent</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">while</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">&gt;=</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Bæ ‘çš„ä¸­é—´èŠ‚ç‚¹ä¹Ÿå­˜å‚¨æ•°æ®ï¼Œå› æ­¤è¿™é‡Œè¿”å›äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç§»åŠ¨åˆ°è¯¥èŠ‚ç‚¹ä¸‹çš„æœ€å·¦èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToLeftmost</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">moveToParent</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">oldPgno</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pParent</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pParent</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_INTERNAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">oldPgno</span> <span class="o">=</span> <span class="n">sqlitepager_pagenumber</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqlitepager_ref</span><span class="p">(</span><span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="o">==</span><span class="n">oldPgno</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è®¾ç½®idxä¸ºåŒ…å«åŸchildçš„Cellçš„ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>sqliteBtreeMoveto</code> å°†Cursorç§»åŠ¨åˆ°æŒ‡å®škeyé™„è¿‘çš„KVã€‚åœ¨keyä¸å­˜åœ¨æ—¶ï¼Œæœ‰å¯èƒ½æŒ‡å‘åœ¨è¯¥keyä¹‹å‰æˆ–ä¹‹åçš„keyï¼Œä½¿ç”¨*pResçš„å€¼æ¥è¡¨ç¤ºä¸åŒçš„ç»“æœï¼ˆ&lt;0 ä¹‹å‰çš„keyï¼Œ=0 æ°å¥½æŒ‡å‘ï¼Œ&gt;0 ä¹‹åçš„keyï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeMoveto</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pKey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nKey</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pRes</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å…ˆç§»åŠ¨åˆ°rooté¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToRoot</span><span class="p">(</span><span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(;;){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">lwr</span><span class="p">,</span> <span class="n">upr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pgno</span> <span class="n">chldPg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lwr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">upr</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// äºŒåˆ†æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span><span class="p">(</span> <span class="n">lwr</span><span class="o">&lt;=</span><span class="n">upr</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lwr</span><span class="o">+</span><span class="n">upr</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ¯”è¾ƒå½“å‰idxæŒ‡å‘çš„Cellå’Œkeyçš„å¤§å°å…³ç³»ï¼Œå¿…è¦æ—¶ä¼šåŠ è½½overflowé¡µçš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteBtreeKeyCompare</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="n">nKey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">iMatch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">c</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">lwr</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">upr</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">lwr</span><span class="o">==</span><span class="n">upr</span><span class="o">+</span><span class="mi">1</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">lwr</span><span class="o">&gt;=</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">chldPg</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">chldPg</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">lwr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰childé¡µäº†åˆ™è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">chldPg</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">iMatch</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pRes</span> <span class="p">)</span> <span class="o">*</span><span class="n">pRes</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»è¯¥childå¤„ç»§ç»­æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">moveToChild</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="n">chldPg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* NOT REACHED */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ’å…¥åˆ é™¤">æ’å…¥åˆ é™¤</h3>
<p>åœ¨æ’å…¥KVæ—¶ï¼Œå…ˆå°†Cursorç§»åŠ¨åˆ°keyé™„è¿‘ï¼Œç„¶åæ ¹æ®æ˜¯å¦å­˜åœ¨keyåšä¸€äº›ä¸åŒ<code>apCell</code> æ•°ç»„çš„ç»´æŠ¤å·¥ä½œï¼Œæœ€åè°ƒç”¨rebalanceæ¥åšæ ‘å¹³è¡¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">** Insert a new record into the BTree.  The key is given by (pKey,nKey)
</span></span></span><span class="line"><span class="cl"><span class="cm">** and the data is given by (pData,nData).  The cursor is used only to
</span></span></span><span class="line"><span class="cl"><span class="cm">** define what database the record should be inserted into.  The cursor
</span></span></span><span class="line"><span class="cl"><span class="cm">** is left pointing at the new record.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeInsert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">,</span>                <span class="cm">/* Insert data into the table of this cursor */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pKey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nKey</span><span class="p">,</span>    <span class="cm">/* The key of the new record */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nData</span>   <span class="cm">/* The data of the new record */</span>
</span></span><span class="line"><span class="cl"><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">Cell</span> <span class="n">newCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">loc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">szNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>  <span class="cm">/* A rollback destroyed this cursor */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="o">||</span> <span class="n">nKey</span><span class="o">+</span><span class="n">nData</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>  <span class="cm">/* Must start a transaction first */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">wrFlag</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_PERM</span><span class="p">;</span>   <span class="cm">/* Cursor not open for writing */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç§»åŠ¨åˆ°keyé™„è¿‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteBtreeMoveto</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="n">nKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">loc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†é…ä¸€ä¸ªcellæ¥å­˜æ”¾key/valueï¼Œå¯èƒ½æœ‰overflow é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">fillInCell</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newCell</span><span class="p">,</span> <span class="n">pKey</span><span class="p">,</span> <span class="n">nKey</span><span class="p">,</span> <span class="n">pData</span><span class="p">,</span> <span class="n">nData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">szNew</span> <span class="o">=</span> <span class="n">cellSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newCell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">loc</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ°å¥½åŒ¹é…ï¼Œéœ€è¦åˆ é™¤ä¹‹å‰çš„Cellã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒç”¨clearCellé‡Šæ”¾æ¶‰åŠçš„overflowé¡µï¼Œè°ƒç”¨dropCellæ¥ä»apCellæ•°ç»„ä¸­åˆ é™¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newCell</span><span class="p">.</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">clearCell</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">dropCell</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">loc</span><span class="o">&lt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>  <span class="cm">/* Must be a leaf page */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// idx+1æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå’Œä¸‹é¢çš„elseå¾—åˆ°ç›¸åŒçš„ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// rightChildè¯´æ˜æ˜¯leafé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assert</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="o">==</span><span class="mi">0</span> <span class="p">);</span>  <span class="cm">/* Must be a leaf page */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†æ–°çš„Cellæ’å…¥ï¼Œæ‰§è¡Œå®Œæˆåæœ‰å¯èƒ½è¶…å‡ºpage sizeï¼Œåé¢çš„balanceä¼šå¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">insertCell</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newCell</span><span class="p">,</span> <span class="n">szNew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* sqliteBtreePageDump(pCur-&gt;pBt, pCur-&gt;pgnoRoot, 1); */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* fflush(stdout); */</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">insertCell</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">Cell</span> <span class="o">*</span><span class="n">pCell</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sz</span><span class="o">==</span><span class="n">cellSize</span><span class="p">(</span><span class="n">pCell</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†é…ç©ºé—´ä¸è¶³ï¼Œidx==0è¯´æ˜æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">idx</span> <span class="o">=</span> <span class="n">allocateSpace</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">j</span><span class="o">&gt;</span><span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">&lt;=</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—´ä¸è¶³ï¼Œæ ‡è®°å·²overfull
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">pCell</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cell</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">allocateSpace</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nByte</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">nByte</span><span class="o">==</span><span class="n">ROUNDUP</span><span class="p">(</span><span class="n">nByte</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç©ºé—´ä¸è¶³æˆ–è€…ä¹‹å‰å·²ç»ä¸è¶³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">&lt;</span><span class="n">nByte</span> <span class="o">||</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="o">*</span><span class="n">pIdx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iSize</span><span class="o">&lt;</span><span class="n">nByte</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="o">/</span><span class="mi">4</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ²¡æœ‰ä¸€ä¸ªè¶³å¤Ÿå¤§çš„ç©ºé—²å—ï¼Œéœ€è¦æ•´ç†é¡µã€‚å°†æ‰€æœ‰çš„Cellç§»åŠ¨åˆ°é¡µçš„å¼€å§‹ï¼Œæœ€åæœ‰ä¸€ä¸ªå¤§çš„ç©ºé—²å—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">defragmentPage</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="o">*</span><span class="n">pIdx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ­£å¥½åŒ¹é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iSize</span><span class="o">==</span><span class="n">nByte</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†è£‚å‡ºä¸€ä¸ªæ–°å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FreeBlk</span> <span class="o">*</span><span class="n">pNew</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span> <span class="o">=</span> <span class="p">(</span><span class="n">FreeBlk</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">[</span><span class="n">start</span> <span class="o">+</span> <span class="n">nByte</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iNext</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">iSize</span> <span class="o">-</span> <span class="n">nByte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">nByte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">-=</span> <span class="n">nByte</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>sqliteBtreeDelete</code> ç”¨äºåˆ é™¤Cursorå½“å‰æŒ‡å‘çš„KVã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeDelete</span><span class="p">(</span><span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Cell</span> <span class="o">*</span><span class="n">pCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Pgno</span> <span class="n">pgnoChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ABORT</span><span class="p">;</span>  <span class="cm">/* A rollback destroyed this cursor */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>  <span class="cm">/* Must start a transaction first */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>  <span class="cm">/* The cursor is not pointing to anything */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">wrFlag</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">SQLITE_PERM</span><span class="p">;</span>   <span class="cm">/* Did not open this cursor for writing */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pCell</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">pgnoChild</span> <span class="o">=</span> <span class="n">pCell</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">clearCell</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pCell</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pgnoChild</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** The entry we are about to delete is not a leaf so if we do not
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** do something we will leave a hole on an internal page.
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** We have to fill the hole by moving in a cell from a leaf.  The
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** next Cell after the one to be deleted is guaranteed to exist and
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** to be a leaf so we can use it.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœä¸æ˜¯å¶èŠ‚ç‚¹ï¼Œå°†è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨è¿‡æ¥ï¼Œä»¥æ»¡è¶³Bæ ‘çš„è¦æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">BtCursor</span> <span class="n">leafCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Cell</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">szNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">getTempCursor</span><span class="p">(</span><span class="n">pCur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leafCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰¾åˆ°nextèŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqliteBtreeNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leafCur</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_CORRUPT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">leafCur</span><span class="p">.</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»å½“å‰page dropå½“å‰cell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dropCell</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">pCell</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">pNext</span> <span class="o">=</span> <span class="n">leafCur</span><span class="p">.</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">leafCur</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">szNext</span> <span class="o">=</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">pNext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿®æ”¹nextèŠ‚ç‚¹çš„leftChildå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">pNext</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="n">pgnoChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†nextèŠ‚ç‚¹æ’å…¥åˆ°å½“å‰çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">insertCell</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">pNext</span><span class="p">,</span> <span class="n">szNext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¹³è¡¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†nextèŠ‚ç‚¹dropæ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dropCell</span><span class="p">(</span><span class="n">leafCur</span><span class="p">.</span><span class="n">pPage</span><span class="p">,</span> <span class="n">leafCur</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">szNext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¹³è¡¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">,</span> <span class="n">leafCur</span><span class="p">.</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">releaseTempCursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leafCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// drop cell  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">dropCell</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">pCell</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">&gt;=</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">){</span> 
</span></span><span class="line"><span class="cl">        <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">bSkipNext</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pPage</span><span class="p">,</span> <span class="n">pCur</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¹³è¡¡æ“ä½œ">å¹³è¡¡æ“ä½œ</h3>
<p>åœ¨çœ‹balanceå®ç°ä¹‹å‰ï¼Œå…ˆçœ‹å‡ ä¸ªè¾…åŠ©å‡½æ•°</p>
<p><code>relinkCellList</code> ç”¨äºåœ¨æ’å…¥æˆ–åˆ é™¤Cellåï¼Œæ›´æ–°<code>MemPage.u.aDisk</code> ä¸­çš„nextæŒ‡é’ˆï¼Œè¿™æ˜¯å› ä¸ºåœ¨insertCellå’ŒdropCellä¸­åªå¤„ç†äº†MemPage.apCellï¼Œæ²¡æœ‰å¤„ç†aDiskä¸­çš„iNextã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">relinkCellList</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">idx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="o">&lt;</span><span class="n">SQLITE_PAGE_SIZE</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>copyPage</code> ç”¨äºæ‹·è´å­˜åœ¨overfullæ—¶çš„pageï¼Œå¯¹äºä¸åœ¨pageçš„Cellï¼Œæ‹·è´åçš„pageä»ç„¶æŒ‡å‘åŸå†…å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">copyPage</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pTo</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">*</span><span class="n">pFrom</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">uptr</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">memcpy</span><span class="p">(</span><span class="n">pTo</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">,</span> <span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">aDisk</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="o">=</span> <span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">nFree</span> <span class="o">=</span> <span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="o">=</span> <span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">isOverfull</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">to</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pTo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">from</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pFrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pTo</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">uptr</span> <span class="n">x</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœåœ¨pageèŒƒå›´å†…ï¼Œæ›´æ–°ï¼Œå¦åˆ™ç”¨fromçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">x</span><span class="o">&gt;</span><span class="n">from</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">&lt;</span><span class="n">from</span><span class="o">+</span><span class="n">SQLITE_PAGE_SIZE</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="p">((</span><span class="n">uptr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pTo</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">to</span> <span class="o">-</span> <span class="n">from</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">pTo</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pFrom</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>reparentChildPages</code> ç”¨äºåœ¨ç§»åŠ¨pageåä¿®æ”¹å†…å­˜ä¸­çš„childé¡µçš„<code>pParent</code> æŒ‡é’ˆï¼Œå› ä¸º<code>pParent</code> æŒ‡é’ˆä»…åœ¨å†…å­˜ä¸­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨å®ç°æ—¶ä¸éœ€è¦ä»ç£ç›˜åŠ è½½æ²¡æœ‰ç¼“å­˜çš„pageã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">reparentChildPages</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">reparentPage</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">,</span> <span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">reparentPage</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">,</span> <span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">reparentPage</span><span class="p">(</span><span class="n">Pager</span> <span class="o">*</span><span class="n">pPager</span><span class="p">,</span> <span class="n">Pgno</span> <span class="n">pgno</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">*</span><span class="n">pNewParent</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">MemPage</span> <span class="o">*</span><span class="n">pThis</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pgno</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">pPager</span><span class="o">!=</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åªéœ€è¦ä¿®æ”¹å†…å­˜ä¸­ç¼“å­˜çš„é¡µçš„parentï¼Œå› æ­¤è°ƒlookupè€Œä¸æ˜¯get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">pThis</span> <span class="o">=</span> <span class="n">sqlitepager_lookup</span><span class="p">(</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgno</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pThis</span> <span class="o">&amp;&amp;</span> <span class="n">pThis</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pThis</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="o">!=</span><span class="n">pNewParent</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pThis</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="p">)</span> <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pThis</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pThis</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="o">=</span> <span class="n">pNewParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pNewParent</span> <span class="p">)</span> <span class="n">sqlitepager_ref</span><span class="p">(</span><span class="n">pNewParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pThis</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é“ºå«å®Œæˆï¼Œä¸‹é¢æ¥çœ‹Bæ ‘çš„å¹³è¡¡å®ç°ã€‚</p>
<p><code>balance</code> ç”¨äºå®ç°Bæ ‘çš„å¹³è¡¡ï¼Œå®ƒçš„åŸºæœ¬æ€æƒ³å¾ˆç®€å•ï¼Œæ‰¾åˆ°é¡µé¢ç›¸é‚»çš„ä¸¤ä¸ªå…„å¼Ÿé¡µé¢ï¼Œç„¶åæ ¹æ®è¿™ä¸‰ä¸ªé¡µé¢çš„æ€»ç©ºé—´éœ€æ±‚ï¼Œåˆ†é…æ–°çš„é¡µé¢æ¥å­˜å‚¨ï¼Œæ–°çš„é¡µé¢çš„freeç©ºé—´å°½å¯èƒ½å‡åŒ€ã€‚æœ€ç»ˆå…„å¼Ÿé¡µé¢çš„ä¸ªæ•°å¯èƒ½ä¼šåŠ 1æˆ–å‡1ï¼Œç›®æ ‡æ˜¯é¡µé¢çš„ç©ºé—´ä½¿ç”¨åœ¨66%åˆ°100%ä¹‹é—´ã€‚</p>
<p>1 å…ˆçœ‹root pageçš„å¤„ç†ã€‚</p>
<ul>
<li>å¦‚æœCellä¸ªæ•°ä¸º0ï¼Œä¸”æœ‰rightChildï¼Œå°†rightChildçš„é¡µæ‹·è´è¿‡æ¥ä½œä¸ºæ–°çš„root pageã€‚æ‹·è´ä¹‹åéœ€è¦ä¿®æ”¹å†…å­˜ä¸­childé¡µçš„parentæŒ‡é’ˆã€‚</li>
<li>å¦‚æœrooté¡µoverfullï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„childé¡µæ‹·è´è¿‡å»ï¼Œç„¶åå°†rooté¡µè®¾ç½®ä¸ºç©ºï¼Œå¹¶ä¸”rightChildæŒ‡å‘æ–°é¡µï¼Œåé¢çš„é€»è¾‘ä¼šæ‰§è¡Œæ–°é¡µçš„splitã€‚é€šè¿‡è¿™æ ·çš„å¤„ç†å¯ä»¥å¤ç”¨érooté¡µçš„balanceé€»è¾‘ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">balance</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">,</span> <span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">,</span> <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// çœç•¥ä¸€äº›å˜é‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="n">pParent</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">pParent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 1 rooté¡µå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">pParent</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">Pgno</span> <span class="n">pgnoChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemPage</span> <span class="o">*</span><span class="n">pChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å¦‚æœroot pageæ²¡æœ‰cellä½†rightChildä¸ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span><span class="p">(</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        ** The root page is empty.  Copy the one child page
</span></span></span><span class="line"><span class="cl"><span class="cm">        ** into the root page and return.  This reduces the depth
</span></span></span><span class="line"><span class="cl"><span class="cm">        ** of the BTree by one.
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="n">pgnoChild</span> <span class="o">=</span> <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgnoChild</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‹·è´è¿‡æ¥åé‡æ–°åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">memcpy</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">pChild</span><span class="p">,</span> <span class="n">SQLITE_PAGE_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">rc</span> <span class="o">=</span> <span class="n">initPage</span><span class="p">(</span><span class="n">pPage</span><span class="p">,</span> <span class="n">sqlitepager_pagenumber</span><span class="p">(</span><span class="n">pPage</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">assert</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‹·è´ä¹‹åï¼Œä¿®æ”¹å†…å­˜ä¸­çš„childé¡µçš„parentæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">reparentChildPages</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span> <span class="o">&amp;&amp;</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="n">pChild</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">          <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">sqlitepager_ref</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">freePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pChild</span><span class="p">,</span> <span class="n">pgnoChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">relinkCellList</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/* It is OK for the root page to be less than half full.
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span>
</span></span><span class="line"><span class="cl">      <span class="n">relinkCellList</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** If we get to here, it means the root page is overfull.
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** When this happens, Create a new child page and copy the
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** contents of the root into the child.  Then make the root
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** page an empty page with rightChild pointing to the new
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** child.  Then fall thru to the code below which will cause
</span></span></span><span class="line"><span class="cl"><span class="cm">    ** the overfull child page to be split.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// rooté¡µoverfullï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„childé¡µæ‹·è´è¿‡å»ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç„¶åå°†rooté¡µè®¾ç½®ä¸ºç©ºï¼Œå¹¶ä¸”rightChildæŒ‡å‘æ–°é¡µï¼Œåé¢çš„é€»è¾‘ä¼šæ‰§è¡Œæ–°é¡µçš„split
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">allocatePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pChild</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pgnoChild</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pChild</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å’Œä¸Šé¢memcpyç„¶åinitPageçš„åŒºåˆ«åœ¨äºï¼ŒcopyPageä¼šè€ƒè™‘overfullï¼Œè¿™äº›cellä»ç„¶æŒ‡å‘pFromçš„åŸå§‹å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">copyPage</span><span class="p">(</span><span class="n">pChild</span><span class="p">,</span> <span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pChild</span><span class="o">-&gt;</span><span class="n">pParent</span> <span class="o">=</span> <span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_ref</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pChild</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span> <span class="o">&amp;&amp;</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="o">==</span><span class="n">pPage</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="n">pChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">extraUnref</span> <span class="o">=</span> <span class="n">pChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">zeroPage</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="o">=</span> <span class="n">pgnoChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pParent</span> <span class="o">=</span> <span class="n">pPage</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pPage</span> <span class="o">=</span> <span class="n">pChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// éœ€è¦ä¿®æ”¹parenté¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_write</span><span class="p">(</span><span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>2 åœ¨é¡µçš„å·¦å³å„å–ä¸€ä¸ªå…„å¼Ÿã€‚å¦‚æœé¡µæ˜¯æœ€å·¦æˆ–æœ€å³æ—¶ï¼Œä¼šå–åŒä¸€è¾¹çš„ä¸¤ä¸ªå…„å¼Ÿã€‚å¦‚æœå…„å¼Ÿä¸ªæ•°å°‘äºç­‰äº3ï¼Œä¼šç”¨ä¸Šæ‰€æœ‰çš„å…„å¼Ÿé¡µã€‚è¿™äº›é¡µçš„CellåŠ ä¸Šparentä¸­åˆ†å‰²çš„Cellä¼šä¸€èµ·è®¡ç®—æ€»çš„ç©ºé—´éœ€æ±‚ï¼Œç”¨äºåˆ†é…æ–°é¡µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// çœç•¥ä¸€äº›é€»è¾‘ï¼Œè®¾ç½®idxä¸ºparenté¡µæŒ‡å‘æœ¬é¡µçš„Cellçš„ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2 åœ¨é¡µå·¦å³å„å–ä¸€ä¸ªå…„å¼Ÿã€‚å¦‚æœé¡µæ˜¯æœ€å·¦æˆ–æœ€å³æ—¶ï¼Œä¼šå–åŒä¸€è¾¹çš„ä¸¤ä¸ªå…„å¼Ÿã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å¦‚æœå…„å¼Ÿä¸ªæ•°å°‘äºç­‰äº3ï¼Œä¼šç”¨ä¸Šæ‰€æœ‰çš„å…„å¼Ÿé¡µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span><span class="p">(</span> <span class="n">idx</span><span class="o">==</span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">nxDiv</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">nxDiv</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">nxDiv</span><span class="o">&lt;</span><span class="mi">0</span> <span class="p">)</span> <span class="n">nxDiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">nDiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">nxDiv</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// parentåªåˆ†å‰²Cellçš„index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">idxDiv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è·å–parentä¸­çš„åˆ†å‰²Cellï¼Œä¼šå’Œå…„å¼Ÿpageçš„Cellä¸€èµ·ç”¨äºåˆ†é…æ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">apDiv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">nDiv</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">apDiv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> <span class="nf">if</span><span class="p">(</span> <span class="n">k</span><span class="o">==</span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è½½å…„å¼Ÿé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_get</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">balance_cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">initPage</span><span class="p">(</span><span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">balance_cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nOld</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3 å°†æ‰¾åˆ°çš„å…„å¼Ÿé¡µæ‹·è´åˆ°å†…å­˜ä¸­çš„ä¸´æ—¶é¡µï¼Œå› ä¸ºè¿™äº›å…„å¼Ÿé¡µåç»­å¯èƒ½ä¼šä¿®æ”¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 3 å°†è¿™äº›é¡µæ‹·è´åˆ°å†…å­˜ä¸­æ–°é¡µï¼Œå› ä¸ºåŸå§‹é¡µæœ‰å¯èƒ½ä¿®æ”¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nOld</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">copyPage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aOld</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">freePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">balance_cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aOld</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4  è®¡ç®—å…„å¼Ÿé¡µå’Œparentä¸­çš„åˆ†å‰²Celléœ€è¦ä½¿ç”¨çš„ç©ºé—´ï¼ŒæŠŠè¿™äº›Celléƒ½æ‹·è´åˆ°apCellæ•°ç»„ï¼Œç„¶åè®¡ç®—éœ€è¦åˆ†é…å¤šå°‘æ–°é¡µï¼Œæ¯ä¸ªæ–°é¡µçš„å‰©ä½™ç©ºé—´ä¿è¯ç›¸å¯¹å‡åŒ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// 4 è®¡ç®—å…„å¼Ÿé¡µå’Œparentä¸­çš„åˆ†å‰²Celléœ€è¦ä½¿ç”¨çš„ç©ºé—´ï¼ŒæŠŠè¿™äº›Celléƒ½æ‹·è´åˆ°apCellæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Cell</span> <span class="o">*</span><span class="n">apCell</span><span class="p">[</span><span class="n">MX_CELL</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>   <span class="cm">/* All cells from pages being balanceed */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">szCell</span><span class="p">[</span><span class="n">MX_CELL</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">5</span><span class="p">];</span>     <span class="cm">/* Local size of all cells */</span>
</span></span><span class="line"><span class="cl">  <span class="n">nCell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nOld</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemPage</span> <span class="o">*</span><span class="n">pOld</span> <span class="o">=</span> <span class="n">apOld</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">pOld</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">apCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span> <span class="o">=</span> <span class="n">pOld</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">szCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">apCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">nCell</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‹·è´parentä¸­çš„åˆ†å‰²Cell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nOld</span><span class="o">-</span><span class="mi">1</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">szCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellSize</span><span class="p">(</span><span class="n">apDiv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aTemp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">apDiv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">szCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">apCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aTemp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä¸´æ—¶ä»parentä¸­åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">dropCell</span><span class="p">(</span><span class="n">pParent</span><span class="p">,</span> <span class="n">nxDiv</span><span class="p">,</span> <span class="n">szCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">apCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="o">==</span><span class="n">pgnoOld</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">apCell</span><span class="p">[</span><span class="n">nCell</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="n">pOld</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">nCell</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¡ç®—æ€»çš„size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">totalSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">totalSize</span> <span class="o">+=</span> <span class="n">szCell</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">cntNew</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>               <span class="cm">/* Index in apCell[] of cell after i-th page */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">szNew</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>                <span class="cm">/* Combined size of cells place on i-th page */</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">subtotal</span><span class="o">=</span><span class="n">k</span><span class="o">=</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">subtotal</span> <span class="o">+=</span> <span class="n">szCell</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// #define USABLE_SPACE  (SQLITE_PAGE_SIZE - sizeof(PageHdr))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ†é…ä¸€ä¸ªæ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span><span class="p">(</span> <span class="n">subtotal</span> <span class="o">&gt;</span> <span class="n">USABLE_SPACE</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">szNew</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtotal</span> <span class="o">-</span> <span class="n">szCell</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">cntNew</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">subtotal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">k</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">szNew</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtotal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">cntNew</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">k</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ç»è¿‡ä¸Šä¸€ä¸ªå¾ªç¯ï¼Œå‰é¢çš„é¡µä¼šæ¥è¿‘æ»¡ï¼Œè€Œåé¢çš„é¡µæœ‰å¯èƒ½æ¥è¿‘ç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ä¸‹é¢çš„å¾ªç¯å†è¿›è¡Œè°ƒæ•´ï¼Œè‡³å°‘å æ»¡USABLE_SPACE/2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span> <span class="n">szNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">USABLE_SPACE</span><span class="o">/</span><span class="mi">2</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä»å‰é¢æŒªCell
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">cntNew</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">cntNew</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">szNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">szCell</span><span class="p">[</span><span class="n">cntNew</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">      <span class="n">szNew</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">szCell</span><span class="p">[</span><span class="n">cntNew</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">cntNew</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="c1">// åˆ†é…kä¸ªæ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">k</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">allocatePage</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pgnoNew</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span> <span class="p">)</span> <span class="k">goto</span> <span class="n">balance_cleanup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nNew</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">zeroPage</span><span class="p">(</span><span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isInit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>5 å°†æ–°é¡µæŒ‰ç…§é¡µå·æ’åºï¼Œç„¶åå†™å…¥Cellåˆ°æ–°é¡µï¼Œå¹¶æŠŠåˆ†å‰²çš„Cellæ’å…¥åˆ°parentä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">  <span class="c1">// 5 å°†æ–°é¡µæŒ‰ç…§é¡µå·æ’åºï¼Œæ’åºåç£ç›˜æ–‡ä»¶æ˜¯æœ‰åºçš„ï¼Œscanæ“ä½œæ˜¯çº¿æ€§çš„ã€‚æ³¨é‡Šä¸­è¯´æ’åºå¯ä»¥è®©å¤§çš„æ’å…¥å’Œåˆ é™¤å¿«25%ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">minV</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">minI</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">k</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&lt;</span><span class="n">minV</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="n">minI</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">minV</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">minI</span><span class="o">&gt;</span><span class="n">i</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">MemPage</span> <span class="o">*</span><span class="n">pT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">t</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">pT</span> <span class="o">=</span> <span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">pgnoNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">minI</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">apNew</span><span class="p">[</span><span class="n">minI</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">pgnoNew</span><span class="p">[</span><span class="n">minI</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">apNew</span><span class="p">[</span><span class="n">minI</span><span class="p">]</span> <span class="o">=</span> <span class="n">pT</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** Evenly distribute the data in apCell[] across the new pages.
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** Insert divider cells into pParent as necessary.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nNew</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">MemPage</span> <span class="o">*</span><span class="n">pNew</span> <span class="o">=</span> <span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">cntNew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">assert</span><span class="p">(</span> <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">nFree</span><span class="o">&gt;=</span><span class="n">szCell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ’å…¥åˆ°é¡µä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">insertCell</span><span class="p">(</span><span class="n">pNew</span><span class="p">,</span> <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">,</span> <span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">szCell</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="o">!</span><span class="n">pNew</span><span class="o">-&gt;</span><span class="n">isOverfull</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»´æŠ¤Cellçš„nextæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">relinkCellList</span><span class="p">(</span><span class="n">pNew</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nNew</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">&lt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æŒ‰ç…§Bæ ‘çš„æ€§è´¨ï¼Œå³å…„å¼ŸèŠ‚ç‚¹çš„å­ç»“ç‚¹ä¹Ÿå¤§äºè‡ªå·±ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯è®¾ç½®rightChild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">pNew</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="o">=</span> <span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// è®¾ç½®parentçš„åˆ†å‰²Cellçš„leftChildä¸ºpgnoNew[i]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// åˆ†å‰²çš„Cellæ’å…¥parent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">insertCell</span><span class="p">(</span><span class="n">pParent</span><span class="p">,</span> <span class="n">nxDiv</span><span class="p">,</span> <span class="n">apCell</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">szCell</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">nxDiv</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">j</span><span class="o">==</span><span class="n">nCell</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">apNew</span><span class="p">[</span><span class="n">nNew</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="o">=</span> <span class="n">apOld</span><span class="p">[</span><span class="n">nOld</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">nxDiv</span><span class="o">==</span><span class="n">pParent</span><span class="o">-&gt;</span><span class="n">nCell</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">rightChild</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">nNew</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pParent</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">nxDiv</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">leftChild</span> <span class="o">=</span> <span class="n">pgnoNew</span><span class="p">[</span><span class="n">nNew</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>6 æœ€ååšä¸€äº›ç»´æŠ¤å·¥ä½œã€‚ç”±äºbalanceå¯èƒ½ä¿®æ”¹parentï¼Œæ‰€ä»¥å¯¹parentè°ƒç”¨balanceã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** Reparent children of all cells.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nNew</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">reparentChildPages</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">apNew</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">reparentChildPages</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">,</span> <span class="n">pParent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">  ** balance the parent page.
</span></span></span><span class="line"><span class="cl"><span class="cm">  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">balance</span><span class="p">(</span><span class="n">pBt</span><span class="p">,</span> <span class="n">pParent</span><span class="p">,</span> <span class="n">pCur</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="äº‹åŠ¡æ“ä½œ">äº‹åŠ¡æ“ä½œ</h3>
<p>å¤šä¸ªè¯»äº‹åŠ¡å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚</p>
<p>å†™äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œå…¶ä»–è¯»å†™äº‹åŠ¡éƒ½ä¸èƒ½æ‰§è¡Œã€‚</p>
<p>äº‹åŠ¡å®ç°åŸºæœ¬å°±æ˜¯è°ƒç”¨ä¸‹Pagerçš„äº‹åŠ¡æ“ä½œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeBeginTrans</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="o">==</span><span class="mi">0</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// åŠ è½½é¡µé¢ï¼Œå¦‚æœæ•°æ®åº“ä¸ä¸ºç©ºï¼Œæ ¡éªŒmagic number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rc</span> <span class="o">=</span> <span class="n">lockBtree</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">!=</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">rc</span> <span class="o">=</span> <span class="n">sqlitepager_begin</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">page1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">rc</span> <span class="o">=</span> <span class="n">newDatabase</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">rc</span><span class="o">==</span><span class="n">SQLITE_OK</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unlockBtreeIfUnused</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeRollback</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">BtCursor</span> <span class="o">*</span><span class="n">pCur</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">pCur</span><span class="o">=</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pCursor</span><span class="p">;</span> <span class="n">pCur</span><span class="p">;</span> <span class="n">pCur</span><span class="o">=</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pNext</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="p">){</span>
</span></span><span class="line"><span class="cl">      <span class="n">sqlitepager_unref</span><span class="p">(</span><span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">pCur</span><span class="o">-&gt;</span><span class="n">pPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="o">?</span> <span class="nl">SQLITE_OK</span> <span class="p">:</span> <span class="n">sqlitepager_rollback</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlockBtreeIfUnused</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sqliteBtreeCommit</span><span class="p">(</span><span class="n">Btree</span> <span class="o">*</span><span class="n">pBt</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span><span class="p">(</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span><span class="o">==</span><span class="mi">0</span> <span class="p">)</span> <span class="k">return</span> <span class="n">SQLITE_ERROR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">rc</span> <span class="o">=</span> <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">readOnly</span> <span class="o">?</span> <span class="nl">SQLITE_OK</span> <span class="p">:</span> <span class="n">sqlitepager_commit</span><span class="p">(</span><span class="n">pBt</span><span class="o">-&gt;</span><span class="n">pPager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inTrans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">pBt</span><span class="o">-&gt;</span><span class="n">inCkpt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">unlockBtreeIfUnused</span><span class="p">(</span><span class="n">pBt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¯¹æ¯”boltdb">å¯¹æ¯”BoltDB</h2>
<ol>
<li>sqliteè‡ªå·±åšpage bufferç®¡ç†ï¼Œéœ€è¦å¤„ç†pageæ·˜æ±°ã€è„é¡µå†™ç›˜ï¼Œè€ŒBoltDBä½¿ç”¨ç³»ç»Ÿmmapæ¥ç®¡ç†å†…å­˜ï¼Œå¾ˆå¤šç®¡ç†é€»è¾‘éƒ½å§”æ‰˜ç»™OSï¼Œå®ç°ç›¸å¯¹ç®€å•ã€‚</li>
<li>è¿™ä¸ªç‰ˆæœ¬çš„sqliteåªæœ‰Bæ ‘å®ç°ï¼Œè€ŒBoltDBä½¿ç”¨B+æ ‘å®ç°ã€‚</li>
<li>sqliteçš„rebalanceå®ç°æ›´åŠ å¤æ‚ï¼ŒBoltDBç›¸å¯¹ç®€å•ã€‚</li>
</ol>
<h2 id="ä»£ç æŠ€å·§">ä»£ç æŠ€å·§</h2>
<p>sqliteå®ç°ä¸­çš„ä¸€äº›ä»£ç æŠ€å·§å€¼å¾—å­¦ä¹ </p>
<ol>
<li>
<p>å°†åœ°å€å½“ä½œæ•°ç»„è®¿é—®ï¼Œç„¶åæ–¹ä¾¿çš„å®šä½åˆ°è¯¥ç»“æ„ä½“å‰åçš„å†…å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#define PGHDR_TO_DATA(P)  ((void*)(&amp;(P)[1]))
</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>é€šè¿‡æŒ‡é’ˆæ¥ç®€åŒ–ä¸€äº›å¤„ç†ï¼Œç±»ä¼¼äº<a href="https://coolshell.cn/articles/8990.html">Linusï¼šåˆ©ç”¨äºŒçº§æŒ‡é’ˆåˆ é™¤å•å‘é“¾è¡¨ | é…· å£³ - CoolShell</a>çš„æŠ€å·§ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå¦‚æœä¸ç”¨æŒ‡é’ˆï¼ŒfirstCellå’ŒiNextéœ€è¦åˆ†åˆ«å»è®¾ç½®ï¼Œä½†é€šè¿‡æŒ‡é’ˆæŠŠå®ƒä»¬çš„è®¾ç½®é€»è¾‘ç»Ÿä¸€äº†èµ·æ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">relinkCellList</span><span class="p">(</span><span class="n">MemPage</span> <span class="o">*</span><span class="n">pPage</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">u16</span> <span class="o">*</span><span class="n">pIdx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span> <span class="n">sqlitepager_iswriteable</span><span class="p">(</span><span class="n">pPage</span><span class="p">)</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">firstCell</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">nCell</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">Addr</span><span class="p">(</span><span class="n">pPage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span> <span class="n">idx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="o">&lt;</span><span class="n">SQLITE_PAGE_SIZE</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">pIdx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pPage</span><span class="o">-&gt;</span><span class="n">apCell</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">.</span><span class="n">iNext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">pIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
]]></content:encoded>
    </item>
    
    <item>
      <title>BoltDBæºç ç¬”è®°</title>
      <link>https://egolearner.github.io/post/boltdb-source-read/</link>
      <pubDate>Thu, 01 Dec 2022 19:43:42 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/boltdb-source-read/</guid>
      <description>&lt;p&gt;BoltDB å—LMDBå¯å‘ï¼Œæ˜¯åŸºäºappend only B+ treeå®ç°çš„KVå­˜å‚¨ã€‚&lt;/p&gt;
&lt;h2 id=&#34;pageå®ç°&#34;&gt;pageå®ç°&lt;/h2&gt;
&lt;p&gt;boltdbæ²¡æœ‰å®ç°è‡ªå·±çš„page bufferç®¡ç†å™¨ï¼Œè€Œæ˜¯ç›´æ¥ç”¨mmapæ¥ä»ç£ç›˜è¯»å–pageã€‚pageçš„å¤§å°å’ŒOSçš„å†…å­˜é¡µå¤§å°ç›¸åŒã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<p>BoltDB å—LMDBå¯å‘ï¼Œæ˜¯åŸºäºappend only B+ treeå®ç°çš„KVå­˜å‚¨ã€‚</p>
<h2 id="pageå®ç°">pageå®ç°</h2>
<p>boltdbæ²¡æœ‰å®ç°è‡ªå·±çš„page bufferç®¡ç†å™¨ï¼Œè€Œæ˜¯ç›´æ¥ç”¨mmapæ¥ä»ç£ç›˜è¯»å–pageã€‚pageçš„å¤§å°å’ŒOSçš„å†…å­˜é¡µå¤§å°ç›¸åŒã€‚</p>
<p>page headerç»“æ„å¦‚ä¸‹ï¼Œä»ptrå¼€å§‹ä¸ºpageé¡µçš„å­˜å‚¨å†…å®¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">pgid</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">page</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">id</span>       <span class="nx">pgid</span>    <span class="c1">// page id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">flags</span>    <span class="kt">uint16</span>  <span class="c1">// page ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">count</span>    <span class="kt">uint16</span>  <span class="c1">// å…ƒç´ çš„ä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">overflow</span> <span class="kt">uint32</span>  <span class="c1">// æ˜¯å¦æœ‰overflowé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ptr</span>      <span class="kt">uintptr</span> <span class="c1">// ptrå¼€å§‹ä¸ºæ•°æ®å­˜å‚¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>page.flags</code> å–å€¼å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">branchPageFlag</span>   <span class="p">=</span> <span class="mh">0x01</span>  <span class="c1">// å†…éƒ¨é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">leafPageFlag</span>     <span class="p">=</span> <span class="mh">0x02</span>  <span class="c1">// leaf é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">metaPageFlag</span>     <span class="p">=</span> <span class="mh">0x04</span>  <span class="c1">// meta é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">freelistPageFlag</span> <span class="p">=</span> <span class="mh">0x10</span>  <span class="c1">// ç©ºé—²pageåˆ—è¡¨é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡boltdbå­¦åˆ°äº†å¦‚ä½•ç”¨goå†™åº•å±‚ä»£ç ï¼Œå¦‚å°†ä¸€ä¸ª <code>byte[]</code> ä½œä¸ºpageè®¿é—®æ˜¯è¿™æ ·çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pageInBuffer retrieves a page reference from a given byte array based on the current page size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">pageInBuffer</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">id</span> <span class="nx">pgid</span><span class="p">)</span> <span class="o">*</span><span class="nx">page</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">page</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="nx">id</span><span class="o">*</span><span class="nf">pgid</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">)]))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="metaé¡µ">metaé¡µ</h3>
<p>boltdbæ•°æ®åº“çš„å‰ä¸¤ä¸ªé¡µä¸ºmetaé¡µï¼Œå­˜å‚¨å…ƒæ•°æ®ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">meta</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">magic</span>    <span class="kt">uint32</span>  <span class="c1">// 0xED0CDAED, ç”¨äºæ–‡ä»¶æ ¡éªŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">version</span>  <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pageSize</span> <span class="kt">uint32</span>  <span class="c1">// é¡µå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">flags</span>    <span class="kt">uint32</span>  <span class="c1">// è²Œä¼¼æœªä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">root</span>     <span class="nx">bucket</span>  <span class="c1">// root bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">freelist</span> <span class="nx">pgid</span>    <span class="c1">// ç©ºé—²page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pgid</span>     <span class="nx">pgid</span>    <span class="c1">// æ•°æ®åº“æ–‡ä»¶çš„æœ€å¤§page idï¼Œè¶…è¿‡éœ€è¦é‡æ–°mmapæˆ–è€…è¯´æ˜æœ‰é”™è¯¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">txid</span>     <span class="nx">txid</span>    <span class="c1">// ç”¨æ¥åˆ†é…å†™äº‹åŠ¡çš„idã€‚idæ›´å¤§çš„metaé¡µæ˜¯æœ€æ–°çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">checksum</span> <span class="kt">uint64</span>  <span class="c1">// æ–‡ä»¶æŸåæ ¡éªŒ
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>meta</code> å­˜å‚¨åœ¨ <code>page</code> ç»“æ„çš„ <code>page.ptr</code> ä½ç½®ï¼Œæ‰€ä»¥ä»pageè®¿é—®metaæ˜¯è¿™æ ·çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// meta returns a pointer to the metadata section of the page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="nf">meta</span><span class="p">()</span> <span class="o">*</span><span class="nx">meta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">meta</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>boltdbçš„ä¸¤ä¸ªmetaé¡µéšç€å†™å…¥çš„è¿›è¡Œä¼šæ¥å›åˆ‡æ¢ï¼Œæœ€æ–°çš„metaé¡µåŒ…å«å½“å‰çš„æœ€æ–°çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// meta retrieves the current meta page reference.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">meta</span><span class="p">()</span> <span class="o">*</span><span class="nx">meta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// We have to return the meta with the highest txid which doesn&#39;t fail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// validation. Otherwise, we can cause errors when in fact the database is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in a consistent state. metaA is the one with the higher txid.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">metaA</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta0</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metaB</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta1</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta1</span><span class="p">.</span><span class="nx">txid</span> <span class="p">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta0</span><span class="p">.</span><span class="nx">txid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metaA</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta1</span>
</span></span><span class="line"><span class="cl">		<span class="nx">metaB</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">meta0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use higher meta page if valid. Otherwise fallback to previous, if valid.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metaA</span><span class="p">.</span><span class="nf">validate</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">metaA</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">metaB</span><span class="p">.</span><span class="nf">validate</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">metaB</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// This should never be reached, because both meta1 and meta0 were validated
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// on mmap() and we do fsync() on every write.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;bolt.DB.meta(): invalid meta pages&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="branché¡µ">branché¡µ</h3>
<p>branché¡µå­˜å‚¨B+æ ‘çš„å†…éƒ¨èŠ‚ç‚¹æ•°æ®ï¼Œç”±<code>branchPageElement</code> æ•°ç»„å’Œkeyæ•°æ®æ„æˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// branchPageElement represents a node on a branch page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">branchPageElement</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pos</span>   <span class="kt">uint32</span>  <span class="c1">// key å­˜å‚¨ä½ç½®ç›¸å¯¹branchPageElementå­˜å‚¨ä½ç½®çš„åç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ksize</span> <span class="kt">uint32</span>  <span class="c1">// key size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pgid</span>  <span class="nx">pgid</span>    <span class="c1">// page id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>branchPageElementæ•°ç»„åŒæ ·å­˜å‚¨åœ¨<code>page</code> ç»“æ„çš„ <code>page.ptr</code> ä½ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// branchPageElement retrieves the branch node by index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="nf">branchPageElement</span><span class="p">(</span><span class="nx">index</span> <span class="kt">uint16</span><span class="p">)</span> <span class="o">*</span><span class="nx">branchPageElement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="p">[</span><span class="mh">0x7FFFFFF</span><span class="p">]</span><span class="nx">branchPageElement</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">)))[</span><span class="nx">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// branchPageElements retrieves a list of branch nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="nf">branchPageElements</span><span class="p">()</span> <span class="p">[]</span><span class="nx">branchPageElement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="p">[</span><span class="mh">0x7FFFFFF</span><span class="p">]</span><span class="nx">branchPageElement</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">)))[:]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>branchPageElement.pos</code> å­˜å‚¨çš„æ˜¯keyå­˜å‚¨ä½ç½®ç›¸å¯¹branchPageElementå­˜å‚¨ä½ç½®çš„åç§»é‡ï¼Œæ‰€ä»¥å¾—åˆ°keyçš„å®ç°å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// key returns a byte slice of the node key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">branchPageElement</span><span class="p">)</span> <span class="nf">key</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// nçš„åœ°å€åŠ ä¸Šn.poså¾—åˆ°keyçš„èµ·å§‹åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">pos</span><span class="p">]))[:</span><span class="nx">n</span><span class="p">.</span><span class="nx">ksize</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="leafé¡µ">leafé¡µ</h3>
<p>leafé¡µå­˜å‚¨B+æ ‘çš„é¡µèŠ‚ç‚¹æ•°æ®ï¼Œå¸ƒå±€å’Œbranché¡µç±»ä¼¼ï¼Œåªä¸è¿‡å¤šäº†valueã€‚leafé¡µç”±<code>leafPageElement</code> æ•°ç»„å’Œkey, valueæ•°æ®æ„æˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// leafPageElement represents a node on a leaf page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">leafPageElement</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flags</span> <span class="kt">uint32</span>  <span class="c1">// ä¸º1è¡¨ç¤ºå­bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pos</span>   <span class="kt">uint32</span>  <span class="c1">// key, valueå­˜å‚¨ä½ç½®çš„ç›¸å¯¹åç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">ksize</span> <span class="kt">uint32</span>  <span class="c1">// key size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">vsize</span> <span class="kt">uint32</span>  <span class="c1">// value size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»pageæ ¹æ®ä¸‹æ ‡è®¿é—®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// leafPageElement retrieves the leaf node by index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="nf">leafPageElement</span><span class="p">(</span><span class="nx">index</span> <span class="kt">uint16</span><span class="p">)</span> <span class="o">*</span><span class="nx">leafPageElement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="p">((</span><span class="o">*</span><span class="p">[</span><span class="mh">0x7FFFFFF</span><span class="p">]</span><span class="nx">leafPageElement</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">)))[</span><span class="nx">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®¿é—®key, valueå®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// key returns a byte slice of the node key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">leafPageElement</span><span class="p">)</span> <span class="nf">key</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æœ€åçš„:n.ksizeç”¨æ¥é™åˆ¶sliceçš„compacity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">pos</span><span class="p">]))[:</span><span class="nx">n</span><span class="p">.</span><span class="nx">ksize</span><span class="p">:</span><span class="nx">n</span><span class="p">.</span><span class="nx">ksize</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// value returns a byte slice of the node value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">leafPageElement</span><span class="p">)</span> <span class="nf">value</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">pos</span><span class="o">+</span><span class="nx">n</span><span class="p">.</span><span class="nx">ksize</span><span class="p">]))[:</span><span class="nx">n</span><span class="p">.</span><span class="nx">vsize</span><span class="p">:</span><span class="nx">n</span><span class="p">.</span><span class="nx">vsize</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="freelisté¡µ">freelisté¡µ</h3>
<p>freelisté¡µå­˜å‚¨ç©ºé—²çš„é¡µè¡¨ï¼Œç”¨äºé‡ç”¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// freelist represents a list of all pages that are available for allocation.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It also tracks pages that have been freed but are still in use by open transactions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">freelist</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ids</span>     <span class="p">[]</span><span class="nx">pgid</span>          <span class="c1">// all free and available free page ids.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è®°å½•æ‰§è¡Œä¸­çš„äº‹åŠ¡ç”¨åˆ°çš„é¡µè¡¨ï¼Œç”¨äºå®‰å…¨çš„é‡ç”¨é¡µè¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pending</span> <span class="kd">map</span><span class="p">[</span><span class="nx">txid</span><span class="p">][]</span><span class="nx">pgid</span> <span class="c1">// mapping of soon-to-be free page ids by tx.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è®°å½•é¡µæ˜¯å¦ç©ºé—²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cache</span>   <span class="kd">map</span><span class="p">[</span><span class="nx">pgid</span><span class="p">]</span><span class="kt">bool</span>   <span class="c1">// fast lookup of all free and pending page ids.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç£ç›˜ä¸Šåªéœ€è¦å­˜å‚¨ <code>freelist.ids</code> ï¼Œè€Œpendingå’Œcacheåªåœ¨å†…å­˜ä¸­ç»´æŠ¤ã€‚ä¸‹é¢çš„åŠ è½½å‡½æ•°ï¼Œä»ç£ç›˜ä¸ŠåŠ è½½ç©ºé—²é¡µçš„idæ•°ç»„ï¼Œç„¶åé€šè¿‡reindexæ¥é‡å»ºcacheå­—æ®µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// read initializes the freelist from a freelist page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">freelist</span><span class="p">)</span> <span class="nf">read</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If the page.count is at the max uint16 value (64k) then it&#39;s considered
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// an overflow and the size of the freelist is stored as the first element.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">idx</span><span class="p">,</span> <span class="nx">count</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">count</span> <span class="o">==</span> <span class="mh">0xFFFF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">idx</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="nx">count</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(((</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="nx">pgid</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Copy the list of page ids from the freelist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">f</span><span class="p">.</span><span class="nx">ids</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ids</span> <span class="o">:=</span> <span class="p">((</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="nx">pgid</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">)))[</span><span class="nx">idx</span><span class="p">:</span><span class="nx">count</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">f</span><span class="p">.</span><span class="nx">ids</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">pgid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ids</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nb">copy</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">,</span> <span class="nx">ids</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Make sure they&#39;re sorted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nf">pgids</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Rebuild the page cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">f</span><span class="p">.</span><span class="nf">reindex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨allocateå‡½æ•°ä¸­ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨nä¸ªè¿ç»­çš„é¡µï¼Œå¦‚æœå­˜åœ¨çš„è¿”å›èµ·å§‹é¡µçš„page idï¼Œå¦åˆ™è¿”å›0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// allocate returns the starting page id of a contiguous list of pages of a given size.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If a contiguous block cannot be found then 0 is returned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">freelist</span><span class="p">)</span> <span class="nf">allocate</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">pgid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">initial</span><span class="p">,</span> <span class="nx">previd</span> <span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">id</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">f</span><span class="p">.</span><span class="nx">ids</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">id</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;invalid page allocation: %d&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Reset initial page if this is not contiguous.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">previd</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">id</span><span class="o">-</span><span class="nx">previd</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">initial</span> <span class="p">=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If we found a contiguous block then remove it and return it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="o">-</span><span class="nx">initial</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="nf">pgid</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// If we&#39;re allocating off the beginning then take the fast path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// and just adjust the existing slice. This will use extra memory
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// temporarily but the append() in free() will realloc the slice
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// as is necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="nx">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">f</span><span class="p">.</span><span class="nx">ids</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">copy</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">				<span class="nx">f</span><span class="p">.</span><span class="nx">ids</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">ids</span><span class="p">)</span><span class="o">-</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Remove from the free cache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nf">pgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nf">pgid</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nb">delete</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">cache</span><span class="p">,</span> <span class="nx">initial</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">initial</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">previd</span> <span class="p">=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nodeç»“æ„">nodeç»“æ„</h3>
<p>pageç»“æ„ä½“å’Œç£ç›˜ä¸Šå­˜å‚¨çš„ç»“æ„ç›´æ¥å¯¹åº”ï¼Œä½¿ç”¨æ—¶å¹¶ä¸æ–¹ä¾¿ï¼Œæ¯”å¦‚ä¸Šé¢ä»‹ç»çš„ <code>page.meta()</code> å‡½æ•°å°±æ˜¯ä¸ºäº†æ–¹ä¾¿è®¿é—®å…ƒæ•°æ®å­—æ®µçš„ã€‚boltdbä¸­æœ€å¤šçš„è¿˜æ˜¯branché¡µå’Œleafé¡µï¼Œå› æ­¤ä¸“é—¨å®šä¹‰äº†nodeæ¥è¡¨ç¤ºåŠ è½½åˆ°å†…å­˜ä¸­çš„pageï¼Œä¾¿äºè®¿é—®branché¡µå’Œleafé¡µçš„æ•°æ®ã€‚å†™äº‹åŠ¡æ‰§è¡Œçš„æ’å…¥å’Œåˆ é™¤ä¹Ÿæ˜¯å…ˆæ›´æ–°åˆ°å†…å­˜ä¸­çš„nodeä¸­ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰åˆ·æ–°åˆ°ç£ç›˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// inode represents an internal node inside of a node.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It can be used to point to elements in a page or point
</span></span></span><span class="line"><span class="cl"><span class="c1">// to an element which hasn&#39;t been added to a page yet.
</span></span></span><span class="line"><span class="cl"><span class="c1">// inode ç»Ÿä¸€è¡¨ç¤ºä¸­é—´èŠ‚ç‚¹å’Œå¶èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">inode</span> <span class="kd">struct</span> 
</span></span><span class="line"><span class="cl">	<span class="nx">flags</span> <span class="kt">uint32</span>  <span class="c1">// å¯¹åº”leafPageElement.flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pgid</span>  <span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">	<span class="nx">key</span>   <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span>  <span class="c1">// ä¸­é—´èŠ‚ç‚¹çš„valueä¸ºnil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">inodes</span> <span class="p">[]</span><span class="nx">inode</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// node represents an in-memory, deserialized page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">node</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bucket</span>     <span class="o">*</span><span class="nx">Bucket</span>
</span></span><span class="line"><span class="cl">	<span class="nx">isLeaf</span>     <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">unbalanced</span> <span class="kt">bool</span>  <span class="c1">// æœ‰åˆ é™¤æ—¶ä¼šè®¾ç½®ä¸ºtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">spilled</span>    <span class="kt">bool</span>  <span class="c1">// æ˜¯å¦å·²ç»åˆ†è£‚å’Œåˆ†é…è„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span>        <span class="p">[]</span><span class="kt">byte</span>  <span class="c1">// ç¬¬0ä¸ªkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">pgid</span>       <span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">	<span class="nx">parent</span>     <span class="o">*</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">	<span class="nx">children</span>   <span class="nx">nodes</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¶å­èŠ‚ç‚¹çš„key/valueæ•°ç»„ï¼Œä¸­é—´èŠ‚ç‚¹çš„keyæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">inodes</span> <span class="nx">inodes</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">nodes</span> <span class="p">[]</span><span class="o">*</span><span class="nx">node</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>nodeå’Œpageçš„ç›¸äº’è½¬æ¢é€»è¾‘å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// read initializes the node from a page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">read</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="p">=</span> <span class="p">((</span><span class="nx">p</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="nx">leafPageFlag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">inodes</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">inode</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">leafPageElement</span><span class="p">(</span><span class="nb">uint16</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">inode</span><span class="p">.</span><span class="nx">flags</span> <span class="p">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">flags</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ä»pageè¯»åˆ°key/valueï¼Œå†™å…¥inodeç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">inode</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">inode</span><span class="p">.</span><span class="nx">value</span> <span class="p">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">value</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">branchPageElement</span><span class="p">(</span><span class="nb">uint16</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">inode</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">			<span class="nx">inode</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">key</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">inode</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;read: zero-length inode key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Save first key so we can find the node in the parent when we spill.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;read: zero-length node key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// write writes the items onto one or more pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">write</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Initialize page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">leafPageFlag</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">branchPageFlag</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xFFFF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;inode overflow: %d (pgid=%d)&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">),</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Stop here if there are no items to write.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Loop over each item and write it to the page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// bæŒ‡å‘key/valueæˆ–keyçš„èµ·å§‹ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">ptr</span><span class="p">))[</span><span class="nx">n</span><span class="p">.</span><span class="nf">pageElementSize</span><span class="p">()</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;write: zero-length inode key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Write the page element.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">leafPageElement</span><span class="p">(</span><span class="nb">uint16</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// posä¸ºbä¸elemçš„åœ°å€å·®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">elem</span><span class="p">.</span><span class="nx">pos</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">elem</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">flags</span> <span class="p">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">flags</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">ksize</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">vsize</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">value</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">branchPageElement</span><span class="p">(</span><span class="nb">uint16</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">pos</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">elem</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">ksize</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">			<span class="nf">_assert</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">pgid</span> <span class="o">!=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;write: circular dependency occurred&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If the length of key+value is larger than the max allocation size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// then we need to reallocate the byte array pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// See: https://github.com/boltdb/bolt/pull/335
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">klen</span><span class="p">,</span> <span class="nx">vlen</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">klen</span><span class="o">+</span><span class="nx">vlen</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nx">maxAllocSize</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[:]</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Write data for the element to the end of the page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// å¤åˆ¶keyå’Œvalueï¼Œç„¶åæ›´æ–°båˆ°ä¸‹ä¸€ä¸ªkey/valueæˆ–keyçš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nb">copy</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:],</span> <span class="nx">item</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">klen</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">		<span class="nb">copy</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:],</span> <span class="nx">item</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">vlen</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// DEBUG ONLY: n.dump()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ’å…¥åˆ é™¤KVæ—¶ä¼šå…ˆä¿®æ”¹åœ¨å†…å­˜ä¸­nodeç»“æ„ï¼Œæ­¤æ—¶B+æ ‘å¯èƒ½æ˜¯ä¸å¹³è¡¡çš„ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶ä¼šè¿›è¡Œrebalanceå’Œå†™ç›˜ã€‚åœ¨åˆ é™¤keyæ—¶ï¼Œå°†äºŒåˆ†æ‰¾åˆ°çš„ä¸‹æ ‡ä½ç½®çš„å…ƒç´ åˆ é™¤ï¼Œåªä¼šä¿®æ”¹å†…å­˜ï¼Œåœ¨äº‹åŠ¡æäº¤æ—¶æ‰ä¼šå®é™…åˆ·æ–°åˆ°ç£ç›˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// del removes a key from the node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">del</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Find index of key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">sort</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Exit if the key isn&#39;t found.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">)</span> <span class="o">||</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Delete inode from the node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ä»inodesä¸­åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[:</span><span class="nx">index</span><span class="p">],</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Mark the node as needing rebalancing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nx">unbalanced</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ’å…¥keyçš„å®ç°ç±»ä¼¼ï¼ŒåŒæ ·åªä¼šä¿®æ”¹å†…å­˜ã€‚</p>
<h2 id="bucketå®ç°">Bucketå®ç°</h2>
<p>boltdbä¸­çš„Bucketç›¸å½“äºmysqlçš„è¡¨ï¼Œå¯ä»¥å­˜å‚¨KVå¯¹ã€‚Bucketä¹Ÿæ”¯æŒåµŒå¥—ã€‚boltdbä¸­æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ¹Bucketï¼Œå…¶ä»–çš„Bucketéƒ½æ˜¯å®ƒçš„å­å­™Bucketã€‚åœ¨ <code>meta.root</code> ä¸­å­˜å‚¨æ ¹Bucketçš„rooté¡µidã€‚åœ¨äº‹åŠ¡åˆå§‹åŒ–æ—¶ä¼šç”¨æ¥è®¾ç½®äº‹åŠ¡çš„root.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// init initializes the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nf">init</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="p">=</span> <span class="nx">db</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">pages</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Copy the meta page since it can be changed by the writer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">meta</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nf">meta</span><span class="p">().</span><span class="nb">copy</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Copy over the root bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">root</span> <span class="p">=</span> <span class="nf">newBucket</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">bucket</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è®¾ç½®root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="o">*</span><span class="nx">tx</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Increment the transaction id and add a page cache for writable transactions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nx">pages</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">pgid</span><span class="p">]</span><span class="o">*</span><span class="nx">page</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span> <span class="o">+=</span> <span class="nf">txid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯ä¸ªå­Bucketéƒ½å­˜å‚¨åœ¨çˆ¶Bucketçš„leafé¡µä¸­ï¼Œæ­¤æ—¶<code>leafPageElement.flags</code> ä¼šè®¾ç½®ä¸º<code>bucketLeafFlag</code> ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bucketLeafFlag</span> <span class="p">=</span> <span class="mh">0x01</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç£ç›˜ä¸Šçš„bucketç»“æ„å¦‚ä¸‹ï¼Œä¸»è¦å­—æ®µä¸ºrooté¡µçš„page idã€‚Bucketæ²¡æœ‰åµŒå¥—çš„Bucketä¸”ç©ºé—´æ¯”è¾ƒå°æ—¶ï¼Œä¸ä¼šåˆ†é…ä¸€ä¸ªå®Œæ•´çš„pageæ¥å­˜å‚¨ï¼Œè€Œæ˜¯ç›´æ¥å­˜å‚¨åˆ°çˆ¶Bucketçš„leafé¡µä¸­ï¼Œæ­¤æ—¶ <code>bucket.root</code> ä¸º0.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// bucket represents the on-file representation of a bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is stored as the &#34;value&#34; of a bucket key. If the bucket is small enough,
</span></span></span><span class="line"><span class="cl"><span class="c1">// then its root page can be stored inline in the &#34;value&#34;, after the bucket
</span></span></span><span class="line"><span class="cl"><span class="c1">// header. In the case of inline buckets, the &#34;root&#34; will be 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">bucket</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">root</span>     <span class="nx">pgid</span>   <span class="c1">// page id of the bucket&#39;s root-level page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sequence</span> <span class="kt">uint64</span> <span class="c1">// monotonically incrementing, used by NextSequence()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†…å­˜ä¸­çš„Bucketç»“æ„å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Bucket represents a collection of key/value pairs inside the database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Bucket</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="nx">bucket</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span>       <span class="o">*</span><span class="nx">Tx</span>                <span class="c1">// the associated transaction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">buckets</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Bucket</span> <span class="c1">// subbucket cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">page</span>     <span class="o">*</span><span class="nx">page</span>              <span class="c1">// inline page reference
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rootNode</span> <span class="o">*</span><span class="nx">node</span>              <span class="c1">// materialized node for the root page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">nodes</span>    <span class="kd">map</span><span class="p">[</span><span class="nx">pgid</span><span class="p">]</span><span class="o">*</span><span class="nx">node</span>     <span class="c1">// node cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Sets the threshold for filling nodes when they split. By default,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the bucket will fill to 50% but it can be useful to increase this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// amount if you know that your write workloads are mostly append-only.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This is non-persisted across transactions so it must be set in every Tx.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">FillPercent</span> <span class="kt">float64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºBucket</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// CreateBucket creates a new bucket at the given key and returns the new bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns an error if the key already exists, if the bucket name is blank, or if the bucket name is too long.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The bucket instance is only valid for the lifetime of the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">CreateBucket</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Bucket</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrTxClosed</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrTxNotWritable</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrBucketNameRequired</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Move cursor to correct position.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">k</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Return an error if there is an existing key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// keyå·²å­˜åœ¨æ—¶æŠ¥é”™ï¼Œæ ¹æ®æ˜¯å¦æ˜¯bucketè¿”å›ä¸åŒçš„é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="nx">bucketLeafFlag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrBucketExists</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrIncompatibleValue</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create empty, inline bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">bucket</span> <span class="p">=</span> <span class="nx">Bucket</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">bucket</span><span class="p">:</span>      <span class="o">&amp;</span><span class="nx">bucket</span><span class="p">{},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rootNode</span><span class="p">:</span>    <span class="o">&amp;</span><span class="nx">node</span><span class="p">{</span><span class="nx">isLeaf</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FillPercent</span><span class="p">:</span> <span class="nx">DefaultFillPercent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">value</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">write</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Insert into node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span> <span class="p">=</span> <span class="nf">cloneBytes</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å†™å…¥åˆ°nodeä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">bucketLeafFlag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Since subbuckets are not allowed on inline buckets, we need to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// dereference the inline page, if it exists. This will cause the bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to be treated as a regular, non-inline bucket for the rest of the tx.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">b</span><span class="p">.</span><span class="nx">page</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ‰“å¼€Bucketä»¥è¿”å›Bucketå¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Bucket</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºBucketçš„keyå’Œæ™®é€šçš„KVåœ¨åŒä¸€namespaceä¸­ï¼Œä¸å…è®¸å’Œæ™®é€šçš„keyé‡å¤ã€‚åœ¨å®ç°ä¸­ï¼Œå°†åˆ›å»ºçš„Bucketè½¬ä¸ºbyte[]ç„¶åå†™å…¥åˆ°æ‰€åœ¨nodeä¸­ï¼Œç„¶åå†è°ƒç”¨ <code>b.Bucket(key)</code>  è¿”å›Bucketå¯¹è±¡ã€‚</p>
<p>æ‰“å¼€Bucketçš„é€»è¾‘å¦‚ä¸‹</p>
<ol>
<li>æ£€æŸ¥æ˜¯å¦å­˜åœ¨keyï¼Œä»¥åŠæ˜¯å¦ä¸ºBucket</li>
<li>è°ƒç”¨openBucketï¼Œååºåˆ—åŒ–ä¸ºBucketç»“æ„ä½“ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Bucket retrieves a nested bucket by name.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns nil if the bucket does not exist.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The bucket instance is only valid for the lifetime of the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">Bucket</span><span class="p">(</span><span class="nx">name</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="o">*</span><span class="nx">Bucket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœåœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">child</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">name</span><span class="p">)];</span> <span class="nx">child</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">child</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Move cursor to key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Return nil if the key doesn&#39;t exist or it is not a bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">bucketLeafFlag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Otherwise create a bucket and cache it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">child</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">openBucket</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// è®¾ç½®åˆ°ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[</span><span class="nb">string</span><span class="p">(</span><span class="nx">name</span><span class="p">)]</span> <span class="p">=</span> <span class="nx">child</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">child</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Helper method that re-interprets a sub-bucket value
</span></span></span><span class="line"><span class="cl"><span class="c1">// from a parent into a Bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">openBucket</span><span class="p">(</span><span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="o">*</span><span class="nx">Bucket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">child</span> <span class="p">=</span> <span class="nf">newBucket</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If unaligned load/stores are broken on this arch and value is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// unaligned simply clone to an aligned byte array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">unaligned</span> <span class="o">:=</span> <span class="nx">brokenUnaligned</span> <span class="o">&amp;&amp;</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">&amp;</span><span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">unaligned</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">value</span> <span class="p">=</span> <span class="nf">cloneBytes</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If this is a writable transaction then we need to copy the bucket entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Read-only transactions can point directly at the mmap entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">unaligned</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å†™äº‹åŠ¡æˆ–è€…æœªå¯¹é½æ—¶ï¼Œä¼šåˆ†é…æ–°çš„å†…å­˜å¹¶æ‹·è´ï¼Œå¦åˆ™ç›´æ¥æŒ‡å‘mmapçš„å†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">child</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">bucket</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="nx">child</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">bucket</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">child</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bucket</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Save a reference to the inline page if the bucket is inline.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å¤„ç†inline pageã€‚åˆšåˆ›å»ºçš„Bucketå¿…ç„¶ä¸ºinline pageã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">root</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">child</span><span class="p">.</span><span class="nx">page</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">page</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">value</span><span class="p">[</span><span class="nx">bucketHeaderSize</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">child</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bæ ‘æ“ä½œåŠç»´æŠ¤">B+æ ‘æ“ä½œåŠç»´æŠ¤</h2>
<h3 id="cursorå®ç°">Cursorå®ç°</h3>
<p>åœ¨boltdbè®¿é—®æ•°æ®æ—¶ï¼Œä½¿ç”¨Cursoræ¥æŸ¥æ‰¾æ•°æ®æˆ–è€…å®ç°éå†åŠŸèƒ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// elemRef represents a reference to an element on a given page/node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">elemRef</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">page</span>  <span class="o">*</span><span class="nx">page</span>  <span class="c1">// é¡µé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">node</span>  <span class="o">*</span><span class="nx">node</span>  <span class="c1">// æ‰“å¼€çš„é¡µé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">index</span> <span class="kt">int</span>    <span class="c1">// å½“å‰è®¿é—®åˆ°çš„æˆå‘˜ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Cursor represents an iterator that can traverse over all key/value pairs in a bucket in sorted order.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Cursors see nested buckets with value == nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Cursor</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bucket</span> <span class="o">*</span><span class="nx">Bucket</span>    <span class="c1">// æŒ‡å‘çš„Bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">stack</span>  <span class="p">[]</span><span class="nx">elemRef</span>  <span class="c1">// è®¿é—®æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Put å®ç°å¦‚ä¸‹ï¼ŒåŸºæœ¬é€»è¾‘ä¸ºåˆ©ç”¨B+æ ‘çš„æ€§è´¨ä¸æ–­äºŒåˆ†æŸ¥æ‰¾ï¼Œç›´åˆ°åˆ°è¾¾leafé¡µï¼Œç„¶åæ’å…¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put sets the value for a key in the bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the key exist then its previous value will be overwritten.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Supplied value must remain valid for the life of the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns an error if the bucket was created from a read-only transaction, if the key is blank, if the key is too large, or if the value is too large.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrTxClosed</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">b</span><span class="p">.</span><span class="nf">Writable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrTxNotWritable</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrKeyRequired</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">MaxKeySize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrKeyTooLarge</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">int64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">&gt;</span> <span class="nx">MaxValueSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrValueTooLarge</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Move cursor to correct position.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å®šä½åˆ°æŒ‡å®šçš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">k</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">seek</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Return an error if there is an existing key with a bucket value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å¦‚æœkeyä½ç½®å­˜åœ¨Bucketï¼Œåˆ™æŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">bucketLeafFlag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrIncompatibleValue</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Insert into node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ä¹‹æ‰€ä»¥æ‹·è´keyä¸æ‹·è´valueï¼Œæ˜¯å› ä¸ºvalueè¦æ±‚åœ¨äº‹åŠ¡ç»“æŸå‰ä¿æŒæœ‰æ•ˆï¼Œè€Œkeyæ²¡æœ‰è¿™æ ·çš„è¦æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span> <span class="p">=</span> <span class="nf">cloneBytes</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ›´æ–°æˆ–è€…æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å°†Cursorå®šä½åˆ°æŒ‡å®šçš„keyçš„å®ç°å¦‚ä¸‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// seek moves the cursor to a given key and returns it.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the key does not exist then the next key is used.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">seek</span><span class="p">(</span><span class="nx">seek</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">flags</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;tx closed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Start from root page/node and traverse to correct page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// æ¸…ç©ºæ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="nx">seek</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ref</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If the cursor is pointing to the end of page/node then return nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If this is a bucket then return a nil value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">keyValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// search recursively performs a binary search against a given page/node until it finds a given key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">search</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">pgid</span> <span class="nx">pgid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ‰“å¼€pageï¼Œå¯èƒ½è¿”å›pageæˆ–è€…nodeç»“æ„ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å› æ­¤åé¢åˆ†åˆ«æœ‰ä»pageæˆ–è€…ä»nodeæ£€ç´¢çš„é€»è¾‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è¿™é‡Œæœ‰ä¸ªç–‘é—®æ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰ç»Ÿä¸€ä¸ºnodeï¼Œçœ‹node.read(p *page) å¼€é”€ä¹Ÿä¸å¤§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// æˆ‘ç†è§£æ˜¯Bucket.node()å®ç°ä¼šå°†å…¶è®°å½•åˆ°Bucket.nodesä¸­ï¼Œç”¨äºB+æ ‘çš„å¹³è¡¡æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å¯¹äºè¯»çš„åœºæ™¯ï¼Œä¸éœ€è¦åšè¿™äº›æ“ä½œï¼Œå› æ­¤æ²¡æœ‰ç»Ÿä¸€é€»è¾‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nf">pageNode</span><span class="p">(</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">branchPageFlag</span><span class="p">|</span><span class="nx">leafPageFlag</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;invalid page type: %d: %x&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="o">:=</span> <span class="nx">elemRef</span><span class="p">{</span><span class="nx">page</span><span class="p">:</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">node</span><span class="p">:</span> <span class="nx">n</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åŠ å…¥åˆ°æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If we&#39;re on a leaf page/node then find the specific node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nf">isLeaf</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">nsearch</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nf">searchNode</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nf">searchPage</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// nsearch searches the leaf node on the top of the stack for a key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">nsearch</span><span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">e</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">page</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If we have a node then search its inodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// äºŒåˆ†æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">index</span> <span class="o">:=</span> <span class="nx">sort</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// è®¾ç½®index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">e</span><span class="p">.</span><span class="nx">index</span> <span class="p">=</span> <span class="nx">index</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If we have a page then search its leaf elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">inodes</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">leafPageElements</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä½¿ç”¨pageæ¥äºŒåˆ†æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">index</span> <span class="o">:=</span> <span class="nx">sort</span><span class="p">.</span><span class="nf">Search</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">count</span><span class="p">),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">key</span><span class="p">(),</span> <span class="nx">key</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è®¾ç½®index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">e</span><span class="p">.</span><span class="nx">index</span> <span class="p">=</span> <span class="nx">index</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nextå®ç°å¦‚ä¸‹ï¼Œå°†Cursorç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªkeyã€‚boltdbçš„B+æ ‘ä¸­æ²¡æœ‰æŒ‡é’ˆæ¥æŒ‡å‘ç›¸é‚»çš„å¶å­pageï¼Œå› æ­¤æ˜¯é€šè¿‡æ ˆå›æº¯æ¥æ‰¾åˆ°ç›¸é‚»çš„å¶å­pageçš„ï¼Œä¸»è¦è¿˜æ˜¯ä¸ºäº†é¿å…æ— è°“çš„pageä¿®æ”¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Next moves the cursor to the next item in the bucket and returns its key and value.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the cursor is at the end of the bucket then a nil key and value are returned.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The returned key and value are only valid for the life of the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">Next</span><span class="p">()</span> <span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;tx closed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nx">flags</span> <span class="o">&amp;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">bucketLeafFlag</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">k</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// next moves to the next leaf element and returns the key and value.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the cursor is at the last leaf element then it stays there and returns nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">next</span><span class="p">()</span> <span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">flags</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Attempt to move over one element until we&#39;re successful.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Move up the stack as we hit the end of each page in our stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">i</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">elem</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">index</span> <span class="p">&lt;</span> <span class="nx">elem</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// å¦‚æœä»»ä½•ä¸€å±‚è¿˜æ²¡å®Œå…¨è®¿é—®ï¼Œåˆ™å°†å…¶index+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">elem</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If we&#39;ve hit the root page then stop and return. This will leave the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// cursor on the last element of the last page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// æ‰€æœ‰å±‚éƒ½è®¿é—®è¿‡äº†ï¼Œå³cursoråœ¨æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Otherwise start from where we left off in the stack and find the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// first element of the first leaf page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[:</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç§»åŠ¨åˆ°ä¸‹é¢çš„ç¬¬ä¸€ä¸ªleafèŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nf">first</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// If this is an empty page then restart and move back up the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// https://github.com/boltdb/bolt/issues/450
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">keyValue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// first moves the cursor to the first leaf element under the last page in the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">first</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Exit when we hit a leaf page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">ref</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// leafåˆ™break
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">isLeaf</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Keep adding pages pointing to the first element to the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">pgid</span> <span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">node</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pgid</span> <span class="p">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="nx">ref</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">pgid</span> <span class="p">=</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nf">branchPageElement</span><span class="p">(</span><span class="nb">uint16</span><span class="p">(</span><span class="nx">ref</span><span class="p">.</span><span class="nx">index</span><span class="p">)).</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nf">pageNode</span><span class="p">(</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// è®¿é—®ä¸‹ä¸€å±‚èŠ‚ç‚¹ï¼Œè®¾ç½®ä¸‹ä¸€å±‚èŠ‚ç‚¹çš„indexä¸º0ï¼Œä»ç¬¬ä¸€ä¸ªå¼€å§‹è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">elemRef</span><span class="p">{</span><span class="nx">page</span><span class="p">:</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">node</span><span class="p">:</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">index</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Cursorçš„å…¶ä»–å‡½æ•°ä¸å†èµ˜è¿°ï¼ŒåŸºæœ¬éƒ½æ˜¯B+æ ‘çš„æ ‡å‡†æ“ä½œã€‚</p>
<h3 id="bæ ‘-rebalance">B+æ ‘ rebalance</h3>
<p>åœ¨æ’å…¥æˆ–åˆ é™¤keyæ—¶ï¼Œéƒ½æ˜¯é€šè¿‡cursor.node()æ“ä½œçš„.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">del</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">c</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®B+æ ‘çš„æ€§è´¨ï¼Œè®¿é—®è·¯å¾„ä¸Šçš„pageéƒ½æœ‰å¯èƒ½è¢«ä¿®æ”¹ï¼Œå› æ­¤cursor.node()ä¼šå°†è¿™äº›pageéƒ½è§£æä¸ºnodeï¼Œå¹¶ç¼“å­˜åˆ°Bucket.nodesä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cursor</span><span class="p">)</span> <span class="nf">node</span><span class="p">()</span> <span class="o">*</span><span class="nx">node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;accessing a node with a zero-length cursor stack&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If the top of the stack is a leaf node then just return it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ref</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">node</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">ref</span><span class="p">.</span><span class="nf">isLeaf</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Start from root and traverse down the hierarchy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">n</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nf">node</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">page</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ref</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">_assert</span><span class="p">(!</span><span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span><span class="p">,</span> <span class="s">&#34;expected branch node&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">childAt</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">ref</span><span class="p">.</span><span class="nx">index</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span><span class="p">,</span> <span class="s">&#34;expected leaf node&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// node creates a node from a page and associates it with a given parent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">node</span><span class="p">(</span><span class="nx">pgid</span> <span class="nx">pgid</span><span class="p">,</span> <span class="nx">parent</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="o">*</span><span class="nx">node</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">,</span> <span class="s">&#34;nodes map expected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Retrieve node if it&#39;s already been created.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">pgid</span><span class="p">];</span> <span class="nx">n</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Otherwise create a node and cache it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">node</span><span class="p">{</span><span class="nx">bucket</span><span class="p">:</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">parent</span><span class="p">:</span> <span class="nx">parent</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">parent</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">parent</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use the inline page if this is an inline bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">p</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">page</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Read the page into the node and cache it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// çºªå½•åˆ°ç¼“å­˜ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">b</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">pgid</span><span class="p">]</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update statistics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">NodeCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±ä¸Šé¢çš„åˆ†æå¯è§ï¼Œåœ¨rebalanceæ—¶åªéœ€è¦æ£€æŸ¥Bucket.nodesç¼“å­˜ä¸­çš„nodeæ˜¯å¦éœ€è¦åˆ†è£‚æˆ–åˆå¹¶å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// rebalance attempts to balance all nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">rebalance</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">nodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ä¾æ¬¡è°ƒç”¨node.rebalance()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">n</span><span class="p">.</span><span class="nf">rebalance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">child</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å¤„ç†æ¯ä¸ªå­Bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">child</span><span class="p">.</span><span class="nf">rebalance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>node rebalanceå®ç°</p>
<p>rebalanceä¸­ä¼šå°†è¿‡å°çš„pageå’Œå…„å¼Ÿpageåˆå¹¶ï¼Œå¹¶ä¸æ˜¯é€šå¸¸æ„ä¹‰ä¸Šè¯´çš„B+æ ‘çš„å†å¹³è¡¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// rebalance attempts to combine the node with sibling nodes if the node fill
</span></span></span><span class="line"><span class="cl"><span class="c1">// size is below a threshold or if there are not enough keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">rebalance</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// åœ¨delete keyæ—¶ä¼šè®¾ç½®unbalancedä¸ºtrueï¼Œè€Œinsertå¹¶ä¸ä¼šè®¾ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å› æ­¤ç»è¿‡node.rebalance()åï¼Œnodeæœ‰å¯èƒ½ä¼šè¶…è¿‡pageå¤§å°ï¼Œæ˜¯åœ¨å¦å¤–çš„åœ°æ–¹å¤„ç†çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nx">unbalanced</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">.</span><span class="nx">unbalanced</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update statistics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Rebalance</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ignore if node is above threshold (25%) and has enough keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">threshold</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span> <span class="o">/</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// nodeå¤§å°è¶…è¿‡25%ä¸”æœ‰è¶³å¤Ÿçš„key(leafè‡³å°‘ä¸º1ä¸ªï¼Œå¦åˆ™è‡³å°‘ä¸º2ä¸ªï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">threshold</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nf">minKeys</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Root node has special handling.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If root node is a branch and only has one node then collapse it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">!</span><span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Move root&#39;s child up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// å°†childç§»åŠ¨åˆ°rootèŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">child</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nf">node</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pgid</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">n</span><span class="p">.</span><span class="nx">isLeaf</span> <span class="p">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">isLeaf</span>
</span></span><span class="line"><span class="cl">			<span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[:]</span>
</span></span><span class="line"><span class="cl">			<span class="nx">n</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">children</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Reparent all child nodes being moved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">inode</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">inode</span><span class="p">.</span><span class="nx">pgid</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Remove old child.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="nb">delete</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">child</span><span class="p">.</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">child</span><span class="p">.</span><span class="nf">free</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If node has no keys then just remove it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nf">numChildren</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">del</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">delete</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nf">free</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">rebalance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">numChildren</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;parent must have at least 2 children&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Destination node is right sibling if idx == 0, otherwise left sibling.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">target</span> <span class="o">*</span><span class="nx">node</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">useNextSibling</span> <span class="p">=</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">childIndex</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">useNextSibling</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">target</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">nextSibling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">target</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">prevSibling</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If both this node and the target node are too small then merge them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ç›´æ¥åˆå¹¶ï¼Œåé¢å†åšsplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">useNextSibling</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Reparent all child nodes being moved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">inode</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">target</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">inode</span><span class="p">.</span><span class="nx">pgid</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Copy over inodes from target and remove target.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">inodes</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">del</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">delete</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">target</span><span class="p">.</span><span class="nf">free</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Reparent all child nodes being moved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">inode</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">inode</span><span class="p">.</span><span class="nx">pgid</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span> <span class="p">=</span> <span class="nx">target</span>
</span></span><span class="line"><span class="cl">				<span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Copy over inodes to target and remove node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">target</span><span class="p">.</span><span class="nx">inodes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">inodes</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">inodes</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">del</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">delete</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nx">pgid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nf">free</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Either this node or the target node was deleted from the parent so rebalance it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ç»è¿‡åˆ é™¤åï¼Œparentä¹Ÿéœ€è¦rebalance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">rebalance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„node.rebalanceå®Œæˆåï¼Œæœ‰å¯èƒ½æœ‰nodeçš„å¤§å°è¶…è¿‡page sizeï¼Œä¸€æ–¹é¢rebalanceå¹¶ä¸ä¼šå¤„ç†æ’å…¥å…ƒç´ ï¼Œå¦ä¸€æ–¹é¢ï¼Œrebalanceæ—¶å¯èƒ½ä¼šåˆå¹¶å…„å¼ŸèŠ‚ç‚¹ã€‚è¿™ä¸ªé—®é¢˜æ˜¯åœ¨å‡†å¤‡åˆ†é…è„é¡µæ—¶å¤„ç†çš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// spill writes the nodes to dirty pages and splits nodes as it goes.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns an error if dirty pages cannot be allocated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">node</span><span class="p">)</span> <span class="nf">spill</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">tx</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">tx</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å·²ç»åˆ†é…è¿‡ï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">spilled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Spill child nodes first. Child nodes can materialize sibling nodes in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the case of split-merge so we cannot use a range loop. We have to check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the children size on every loop iteration.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">spill</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// We no longer need the child list because it&#39;s only used for spill tracking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">n</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Split nodes into appropriate sizes. The first node will always be n.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// æ ¹æ®page sizeæœ‰å¯èƒ½åˆ†è£‚æˆå¤šä¸ªé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">nodes</span> <span class="p">=</span> <span class="nx">n</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">node</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nodes</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Add node&#39;s page to the freelist if it&#39;s not new.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span><span class="p">,</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">pgid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">node</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Allocate contiguous space for the node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// ä¸ºæ¯ä¸ªpageåˆ†é…æ–°é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">allocate</span><span class="p">((</span><span class="nx">node</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span> <span class="o">/</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Write the node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span> <span class="o">&gt;=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;pgid (%d) above high water mark (%d)&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">node</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">		<span class="nx">node</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">node</span><span class="p">.</span><span class="nx">spilled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Insert into parent inodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parent</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">key</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">key</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">key</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// æ›´æ–°åˆ°parentä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">node</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">pgid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">node</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">inodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">			<span class="nf">_assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;spill: zero-length node key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Update the statistics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Spill</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If the root node split and created a new root then we need to spill that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// as well. We&#39;ll clear out the children to make sure it doesn&#39;t try to respill.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">pgid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span><span class="p">.</span><span class="nx">children</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nf">spill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ†é…è„é¡µæ—¶ï¼Œä¼šå°†è¶…è¿‡page sizeçš„é¡µæ‹†åˆ†ä¸ºå¤šä¸ªé¡µï¼Œè¿™æ˜¯åŸºäºç£ç›˜pageçš„B+æ ‘ä¸å†…å­˜B+æ ‘çš„ä¸åŒç‚¹ä¹‹ä¸€ï¼Œè€Œå†…å­˜ä¸­çš„B+æ ‘ä¸€èˆ¬æ˜¯æœ‰å›ºå®šçš„keyæ•°çš„ï¼Œè¶…è¿‡keyæ•°æ—¶æ‰éœ€è¦æ‹†åˆ†ã€‚</p>
<h2 id="äº‹åŠ¡å¤„ç†">äº‹åŠ¡å¤„ç†</h2>
<p>boltdbä»»ä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªå†™äº‹åŠ¡ï¼Œä½†å…è®¸å¤šä¸ªè¯»äº‹åŠ¡åŒæ—¶è¿è¡Œã€‚ç”±äºé‡‡ç”¨äº†append only B+ treeå®ç°ï¼Œå†™äº‹åŠ¡ä¸ä¼šæ›´æ–°å·²æœ‰çš„æ•°æ®é¡µï¼Œå› æ­¤å†™äº‹åŠ¡è¿è¡Œæ—¶å¤šä¸ªè¯»äº‹åŠ¡ä¹Ÿå¯ä»¥æ­£å¸¸è¿›è¡Œã€‚</p>
<h3 id="è¯»äº‹åŠ¡">è¯»äº‹åŠ¡</h3>
<p>boltdbæä¾›äº†Viewå‡½æ•°æ¥æ–¹ä¾¿æ‰§è¡Œè¯»äº‹åŠ¡ï¼Œä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥æœ€åéƒ½ä¼šè°ƒç”¨Rollbackæ¥å…³é—­äº‹åŠ¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// View executes a function within the context of a managed read-only transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Any error that is returned from the function is returned from the View() method.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Attempting to manually rollback within the function will cause a panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">View</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Begin</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Make sure the transaction rolls back in the event of a panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">db</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">t</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Mark as a managed tx so that the inner function cannot manually rollback.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span><span class="p">.</span><span class="nx">managed</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If an error is returned from the function then pass it through.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">managed</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ç”¨æ¥é‡Šæ”¾pageé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">beginTx</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">Tx</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Lock the meta pages while we initialize the transaction. We obtain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the meta lock before the mmap lock because that&#39;s the order that the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// write transaction will obtain them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Obtain a read-only lock on the mmap. When the mmap is remapped it will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// obtain a write lock so all transactions must finish before it can be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// remapped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è¯»äº‹åŠ¡è¿è¡Œæ—¶ä¼šä¸€ç›´æŒæœ‰mmaplockçš„è¯»é”ï¼Œä¸€èˆ¬ä¸ä¼šblockå†™äº‹åŠ¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// é•¿æ—¶é—´æ‰§è¡Œçš„è¯»äº‹åŠ¡ä¸ºäº†é˜²æ­¢blockå†™äº‹åŠ¡ï¼Œéœ€è¦è®¾ç½®InitialMmapSizeä¸ºæ¯”è¾ƒå¤§çš„å€¼ï¼Œä»¥ä¾¿è®©å†™äº‹åŠ¡ä¸éœ€è¦é‡æ–°mmapã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">mmaplock</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Exit if the database is not open yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">db</span><span class="p">.</span><span class="nx">opened</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">db</span><span class="p">.</span><span class="nx">mmaplock</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrDatabaseNotOpen</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create a transaction associated with the database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Tx</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Keep track of transaction until it closes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è®°å½•è¿è¡Œä¸­çš„è¯»äº‹åŠ¡ï¼Œç”¨äºå®‰å…¨çš„é‡Šæ”¾page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">txs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Unlock the meta pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update the transaction stats.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">TxN</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">OpenTxN</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯»äº‹åŠ¡æ‰§è¡Œå®Œæˆåï¼Œéœ€è¦å…³é—­äº‹åŠ¡ï¼Œä»¥ä¾¿é‡Šæ”¾èµ„æºã€‚è¯»äº‹åŠ¡æ˜¯é€šè¿‡è°ƒç”¨Rollbackæ¥å…³é—­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nb">close</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">removeTx</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Clear all references.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">root</span> <span class="p">=</span> <span class="nx">Bucket</span><span class="p">{</span><span class="nx">tx</span><span class="p">:</span> <span class="nx">tx</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">pages</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// removeTx removes a transaction from the database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">removeTx</span><span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Release the read lock on the mmap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// é‡Šæ”¾mmapè¯»é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">mmaplock</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Use the meta lock to restrict access to the DB object.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Remove the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ç§»é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">t</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">db</span><span class="p">.</span><span class="nx">txs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="nx">tx</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">last</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">[</span><span class="nx">last</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">[</span><span class="nx">last</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="nx">db</span><span class="p">.</span><span class="nx">txs</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">[:</span><span class="nx">last</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">txs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Unlock the meta pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Merge statistics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">OpenTxN</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">TxStats</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å†™äº‹åŠ¡">å†™äº‹åŠ¡</h3>
<p>boltdbæä¾›äº†Updateå‡½æ•°æ¥æ–¹ä¾¿æ‰§è¡Œå†™äº‹åŠ¡ï¼Œåœ¨æˆåŠŸæ—¶è‡ªåŠ¨Commitï¼Œåœ¨å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Update executes a function within the context of a read-write managed transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If no error is returned from the function then the transaction is committed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If an error is returned then the entire transaction is rolled back.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Any error that is returned from the function or returned from the commit is
</span></span></span><span class="line"><span class="cl"><span class="c1">// returned from the Update() method.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Attempting to manually commit or rollback within the function will cause a panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Update</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Begin</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Make sure the transaction rolls back in the event of a panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">db</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">t</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Mark as a managed tx so that the inner function cannot manually commit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span><span class="p">.</span><span class="nx">managed</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If an error is returned from the function then rollback and return error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">managed</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¼€å§‹å†™äº‹åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">beginRWTx</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">Tx</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// If the database was opened with Options.ReadOnly, return an error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">db</span><span class="p">.</span><span class="nx">readOnly</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrDatabaseReadOnly</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Obtain writer lock. This is released by the transaction when it closes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This enforces only one writer transaction at a time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// é™åˆ¶åªèƒ½æœ‰ä¸€ä¸ªå†™äº‹åŠ¡åœ¨åŒæ—¶è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">rwlock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Once we have the writer lock then we can lock the meta pages so that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// we can set up the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nx">metalock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Exit if the database is not open yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">db</span><span class="p">.</span><span class="nx">opened</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">db</span><span class="p">.</span><span class="nx">rwlock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrDatabaseNotOpen</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Create a transaction associated with the database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Tx</span><span class="p">{</span><span class="nx">writable</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å†™äº‹åŠ¡åœ¨initä¸­åˆå§‹åŒ–pages mapï¼Œç”¨æ¥è®°å½•éœ€è¦å†™çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// åœ¨tx.allocateä¸­ä¼šæ‰§è¡Œ tx.pages[p.id] = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">rwtx</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Free any pages associated with closed read-only transactions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">minid</span> <span class="nx">txid</span> <span class="p">=</span> <span class="mh">0xFFFFFFFFFFFFFFFF</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">t</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">db</span><span class="p">.</span><span class="nx">txs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span> <span class="p">&lt;</span> <span class="nx">minid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">minid</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">minid</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// é‡Šæ”¾å·²ç»æ‰§è¡Œå®Œçš„äº‹åŠ¡ç”¨åˆ°çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">release</span><span class="p">(</span><span class="nx">minid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å›æ»šäº‹åŠ¡çš„é€»è¾‘ç›¸å¯¹ç®€å•</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nf">rollback</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å›æ»šå†™äº‹åŠ¡å³å°†é‡Šæ”¾çš„é¡µï¼Œè¿™äº›é¡µæœ¬æ¥è¦é‡Šæ”¾æˆç©ºé—²é¡µï¼Œæ”¹ä¸ºä¸é‡Šæ”¾äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">rollback</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// é‡æ–°åŠ è½½ç©ºé—²é¡µåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">reload</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">meta</span><span class="p">().</span><span class="nx">freelist</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nb">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nb">close</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Remove transaction ref &amp; writer lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">rwtx</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// é‡Šæ”¾é”ï¼Œä»¥ä¾¿è®©å…¶ä»–å†™äº‹åŠ¡æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">rwlock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Merge statistics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// æ›´æ–°ä¸€äº›ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">statlock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">removeTx</span><span class="p">(</span><span class="nx">tx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Clear all references.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">root</span> <span class="p">=</span> <span class="nx">Bucket</span><span class="p">{</span><span class="nx">tx</span><span class="p">:</span> <span class="nx">tx</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">pages</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æäº¤äº‹åŠ¡çš„å®ç°å¦‚ä¸‹</p>
<ol>
<li>è°ƒç”¨rebalanceæ¥åˆå¹¶è¿‡å°çš„é¡µ</li>
<li>è°ƒç”¨splilæ¥åˆ†é…è„é¡µï¼Œå¹¶splitè¿‡å¤§çš„é¡µ</li>
<li>åˆ†é…æ–°çš„freelisté¡µï¼Œå†™ç›˜</li>
<li>è„é¡µå†™ç›˜</li>
<li>å†™å…¥æ–°çš„metaé¡µ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Commit writes all changes to disk and updates the meta page.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns an error if a disk write error occurs, or if Commit is
</span></span></span><span class="line"><span class="cl"><span class="c1">// called on a read-only transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">tx</span> <span class="o">*</span><span class="nx">Tx</span><span class="p">)</span> <span class="nf">Commit</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">_assert</span><span class="p">(!</span><span class="nx">tx</span><span class="p">.</span><span class="nx">managed</span><span class="p">,</span> <span class="s">&#34;managed tx commit not allowed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrTxClosed</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">!</span><span class="nx">tx</span><span class="p">.</span><span class="nx">writable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">ErrTxNotWritable</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO(benbjohnson): Use vectorized I/O to write out dirty pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Rebalance nodes which have had deletions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">startTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è°ƒç”¨rebalanceæ¥åˆå¹¶è¿‡å°çš„page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nf">rebalance</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Rebalance</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">RebalanceTime</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// spill data onto dirty pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">startTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è°ƒç”¨Bucket.spillæ¥åˆ†é…è„é¡µï¼Œå¹¶splitè¿‡å¤§çš„é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nf">spill</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">SpillTime</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Free the old root bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">root</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">root</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">opgid</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Free the freelist and allocate new pages for it. This will overestimate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the size of the freelist but not underestimate the size (which would be bad).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">txid</span><span class="p">,</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">page</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">freelist</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ†é…æ–°çš„freelisté¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">allocate</span><span class="p">((</span><span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">size</span><span class="p">()</span> <span class="o">/</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å†™å…¥freelisté¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">freelist</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">freelist</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If the high water mark has moved up then attempt to grow the database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å¦‚æœæ–‡ä»¶å˜å¤§äº†ï¼Œåˆ™è°ƒç”¨truncate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">&gt;</span> <span class="nx">opgid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">grow</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">pageSize</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Write dirty pages to disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">startTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å°†æ¶‰åŠçš„è„é¡µè°ƒç”¨writeå†™ç›˜ï¼Œå¹¶å°†æ²¡æœ‰overflowçš„å†…å­˜pageåŠ å…¥page poolä¸­ä»¥ä¾¿åç»­é‡ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">write</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If strict mode is enabled then perform a consistency check.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Only the first consistency error is reported in the panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">StrictMode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Check</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">errs</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">errs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;check fail: &#34;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">errs</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Write meta to disk.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å†™å…¥metaé¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">writeMeta</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tx</span><span class="p">.</span><span class="nf">rollback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tx</span><span class="p">.</span><span class="nx">stats</span><span class="p">.</span><span class="nx">WriteTime</span> <span class="o">+=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">startTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Finalize the transaction.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tx</span><span class="p">.</span><span class="nb">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Execute commit handlers now that the locks have been removed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">tx</span><span class="p">.</span><span class="nx">commitHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Bucketçš„spillå®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// spill writes all the nodes for this bucket to dirty pages.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Bucket</span><span class="p">)</span> <span class="nf">spill</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Spill all child buckets first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">child</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the child bucket is small enough and it has no child buckets then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// write it inline into the parent bucket&#39;s page. Otherwise spill it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// like a normal bucket and make the parent value a pointer to the page.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">value</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nf">inlineable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">child</span><span class="p">.</span><span class="nf">free</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å†…åµŒé¡µå¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">value</span> <span class="p">=</span> <span class="nx">child</span><span class="p">.</span><span class="nf">write</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¯¹child bucketè°ƒç”¨spill
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">child</span><span class="p">.</span><span class="nf">spill</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Update the child bucket header in this bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">value</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">bucket</span><span class="p">{}))</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">bucket</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bucket</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">			<span class="o">*</span><span class="nx">bucket</span> <span class="p">=</span> <span class="o">*</span><span class="nx">child</span><span class="p">.</span><span class="nx">bucket</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Skip writing the bucket if there are no materialized nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">rootNode</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Update parent node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kd">var</span> <span class="nx">c</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">k</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">seek</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;misplaced bucket header: %x -&gt; %x&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">flags</span><span class="o">&amp;</span><span class="nx">bucketLeafFlag</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unexpected bucket header flag: %x&#34;</span><span class="p">,</span> <span class="nx">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å†™å…¥nodeä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">c</span><span class="p">.</span><span class="nf">node</span><span class="p">().</span><span class="nf">put</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">bucketLeafFlag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ignore if there&#39;s not a materialized root node.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Spill nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// è°ƒç”¨node.spill
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span><span class="p">.</span><span class="nf">spill</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span><span class="p">.</span><span class="nf">root</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Update the root node for this bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">pgid</span> <span class="o">&gt;=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;pgid (%d) above high water mark (%d)&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">pgid</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tx</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">pgid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">b</span><span class="p">.</span><span class="nx">root</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">pgid</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mvcc">MVCC</h3>
<p>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)æ˜¯æŒ‡æ•°æ®åº“ä¸­åŒæ—¶ä¿å­˜æ•°æ®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œä»¥ä¾¿æ”¯æŒå¤šä¸ªäº‹åŠ¡çš„éš”ç¦»å’ŒåŒæ—¶è¿è¡Œã€‚å†™äº‹åŠ¡å¹¶ä¸ä¼šç›´æ¥ä¿®æ”¹æ•°æ®ï¼Œè€Œæ˜¯åˆ›å»ºæ•°æ®çš„ä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚</p>
<p>åœ¨boltdbä¸­ï¼Œæ”¯æŒå¤šä¸ªè¯»äº‹åŠ¡åŒæ—¶è¿è¡Œï¼Œä»»ä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå†™äº‹åŠ¡èƒ½å¤Ÿè¿è¡Œã€‚ä»ä¸Šé¢çš„äº‹åŠ¡å¤„ç†åˆ†æå¯è§ï¼Œå†™äº‹åŠ¡å¹¶ä¸ä¼šä¿®æ”¹å·²æœ‰çš„pageï¼Œè€Œæ˜¯åˆ†é…æ–°çš„pageç„¶åå†™å…¥ï¼Œå› æ­¤åŒæ—¶è¿è¡Œçš„è¯»äº‹åŠ¡å¯ä»¥ç»§ç»­è®¿é—®è€ç‰ˆæœ¬çš„æ•°æ®è€Œä¸å—å½±å“ã€‚å†™äº‹åŠ¡åœ¨æäº¤æ—¶ä¼šä¿®æ”¹metaé¡µï¼Œæ­¤ååˆ›å»ºçš„è¯»å†™äº‹åŠ¡ä¼šç”¨æœ€æ–°metaé¡µæ¥åˆå§‹åŒ–äº‹åŠ¡ï¼Œä¹Ÿå°±å¯ä»¥è¯»åˆ°æœ€æ–°ç‰ˆæœ¬çš„æ•°æ®ã€‚</p>
<h2 id="crash-recovery">crash recovery</h2>
<p>boltdbæ²¡æœ‰åšä¸“é—¨çš„crash recoveryï¼Œæ˜¯é€šè¿‡æ§åˆ¶ä¿®æ”¹çš„é¡ºåºæ¥ä¿è¯æ•°æ®å®Œæ•´æ€§çš„ï¼Œå…ˆå†™å…¥æ ‘ç»“æ„ï¼Œå†å†™å…¥metaé¡µã€‚åœ¨å†™äº‹åŠ¡æäº¤è¿‡ç¨‹ä¸­æœºå™¨å®•æœºæ—¶ï¼Œå¦‚æœmetaé¡µè¿˜æœªä¿®æ”¹ï¼Œä¼šç”¨ä¹‹å‰çš„çŠ¶æ€é‡æ–°æ‰“å¼€DBï¼Œå¦‚æœmetaé¡µå†™å…¥ä¸å®Œæ•´ï¼Œä¼šç”¨å¦ä¸€ä¸ªmetaé¡µæ¥é‡æ–°æ‰“å¼€DBã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºmmapè€Œè¨€ï¼Œä»…æ§åˆ¶å†™å…¥çš„å¹¶ä¸èƒ½ä¿è¯åŒæ­¥åˆ°ç£ç›˜çš„é¡ºåºï¼Œå› æ­¤boltdbå®ç°æ—¶éƒ½æœ‰æ˜¾å¼çš„è°ƒç”¨<code>fdatasync</code> ï¼Œä¿è¯å‰é¢çš„ä¿®æ”¹åŒæ­¥åˆ°ç£ç›˜åæ‰è¿›è¡Œåé¢çš„æ“ä½œã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>boltdbä»£ç è¿˜æ˜¯å¾ˆå€¼å¾—é˜…è¯»å’Œå­¦ä¹ çš„ï¼Œé€šè¿‡4000è¡Œå·¦å³çš„ä»£ç ï¼Œå®ç°äº†é«˜æ•ˆçš„KVæ•°æ®åº“ã€‚</p>
<ul>
<li>boltdbå€ŸåŠ©mmapæ¥ç®€åŒ–bufferç®¡ç†å™¨çš„å®ç°ï¼Œé€šè¿‡æ§åˆ¶å†™ç›˜é¡ºåºè€Œä¸éœ€è¦ä¸“é—¨çš„crash recoveryå¤„ç†ã€‚</li>
<li>boltdbå®ç°äº†append only B+æ ‘ã€‚</li>
<li>boltdbçš„é¡µåˆ†é…ç®—æ³•æ¯”è¾ƒå·§å¦™çš„æ˜¯åªä¼šåˆ†é…è¿ç»­çš„é¡µï¼Œç®€åŒ–äº†åç»­çš„å¤„ç†é€»è¾‘ã€‚</li>
</ul>
<p>å‚è€ƒèµ„æ–™</p>
<ul>
<li><a href="https://github.com/jaydenwen123/boltdb_book/blob/master/boltdb%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md">boltdb_book/boltdbæºç åˆ†æ.md at master Â· jaydenwen123/boltdb_book Â· GitHub</a></li>
<li><a href="https://www.codedump.info/post/20200625-boltdb-1/">boltdb 1.3.0å®ç°åˆ†æï¼ˆä¸€ï¼‰ - codedumpçš„ç½‘ç»œæ—¥å¿—</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>è®ºæ–‡ç¬”è®°ï¼šPacificA: Replication in Log-Based Distributed Storage Systems</title>
      <link>https://egolearner.github.io/post/pacifica/</link>
      <pubDate>Sun, 27 Nov 2022 21:21:11 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/pacifica/</guid>
      <description>&lt;ul&gt;
&lt;li&gt;Authors: Mao Yang, Wei Lin&lt;/li&gt;
&lt;li&gt;Created: November 26, 2022 8:29 PM&lt;/li&gt;
&lt;li&gt;PublishedAt: MSR-TR-2008-25&lt;/li&gt;
&lt;li&gt;Tags: distributed-system&lt;/li&gt;
&lt;li&gt;URL: &lt;a href=&#34;https://www.microsoft.com/en-us/research/wp-content/uploads/2008/02/tr-2008-25.pdf&#34;&gt;https://www.microsoft.com/en-us/research/wp-content/uploads/2008/02/tr-2008-25.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Year: 2008&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;summary&#34;&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;è®ºæ–‡æå‡ºäº†ä¸€ç§åŸºäºæ—¥å¿—çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿå®ç°æ–¹å¼ï¼Œå°†å¤åˆ¶ç»„çš„æˆå‘˜ç®¡ç†å’Œæ•°æ®å¤åˆ¶è§£è€¦å¼€æ¥ï¼Œå‰è€…ä½¿ç”¨é…ç½®ç®¡ç†å™¨ï¼ˆå¦‚Paxosï¼‰æ¥ç®¡ç†ï¼Œåè€…ä½¿ç”¨primary/backupæœºåˆ¶ï¼šä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å†™è¯·æ±‚åï¼Œå°†å…¶å¤åˆ¶åˆ°æ‰€æœ‰çš„ä»èŠ‚ç‚¹åå†å‘å®¢æˆ·ç«¯å‘é€å“åº”ï¼›åœ¨å¼ºä¸€è‡´æ€§æ¨¡å¼ä¸‹åªæœ‰ä¸»èŠ‚ç‚¹ä¼šå¤„ç†è¯»è¯·æ±‚ï¼›æ•°æ®ç®¡ç†èŠ‚ç‚¹æœ€å¤šå¯ä»¥å®¹å¿n-1ä¸ªèŠ‚ç‚¹å¤±è´¥ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<ul>
<li>Authors: Mao Yang, Wei Lin</li>
<li>Created: November 26, 2022 8:29 PM</li>
<li>PublishedAt: MSR-TR-2008-25</li>
<li>Tags: distributed-system</li>
<li>URL: <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2008/02/tr-2008-25.pdf">https://www.microsoft.com/en-us/research/wp-content/uploads/2008/02/tr-2008-25.pdf</a></li>
<li>Year: 2008</li>
</ul>
<h1 id="summary"><strong>Summary</strong></h1>
<p>è®ºæ–‡æå‡ºäº†ä¸€ç§åŸºäºæ—¥å¿—çš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿå®ç°æ–¹å¼ï¼Œå°†å¤åˆ¶ç»„çš„æˆå‘˜ç®¡ç†å’Œæ•°æ®å¤åˆ¶è§£è€¦å¼€æ¥ï¼Œå‰è€…ä½¿ç”¨é…ç½®ç®¡ç†å™¨ï¼ˆå¦‚Paxosï¼‰æ¥ç®¡ç†ï¼Œåè€…ä½¿ç”¨primary/backupæœºåˆ¶ï¼šä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„å†™è¯·æ±‚åï¼Œå°†å…¶å¤åˆ¶åˆ°æ‰€æœ‰çš„ä»èŠ‚ç‚¹åå†å‘å®¢æˆ·ç«¯å‘é€å“åº”ï¼›åœ¨å¼ºä¸€è‡´æ€§æ¨¡å¼ä¸‹åªæœ‰ä¸»èŠ‚ç‚¹ä¼šå¤„ç†è¯»è¯·æ±‚ï¼›æ•°æ®ç®¡ç†èŠ‚ç‚¹æœ€å¤šå¯ä»¥å®¹å¿n-1ä¸ªèŠ‚ç‚¹å¤±è´¥ã€‚</p>
<h2 id="strength"><strong>Strength</strong></h2>
<ul>
<li>å®¹æ˜“ç†è§£å’Œè®ºè¯æ­£ç¡®æ€§ï¼Œå·¥ç¨‹ä¸Šå®¹æ˜“å®ç°ã€‚</li>
<li>æœ€å¤šå¯ä»¥å®¹å¿n-1ä¸ªèŠ‚ç‚¹å¤±è´¥ã€‚</li>
</ul>
<h2 id="weakness"><strong>Weakness</strong></h2>
<ul>
<li>èŠ‚ç‚¹æŠ–åŠ¨æ—¶å®¹æ˜“å‡ºç°å†™è¯·æ±‚åœæ»ï¼Œä¾èµ–äºåˆç†çš„é…ç½®ç§Ÿçº¦è¿‡æœŸæ—¶é—´ã€‚</li>
</ul>
<h2 id="æˆ‘çš„æ€è€ƒ">æˆ‘çš„æ€è€ƒ</h2>
<p>è®ºæ–‡æå‡ºçš„æ¨¡å¼åœ¨å·¥ç¨‹ä¸Šå®¹æ˜“å®ç°ï¼ŒESå°±é‡‡ç”¨äº†PacificAçš„æ¨¡å¼ã€‚è¿™ç¯‡è®ºæ–‡å‘è¡¨æ—¶Raftè¿˜æ²¡æœ‰å‘è¡¨ï¼Œåº”è¯¥ä¹Ÿæ²¡æœ‰å¯ç”¨çš„Paxosåº“ï¼Œå› æ­¤è¿™ä¸ªæ¨¡å¼æ˜¯æœ‰æ„ä¹‰çš„ï¼Œä½¿ç”¨å·²æœ‰çš„PaxosæœåŠ¡æ¥åšæˆå‘˜ç®¡ç†ï¼Œç„¶åè‡ªå·±å®ç°æ•°æ®å¤åˆ¶ã€‚åœ¨æœ‰å¾ˆå¤šRaftå’ŒPaxosåº“çš„ä»Šå¤©ï¼ŒåŸºäºè¿™äº›åº“æ¥å®ç°æ—¥å¿—å¤åˆ¶æˆä¸ºæ›´ç®€å•å¯è¡Œçš„æ–¹æ¡ˆã€‚</p>
<h1 id="2-pacifica-replication-framework">2. PACIFICA REPLICATION FRAMEWORK</h1>
<p>é€‚ç”¨ç½‘ç»œç¯å¢ƒï¼šå±€åŸŸç½‘ã€‚</p>
<p>é”™è¯¯æ¨¡å‹ï¼šfail-stopã€‚è®ºæ–‡ä¸è¦æ±‚serveré—´çš„æ¶ˆæ¯æ—¶å»¶æœ‰ä¸Šé™ã€‚ä¸è¦æ±‚æ—¶é’Ÿæ˜¯åŒæ­¥çš„æˆ–è€…æ¾æ•£åŒæ­¥çš„ï¼Œä½†è¦æ±‚æ—¶é’Ÿé£˜ç§»æœ‰ä¸Šé™ã€‚</p>
<h2 id="21-primarybackup-data-replication">2.1 Primary/Backup Data Replication</h2>
<p>ä¸€ä¸ªå¤åˆ¶ç»„çš„ä¸»èŠ‚ç‚¹è´Ÿè´£å¤„ç†å†™è¯·æ±‚å’Œè¯»è¯·æ±‚ï¼Œå¹¶å°†å†™è¯·æ±‚åŒæ­¥åˆ°secondariesèŠ‚ç‚¹ä¸Šå»ã€‚ä¸»èŠ‚ç‚¹ä¸ºupdateè¯·æ±‚ç¡®å®šå•è°ƒé€’å¢çš„åºåˆ—å·ï¼Œä»èŠ‚ç‚¹ä¹ŸæŒ‰ç…§è¿™ä¸ªé¡ºåºå¤„ç†è¯·æ±‚ï¼Œå› æ­¤å¯ä»¥ä¿è¯ä»èŠ‚ç‚¹çš„æ•°æ®å’Œä¸»èŠ‚ç‚¹ä¸€è‡´ã€‚</p>
<p>æ¯ä¸ªå‰¯æœ¬ç»´æŠ¤prepared listå’Œcommitted pointï¼Œcommitted pointä¹‹å‰ä¸ºcommitted listã€‚</p>
<ul>
<li>è¯»è¯·æ±‚å¤„ç†ã€‚ä¸»èŠ‚ç‚¹ä½¿ç”¨ä½¿ç”¨å½“å‰çš„committed listè¡¨ç¤ºçš„çŠ¶æ€æ¥å¤„ç†è¯·æ±‚å¹¶è¿”å›ç»“æœã€‚</li>
<li>å†™è¯·æ±‚å¤„ç†ã€‚
<ul>
<li>ä¸»èŠ‚ç‚¹åˆ†é…è¯·æ±‚çš„åºåˆ—å·ï¼Œå°†è¯·æ±‚ã€åºåˆ—å·åŠå½“å‰çš„é…ç½®ç‰ˆæœ¬ä½œä¸ºprepareæ¶ˆæ¯å‘é€åˆ°æ‰€æœ‰ä»èŠ‚ç‚¹ã€‚</li>
<li>ä»èŠ‚ç‚¹å°†æ¥æ”¶åˆ°çš„è¯·æ±‚ä»¥åºåˆ—å·çš„é¡ºåºæ’å…¥prepared listï¼Œç„¶åå‘é€å“åº”ç»™ä¸»èŠ‚ç‚¹ã€‚</li>
<li>ä¸»èŠ‚ç‚¹æ¥æ”¶åˆ°æ‰€æœ‰ä»èŠ‚ç‚¹çš„ackåè¯·æ±‚å˜ä¸ºcomittedï¼Œå‘å®¢æˆ·ç«¯å‘é€å“åº”ã€‚</li>
<li>æ¯æ¬¡prepareæ¶ˆæ¯è¿˜å¸¦ä¸Šcommitted pointçš„åºåˆ—å·ï¼Œä»¥ä¾¿ä»èŠ‚ç‚¹ç§»åŠ¨committed pointã€‚</li>
</ul>
</li>
</ul>
<img src="/static/PacificA%20Replication%20in%20Log-Based%20Distributed%20Stor%206514f49fc42c4b8a91f2da1663a6af6a/Untitled.png">
<h2 id="22-configuration-management">2.2 Configuration Management</h2>
<p>ä½¿ç”¨é…ç½®ç®¡ç†å™¨ï¼ˆå¦‚Paxosï¼‰ç»´æŠ¤èŠ‚ç‚¹ä¿¡æ¯ã€‚åœ¨èŠ‚ç‚¹ç–‘ä¼¼å¤±æ•ˆæˆ–è€…æ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¼šæäº¤æ–°é…ç½®ã€‚åªæœ‰ç‰ˆæœ¬åŒ¹é…æ—¶æ‰å…è®¸æäº¤ã€‚</p>
<p>åœ¨å‡ºç°ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå¯èƒ½æœ‰å†²çªçš„é‡æ–°é…ç½®è¯·æ±‚ï¼šä¸»èŠ‚ç‚¹æƒ³è¦ç§»é™¤æŸäº›ä»èŠ‚ç‚¹ï¼Œè€ŒæŸäº›ä»èŠ‚ç‚¹æƒ³è¦ç§»é™¤ä¸»èŠ‚ç‚¹ã€‚å› ä¸ºè¿™äº›è¯·æ±‚éƒ½æ˜¯åŸºäºå½“å‰çš„é…ç½®ï¼Œå› æ­¤ç¬¬ä¸€ä¸ªè¢«Paxosæ¥å—çš„è¯·æ±‚è·å¾—èƒœåˆ©ï¼Œå…¶ä»–å†²çªçš„è¯·æ±‚å› ä¸ºç‰ˆæœ¬ä¸åŒ¹é…è€Œè¢«æ‹’ç»ã€‚</p>
<img src="/static/PacificA%20Replication%20in%20Log-Based%20Distributed%20Stor%206514f49fc42c4b8a91f2da1663a6af6a/Untitled%201.png">
<h2 id="23-leases-and-failure-detection">2.3 Leases and Failure Detection</h2>
<p>ä½¿ç”¨ç§Ÿçº¦æ¥é˜²æ­¢è„‘è£‚é—®é¢˜ã€‚</p>
<p>ä¸»èŠ‚ç‚¹ä»æ¯ä¸ªèŠ‚ç‚¹å–å¾—ç§Ÿçº¦ï¼Œç„¶åå®šæœŸå‘é€beaconæ¥ç»´æŠ¤ç§Ÿçº¦ã€‚å¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰æ”¶åˆ°ä»èŠ‚ç‚¹å¯¹beaconçš„å“åº”ï¼Œåˆ™ç§Ÿçº¦è¿‡æœŸã€‚å¦‚æœä»»ä¸€ç§Ÿçº¦è¿‡æœŸï¼Œä¸»èŠ‚ç‚¹ä¸å†è®¤ä¸ºè‡ªå·±æ˜¯ä¸»èŠ‚ç‚¹ï¼Œåœæ­¢å¤„ç†è¯»å†™è¯·æ±‚ï¼Œå…ˆä»Paxosä¸­ç§»é™¤å¤±æ•ˆçš„ä»èŠ‚ç‚¹ã€‚</p>
<p>åªè¦å‘é€beaconçš„èŠ‚ç‚¹æ˜¯å½“å‰é…ç½®çš„ä¸»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹å°±å›å¤ackã€‚è¶…è¿‡grace periodåæ²¡æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„beaconï¼Œä»èŠ‚ç‚¹è®¤ä¸ºç§Ÿçº¦è¿‡æœŸï¼Œè”ç³»Paxosç§»é™¤å½“å‰çš„ä¸»èŠ‚ç‚¹å¹¶æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚</p>
<p>å‡è®¾æ²¡æœ‰æ—¶é’Ÿé£˜ç§»ï¼Œåªè¦grace periodå¤§äºç­‰äºç§Ÿçº¦æ—¶é—´ï¼Œå°±å¯ä»¥ä¿è¯ç§Ÿçº¦åœ¨ä¸»èŠ‚ç‚¹ä¸Šè¿‡æœŸå…ˆäºåœ¨ä»èŠ‚ç‚¹ä¸Šè¿‡æœŸã€‚</p>
<p>æœ‰è¯·æ±‚æ—¶ï¼Œbeaconå’Œackå’Œé™„å¸¦å‘é€ã€‚æ²¡æœ‰è¯·æ±‚æ—¶ï¼Œæ‰éœ€è¦ä¸“é—¨å‘é€beaconå’Œackã€‚</p>
<h2 id="24-reconfiguration-reconciliation-and-recovery">2.4 Reconfiguration, Reconciliation, and Recovery</h2>
<p>æ–°çš„ä¸»èŠ‚ç‚¹å³ä½åå¼€å§‹reconciliationã€‚æ–°ä¸»å°†è‡ªå·±çš„prepared listå‘é€åˆ°æ‰€æœ‰ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹éœ€è¦æˆªæ–­æ–°ä¸»çš„committed pointä¹‹åçš„è¯·æ±‚ã€‚</p>
<p>å‘ç”Ÿä¸»èŠ‚ç‚¹åˆ‡æ¢æ—¶ï¼Œå·²æäº¤çš„åºåˆ—å·ä¼šè¢«ä¿æŒï¼Œè€Œæœªæäº¤çš„åºåˆ—å·åˆ™ä¸ä¸€å®šä¿æŒã€‚</p>
<p>æ–°çš„èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œä¸ºé¿å…é˜»å¡è¯·æ±‚å¤„ç†ï¼Œå…ˆä½œä¸ºå€™é€‰ä»èŠ‚ç‚¹åŠ å…¥ï¼Œè¿½ä¸Šåé€šçŸ¥ä¸»èŠ‚ç‚¹å°†å…¶ä½œä¸ºä»èŠ‚ç‚¹åŠ å…¥é…ç½®ä¸­ã€‚</p>
<p>åœ¨èŠ‚ç‚¹å…ˆè¢«ç§»é™¤é…ç½®ååˆé‡æ–°åŠ å›é…ç½®çš„åœºæ™¯ä¸­ï¼Œå¯ä»¥å…ˆä»prepared listä¸­æˆªæ–­ä¸ä¸€è‡´çš„è¯·æ±‚ï¼Œç„¶ååŒæ­¥å¢é‡è¯·æ±‚ã€‚</p>
<h2 id="25-correctness">2.5 Correctness</h2>
<blockquote>
<p>Linearizability: The system execution is equivalent to a linearized execution of all processed requests. <br />
Durability: If a client receives an acknowledgment from the system for an update, the update has been included in the equivalent linearized execution. <br />
Progress: Assuming that communication links between non-faulty servers are reliable, that the configuration manager eventually responds to reconfiguration requests, and that eventually there are no failures and no reconfigurations in the system, the system will return a response to each client request. <br /></p>
</blockquote>
<h2 id="26-implementations">2.6 Implementations</h2>
<p>å¦‚æœæ”¯æŒappend-onlyçš„åº”ç”¨çŠ¶æ€çš„è¯ï¼Œå¯ä»¥ç›´æ¥ç”¨ä½œprepared listã€‚</p>
<h2 id="27-discussions">2.7 Discussions</h2>
<p>æœ€å¤šå…è®¸n-1ä¸ªèŠ‚ç‚¹å¤±è´¥ã€‚</p>
<p>ä¸ºäº†åº”å¯¹æ•´ä¸ªå¤åˆ¶ç»„çš„çŸ­æš‚å¤±è´¥ï¼Œæ‰€æœ‰å‰¯æœ¬çš„prepared listå’Œcommitted pointéœ€è¦ç»´æŠ¤åœ¨æŒä¹…åŒ–å­˜å‚¨ä¸Šã€‚</p>
<p>å’ŒPaxosçš„å¯¹æ¯”</p>
<ol>
<li>Paxoså¯¹å°‘æ•°æ…¢èŠ‚ç‚¹ä¸æ•æ„Ÿï¼Œè€Œä¼šå¯¼è‡´primary/backupåè®®åœæ»ï¼Œç›´åˆ°é‡æ–°é…ç½®è¯·æ±‚å°†å…¶ä»å¤åˆ¶ç»„ä¸­ç§»é™¤ã€‚ç§Ÿçº¦æ—¶é—´ä¹Ÿéœ€è¦åˆç†é…ç½®ï¼Œå¦‚æœè¿‡å¤§åœ¨èŠ‚ç‚¹å¤±è´¥æ—¶ä¼šæœ‰æ¯”è¾ƒé•¿çš„åœæ»æ—¶é—´ï¼Œå¦‚æœè¿‡å°ä¼šå¯¼è‡´å‡é˜³æ€§ã€‚</li>
<li>PacificAå®¹å¿æ›´å¤šçš„èŠ‚ç‚¹å¤±è´¥ã€‚</li>
<li>PacificAçš„é‡æ–°é…ç½®å€ŸåŠ©é…ç½®ç®¡ç†å™¨å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ã€‚</li>
</ol>
<p>å¼±åŒ–ä¸€è‡´æ€§è¦æ±‚ï¼šç§Ÿçº¦è¿‡æœŸçš„ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ä¹Ÿå…è®¸å¤„ç†queryè¯·æ±‚ã€‚</p>
<h1 id="3-replication-for-distributed-log-based-storage-systems">3 REPLICATION FOR DISTRIBUTED LOG-BASED STORAGE SYSTEMS</h1>
<img src="/static/PacificA%20Replication%20in%20Log-Based%20Distributed%20Stor%206514f49fc42c4b8a91f2da1663a6af6a/Untitled%202.png">
<p>ä¸Šå›¾ä¸ºå•æœºæ¶æ„ã€‚</p>
<h2 id="31-logical-replication">3.1 Logical Replication</h2>
<p>åœ¨åº”ç”¨æ—¥å¿—åŸºç¡€ä¸ŠåŠ ä¸Š3ä¸ªå­—æ®µï¼šé…ç½®ç‰ˆæœ¬ã€åºåˆ—å·ã€ä¸Šä¸ªæäº¤çš„åºåˆ—å·ï¼Œå³å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæ—¥å¿—åŒæ—¶ä½œä¸ºåº”ç”¨æ—¥å¿—å’Œprepared requestå­˜å‚¨ã€‚å¯¹äºç›¸åŒåºåˆ—å·çš„æ—¥å¿—ï¼Œé«˜é…ç½®ç‰ˆæœ¬ä¼šè¦†ç›–ä½ç‰ˆæœ¬çš„æ—¥å¿—ã€‚</p>
<p>åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œæ¥æ”¶åˆ°prepareæ¶ˆæ¯æ—¶ï¼Œå‰¯æœ¬è¿½åŠ åˆ°æ—¥å¿—ä¸­ã€‚åœ¨ç¬¬äºŒä¸ªé˜¶æ®µï¼Œè¯·æ±‚æäº¤æ—¶ï¼Œè¢«åº”ç”¨åˆ°å†…å­˜ä¸­çš„æ•°æ®ç»“æ„ä¸­ã€‚</p>
<p>åœ¨checkpointåï¼Œå¯ä»¥æˆªæ–­å·²åº”ç”¨å’Œå·²checkpointçš„æ—¥å¿—ã€‚</p>
<p>logical-Væ˜¯logical replicationçš„å˜ä½“ï¼Œåªæœ‰ä¸»èŠ‚ç‚¹ç»´æŠ¤å†…å­˜çŠ¶æ€ï¼Œä»èŠ‚ç‚¹åªéœ€è¦è¿½åŠ æ—¥å¿—ï¼Œè€Œä¸éœ€è¦åº”ç”¨åˆ°å†…å­˜çŠ¶æ€ã€‚ä¸»èŠ‚ç‚¹ç”Ÿæˆå¿«ç…§çš„æ—¶å€™ï¼Œä»èŠ‚ç‚¹ä¹Ÿéœ€è¦fetchå¿«ç…§ï¼Œæˆªæ–­å·²è¢«ä¸¢å¼ƒæˆ–è€…å¿«ç…§çš„æ—¥å¿—ã€‚ä¼˜åŠ¿æ˜¯ä»èŠ‚ç‚¹æ¶ˆè€—æ›´å°‘çš„å†…å­˜å’ŒCPUï¼Œç¼ºç‚¹æ˜¯æ›´é«˜çš„ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼Œä¸»èŠ‚ç‚¹åˆ‡æ¢ä¹Ÿéœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´æ¥é‡å»ºå†…å­˜çŠ¶æ€ã€‚</p>
<h2 id="32-layered-replication">3.2 Layered Replication</h2>
<p>åŸºäºlogçš„å­˜å‚¨ç³»ç»Ÿç”±ä¸¤å±‚æ„æˆï¼šåº•å±‚æä¾›æŒä¹…åŒ–æ–‡ä»¶å­˜å‚¨ï¼Œä¸Šå±‚å°†åº”ç”¨é€»è¾‘å˜ä¸ºæ–‡ä»¶æ“ä½œã€‚</p>
<h2 id="33-log-merging">3.3 Log Merging</h2>
<p>ä¸€ä¸ªæœºå™¨ä¸Šæœ‰å¤šä¸ªå¤åˆ¶ç»„æ—¶ï¼Œéœ€è¦åˆå¹¶æ—¥å¿—ä»¥é¿å…å¯¼è‡´ç£ç›˜éšæœºseekã€‚</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>è®ºæ–‡ç¬”è®°ï¼šDiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node</title>
      <link>https://egolearner.github.io/post/diskann/</link>
      <pubDate>Sun, 13 Nov 2022 08:47:05 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/diskann/</guid>
      <description>&lt;ul&gt;
&lt;li&gt;Authors: Devvrit, Suhas Jayaram Subramanya&lt;/li&gt;
&lt;li&gt;Created: October 4, 2022 9:45 PM&lt;/li&gt;
&lt;li&gt;PublishedAt: NIPS&lt;/li&gt;
&lt;li&gt;URL: &lt;a href=&#34;https://suhasjs.github.io/files/diskann_neurips19.pdf&#34;&gt;https://suhasjs.github.io/files/diskann_neurips19.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Year: 2019&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;summary&#34;&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/h1&gt;
&lt;ol&gt;
&lt;li&gt;DiskANNä½¿ç”¨64G RAMæ¥ç´¢å¼•å’ŒæœåŠ¡100ç»´å·¦å³çš„10äº¿æ•°æ®é›†ï¼Œ95%ä»¥ä¸Šçš„1-recall@1çš„æ—¶å»¶åœ¨5msä»¥å†…ã€‚&lt;/li&gt;
&lt;li&gt;æå‡ºVamanaå›¾ç®—æ³•ï¼Œç›´å¾„æ¯”NSGå’ŒHNSWæ›´å°ã€‚&lt;/li&gt;
&lt;li&gt;å°†ç‚¹åŠ å…¥é‡å èšç±»ï¼Œæ¯ä¸ªèšç±»æ„å»ºVamanaç´¢å¼•ï¼Œç„¶åé€šè¿‡åˆå¹¶è¾¹æ¥å®ç°å›¾åˆå¹¶ï¼Œå’Œæ‰€æœ‰æ•°æ®ç‚¹æ„å»ºå•ä¸€ç´¢å¼•çš„æœç´¢æ€§èƒ½ç›¸è¿‘ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;strength&#34;&gt;&lt;strong&gt;Strength&lt;/strong&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;é€šè¿‡å°†ç‚¹åŠ å…¥é‡å èšç±»ï¼Œæ„å»ºçš„å›¾ç®€å•åˆå¹¶ä¹Ÿæœ‰ä¸é”™çš„æ•ˆæœã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;weakness&#34;&gt;&lt;strong&gt;Weakness&lt;/strong&gt;&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;å›¾ç´¢å¼•ç”¨åœ¨SSDä¸Šï¼Œç›´è§‰ä¸Šå¤ªå¤šéšæœºè®¿é—®æ•ˆæœåº”è¯¥ä¼šæ‰“æŠ˜æ‰£ï¼Œè™½ç„¶Vamanaåšäº†ä¼˜åŒ–ã€‚åç»­çš„SPANNé€šè¿‡å±‚æ¬¡å‡è¡¡èšç±»æ„å»ºå€’æ’ç´¢å¼•ï¼Œæ€§èƒ½è¶…è¿‡äº†DiskANNã€‚&lt;/li&gt;
&lt;li&gt;ç´¢å¼•ä¸­éœ€è¦åŒæ—¶å­˜åŸå§‹å‘é‡å’ŒPQå‹ç¼©å‘é‡ï¼Œåº”è¯¥ç£ç›˜ä½¿ç”¨ä¼šæ¯”è¾ƒå¤§ã€‚&lt;/li&gt;
&lt;li&gt;æ€§èƒ½æ•°æ®åªæ¯”è¾ƒäº†1-recall@1ï¼Œå¾ˆå¤šç³»ç»Ÿåœ¨å¬å›æ—¶ä¸æ­¢å¬å›ä¸€ä¸ªã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;take-away&#34;&gt;&lt;strong&gt;Take Away&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;å›¾ç´¢å¼•åˆå¹¶ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<ul>
<li>Authors: Devvrit, Suhas Jayaram Subramanya</li>
<li>Created: October 4, 2022 9:45 PM</li>
<li>PublishedAt: NIPS</li>
<li>URL: <a href="https://suhasjs.github.io/files/diskann_neurips19.pdf">https://suhasjs.github.io/files/diskann_neurips19.pdf</a></li>
<li>Year: 2019</li>
</ul>
<h1 id="summary"><strong>Summary</strong></h1>
<ol>
<li>DiskANNä½¿ç”¨64G RAMæ¥ç´¢å¼•å’ŒæœåŠ¡100ç»´å·¦å³çš„10äº¿æ•°æ®é›†ï¼Œ95%ä»¥ä¸Šçš„1-recall@1çš„æ—¶å»¶åœ¨5msä»¥å†…ã€‚</li>
<li>æå‡ºVamanaå›¾ç®—æ³•ï¼Œç›´å¾„æ¯”NSGå’ŒHNSWæ›´å°ã€‚</li>
<li>å°†ç‚¹åŠ å…¥é‡å èšç±»ï¼Œæ¯ä¸ªèšç±»æ„å»ºVamanaç´¢å¼•ï¼Œç„¶åé€šè¿‡åˆå¹¶è¾¹æ¥å®ç°å›¾åˆå¹¶ï¼Œå’Œæ‰€æœ‰æ•°æ®ç‚¹æ„å»ºå•ä¸€ç´¢å¼•çš„æœç´¢æ€§èƒ½ç›¸è¿‘ã€‚</li>
</ol>
<h2 id="strength"><strong>Strength</strong></h2>
<ol>
<li>é€šè¿‡å°†ç‚¹åŠ å…¥é‡å èšç±»ï¼Œæ„å»ºçš„å›¾ç®€å•åˆå¹¶ä¹Ÿæœ‰ä¸é”™çš„æ•ˆæœã€‚</li>
</ol>
<h2 id="weakness"><strong>Weakness</strong></h2>
<ol>
<li>å›¾ç´¢å¼•ç”¨åœ¨SSDä¸Šï¼Œç›´è§‰ä¸Šå¤ªå¤šéšæœºè®¿é—®æ•ˆæœåº”è¯¥ä¼šæ‰“æŠ˜æ‰£ï¼Œè™½ç„¶Vamanaåšäº†ä¼˜åŒ–ã€‚åç»­çš„SPANNé€šè¿‡å±‚æ¬¡å‡è¡¡èšç±»æ„å»ºå€’æ’ç´¢å¼•ï¼Œæ€§èƒ½è¶…è¿‡äº†DiskANNã€‚</li>
<li>ç´¢å¼•ä¸­éœ€è¦åŒæ—¶å­˜åŸå§‹å‘é‡å’ŒPQå‹ç¼©å‘é‡ï¼Œåº”è¯¥ç£ç›˜ä½¿ç”¨ä¼šæ¯”è¾ƒå¤§ã€‚</li>
<li>æ€§èƒ½æ•°æ®åªæ¯”è¾ƒäº†1-recall@1ï¼Œå¾ˆå¤šç³»ç»Ÿåœ¨å¬å›æ—¶ä¸æ­¢å¬å›ä¸€ä¸ªã€‚</li>
</ol>
<h2 id="take-away"><strong>Take Away</strong></h2>
<p>å›¾ç´¢å¼•åˆå¹¶ã€‚</p>
<h1 id="1-å¼•è¨€">1 å¼•è¨€</h1>
<p>æ€»ç»“å½“å‰10äº¿çº§å‘é‡æ£€ç´¢çš„è§£å†³æ–¹æ¡ˆ</p>
<p>æ–¹æ¡ˆ1ã€‚åŸºäºå€’æ’ç´¢å¼•å’Œæ•°æ®å‹ç¼©ï¼Œå…¸å‹ä¾‹å­Faisså’ŒIVFOADC+G+Pã€‚å°†å‘é‡åˆ’åˆ†ä¸ºMä¸ªèšç±»ï¼Œæ£€ç´¢æ—¶åªæ‰«æm &laquo; Mä¸ªåˆ†åŒºï¼›å› ä¸ºåŸå§‹æ•°æ®å†…å­˜ä¸­æ”¾ä¸ä¸‹ï¼Œä½¿ç”¨ä½¿ç”¨PQç­‰é‡åŒ–æ‰‹æ®µæ¥å‹ç¼©æ•°æ®ã€‚ä¼˜ç‚¹æ˜¯å†…å­˜ä½¿ç”¨ä½ï¼Œ128ç»´10äº¿ç‚¹ä½¿ç”¨å°äº64GBçš„å†…å­˜ã€‚ç¼ºç‚¹æ˜¯ç”±äºæ•°æ®å‹ç¼©æœ‰æŸï¼Œ1-recall@1åªæœ‰0.5å·¦å³ã€‚</p>
<p>æ–¹æ¡ˆ2ã€‚æ•°æ®åˆ’åˆ†ä¸ºä¸ç›¸äº¤åˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡æ„å»ºå†…å­˜ç´¢å¼•ã€‚ä¼˜ç‚¹æ˜¯å¬å›å¾ˆé«˜ï¼Œç¼ºç‚¹æ˜¯å†…å­˜ä½¿ç”¨å¾ˆå¤§ã€‚</p>
<p>è®ºæ–‡è®¤ä¸ºä¸Šè¿°ä¸¤ä¸ªæ–¹æ¡ˆçš„å±€é™åœ¨äºå®ƒä»¬æ„å»ºçš„ç´¢å¼•åªèƒ½ä½¿ç”¨å†…å­˜æœåŠ¡ã€‚</p>
<p>é›¶å”®çº§çš„SSDä¸€æ¬¡éšæœºè¯»éœ€è¦å‡ ç™¾å¾®ç§’ï¼Œæ¯ç§’èƒ½å¤„ç†çº¦300kçš„éšæœºè¯»ã€‚è€Œæœç´¢åº”ç”¨ä¸­æœ€è¿‘é‚»æ£€ç´¢çš„æ—¶å»¶è¦æ±‚ä¸ºå‡ æ¯«ç§’ã€‚å› æ­¤è®¾è®¡é«˜æ•ˆçš„SSDé©»ç•™ç´¢å¼•çš„å…³é”®æœ‰ä¸¤ç‚¹ï¼šå‡å°‘éšæœºSSDè®¿é—®åˆ°å‡ åä¸ªï¼›å‡å°‘åˆ°ç£ç›˜çš„round tripè¯·æ±‚æ•°åˆ°10ä¸ªä»¥å†…ï¼Œæœ€å¥½åˆ°5ä¸ªã€‚ï¼ˆä¸ªäººç†è§£ç¬¬ä¸€ç‚¹åœ¨å¼ºè°ƒå›¾çš„ç›´å¾„ä¸èƒ½å¤ªå¤§ï¼Œç¬¬äºŒç‚¹åœ¨å¼ºè°ƒå‡å°‘ç£ç›˜è®¿é—®ï¼Œå³åé¢æå‡ºçš„Wå‚æ•°ï¼‰</p>
<h1 id="2-vamana-å›¾æ„å»ºç®—æ³•">2 Vamana å›¾æ„å»ºç®—æ³•</h1>
<h2 id="21-è¿‘ä¼¼é‚»å±…å›¾å’Œgreedysearchç®—æ³•">2.1 è¿‘ä¼¼é‚»å±…å›¾å’ŒGreedySearchç®—æ³•</h2>
<p>åŸºäºè¿‘ä¼¼å›¾çš„æ£€ç´¢ç®—æ³•ï¼Œä¸€èˆ¬é‡‡ç”¨è´ªå¿ƒç®—æ³•ï¼Œä»æŸä¸ªç‚¹å‡ºå‘ï¼Œéå†å›¾æ¥æ¸è¿‘çš„è¶‹å‘æ£€ç´¢ç‚¹ã€‚è¿™è¦æ±‚è¿‘ä¼¼å›¾æ»¡è¶³sparse neighborhood graph(SNG)çš„æ€§è´¨ã€‚SNGä¸­ç¡®å®šä¸€ä¸ªç‚¹pçš„å‡ºé‚»å±…çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>initialize a set S = P \ {p}. As long as S != âˆ…, add a directed edge from p to pâˆ—, where pâˆ— is the closest point to p from S, and remove from S all points pâ€² such that d(p, pâ€²) &gt; d(pâˆ—, pâ€²). It is then easy to see that GreedySearch(s, x_p, 1, 1) starting at any s âˆˆ P would converge to p for all base points p âˆˆ P .</p>
</blockquote>
<p>å¤§è‡´æ˜¯ä»Sä¸­é€‰ä¾æ¬¡é€‰åˆ°pæœ€è¿‘çš„ç‚¹p*ï¼Œç„¶åç§»é™¤Sä¸­åˆ°pæ¯”åˆ°p*æ›´è¿œçš„ç‚¹ï¼Œç›´åˆ°Sä¸ºç©ºã€‚</p>
<p>SNGçš„å¤æ‚åº¦æ˜¯O(n2)ï¼Œå› æ­¤ä¸å¯è¡Œã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼ŒHNSWå’ŒSSGéƒ½æ˜¯å¯¹SNGçš„è¿‘ä¼¼ï¼Œå› æ­¤è¿™äº›ç®—æ³•è¾“å‡ºçš„å›¾çš„ç›´å¾„å’Œå¯†åº¦éƒ½æ˜¯ä¸å¯çµæ´»æ§åˆ¶çš„ã€‚</p>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled.png">
<h2 id="22-å¥å£®å‰ªæè¿‡ç¨‹">2.2 å¥å£®å‰ªæè¿‡ç¨‹</h2>
<p>æ»¡è¶³SNGæ€§è´¨çš„å›¾çš„ç›´å¾„å¯èƒ½éå¸¸å¤§ã€‚è®ºæ–‡ç»™å‡ºçš„æç«¯æƒ…å†µä¸ºæ‰€æœ‰ç‚¹éƒ½åœ¨ä¸€æ¡ç›´çº¿ä¸Šï¼ŒæŒ‰ç…§SSGçš„é€‰è¾¹ç®—æ³•æ¯ä¸ªç‚¹åªä¼šè¿æ¥æœ€è¿‘çš„ä¸¤ä¸ªç‚¹ã€‚è€ŒæŒ‰ç…§Vamanaçš„ç®—æ³•ï¼Œæœ‰å¯èƒ½è¿æ¥æ›´å¤šçš„ç‚¹ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥ä¹˜æ•°Î±&gt;1è¦æ±‚æ£€ç´¢è·¯å¾„ä¸Šçš„ç‚¹åˆ°queryçš„è·ç¦»ä¾æ¬¡å‡å°‘Î±å€ã€‚</p>
<p>å¦‚æœç‚¹pçš„å‡ºé‚»å±…é€šè¿‡RobustPrune(p, P \ {p}, Î±, n-1) ç¡®å®šï¼Œå¯ä»¥ä¿è¯GreedySearch(s, p, 1, 1) ä»ä»»æ„ç‚¹så‡ºå‘å°†åœ¨logå¤æ‚åº¦å†…æ”¶æ•›åˆ° p âˆˆ Pã€‚ä½†æ˜¯è¿™éœ€è¦O(n2)çš„è¿è¡Œæ—¶é—´ã€‚Vamanaé€šè¿‡ç²¾å¿ƒæŒ‘é€‰Vå’Œè¿œå°äºn-1çš„ç‚¹æ¥ä¼˜åŒ–ç´¢å¼•æ„å»ºæ—¶é—´ã€‚</p>
<p>RobustPruneæœ€åçš„è£è¾¹ä¸­ï¼Œé€šè¿‡å¼•å…¥Î±ï¼Œå°†è·ç¦»p*æ¯”è·ç¦»pè¿‘1/Î±å€çš„ç‚¹ç§»é™¤æ‰äº†ï¼Œå¯ä»¥ä¿ç•™æ›´å¤šçš„é•¿è¾¹ï¼ˆÎ±è¶Šå¤§ï¼Œè¶Šæœ‰å¯èƒ½åœ¨å€™é€‰é›†ä¸­ä¿ç•™è·ç¦»pæ›´è¿œçš„ç‚¹ï¼‰ã€‚</p>
<h2 id="23-vamanaç´¢å¼•ç®—æ³•">2.3 Vamanaç´¢å¼•ç®—æ³•</h2>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled%201.png">
<ol>
<li>é¦–å…ˆéšæœºåˆå§‹åŒ–Gï¼Œæ¯ä¸ªç‚¹æœ‰Rä¸ªéšæœºé€‰æ‹©çš„å‡ºé‚»å±…ã€‚</li>
<li>è®¡ç®—æ•°æ®é›†Pçš„ä¸­å¿ƒç‚¹sï¼Œä½œä¸ºæ£€ç´¢ç®—æ³•çš„èµ·å§‹ç‚¹ã€‚</li>
<li>éšæœºéå†Pçš„æ‰€æœ‰ç‚¹pï¼Œå¯¹GreedySearchè®¿é—®çš„ç‚¹è¿è¡ŒRobustPruneæ¥å¾—åˆ°ç‚¹pçš„å‡ºé‚»å±…ã€‚</li>
<li>å¯¹ç‚¹pçš„å‡ºé‚»å±…pâ€™æ·»åŠ åå‘è¾¹pâ€™pï¼Œå¦‚æœå‡ºåº¦è¶…è¿‡Råˆ™è¿è¡ŒRobustPruneæ¥é€‰è¾¹ã€‚</li>
</ol>
<p>éšç€ç®—æ³•çš„è¿è¡Œï¼Œå›¾å˜å¾—ä¸€è‡´åœ°æ›´å¥½ï¼ŒGreedySearchè¿è¡Œæ›´å¿«ã€‚</p>
<p>æ•´ä½“ç®—æ³•è¿è¡Œä¸¤éï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨Î±=1è¿è¡Œï¼Œç¬¬äºŒæ¬¡ä½¿ç”¨ç”¨æˆ·å®šä¹‰çš„Î±â‰¥1è¿è¡Œã€‚ä½œè€…è§‚å¯Ÿåˆ°ç¬¬äºŒæ¬¡è¿è¡Œå¾—åˆ°æ›´å¥½çš„å›¾ï¼Œå¦‚æœä¸¤æ¬¡éƒ½ç”¨ç”¨æˆ·å®šä¹‰çš„Î±è¿è¡Œä¼šä½¿ç´¢å¼•ç®—æ³•å˜æ…¢ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡è¿è¡Œè®¡ç®—å‡ºçš„å›¾çš„å¹³å‡åº¦æ•°æ›´å¤§ï¼Œè®¡ç®—æ—¶é—´ä¹Ÿæ›´é•¿ã€‚ï¼ˆç¬¬ä¸€æ¬¡è¿è¡Œå¦‚æœä½¿ç”¨Î±&gt;1çš„è¯ï¼Œå€™é€‰é›†ä¸­ä¿ç•™äº†æ›´å¤šçš„ç‚¹ï¼Œæœ€åçš„åº¦æ•°ä¹Ÿä¼šæ›´å¤§ï¼‰</p>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled%202.png">
<p>ç¬¬äºŒæ¬¡è¿è¡Œå¼•å…¥äº†é•¿è¾¹ã€‚</p>
<h2 id="24-å¯¹æ¯”hnswå’Œnsg">2.4 å¯¹æ¯”HNSWå’ŒNSG</h2>
<p>HNSWå’ŒNSGæ²¡æœ‰è¶…å‚æ•°Î±ï¼Œéšå«ä½¿ç”¨äº†Î±=1. è¿™æ˜¯Vamanaå®ç°åœ¨å›¾çš„åº¦æ•°å’Œç›´å¾„ä¹‹é—´æ›´å¥½æƒè¡¡çš„ä¸»è¦å› ç´ ã€‚</p>
<ul>
<li>HNSWä½¿ç”¨GreedySearchçš„è¾“å‡ºä½œä¸ºå‰ªæçš„å€™é€‰é›†ï¼Œè€ŒVamanaå’ŒSNGéƒ½ä½¿ç”¨GreedySearchè®¿é—®è¿‡çš„ç‚¹ä½œä¸ºå€™é€‰é›†ã€‚ç›´è§‰ä¸Šæ¥è¯´ï¼Œè¿™å¸®åŠ©Vamanaå’ŒNSGæ·»åŠ äº†é•¿è¾¹ï¼Œè€ŒHNSWåªæœ‰é‚»è¿‘è¾¹è¿˜éœ€è¦åœ¨é‡‡æ ·çš„ç‚¹ä¸Šæ„å»ºåˆ†å±‚å›¾ã€‚</li>
<li>NSGè¦æ±‚è¾“å…¥ä¸ºæ„å»ºè€—æ—¶é•¿å’Œå†…å­˜ä½¿ç”¨é«˜çš„kNNé‚»å±…å›¾ï¼ŒHNSWå’ŒVamanaæœ‰æ›´ç®€å•çš„åˆå§‹åŒ–ï¼ŒHNSWä½¿ç”¨ç©ºç™½å›¾ï¼ŒVamanaä½¿ç”¨éšæœºå›¾ã€‚Vamanaä½¿ç”¨éšæœºå›¾åˆå§‹åŒ–æ¯”ç©ºç™½å›¾åˆå§‹åŒ–å¾—åˆ°çš„ç»“æœå›¾çš„è´¨é‡æ›´å¥½ã€‚</li>
<li>Vamanaéœ€è¦è¿è¡Œä¸¤éï¼ŒHNSWå’ŒNSGåªéœ€è¦è¿è¡Œä¸€éã€‚</li>
</ul>
<h1 id="3-diskannæ„å»ºssdé©»ç•™çš„ç´¢å¼•">3 DiskANNï¼šæ„å»ºSSDé©»ç•™çš„ç´¢å¼•</h1>
<h2 id="31-ç´¢å¼•è®¾è®¡">3.1 ç´¢å¼•è®¾è®¡</h2>
<p>åŸºæœ¬æ€æƒ³æ˜¯æ„å»ºVamanaç´¢å¼•å¹¶å­˜å‚¨åˆ°SSDä¸Šã€‚æœ‰ä¸¤ä¸ªé—®é¢˜éœ€è¦è§£å†³ï¼šå¦‚ä½•æ„å»ºæœ‰10äº¿ä¸ªç‚¹çš„å›¾ï¼Ÿå†…å­˜ä¸­å­˜ä¸ä¸‹çš„æƒ…å†µä¸‹å¦‚ä½•è®¡ç®—queryç‚¹å’Œå€™é€‰åˆ—è¡¨çš„ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Ÿ</p>
<p>ä¸å…¶åœ¨æ£€ç´¢æ—¶å°†queryç‚¹è·¯ç”±åˆ°å¤šä¸ªåˆ†ç‰‡ï¼Œä¸å¦‚å°†base pointå‘å¾€å¤šä¸ªä¸´è¿‘çš„ä¸­å¿ƒç‚¹æ¥å½¢æˆé‡å çš„èšç±»ã€‚</p>
<ol>
<li>å°†10äº¿ä¸ªç‚¹ä½¿ç”¨k-meansåˆ’åˆ†ä¸ºkä¸ªèšç±»ï¼ˆæ¯”å¦‚k=40ï¼‰</li>
<li>å°†æ¯ä¸ªbase pointåˆ†é…åˆ°lä¸ªæœ€è¿‘çš„ä¸­å¿ƒç‚¹ï¼ˆé€šå¸¸l=2å°±è¶³å¤Ÿäº†ï¼‰</li>
<li>åœ¨æ¯ä¸ªèšç±»ä¸Šæ„å»ºVamanaç´¢å¼•ï¼Œå¤§çº¦æœ‰Nl/kä¸ªç‚¹ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­æ„å»ºã€‚</li>
<li>é€šè¿‡ç®€å•çš„åˆå¹¶è¾¹å°†å¤šä¸ªå›¾åˆå¹¶ä¸ºä¸€ä¸ªå›¾ã€‚</li>
</ol>
<p>ç»éªŒåœ°ï¼Œä¸åŒèšç±»çš„é‡å æ€§æä¾›äº†è¶³å¤Ÿçš„è¿æ¥æ€§ï¼Œå³ä½¿queryç‚¹çš„æœ€è¿‘çš„é‚»å±…åˆ†å¼€åœ¨å¤šä¸ªåˆ†ç‰‡æ—¶GreedySearchä¹Ÿèƒ½æˆåŠŸã€‚</p>
<p>è§£å†³ç¬¬äºŒä¸ªé—®é¢˜çš„æ€è·¯ä¸ºåœ¨å†…å­˜ä¸­å­˜å‚¨æ¯ä¸ªç‚¹çš„PQå‹ç¼©åçš„å‘é‡ï¼ŒåŒæ—¶åœ¨SSDä¸Šå­˜å‚¨å›¾ã€‚è®ºæ–‡æŒ‡å‡ºVamanaæ„å»ºç´¢å¼•æ—¶ä½¿ç”¨å…¨ç²¾åº¦çš„åæ ‡ï¼Œå› æ­¤å³ä½¿åœ¨æ£€ç´¢æ—¶ä½¿ç”¨å‹ç¼©åçš„æ•°æ®ï¼Œä¹Ÿèƒ½é«˜æ•ˆçš„å¼•å¯¼æ£€ç´¢åˆ°å›¾ä¸­æ­£ç¡®çš„åŒºåŸŸã€‚</p>
<h2 id="32-ç´¢å¼•å¸ƒå±€">3.2 ç´¢å¼•å¸ƒå±€</h2>
<p>å†…å­˜ä¸­å­˜å‚¨å‹ç¼©åçš„æ‰€æœ‰æ•°æ®ç‚¹ï¼ŒSSDä¸Šå­˜å‚¨å›¾å’Œå…¨ç²¾åº¦çš„å‘é‡ã€‚åœ¨ç£ç›˜ä¸Šï¼Œåœ¨æ¯ä¸ªç‚¹çš„â‰¤Rä¸ªé‚»å±…ä¹‹åå­˜å‚¨çš„æ˜¯å…¨ç²¾åº¦å‘é‡ã€‚åœ¨åº¦æ•°å°äºRæ—¶è¡¥0ï¼Œä»¥ä¾¿å¯ä»¥ç›´æ¥è®¡ç®—offsetã€‚</p>
<h2 id="33-beam-search">3.3 Beam Search</h2>
<p>åŸºæœ¬çš„è´ªå¿ƒç®—æ³•çš„é—®é¢˜æ˜¯éœ€è¦æœ‰è®¸å¤šSSD roundtripï¼Œå¯¼è‡´é«˜å»¶è¿Ÿã€‚ä¸ºäº†å‡å°‘SSD roundtripæ•°è€Œä¸è¿‡åº¦å¢åŠ è®¡ç®—é‡ï¼Œæˆ‘ä»¬ä¸€æ¬¡è·å– $\mathcal{L} \backslash \mathcal{V}$ ä¸­Wï¼ˆæ¯”å¦‚4ï¼Œ8ï¼‰ä¸ªæœ€è¿‘çš„ç‚¹çš„é‚»å±…ï¼Œæ›´æ–°$\mathcal{L}$ä¸ºtop Lçš„å€™é€‰é›†ã€‚æ³¨æ„ä»SSDè¯»å–å°‘é‡çš„éšæœºæ‰‡åŒºçš„æ—¶é—´å‡ ä¹å’Œä¸€ä¸ªæ‰‡åŒºçš„æ—¶é—´ç›¸åŒã€‚ä¿®æ”¹åçš„æ£€ç´¢ç®—æ³•ç§°ä¸ºBeamSearchã€‚åœ¨W=1æ—¶ï¼Œç­‰ä»·äºè´ªå¿ƒæ£€ç´¢ã€‚å¦‚æœWè¿‡å¤§ï¼Œæ¯”å¦‚16æˆ–æ›´å¤šï¼Œè®¡ç®—å’ŒSSDå¸¦å®½éƒ½å¯èƒ½æ˜¯æµªè´¹çš„ã€‚</p>
<p>SSDå¸¦å®½æ‰“æ»¡æ—¶ï¼Œè¯»å»¶è¿Ÿä¼šè¶…è¿‡1msã€‚å› æ­¤éœ€è¦åœ¨æ›´ä½çš„è´Ÿè½½ä¸‹è¿ç»´SSDä»¥ä¿è¯ä½æ£€ç´¢å»¶è¿Ÿã€‚è®ºæ–‡å‘ç°åœ¨ä½å¹³è¡¡å®½åº¦æ—¶ï¼ˆå¦‚W=2,4,8ï¼‰èƒ½åœ¨å»¶è¿Ÿå’Œååä¹‹é—´å–å¾—å¹³è¡¡ã€‚è¿™æ—¶SSDçš„load factoråœ¨30-40%ï¼Œæ¯ä¸ªçº¿ç¨‹queryå¤„ç†çš„æ—¶é—´ä¸­40-50%æ˜¯åœ¨IOä¸Šã€‚</p>
<h2 id="34-ç¼“å­˜é¢‘ç¹è®¿é—®çš„ç‚¹">3.4 ç¼“å­˜é¢‘ç¹è®¿é—®çš„ç‚¹</h2>
<p>ä¸ºäº†è¿›ä¸€æ­¥å‡å°‘æ¯ä¸ªqueryçš„ç£ç›˜è®¿é—®æ•°ï¼Œåœ¨å†…å­˜ä¸­ç¼“å­˜ä¸€éƒ¨åˆ†ç‚¹ï¼Œè¦ä¹ˆåŸºäºå·²çŸ¥çš„queryåˆ†å¸ƒï¼Œè¦ä¹ˆç®€å•çš„ç¼“å­˜ä»èµ·å§‹ç‚¹å¼€å§‹C=3,4è·³çš„ç‚¹ã€‚å› ä¸ºç‚¹çš„ä¸ªæ•°éšCæŒ‡æ•°å¢é•¿ï¼Œæ›´å¤§çš„Cå¸¦æ¥æ›´å¤§çš„å†…å­˜ä½¿ç”¨ã€‚</p>
<h2 id="35-ä½¿ç”¨å…¨ç²¾åº¦å‘é‡éšå¼re-ranking">3.5 ä½¿ç”¨å…¨ç²¾åº¦å‘é‡éšå¼Re-Ranking</h2>
<p>PQæ˜¯æœ‰æŸå‹ç¼©ï¼Œå› æ­¤ä½¿ç”¨PQå’Œä½¿ç”¨çœŸå®è·ç¦»è®¡ç®—çš„kä¸ªå€™é€‰é›†å¯èƒ½æœ‰å·®åˆ«ã€‚ä¸ºäº†æ¶ˆé™¤å·®è·ï¼Œè®ºæ–‡ä½¿ç”¨åœ¨æ¯ä¸ªç‚¹çš„é‚»å±…ä¹‹åå­˜å‚¨çš„å…¨ç²¾åº¦å‘é‡ã€‚é‚»å±…å…³ç³»å’Œå…¨ç²¾åº¦å‘é‡å¯ä»¥å­˜å‚¨åœ¨åŒä¸€æ‰‡åŒºå†…ï¼Œå› æ­¤åœ¨BeamSearchåŠ è½½é‚»å±…ä¿¡æ¯æ—¶ï¼Œä¹Ÿå¯ä»¥ç¼“å­˜åœ¨æœç´¢è¿‡ç¨‹ä¸­è®¿é—®è¿‡çš„æ‰€æœ‰ç‚¹çš„å…¨ç²¾åº¦å‘é‡ï¼Œè€Œä¸ä½¿ç”¨é¢å¤–çš„SSDè¯»ã€‚è¿™å¯ä»¥è®©æˆ‘ä»¬åŸºäºå…¨ç²¾åº¦å‘é‡æ¥è¿”å›top kå€™é€‰é›†ã€‚ï¼ˆæŒ‰ä¸Šé¢çš„ç®—æ³•1ï¼Œè®¿é—®è¿‡çš„ç‚¹éƒ½æ˜¯è¦è®°å½•çš„ï¼Œæœ‰é¢å¤–çš„è®¡ç®—å¼€é”€ä½†æ²¡æœ‰å†…å­˜å¼€é”€ã€‚ï¼‰</p>
<h1 id="4-è¯„ä¼°">4 è¯„ä¼°</h1>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled%203.png">
<p>æ‰€æœ‰æ•°æ®é›†ä¸­ï¼ŒVamanaè¶…è¿‡äº†HNSWã€‚åœ¨GIST1Mä¸­ï¼ŒVamanaè¶…è¿‡äº†NSGã€‚å¦å¤–åœ¨ä¸‰ä¸ªå®éªŒä¸­ï¼ŒVamanaçš„ç´¢å¼•æ„å»ºæ—¶é—´çŸ­äºHNSWå’ŒNSGã€‚åœ¨DEEP1Mä¸Šï¼Œåˆ†åˆ«ä¸º129s, 219s, 480sï¼ˆåŒ…å«EFANNæ„å»ºkNNå›¾çš„æ—¶é—´ï¼‰ã€‚</p>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled%204.png">
<p>è·³æ•°æŒ‡åœ¨æ£€ç´¢çš„å…³é”®è·¯å¾„ä¸­ç£ç›˜è®¿é—®çš„è½®æ•°ã€‚HNSWå’ŒNSGæœ‰åœæ»çš„è¶‹åŠ¿ï¼Œè€ŒVamanaéšæœ€å¤§åº¦æ•°å’ŒÎ±çš„å¢åŠ è·³æ•°åœ¨å‡å°‘ã€‚ä½œè€…æ¨æ–­Î±&gt;1çš„Vamanaç›¸æ¯”å…¶ä»–å›¾ç®—æ³•æ›´æœ‰æ•ˆçš„åˆ©ç”¨äº†SSDæä¾›çš„å¤§å®¹é‡ã€‚</p>
<img src="/static/DiskANN%20Fast%20Accurate%20Billion-point%20Nearest%20Neighb%20121a2edf1de742c0be953e90c69ed864/Untitled%205.png">
<p>ä¸ºäº†è¯´æ˜å°ç´¢å¼•åˆå¹¶ç®—æ³•çš„æœ‰æ•ˆæ€§ï¼Œè®ºæ–‡åˆ†åˆ«åœ¨é«˜é…æœºå™¨ä¸Šæ„å»º1ä»½å¤§ç´¢å¼•å’Œåœ¨ä½é…æœºå™¨ä¸Šæ„å»ºkä»½å°ç´¢å¼•å¹¶åˆå¹¶ä¸º1ä»½ç´¢å¼•ã€‚2(a)ä¸­å•ä¸€ç´¢å¼•çš„æ€§èƒ½ä¼˜äºåˆå¹¶ç´¢å¼•ï¼Œå› ä¸ºåˆå¹¶ç´¢å¼•éœ€è¦éå†æ›´å¤šçš„è¿æ¥ã€‚ä½†åˆå¹¶ç´¢å¼•çš„æ•ˆæœä¹Ÿè¶³å¤Ÿå¥½ï¼Œä¼˜äºå½“æ—¶çš„state-of-art IVFOADC+G+Pï¼Œå»¶æ—¶ä»…æ¯”å•ä¸€ç´¢å¼•æ…¢ä¸åˆ°20%.</p>
<p>ç”±äºIVFOADC+G+Påœ¨ä¹‹å‰çš„è®ºæ–‡ä¸­è¯æ˜äº†æ•ˆæœä¼˜äºFAISSï¼Œè®ºæ–‡åªå¯¹æ¯”äº†DiskANNå’ŒIVFOADC+G+Pã€‚IVFOADC+G+Pçš„1-recall@1ä¸Šé™ä¸º62.74%ï¼Œè€ŒDiskANNä¸º100%ï¼Œæ»¡è¶³1-recall@1é«˜äº95%æ—¶çš„æ—¶å»¶åœ¨3.5msä»¥ä¸‹ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h1>
<p>å®¡ç¨¿æ„è§</p>
<ul>
<li><a href="https://proceedings.neurips.cc/paper/2019/file/09853c7fb1d3f8ee67a61b6bf4a7f8e6-Reviews.html">Reviews: DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single Node (neurips.cc)</a></li>
</ul>
<p>è§†é¢‘</p>
<ul>
<li><a href="https://northwestern.hosted.panopto.com/Panopto/Pages/Viewer.aspx?id=afbc4c0c-0464-499c-816c-af0e015777f8">Theory-in-Practice Day one- Harsha Simhadri (panopto.com)</a></li>
<li><a href="https://www.youtube.com/watch?v=BnYNdSIKibQ">Research talk: Approximate nearest neighbor search systems at scale - YouTube</a></li>
</ul>
<p>è®ºæ–‡ç¬”è®°</p>
<ul>
<li><a href="https://mp.weixin.qq.com/s/KgjpRGF4AoUskFESZR4lxQ">Paper Reading | DiskANNï¼š åäº¿è§„æ¨¡æ•°æ®é›†ä¸Šé«˜å¬å›é«˜ QPS çš„ ANNS å•æœºæ–¹æ¡ˆ (qq.com)</a></li>
<li><a href="https://www.jianshu.com/p/07ed2202f107">2019NIPS-(å¤§æ•°æ®é›†åŸºäºå›¾çš„KNNç®—æ³•)DiskANN: Fast Accurate Billion-point Nearest Neighbor Search on a Single &hellip; - ç®€ä¹¦ (jianshu.com)</a></li>
<li><a href="https://blog.csdn.net/whenever5225/article/details/106863674">DiskANNï¼šåœ¨å•æœºä¸Šå¿«é€Ÿå‡†ç¡®åœ°è¿›è¡Œåäº¿æ•°æ®æœ€è¿‘é‚»æœç´¢(å¾®è½¯å°åº¦ç ”ç©¶é™¢)â€”â€”NeurIPS 2019_ç¨‹åºå‘˜ç‹åŒå­¦çš„åšå®¢-CSDNåšå®¢</a></li>
<li><a href="https://blog.csdn.net/whenever5225/article/details/122147361">DiskANNåäº¿çº§è§„æ¨¡å‘é‡æ£€ç´¢æ–¹æ¡ˆè®ºæ–‡æµ…è°ˆ_ç¨‹åºå‘˜ç‹åŒå­¦çš„åšå®¢-CSDNåšå®¢</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>braftæºç åˆ†æ</title>
      <link>https://egolearner.github.io/post/braft-source-read/</link>
      <pubDate>Sun, 23 Oct 2022 15:44:11 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/braft-source-read/</guid>
      <description>&lt;p&gt;bratæ˜¯ç™¾åº¦å¼€æºçš„RAFTå®ç°ã€‚&lt;/p&gt;
&lt;h2 id=&#34;åˆå§‹åŒ–&#34;&gt;åˆå§‹åŒ–&lt;/h2&gt;
&lt;p&gt;braft::add_serviceæ·»åŠ çš„æœåŠ¡&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pr</description>
      <content:encoded><![CDATA[<p>bratæ˜¯ç™¾åº¦å¼€æºçš„RAFTå®ç°ã€‚</p>
<h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h2>
<p>braft::add_serviceæ·»åŠ çš„æœåŠ¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="c1">// å‘é€æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="n">file_service</span><span class="p">(),</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_DOESNT_OWN_SERVICE</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// raftå®ç°ï¼Œpre_vote/request_vote/append_entries/install_snapshot/timeout_now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="n">RaftServiceImpl</span><span class="p">(</span><span class="n">listen_address</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="k">new</span> <span class="n">RaftStatImpl</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘½ä»¤è¡Œæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">server</span><span class="o">-&gt;</span><span class="n">AddService</span><span class="p">(</span><span class="k">new</span> <span class="n">CliServiceImpl</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">SERVER_OWNS_SERVICE</span><span class="p">))</span> <span class="p">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>NodeImpl::init</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_vote_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span> <span class="o">+</span> <span class="n">options</span><span class="p">.</span><span class="n">max_clock_drift_ms</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_election_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_stepdown_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_snapshot_timer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">snapshot_interval_s</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_apply_queue_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">execute_applying_tasks</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// log storage and log manager init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_log_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–fsm calleræ—¶åˆ›å»ºäº†å¦å¤–ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_fsm_caller</span><span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// commitment manager init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_ballot_box</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BallotBox</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">ballot_box_options</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// snapshot storage init and load
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_snapshot_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// if have log using conf in log, else using conf in options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">_options</span><span class="p">.</span><span class="n">initial_conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// init meta and check term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">init_meta_storage</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Now the raft node is started , have to acquire the lock to avoid race
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// conditions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ—¶é©¬ä¸Šé€‰ä¸¾è‡ªå·±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1u</span>
</span></span><span class="line"><span class="cl">            <span class="o">&amp;&amp;</span> <span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">_server_id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The group contains only this server which must be the LEADER, trigger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the timer immediately.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">elect_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é€‰ä¸¾é˜¶æ®µ"><strong><strong>é€‰ä¸¾é˜¶æ®µ</strong></strong></h2>
<p>é€‰ä¸¾è¶…æ—¶å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_election_timeout</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_FOLLOWER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger vote manually, or wait until follower lease expire.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_vote_triggered</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_follower_lease</span><span class="p">.</span><span class="n">expired</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">triggered</span> <span class="o">=</span> <span class="n">_vote_triggered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_vote_triggered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Reset leader as the leader is uncerntain on election timeout.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">PeerId</span> <span class="n">empty_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ERAFTTIMEDOUT</span><span class="p">,</span> <span class="s">&#34;Lost connection from leader %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">_leader_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é‡Œé¢ä¼šæ ¹æ®æƒ…å†µæƒ…å†µå›è°ƒon_start_following/on_stop_following
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">reset_leader_id</span><span class="p">(</span><span class="n">empty_id</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘èµ·é¢„é€‰ä¸¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">pre_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">,</span> <span class="n">triggered</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Don&#39;t touch any thing of *this ever after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pre_vote">pre_vote</h3>
<p>Pre_vote ç®—æ³•æ˜¯ raft ä½œè€…åœ¨å…¶åšå£«è®ºæ–‡ä¸­æå‡ºçš„ï¼Œåœ¨èŠ‚ç‚¹å‘èµ·ä¸€æ¬¡é€‰ä¸¾æ—¶ï¼Œä¼šå…ˆå‘èµ·ä¸€æ¬¡ prevote è¯·æ±‚ï¼Œåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿèµ¢å¾—é€‰ä¸¾ï¼Œèµ¢å¾—é€‰ä¸¾çš„æ¡ä»¶ä¸æ­£å¸¸é€‰ä¸¾ç›¸åŒã€‚å¦‚æœå¯ä»¥ï¼Œåˆ™å¢åŠ  term å€¼ï¼Œå¹¶å‘èµ·æ­£å¸¸çš„é€‰ä¸¾ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">pre_vote</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;*</span> <span class="n">lck</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">triggered</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–last logçš„termå’Œid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int64_t</span> <span class="n">old_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// get last_log_id outof node mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pre_vote need defense ABA after unlock&amp;lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">old_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">                     <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">triggered</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘æ‰€æœ‰peerå‘é€pre_voteè¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iter</span> <span class="o">==</span> <span class="n">_server_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnPreVoteRPCDone</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnPreVoteRPCDone</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">version</span><span class="p">(),</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="p">.</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// next term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_last_log_index</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">.</span><span class="n">set_last_log_term</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">.</span><span class="n">term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">stub</span><span class="p">.</span><span class="n">pre_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»™è‡ªå·±æŠ•ç¥¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">grant_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_pre_vote_ctx</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pre_voteè¯·æ±‚å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">RaftServiceImpl</span><span class="o">::</span><span class="n">pre_vote</span><span class="p">(</span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">RpcController</span><span class="o">*</span> <span class="n">cntl_base</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–nodeå¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">scoped_refptr</span><span class="o">&lt;</span><span class="n">NodeImpl</span><span class="o">&gt;</span> <span class="n">node_ptr</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">global_node_manager</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">group_id</span><span class="p">(),</span> <span class="n">peer_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeImpl</span><span class="o">*</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node_ptr</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">handle_pre_vote_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="n">berror</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_pre_vote_request</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">granted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ignore older term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// get last_log_id outof node mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// pre_vote not need ABA check after unlock&amp;lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">votable_time</span> <span class="o">=</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">votable_time_from_now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">grantable</span> <span class="o">=</span> <span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">(),</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_term</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                        <span class="o">&gt;=</span> <span class="n">last_log_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">grantable</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">granted</span> <span class="o">=</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_granted</span><span class="p">(</span><span class="n">granted</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_rejected_by_lease</span><span class="p">(</span><span class="n">rejected_by_lease</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_disrupted</span><span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_LEADER</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_previous_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>pre_voteå“åº”å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_pre_vote_response</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">ctx_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">const</span> <span class="n">RequestVoteResponse</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check response termï¼Œæ”¶åˆ°çš„termæ›´å¤§åˆ™æ”¾å¼ƒé€‰ä¸¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;pre_vote_response.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">step_down</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çœç•¥æ¯”è¾ƒå¤æ‚çš„æ£€æŸ¥granté€»è¾‘ï¼Œæ¶‰åŠlease/disrupted_leaderç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é¢„é€‰ä¸¾é€šè¿‡ï¼Œå¼€å§‹æ­£å¼çš„é€‰ä¸¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">elect_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="elect">elect</h3>
<p>é¢„é€‰ä¸¾é€šè¿‡ï¼Œå¼€å§‹æ­£å¼çš„é€‰ä¸¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// in lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">elect_self</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;*</span> <span class="n">lck</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                          <span class="kt">bool</span> <span class="n">old_leader_stepped_down</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// cancel follower election timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_FOLLOWER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_election_timer</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// reset leader_id before vote
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">PeerId</span> <span class="n">old_leader</span> <span class="o">=</span> <span class="n">_leader_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">leader_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">PeerId</span> <span class="n">empty_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ERAFTTIMEDOUT</span><span class="p">,</span> <span class="s">&#34;A follower&#39;s leader_id is reset to NULL &#34;</span>
</span></span><span class="line"><span class="cl">                                    <span class="s">&#34;as it begins to request_vote.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">reset_leader_id</span><span class="p">(</span><span class="n">empty_id</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿®æ”¹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_CANDIDATE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// termåŠ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_current_term</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_voted_id</span> <span class="o">=</span> <span class="n">_server_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">               <span class="o">&lt;&lt;</span> <span class="s">&#34; term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; start vote_timer&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨voteå®šæ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_vote_timer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_pre_vote_ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_leader_stepped_down</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_disrupted_leader</span><span class="p">(</span><span class="n">DisruptedLeader</span><span class="p">(</span><span class="n">old_leader</span><span class="p">,</span> <span class="n">leader_term</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">_follower_lease</span><span class="p">.</span><span class="n">expire</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">old_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// get last_log_id outof node mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// vote need defense ABA after unlock&amp;lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">old_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// term changed cause by step_down
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">                     <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_last_log_id</span><span class="p">(</span><span class="n">last_log_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘peerå‘é€voteè¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">request_peers_to_vote</span><span class="p">(</span><span class="n">peers</span><span class="p">,</span> <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">disrupted_leader</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//TODO: outof lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">status</span> <span class="o">=</span> <span class="n">_meta_storage</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">set_term_and_votedfor</span><span class="p">(</span><span class="n">_current_term</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">,</span> <span class="n">_v_group_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&lt;&lt;</span> <span class="s">&#34; fail to set_term_and_votedfor itself when elect_self,&#34;</span>
</span></span><span class="line"><span class="cl">                      <span class="s">&#34; error: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// reset _voted_id to avoid inconsistent cases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// return immediately without granting _vote_ctx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_voted_id</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»™è‡ªå·±æŠ•ç¥¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">grant_self</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_vote_ctx</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>request voteè¯·æ±‚å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_request_vote_request</span><span class="p">(</span><span class="k">const</span> <span class="n">RequestVoteRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">RequestVoteResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¿½ç•¥ä¸€äº›disrupté€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">disrupted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">previous_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ignore older term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ignore older term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// get last_log_id outof node mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">LogId</span> <span class="n">last_log_id</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_id</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// vote need ABA check after unlock&amp;lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">previous_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">                         <span class="o">&lt;&lt;</span> <span class="s">&#34; raise term &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_current_term</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; when get last_log_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">log_is_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">LogId</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">(),</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">last_log_term</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">                          <span class="o">&gt;=</span> <span class="n">last_log_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">votable_time</span> <span class="o">=</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">votable_time_from_now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// if the vote is rejected by lease, tell the candidate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">votable_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">rejected_by_lease</span> <span class="o">=</span> <span class="n">log_is_ok</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// increase current term, change state to follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMREQUEST</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;request_vote_request.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">disrupted</span> <span class="o">=</span> <span class="p">(</span><span class="n">_state</span> <span class="o">&lt;=</span> <span class="n">STATE_TRANSFERRING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// save
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">log_is_ok</span> <span class="o">&amp;&amp;</span> <span class="n">_voted_id</span><span class="p">.</span><span class="n">is_empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EVOTEFORCANDIDATE</span><span class="p">,</span> <span class="s">&#34;Raft node votes for some candidate, &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;step down to restart election_timer.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">_voted_id</span> <span class="o">=</span> <span class="n">candidate_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//TODO: outof lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æŠ•ç¥¨éœ€è¦æŒä¹…åŒ–å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">status</span> <span class="o">=</span> <span class="n">_meta_storage</span><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">set_term_and_votedfor</span><span class="p">(</span><span class="n">_current_term</span><span class="p">,</span> <span class="n">candidate_id</span><span class="p">,</span> <span class="n">_v_group_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// reset _voted_id to response set_granted(false)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">_voted_id</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_disrupted</span><span class="p">(</span><span class="n">disrupted</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_previous_term</span><span class="p">(</span><span class="n">previous_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_granted</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">==</span> <span class="n">_current_term</span> <span class="o">&amp;&amp;</span> <span class="n">_voted_id</span> <span class="o">==</span> <span class="n">candidate_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_rejected_by_lease</span><span class="p">(</span><span class="n">rejected_by_lease</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>request voteå“åº”å¤„ç†é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_request_vote_response</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">ctx_version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                            <span class="k">const</span> <span class="n">RequestVoteResponse</span><span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BAIDU_SCOPED_LOCK</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check stateï¼ŒçŠ¶æ€ä¸å¯¹ç›´æ¥å¿½ç•¥ï¼Œæ¯”å¦‚å·²æˆä¸ºleader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_CANDIDATE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check response termï¼Œresponse termæ›´å¤§åˆ™åœæ­¢é€‰ä¸¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Raft node receives higher term &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;request_vote_response.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">step_down</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">term</span><span class="p">(),</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="n">granted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">response</span><span class="p">.</span><span class="n">rejected_by_lease</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">disrupted</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">set_disrupted_leader</span><span class="p">(</span><span class="n">DisruptedLeader</span><span class="p">(</span><span class="n">peer_id</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">previous_term</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">peer_id</span> <span class="o">==</span> <span class="n">_follower_lease</span><span class="p">.</span><span class="n">last_leader</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="n">_server_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">stop_grant_self_timer</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœè·å¾—å¤šæ•°æ”¯æŒï¼Œæˆä¸ºleader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_vote_ctx</span><span class="p">.</span><span class="n">granted</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">become_leader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If the follower rejected the vote because of lease, reserve it, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the candidate will try again after it disrupt the old leader.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†æ¬¡è¦æ±‚é¢„ç•™çš„peeræŠ•ç¥¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">retry_vote_on_reserved_peers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">retry_vote_on_reserved_peers</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">pop_grantable_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">request_peers_to_vote</span><span class="p">(</span><span class="n">peers</span><span class="p">,</span> <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">disrupted_leader</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="leaderé€»è¾‘">leaderé€»è¾‘</h2>
<h3 id="æˆä¸ºleader">æˆä¸ºleader</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">become_leader</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥çŠ¶æ€å¿…é¡»ä¸ºå€™é€‰è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHECK</span><span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_CANDIDATE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// cancel candidate vote timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_vote_timer</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_vote_ctx</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿®æ”¹çŠ¶æ€å’Œleader_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_state</span> <span class="o">=</span> <span class="n">STATE_LEADER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_leader_id</span> <span class="o">=</span> <span class="n">_server_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_replicator_group</span><span class="p">.</span><span class="n">reset_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_follower_lease</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_leader_lease</span><span class="p">.</span><span class="n">on_leader_start</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span> <span class="n">peers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¯ä¸ªfollowerå¯åŠ¨ä¸€ä¸ªreplicator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">iter</span> <span class="o">==</span> <span class="n">_server_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">_replicator_group</span><span class="p">.</span><span class="n">add_replicator</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// init commit manager
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">reset_pending_index</span><span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Register _conf_ctx to reject configuration changing before the first log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is committed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">flush</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span> <span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_stepdown_timer</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¹æ®Raftè®ºæ–‡ï¼Œæ–°leaderç™»åŸºä¹‹åéœ€è¦æäº¤ä¸€ä¸ªno-opæ—¥å¿—æ‰èƒ½å®‰å…¨çš„æäº¤ä¹‹å‰ä»»æœŸçš„æ—¥å¿—ã€‚åœ¨braftçš„å®ç°ä¸­ï¼Œ <code>_conf_ctx.flush(_conf.conf, _conf.old_conf)</code> ä¼šå‘èµ·ä¸€æ¬¡èŠ‚ç‚¹æ›´æ–°ï¼Œåœ¨èŠ‚ç‚¹æ›´æ–°çš„æ—¥å¿—æˆåŠŸæäº¤åå›è°ƒç”¨æˆ·çŠ¶æ€æœºçš„ <code>on_leader_start</code> ã€‚braftä½¿ç”¨èŠ‚ç‚¹æ›´æ–°æ—¥å¿—æ›¿ä»£äº†è®ºæ–‡ä¸­çš„no-opæ—¥å¿—ã€‚</p>
<p>Replicatorå¯åŠ¨é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">ReplicatorOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="n">ReplicatorId</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Replicator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">brpc</span><span class="o">::</span><span class="n">ChannelOptions</span> <span class="n">channel_opt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//channel_opt.connect_timeout_ms = *options.heartbeat_timeout_ms;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">channel_opt</span><span class="p">.</span><span class="n">timeout_ms</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// We don&#39;t need RPC timeout
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ›å»ºå‘é€channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_sending_channel</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel_opt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®°å½•åˆ°bthread localå­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_on_error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_catchup_closure</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note: r-&gt;_id is unlock in _send_empty_entries, don&#39;t touch r ever after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘é€no_opæ¥å®£ç¤ºleaderèº«ä»½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç»´æŠ¤leaderèº«ä»½å¿ƒè·³">ç»´æŠ¤leaderèº«ä»½â€”â€”å¿ƒè·³</h3>
<p>åœ¨Replicator::starté‡Œé¢å¼€å§‹äº†heartbeat_timerï¼Œå®ƒæ˜¯ä¸ªbthread_timerï¼Œåœ¨è¶…æ—¶çš„æ—¶å€™ä¼šè°ƒç”¨Replicator::_on_timedoutï¼Œè¯¥å‡½æ•°ä¼šæŠŠå¯¹åº”çš„idè®¾ç½®ä¸ºETIMEDOUTã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_timedout</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">id</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">arg</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_error</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">ETIMEDOUT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>bthread_id_errorä¼šå»è°ƒç”¨_on_errorï¼Œç„¶åå¼€å§‹_send_heartbeatã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_error</span><span class="p">(</span><span class="n">bthread_id_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">error_code</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// This error is issued in the TimerThread, start a new bthread to avoid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// blocking the caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Unlock id to remove the context-switch out of the critical section
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bthread_t</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¯åŠ¨ä¸€ä¸ªbthreadæ¥æ‰§è¡Œ_send_heartbeat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bthread_start_urgent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_send_heartbeat</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">value</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to start bthread&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">_send_heartbeat</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å‘é€å¿ƒè·³</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_heartbeat</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">id</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">arg</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»bthread localå­˜å‚¨è·å–replicator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// This replicator is stopped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// id is unlock in _send_empty_entries;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="kt">bool</span> <span class="n">is_heartbeat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl</span><span class="p">(</span><span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesRequest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">response</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">is_heartbeat</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">is_heartbeat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _id is unlock in _install_snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">is_heartbeat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_heartbeat_in_fly</span> <span class="o">=</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_heartbeat_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// set RPC timeout for heartbeat, how long should timeout be is waiting to be optimized.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="o">*</span><span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">APPENDING_ENTRIES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_st</span><span class="p">.</span><span class="n">first_log_index</span> <span class="o">=</span> <span class="n">_next_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_st</span><span class="p">.</span><span class="n">last_log_index</span> <span class="o">=</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK</span><span class="p">(</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">_flying_append_entries_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FlyingAppendEntriesRpc</span><span class="p">(</span><span class="n">_next_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">        <span class="n">_append_entries_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">is_heartbeat</span> <span class="o">?</span> <span class="nl">_on_heartbeat_returned</span> <span class="p">:</span> <span class="n">_on_rpc_returned</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cntl</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stub</span><span class="p">.</span><span class="n">append_entries</span><span class="p">(</span><span class="n">cntl</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">response</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>append_entriesè¯·æ±‚å¤„ç†é€»è¾‘ï¼Œæ—¢åŒ…æ‹¬å¿ƒè·³å¤„ç†ï¼Œä¹ŸåŒ…æ‹¬æ­£å¸¸çš„è¯·æ±‚å¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_append_entries_request</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="k">const</span> <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                             <span class="kt">bool</span> <span class="n">from_append_entries_cache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entries</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// pre set term, to avoid get term in lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check stale term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®©å·²è¢«ç¯¡ä½çš„leaderä¸‹å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">saved_current_term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">saved_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check term and state to step down
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">check_step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">server_id</span><span class="p">);</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæœ‰ä¸¤ä¸ªç›¸åŒtermçš„leaderï¼Œè‡ªå·±çš„termåŠ ä¸€è®©ä¸¤ä¸ªleaderéƒ½ä¸‹å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server_id</span> <span class="o">!=</span> <span class="n">_leader_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Increase the term by 1 and make both leaders step down to minimize the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// loss of split brain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ELEADERCONFLICT</span><span class="p">,</span> <span class="s">&#34;More than one leader in the same term.&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">prev_log_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">prev_log_term</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_term</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">local_prev_log_term</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_term</span><span class="p">(</span><span class="n">prev_log_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœtermä¸åŒ¹é…ï¼Œè§†æ˜¯å¦å…è®¸ä¹±åºè€ŒæŠ¥é”™æˆ–æ­£å¸¸å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">local_prev_log_term</span> <span class="o">!=</span> <span class="n">prev_log_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¿ƒè·³è¯·æ±‚å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_last_log_index</span><span class="p">(</span><span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_readonly</span><span class="p">(</span><span class="n">_node_readonly</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// see the comments at FollowerStableClosure::run()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">set_last_committed_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                         <span class="n">prev_log_index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Parse request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">butil</span><span class="o">::</span><span class="n">IOBuf</span> <span class="n">data_buf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data_buf</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">request_attachment</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">prev_log_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="n">EntryMeta</span><span class="o">&amp;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="o">!=</span> <span class="n">ENTRY_TYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LogEntry</span><span class="o">*</span> <span class="n">log_entry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">term</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">EntryType</span><span class="p">)</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœè¯·æ±‚ä¸­peerä¸ä¸ºç©ºï¼Œä¹Ÿè®¾ç½®log_entryçš„peer/old_peerå­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">CHECK_NE</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">type</span><span class="p">(),</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">has_data_len</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">data_len</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                <span class="n">data_buf</span><span class="p">.</span><span class="n">cutn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">log_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check out-of-order cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">check_append_entries_cache</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FollowerStableClosure</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FollowerStableClosure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†™å…¥logï¼Œåœ¨å›è°ƒä¸­è¿›è¡Œå›åŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// update configuration after _log_manager updated its memory status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¿ƒè·³å›åŒ…å¤„ç†é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_heartbeat_returned</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">        <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">rpc_send_time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl_guard</span><span class="p">(</span><span class="n">cntl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span>  <span class="n">req_guard</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">res_guard</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">long</span> <span class="n">start_time_us</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// XXX bthread_idå¤§æ¦‚ç›¸å½“äºpthread key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">Failed</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå¤±è´¥åˆ™å†æ¬¡å¯åŠ¨å®šæ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_consecutive_error_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¿ƒè·³æ”¶åˆ°æ›´é«˜çš„termï¼Œåˆ™é€€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">NodeImpl</span> <span class="o">*</span><span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Acquire a reference of Node here in case that Node is detroyed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// after _notify_on_caught_up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Replicator=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; is going to quit&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="o">&lt;&lt;</span> <span class="s">&#34;, group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Leader receives higher term &#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;heartbeat_response from peer:%s&#34;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_destroy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">increase_term_to</span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">readonly</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">has_readonly</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">readonly</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; readonly &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">readonly</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">rpc_send_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_start_heartbeat_timer</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">NodeImpl</span><span class="o">*</span> <span class="n">node_impl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if readonly config changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">readonly</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_readonly_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">!</span><span class="n">readonly</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_readonly_index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_impl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">PeerId</span> <span class="n">peer_id</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">term</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">change_readonly_config</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">peer_id</span><span class="p">,</span> <span class="n">readonly</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="çŠ¶æ€æœºä»»åŠ¡æ‰§è¡Œ">çŠ¶æ€æœºä»»åŠ¡æ‰§è¡Œ</h2>
<p>ç”¨æˆ·ä»£ç ä¼šè°ƒç”¨<code>NodeImpl::apply(const Task&amp; task)</code>ï¼Œapplyçš„å®ç°ä¸­å°†ä»»åŠ¡åŠ å…¥<code>_apply_queue</code>é˜Ÿåˆ—ã€‚é˜Ÿåˆ—æ‰§è¡Œæ—¶æœ€ç»ˆä¼šè°ƒç”¨ä¸‹é¢çš„å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">apply</span><span class="p">(</span><span class="n">LogEntryAndClosure</span> <span class="n">tasks</span><span class="p">[],</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">g_apply_tasks_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entries</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">reject_new_user_logs</span> <span class="o">=</span> <span class="p">(</span><span class="n">_node_readonly</span> <span class="o">||</span> <span class="n">_majority_nodes_readonly</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span> <span class="o">||</span> <span class="n">reject_new_user_logs</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// éleaderæˆ–åªè¯»æ—¶è®¾ç½®é”™è¯¯ï¼Œå¹¶å›è°ƒç”¨æˆ·çš„done
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">st</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="s">&#34;is not leader&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ£€æŸ¥ABAé—®é¢˜ï¼Œæœ‰é—®é¢˜ä¼šè®¾ç½®é”™è¯¯å’Œè°ƒç”¨done
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">expected_term</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">expected_term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ENTRY_TYPE_DATA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŠ å…¥æŠ•ç¥¨ç®±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// LeaderStableClosureåœ¨å›è°ƒæ—¶ä¼šæŠ•ç¥¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="k">new</span> <span class="n">LeaderStableClosure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">NodeId</span><span class="p">(</span><span class="n">_group_id</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">entries</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">_ballot_box</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// update _conf.first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="logæŒä¹…åŒ–">logæŒä¹…åŒ–</h3>
<p>æ— è®ºæ˜¯leaderè¿˜æ˜¯followeréƒ½æ˜¯è°ƒç”¨LogManageræ¥æŒä¹…åŒ–æ—¥å¿—ï¼Œå¯¹äºleaderæ¥è¯´ï¼ŒæŒä¹…åŒ–å®Œæˆåè¿›è¡ŒæŠ•ç¥¨ï¼›å¯¹äºfolloweræ¥è¯´ï¼ŒæŒä¹…åŒ–å®Œæˆåå›åŒ…ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_entries</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">check_and_resolve_conflict</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// release entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add ref for disk_thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ConfigurationEntry</span> <span class="nf">conf_entry</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯¹äºä¿®æ”¹peerçš„ç±»å‹çš„æ—¥å¿—ï¼ŒåŠ å…¥config managerï¼Œå½±å“åç»­çš„æŠ•ç¥¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">conf_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">_first_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ’å…¥å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_logs_in_memory</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">_logs_in_memory</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">done</span><span class="o">-&gt;</span><span class="n">_entries</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ·ç›˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_disk_queue</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;execq execute failed, ret: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; err: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">berror</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">wakeup_all_waiter</span><span class="p">(</span><span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">check_and_resolve_conflict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">AsyncClosureGuard</span> <span class="nf">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŸäº›æƒ…å†µä¸‹leaderä¼šè®¾ç½®index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Node is currently the leader and |entries| are from the user who
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// don&#39;t know the correct indexes the logs should assign to. So we have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to assign indexes to the appending entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="o">++</span><span class="n">_last_log_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// followeré€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Node is currently a follower and |entries| are from the leader. We 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// should check and resolve the confliction between the local logs and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// |entries|
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ—¥å¿—ä¸è¿ç»­æ€§ï¼ŒæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">_last_log_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;There&#39;s gap between first_index=%&#34;</span> <span class="n">PRId64</span>
</span></span><span class="line"><span class="cl">                                     <span class="s">&#34; and last_log_index=%&#34;</span> <span class="n">PRId64</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="n">_last_log_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">applied_index</span> <span class="o">=</span> <span class="n">_applied_id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæœ€åä¸€æ¡æ—¥å¿—å·²ç»applyè¿‡ï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">applied_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">_last_log_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ç¬¬ä¸€æ¡æ—¥å¿—æ­£å¥½å¯¹ä¸Šï¼Œåªéœ€è¦æ›´æ–°_last_log_index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Fast path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_last_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Appending entries overlap the local ones. We should find if there
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// is a conflicting index from which we should truncate the local
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ones.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªå†²çªçš„æ—¥å¿—index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size_t</span> <span class="n">conflicting_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(;</span> <span class="n">conflicting_index</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">conflicting_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">unsafe_get_term</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœå­˜åœ¨å†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">conflicting_index</span> <span class="o">!=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">_last_log_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Truncate all the conflicting entries to make local logs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// consensus with the leader.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// truncateæ—¥å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">unsafe_truncate_suffix</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">conflicting_index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="n">_last_log_index</span> <span class="o">=</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">back</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>  <span class="c1">// else this is a duplicated AppendEntriesRequest, we have 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>               <span class="c1">// nothing to do besides releasing all the entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// Release all the entries before the conflicting_index and the rest
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// would be append to _logs_in_memory and _log_storage after this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// function returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">conflicting_index</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¸å†²çªçš„æ—¥å¿—ç›´æ¥ç§»é™¤ï¼Œå·²ç»æŒä¹…åŒ–è¿‡äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">entries</span><span class="o">-&gt;</span><span class="n">erase</span><span class="p">(</span><span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                           <span class="n">entries</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="n">conflicting_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t reach here&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Impossible&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¥å¿—åˆ·ç›˜</p>
<p>åœ¨LogManagerçš„æ„é€ å‡½æ•°ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">start_disk_thread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread</span><span class="o">::</span><span class="n">ExecutionQueueOptions</span> <span class="n">queue_options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">queue_options</span><span class="p">.</span><span class="n">bthread_attr</span> <span class="o">=</span> <span class="n">BTHREAD_ATTR_NORMAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_disk_queue</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="o">&amp;</span><span class="n">queue_options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">disk_thread</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>disk_threadæ˜¯è´Ÿè´£åˆ·ç›˜çš„å‡½æ•°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">disk_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">meta</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">bthread</span><span class="o">::</span><span class="n">TaskIterator</span><span class="o">&lt;</span><span class="n">StableClosure</span><span class="o">*&gt;&amp;</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">is_queue_stopped</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LogManager</span><span class="o">*</span> <span class="n">log_manager</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">LogManager</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// FIXME(chenzhangyi01): it&#39;s buggy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LogId</span> <span class="n">last_id</span> <span class="o">=</span> <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">_disk_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">StableClosure</span><span class="o">*</span> <span class="n">storage</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">AppendBatcher</span> <span class="nf">ab</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">storage</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">last_id</span><span class="p">,</span> <span class="n">log_manager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ^^^ Must iterate to the end to release to corresponding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//     even if some error has occurred
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">_entries</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ç»„batch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ab</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ·ç›˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">ab</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ—¥å¿—é¡¹ä¸ºç©ºçš„ä»»åŠ¡ï¼Œæ˜¯ä¸€äº›ç®¡ç†ç±»çš„ä»»åŠ¡ã€‚å¦‚LastLogIdClosure, TruncatePrefixClosure, TruncateSuffixClosure, ResetClosure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">TruncatePrefixClosure</span><span class="o">*</span> <span class="n">tpc</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">                        <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">TruncatePrefixClosure</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span> <span class="o">=</span> <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">_log_storage</span><span class="o">-&gt;</span><span class="n">truncate_prefix</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">tpc</span><span class="o">-&gt;</span><span class="n">first_index_kept</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å‘½ä¸­ä¸€ç§å³é€€å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">report_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;Failed operation on LogStorage&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Must iterate to the end&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ab</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">set_disk_id</span><span class="p">(</span><span class="n">last_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢AppendBatcher::appendä¼šå°†æ—¥å¿—åŠ å…¥é˜Ÿåˆ—ï¼ŒAppendBatcher::flushä¼šè°ƒç”¨LogManager::append_to_storageæ¥å†™ç›˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_to_storage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;*</span> <span class="n">to_append</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                   <span class="n">LogId</span><span class="o">*</span> <span class="n">last_id</span><span class="p">,</span> <span class="n">IOMetric</span><span class="o">*</span> <span class="n">metric</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_has_error</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨åº•å±‚å­˜å‚¨å®ç°ï¼Œé»˜è®¤ä¸ºSegmentLogStorage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">int</span> <span class="n">nappent</span> <span class="o">=</span> <span class="n">_log_storage</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">*</span><span class="n">to_append</span><span class="p">,</span> <span class="n">metric</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">nappent</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">to_append</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">report_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to append entries&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">to_append</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="o">*</span><span class="n">to_append</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">to_append</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åŒæ­¥follower">åŒæ­¥follower</h3>
<p>_send_entries è´Ÿè´£åŒæ­¥taskåˆ°followerã€‚åœ¨apply_taskæ—¶ä¼šå°†ä»»åŠ¡å†™åˆ°log_manageré‡Œé¢ï¼Œè€Œåœ¨_send_entrieså®ç°ä¸­ï¼Œä¼šè°ƒç”¨_prepare_entryæ¥ä»log_managerè·å–entryã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_entries</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl</span><span class="p">(</span><span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span> <span class="n">request</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesRequest</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">response</span><span class="p">(</span><span class="k">new</span> <span class="n">AppendEntriesResponse</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">EntryMeta</span> <span class="n">em</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">max_entries_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_max_entries_size</span> <span class="o">-</span> <span class="n">_flying_append_entries_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">prepare_entry_rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">max_entries_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_entries_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»log_manageræ¥å‡†å¤‡entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">prepare_entry_rc</span> <span class="o">=</span> <span class="n">_prepare_entry</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">em</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">request_attachment</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">prepare_entry_rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">request</span><span class="o">-&gt;</span><span class="n">add_entries</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">em</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _id is unlock in _wait_more
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_next_index</span> <span class="o">&lt;</span> <span class="n">_options</span><span class="p">.</span><span class="n">log_manager</span><span class="o">-&gt;</span><span class="n">first_log_index</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">_wait_more_entries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">FlyingAppendEntriesRpc</span><span class="p">(</span><span class="n">_next_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                     <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">(),</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">_append_entries_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_next_index</span> <span class="o">+=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_flying_append_entries_size</span> <span class="o">+=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">g_send_entries_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">APPENDING_ENTRIES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_st</span><span class="p">.</span><span class="n">first_log_index</span> <span class="o">=</span> <span class="n">_min_flying_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_st</span><span class="p">.</span><span class="n">last_log_index</span> <span class="o">=</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_on_rpc_returned</span><span class="p">,</span> <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cntl</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                <span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">response</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stub</span><span class="p">.</span><span class="n">append_entries</span><span class="p">(</span><span class="n">cntl</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">request</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> 
</span></span><span class="line"><span class="cl">                        <span class="n">response</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_wait_more_entries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>send_entriesç»“æœå¤„ç†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_rpc_returned</span><span class="p">(</span><span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">AppendEntriesRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                     <span class="n">AppendEntriesResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                     <span class="kt">int64_t</span> <span class="n">rpc_send_time</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">&gt;</span> <span class="n">cntl_guard</span><span class="p">(</span><span class="n">cntl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesRequest</span><span class="o">&gt;</span>  <span class="n">req_guard</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AppendEntriesResponse</span><span class="o">&gt;</span> <span class="n">res_guard</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">long</span> <span class="n">start_time_us</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">valid_rpc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">rpc_first_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">min_flying_index</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_GT</span><span class="p">(</span><span class="n">min_flying_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// çœç•¥æ ¡éªŒcall_idæ˜¯å¦åŒ¹é…çš„é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">Failed</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fail, sleep.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If the follower crashes, any RPC to the follower fails immediately,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so we need to block the follower for a while instead of looping until
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it comes back or be removed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// dummy_id is unlock in block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¤±è´¥äº†blockä¸€æ®µæ—¶é—´ï¼Œæœ‰å¯èƒ½follower crash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_block</span><span class="p">(</span><span class="n">start_time_us</span><span class="p">,</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">ErrorCode</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_consecutive_error_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå“åº”ä¸­çš„termæ›´å¤§åˆ™é€€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">NodeImpl</span> <span class="o">*</span><span class="n">node_impl</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHIGHERTERMRESPONSE</span><span class="p">,</span> <span class="s">&#34;Leader receives higher term &#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="s">&#34;%s from peer:%s&#34;</span><span class="p">,</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">GetTypeName</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">increase_term_to</span><span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">node_impl</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// prev_log_index and prev_log_term doesn&#39;t match
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// log index ä¸åŒ¹é…åˆ™ç›´æ¥è®¾ç½®next_index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// The peer contains less logs than leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">last_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦åˆ™ä¾æ¬¡å‡1ç›´åˆ°åŒ¹é…(XXX çœ‹ä¸‹é¢çš„å®ç°ä¸æ˜¯termä¸åŒ¹é…å¯¼è‡´çš„ï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¼šèµ°åˆ°è¿™ä¸ªé€»è¾‘ï¼Ÿï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The peer contains logs from old term which should be truncated,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// decrease _last_log_at_peer by one to test the right index to keep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">BAIDU_LIKELY</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="o">--</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_next_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span> 
</span></span><span class="line"><span class="cl">                           <span class="o">&lt;&lt;</span> <span class="s">&#34; peer=&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span>
</span></span><span class="line"><span class="cl">                           <span class="o">&lt;&lt;</span> <span class="s">&#34; declares that log at index=0 doesn&#39;t match,&#34;</span>
</span></span><span class="line"><span class="cl">                              <span class="s">&#34; which is not supposed to happen&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// dummy_id is unlock in _send_heartbeat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç”¨äºæ›´æ–°log indexä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_empty_entries</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; success&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BRAFT_VLOG</span> <span class="o">&lt;&lt;</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">!=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_update_last_rpc_send_timestamp</span><span class="p">(</span><span class="n">rpc_send_time</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int</span> <span class="n">entries_size</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">entries_size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">rpc_last_log_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">prev_log_index</span><span class="p">()</span> <span class="o">+</span> <span class="n">entries_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">BRAFT_VLOG_IF</span><span class="p">(</span><span class="n">entries_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Group &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">&lt;&lt;</span> <span class="s">&#34; replicated logs in [&#34;</span> 
</span></span><span class="line"><span class="cl">                                    <span class="o">&lt;&lt;</span> <span class="n">min_flying_index</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;, &#34;</span> 
</span></span><span class="line"><span class="cl">                                    <span class="o">&lt;&lt;</span> <span class="n">rpc_last_log_index</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">&lt;&lt;</span> <span class="s">&#34;] to peer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">entries_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ£€æŸ¥æ˜¯å¦é€šè¿‡æŠ•ç¥¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">ballot_box</span><span class="o">-&gt;</span><span class="n">commit_at</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">min_flying_index</span><span class="p">,</span> <span class="n">rpc_last_log_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// A rpc is marked as success, means all request before it are success,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// erase them sequentially.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">           <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">log_index</span> <span class="o">&lt;=</span> <span class="n">rpc_first_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_flying_append_entries_size</span> <span class="o">-=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">entries_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_append_entries_in_fly</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// dummy_id is unlock in _send_entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_timeout_now</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å†æ¬¡è°ƒç”¨send
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_entries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="apply_log">apply_log</h3>
<p>åœ¨logè¢«æŒä¹…åŒ–åˆ°å¤šæ•°èŠ‚ç‚¹ä¸Šæ—¶ï¼ŒBallotBox::commit_atä¼šè°ƒç”¨ä¸‹åˆ—å‡½æ•°å‘é˜Ÿåˆ—æ·»åŠ COMMITEDä»»åŠ¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">on_committed</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplyTask</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">COMMITTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span><span class="p">.</span><span class="n">committed_index</span> <span class="o">=</span> <span class="n">committed_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_queue_id</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é˜Ÿåˆ—æ‰§è¡Œå‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">meta</span><span class="p">,</span> <span class="n">bthread</span><span class="o">::</span><span class="n">TaskIterator</span><span class="o">&lt;</span><span class="n">ApplyTask</span><span class="o">&gt;&amp;</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FSMCaller</span><span class="o">*</span> <span class="n">caller</span> <span class="o">=</span> <span class="p">(</span><span class="n">FSMCaller</span><span class="o">*</span><span class="p">)</span><span class="n">meta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">is_queue_stopped</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">caller</span><span class="o">-&gt;</span><span class="n">do_shutdown</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">max_committed_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span>  <span class="n">batch_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_fsm_caller_commit_batch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span><span class="p">;</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">COMMITTED</span> <span class="o">&amp;&amp;</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="n">batch_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span> <span class="o">&gt;</span> <span class="n">max_committed_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">max_committed_index</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">max_committed_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">caller</span><span class="o">-&gt;</span><span class="n">_cur_task</span> <span class="o">=</span> <span class="n">COMMITTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å‡ºç°è¿ç»­çš„COMMITEDä»»åŠ¡è¶…è¿‡commit_batchï¼Œæˆ–è€…å‡ºç°äº†åˆ«çš„ç±»å‹çš„ä»»åŠ¡æ—¶è°ƒç”¨do_committed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">caller</span><span class="o">-&gt;</span><span class="n">do_committed</span><span class="p">(</span><span class="n">max_committed_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">max_committed_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">g_commit_tasks_batch_counter</span> <span class="o">&lt;&lt;</span> <span class="n">counter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">FLAGS_raft_fsm_caller_commit_batch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">COMMITTED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span> <span class="o">&gt;</span> <span class="n">max_committed_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">max_committed_index</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">committed_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nl">SNAPSHOT_SAVE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>do_commitedå®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">do_committed</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_error</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">last_applied_index</span> <span class="o">=</span> <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">load</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We can tolerate the disorder of committed_index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">last_applied_index</span> <span class="o">&gt;=</span> <span class="n">committed_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Closure</span><span class="o">*&gt;</span> <span class="n">closure</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">first_closure_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_closure_queue</span><span class="o">-&gt;</span><span class="n">pop_closure_until</span><span class="p">(</span><span class="n">committed_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">closure</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">&amp;</span><span class="n">first_closure_index</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">IteratorImpl</span> <span class="nf">iter_impl</span><span class="p">(</span><span class="n">_fsm</span><span class="p">,</span> <span class="n">_log_manager</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">closure</span><span class="p">,</span> <span class="n">first_closure_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">last_applied_index</span><span class="p">,</span> <span class="n">committed_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_applying_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(;</span> <span class="n">iter_impl</span><span class="p">.</span><span class="n">is_good</span><span class="p">();)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ENTRY_TYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é…ç½®å˜æ›´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">old_peers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Joint stage is not supposed to be noticeable by end users.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_configuration_committed</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                            <span class="n">Configuration</span><span class="p">(</span><span class="o">*</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                            <span class="n">iter_impl</span><span class="p">.</span><span class="n">entry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å…¶ä»–ä»»åŠ¡æ‰§è¡Œå›è°ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// For other entries, we have nothing to do besides flush the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// pending tasks and run this closure to notify the caller that the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// entries before this one were successfully committed and applied.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">done</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">iter_impl</span><span class="p">.</span><span class="n">done</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter_impl</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">Iterator</span> <span class="nf">iter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_impl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‰§è¡Œç”¨æˆ·é€»è¾‘æ¥apply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_apply</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Try move to next in case that we pass the same log twice.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">has_error</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">set_error</span><span class="p">(</span><span class="n">iter_impl</span><span class="p">.</span><span class="n">error</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">iter_impl</span><span class="p">.</span><span class="n">run_the_rest_closure_with_error</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">last_index</span> <span class="o">=</span> <span class="n">iter_impl</span><span class="p">.</span><span class="n">index</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">int64_t</span> <span class="n">last_term</span> <span class="o">=</span> <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_term</span><span class="p">(</span><span class="n">last_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">LogId</span> <span class="nf">last_applied_id</span><span class="p">(</span><span class="n">last_index</span><span class="p">,</span> <span class="n">last_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®°å½•applied index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">committed_index</span><span class="p">,</span> <span class="n">butil</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_last_applied_term</span> <span class="o">=</span> <span class="n">last_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼šapplied indexå¹¶æ²¡æœ‰æŒä¹…åŒ–ä¿å­˜ï¼Œåªåœ¨å†…å­˜ä¸­ä¿å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">set_applied_id</span><span class="p">(</span><span class="n">last_applied_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="èŠ‚ç‚¹æ›´æ–°">èŠ‚ç‚¹æ›´æ–°</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">unsafe_register_conf_change</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">old_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                           <span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éleaderæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">==</span> <span class="n">STATE_TRANSFERRING</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EBUSY</span><span class="p">,</span> <span class="s">&#34;Is transferring leadership&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EPERM</span><span class="p">,</span> <span class="s">&#34;Not leader&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// check concurrent conf change
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœåœ¨æ›´æ–°confï¼Œåˆ™æŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EBUSY</span><span class="p">,</span> <span class="s">&#34;Doing another configuration change&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Return immediately when the new peers equals to current configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// confä¸å˜ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="n">new_conf</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">old_conf</span><span class="p">,</span> <span class="n">new_conf</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è¿½èµ¶é˜¶æ®µ"><strong>è¿½èµ¶é˜¶æ®µ</strong></h3>
<p>å¦‚æœæ–°çš„èŠ‚ç‚¹é…ç½®ç›¸å¯¹äºå½“å‰æœ‰æ–°å¢çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªèŠ‚ç‚¹ï¼Œleaderå¯¹åº”çš„Replicator, å‘æŠŠæœ€æ–°çš„snapshotå†è¿™ä¸ªè¿™äº›ä¸­å®‰è£…ï¼Œç„¶åå¼€å§‹åŒæ­¥ä¹‹åçš„æ—¥å¿—ã€‚ç­‰åˆ°æ‰€æœ‰çš„æ–°èŠ‚ç‚¹æ•°æ®éƒ½è¿½çš„å·®ä¸å¤šï¼Œå°±å¼€å§‹è¿›å…¥ä¸€ä¸‹ä¸€é˜¶æ®µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">old_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®çŠ¶æ€ä¸ºè¿½èµ¶é˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_CATCHING_UP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// diffå¾—åˆ°èŠ‚ç‚¹å˜åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">new_conf</span><span class="p">.</span><span class="n">diffs</span><span class="p">(</span><span class="n">old_conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">removing</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰æ–°å¢èŠ‚ç‚¹è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">adding</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">next_stage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">adding</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_adding_peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">iter</span>
</span></span><span class="line"><span class="cl">            <span class="o">=</span> <span class="n">_adding_peers</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">_adding_peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ›å»ºreplicator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_replicator_group</span><span class="p">.</span><span class="n">add_replicator</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">OnCaughtUp</span><span class="o">*</span> <span class="n">caught_up</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnCaughtUp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_node</span><span class="p">,</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_current_term</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">timespec</span> <span class="n">due_time</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">milliseconds_from_now</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">get_catchup_timeout_ms</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¯¹æ–°å¢èŠ‚ç‚¹ï¼Œç­‰å¾…æ–°èŠ‚ç‚¹æ•°æ®è¿½çš„å·®ä¸å¤šï¼Œé»˜è®¤marginä¸º1000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_replicator_group</span><span class="p">.</span><span class="n">wait_caughtup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">catchup_margin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">due_time</span><span class="p">,</span> <span class="n">caught_up</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">caught_up</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">on_caughtup</span><span class="p">(</span><span class="n">_version</span><span class="p">,</span> <span class="o">*</span><span class="n">iter</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">ReplicatorGroup</span><span class="o">::</span><span class="n">wait_caughtup</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                   <span class="kt">int64_t</span> <span class="n">max_margin</span><span class="p">,</span> <span class="k">const</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">due_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">CatchupClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="p">,</span> <span class="n">ReplicatorIdAndStatus</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">_rmap</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">peer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ReplicatorId</span> <span class="n">rid</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰¾replicator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Replicator</span><span class="o">::</span><span class="n">wait_for_caught_up</span><span class="p">(</span><span class="n">rid</span><span class="p">,</span> <span class="n">max_margin</span><span class="p">,</span> <span class="n">due_time</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">wait_for_caught_up</span><span class="p">(</span><span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                    <span class="kt">int64_t</span> <span class="n">max_margin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">const</span> <span class="n">timespec</span><span class="o">*</span> <span class="n">due_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">CatchupClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span><span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">done</span><span class="o">-&gt;</span><span class="n">_max_margin</span> <span class="o">=</span> <span class="n">max_margin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·²ç»è¿½ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_is_catchup</span><span class="p">(</span><span class="n">max_margin</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">due_time</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">_has_timer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ›å»ºå®šæ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">bthread_timer_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">_timer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="o">*</span><span class="n">due_time</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="n">_on_catch_up_timedout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                              <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;Duplicated call&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_catchup_closure</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// success
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">            <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">dummy_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>caughtupå›è°ƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">on_caughtup</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="kt">int64_t</span> <span class="n">version</span><span class="p">,</span> <span class="k">const</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">&amp;</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">BAIDU_SCOPED_LOCK</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CHECK _state and _current_term to avoid ABA problem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// leaderé€€ä½å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_state</span> <span class="o">!=</span> <span class="n">STATE_LEADER</span> <span class="o">||</span> <span class="n">term</span> <span class="o">!=</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// if leader stepped down, reset() has already been called in step_down(),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so nothing needs to be done here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æˆåŠŸè¿½ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>  <span class="c1">// Caught up successfully
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">on_caughtup</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Retry if this peer is still alive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœè¶…æ—¶å†æ¬¡é‡è¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">error_code</span><span class="p">()</span> <span class="o">==</span> <span class="n">ETIMEDOUT</span> 
</span></span><span class="line"><span class="cl">            <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">monotonic_time_ms</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">-</span> <span class="n">_replicator_group</span><span class="p">.</span><span class="n">last_rpc_send_timestamp</span><span class="p">(</span><span class="n">peer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="o">&lt;=</span> <span class="n">_options</span><span class="p">.</span><span class="n">election_timeout_ms</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">OnCaughtUp</span><span class="o">*</span> <span class="n">caught_up</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OnCaughtUp</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">_replicator_group</span><span class="p">.</span><span class="n">wait_caughtup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">peer</span><span class="p">,</span> <span class="n">_options</span><span class="p">.</span><span class="n">catchup_margin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">due_time</span><span class="p">,</span> <span class="n">caught_up</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_group_id</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;:&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_server_id</span>
</span></span><span class="line"><span class="cl">                <span class="o">&lt;&lt;</span> <span class="s">&#34; wait_caughtup failed, peer &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">peer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">delete</span> <span class="n">caught_up</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘èµ·é‡è¯•å¤±è´¥ï¼Œåˆ™å½»åº•å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_conf_ctx</span><span class="p">.</span><span class="n">on_caughtup</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">on_caughtup</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">version</span><span class="p">,</span> <span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer_id</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥å¿…é¡»ä¸ºè¿½èµ¶é˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">STAGE_CATCHING_UP</span><span class="p">,</span> <span class="n">_stage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_adding_peers</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">peer_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// addçš„èŠ‚ç‚¹ä¸ºç©ºåˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_adding_peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nf">next_stage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Fail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">err</span><span class="p">(</span><span class="n">ECATCHUP</span><span class="p">,</span> <span class="s">&#34;Peer %s failed to catch up&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤±è´¥é‡ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è”åˆé€‰ä¸¾é˜¶æ®µ"><strong>è”åˆé€‰ä¸¾é˜¶æ®µ</strong></h3>
<p>leaderä¼šå°†æ—§èŠ‚ç‚¹é…ç½®å’Œæ–°èŠ‚ç‚¹é…ç½®å†™å…¥Log, åœ¨è¿™ä¸ªé˜¶æ®µä¹‹åç›´åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µä¹‹å‰ï¼Œæ‰€æœ‰çš„é€‰ä¸¾å’Œæ—¥å¿—åŒæ­¥éƒ½éœ€è¦åœ¨<strong>æ–°è€èŠ‚ç‚¹ä¹‹é—´è¾¾åˆ°å¤šæ•°ã€‚</strong></p>
<p>å˜æ›´èŠ‚ç‚¹å¤§äº1æ—¶ï¼Œè¿›å…¥è”åˆé€‰ä¸¾é˜¶æ®µï¼›å¦‚æœè¿™æ¬¡åªå˜æ›´äº†ä¸€ä¸ªèŠ‚ç‚¹, åˆ™ç›´æ¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">ConfigurationCtx</span><span class="o">::</span><span class="n">next_stage</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">is_busy</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">_stage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">STAGE_CATCHING_UP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">_nchanges</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_JOINT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">Configuration</span> <span class="nf">old_conf</span><span class="p">(</span><span class="n">_old_peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">old_conf</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Skip joint consensus since only one peer has been changed here. Make
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it a one-stage change to be compitible with the legacy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// implementation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nl">STAGE_JOINT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_STABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å®ƒä¼šç”Ÿæˆä¸€ä¸ªç±»å‹ä¸ºENTRY_TYPE_CONFIGURATIONçš„logEntryï¼Œå°†entryçš„peersè®¾ç½®ä¸ºæ–°é…ç½®ï¼Œold_peersè®¾ç½®ä¸ºæ—§é…ç½®ã€‚ç„¶åæŠŠè¿™ä¸ªä»»åŠ¡æ·»åŠ åˆ°æŠ•ç¥¨ç®±é‡Œé¢ï¼Œå¹¶è°ƒç”¨LogManager::append_entriesæŠŠentry appendåˆ°å†…å­˜å¹¶æŒä¹…åŒ–ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">new_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="k">const</span> <span class="n">Configuration</span><span class="o">*</span> <span class="n">old_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="kt">bool</span> <span class="n">leader_start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">_conf_ctx</span><span class="p">.</span><span class="n">is_busy</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">LogEntry</span><span class="o">*</span> <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LogEntry</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">_current_term</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// äº§ç”Ÿä¸€ä¸ªé…ç½®å˜æ›´çš„æ—¥å¿—é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_conf</span><span class="p">.</span><span class="n">list_peers</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">entry</span><span class="o">-&gt;</span><span class="n">old_peers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PeerId</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">list_peers</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">old_peers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ConfigurationChangeDone</span><span class="o">*</span> <span class="n">configuration_change_done</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">ConfigurationChangeDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">_current_term</span><span class="p">,</span> <span class="n">leader_start</span><span class="p">,</span> <span class="n">_leader_lease</span><span class="p">.</span><span class="n">lease_epoch</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Use the new_conf to deal the quorum of this very log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">new_conf</span><span class="p">,</span> <span class="n">old_conf</span><span class="p">,</span> <span class="n">configuration_change_done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="n">entries</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entries</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// append æ—¥å¿—é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">append_entries</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entries</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                 <span class="k">new</span> <span class="n">LeaderStableClosure</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">NodeId</span><span class="p">(</span><span class="n">_group_id</span><span class="p">,</span> <span class="n">_server_id</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                                        <span class="mi">1u</span><span class="p">,</span> <span class="n">_ballot_box</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">check_and_set_configuration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_conf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœentry typeæ˜¯ENTRY_TYPE_CONFIGURATIONçš„è¯å°±æŠŠè¿™ä¸ªé…ç½®appendåˆ°_config_manageré‡Œé¢ã€‚ä¹‹åä¼šè°ƒç”¨LogManager::check_and_set_configurationæŠŠ_confè®¾ç½®ä¸ºåˆšåˆšæ”¾è¿›å»çš„æ–°é…ç½®ï¼ˆå…¶ä¸­old_confä¸ºä¹‹å‰çš„é…ç½®ï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">append_entries</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">LogEntry</span><span class="o">*&gt;</span> <span class="o">*</span><span class="n">entries</span><span class="p">,</span> <span class="n">StableClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add ref for disk_thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">AddRef</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ENTRY_TYPE_CONFIGURATION</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ConfigurationEntry</span> <span class="nf">conf_entry</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="n">entries</span><span class="p">)[</span><span class="n">i</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯¹äºä¿®æ”¹peerçš„ç±»å‹çš„æ—¥å¿—ï¼ŒåŠ å…¥config managerï¼Œå½±å“åç»­çš„æŠ•ç¥¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">(</span><span class="n">conf_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹åï¼Œäº§ç”Ÿçš„ä»»åŠ¡ï¼Œåœ¨æ”¾åˆ°æŠ•ç¥¨ç®±çš„æ—¶å€™_conf.stableä¼šè¿”å›falseï¼Œç„¶åå°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸º_conf.old_confã€‚å› æ­¤è¿™ä¸ªæ—¶é—´ç‚¹ä¹‹åäº§ç”Ÿçš„ä»»åŠ¡éœ€è¦æ–°æ—§ä¸¤ä¸ªé…ç½®å…±åŒå†³å®šæ˜¯å¦æäº¤ï¼Œä¹Ÿå°±æ˜¯JOINTçŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">_ballot_box</span><span class="o">-&gt;</span><span class="n">append_pending_task</span><span class="p">(</span><span class="n">_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">_conf</span><span class="p">.</span><span class="n">stable</span><span class="p">()</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">_conf</span><span class="p">.</span><span class="n">old_conf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">tasks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">done</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æŠ•ç¥¨é˜¶æ®µï¼Œæ–°æ—§é…ç½®åŒæ—¶è¾¾åˆ°å¤šæ•°æ‰é€šè¿‡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Ballot</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">Configuration</span><span class="o">&amp;</span> <span class="n">conf</span><span class="p">,</span> <span class="k">const</span> <span class="n">Configuration</span><span class="o">*</span> <span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">_peers</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">conf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_peers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_quorum</span> <span class="o">=</span> <span class="n">_peers</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_conf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_old_peers</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">old_conf</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_old_peers</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">iter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_old_quorum</span> <span class="o">=</span> <span class="n">_old_peers</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Ballot</span><span class="o">::</span><span class="n">PosHint</span> <span class="n">Ballot</span><span class="o">::</span><span class="n">grant</span><span class="p">(</span><span class="k">const</span> <span class="n">PeerId</span><span class="o">&amp;</span> <span class="n">peer</span><span class="p">,</span> <span class="n">PosHint</span> <span class="n">hint</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">UnfoundPeerId</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">iter</span> <span class="o">=</span> <span class="n">find_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">_peers</span><span class="p">,</span> <span class="n">hint</span><span class="p">.</span><span class="n">pos0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">_peers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span><span class="o">-&gt;</span><span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ–°é…ç½®è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">--</span><span class="n">_quorum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hint</span><span class="p">.</span><span class="n">pos0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_old_peers</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">hint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">iter</span> <span class="o">=</span> <span class="n">find_peer</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">_old_peers</span><span class="p">,</span> <span class="n">hint</span><span class="p">.</span><span class="n">pos1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">_old_peers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span><span class="o">-&gt;</span><span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ—§é…ç½®è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">--</span><span class="n">_old_quorum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hint</span><span class="p">.</span><span class="n">pos1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hint</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">granted</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_quorum</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_old_quorum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ConfigurationChangeDoneå›è°ƒæ—¶ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚</p>
<h3 id="æ–°é…ç½®åŒæ­¥é˜¶æ®µ"><strong>æ–°é…ç½®åŒæ­¥é˜¶æ®µ</strong></h3>
<p>å½“è”åˆé€‰ä¸¾æ—¥å¿—æ­£å¼è¢«æ–°æ—§é›†ç¾¤æ¥å—ä¹‹åï¼Œleaderå°†æ–°èŠ‚ç‚¹é…ç½®å†™å…¥logï¼Œä¹‹åæ‰€æœ‰çš„logå’Œé€‰ä¸¾åªéœ€è¦åœ¨æ–°é›†ç¾¤ä¸­è¾¾æˆä¸€è‡´ã€‚ ç­‰å¾…æ—¥å¿—æäº¤åˆ°<strong>æ–°é›†ç¾¤</strong>ä¸­çš„å¤šæ•°èŠ‚ç‚¹ä¸­ä¹‹åï¼Œ æ­£å¼å®ŒæˆèŠ‚ç‚¹å˜æ›´ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">STAGE_JOINT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">_stage</span> <span class="o">=</span> <span class="n">STAGE_STABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">unsafe_apply_configuration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">Configuration</span><span class="p">(</span><span class="n">_new_peers</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å’Œè”åˆé€‰ä¸¾é˜¶æ®µè°ƒç”¨ç›¸åŒçš„å®ç°ï¼Œåªæ˜¯old_confä¸ºNULLã€‚</p>
<h3 id="æ¸…ç†é˜¶æ®µ"><strong>æ¸…ç†é˜¶æ®µ</strong></h3>
<p>leaderä¼šå°†å¤šä½™çš„Replicator(å¦‚æœæœ‰)å…³é—­ï¼Œç‰¹åˆ«å¦‚æœå½“leaderæœ¬èº«å·²ç»ä»èŠ‚ç‚¹é…ç½®ä¸­è¢«ç§»é™¤ï¼Œè¿™æ—¶å€™leaderä¼šæ‰§è¡Œstepdownå¹¶ä¸”å”¤é†’ä¸€ä¸ªåˆé€‚çš„èŠ‚ç‚¹è§¦å‘é€‰ä¸¾ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">case</span> <span class="nl">STAGE_STABLE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">bool</span> <span class="n">should_step_down</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">                <span class="n">_new_peers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_server_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">_new_peers</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">st</span> <span class="o">=</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">::</span><span class="n">OK</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">should_step_down</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é€€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="n">_node</span><span class="o">-&gt;</span><span class="n">step_down</span><span class="p">(</span><span class="n">_node</span><span class="o">-&gt;</span><span class="n">_current_term</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="p">(</span><span class="n">ELEADERREMOVED</span><span class="p">,</span> <span class="s">&#34;This node was removed&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å¿«ç…§">å¿«ç…§</h2>
<h3 id="æ‰“å¿«ç…§">æ‰“å¿«ç…§</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_snapshot_executor</span><span class="o">-&gt;</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">do_snapshot</span><span class="p">(</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºwriterï¼Œé»˜è®¤ä¸ºLocalSnapshotWriterï¼Œä½¿ç”¨ä¸´æ—¶æ–‡ä»¶è·¯å¾„æ¥åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_saving_snapshot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SaveSnapshotDone</span><span class="o">*</span> <span class="n">snapshot_save_done</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SaveSnapshotDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_fsm_caller</span><span class="o">-&gt;</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">snapshot_save_done</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">SaveSnapshotClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ApplyTask</span> <span class="n">task</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNAPSHOT_SAVE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">task</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">bthread</span><span class="o">::</span><span class="n">execution_queue_execute</span><span class="p">(</span><span class="n">_queue_id</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>FSMCallerå¤„ç†åˆ°æ‰“å¿«ç…§çš„ä»»åŠ¡æ—¶ï¼Œæ‰§è¡Œä¸‹é¢çš„å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">FSMCaller</span><span class="o">::</span><span class="n">do_snapshot_save</span><span class="p">(</span><span class="n">SaveSnapshotClosure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">last_applied_index</span> <span class="o">=</span> <span class="n">_last_applied_index</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®metaä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SnapshotMeta</span> <span class="n">meta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">meta</span><span class="p">.</span><span class="n">set_last_included_index</span><span class="p">(</span><span class="n">last_applied_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">meta</span><span class="p">.</span><span class="n">set_last_included_term</span><span class="p">(</span><span class="n">_last_applied_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ConfigurationEntry</span> <span class="n">conf_entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">get_configuration</span><span class="p">(</span><span class="n">last_applied_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">add_peers</span><span class="p">()</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">to_string</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">Configuration</span><span class="o">::</span><span class="n">const_iterator</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">old_conf</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">iter</span> <span class="o">!=</span> <span class="n">conf_entry</span><span class="p">.</span><span class="n">old_conf</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">meta</span><span class="p">.</span><span class="n">add_old_peers</span><span class="p">()</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">to_string</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†metaä¿å­˜åˆ°writerå¯¹è±¡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">done</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">,</span> <span class="s">&#34;snapshot_storage create SnapshotWriter failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ç”¨æˆ·çš„snapshot saveå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_fsm</span><span class="o">-&gt;</span><span class="n">on_snapshot_save</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ç”¨æˆ·çš„snapshot saveå®ç°ä¸­ï¼Œä¼šå›è°ƒSaveSnapshotClosure::Runï¼Œæ¥å®Œæˆsnapshot metaä¿¡æ¯çš„ä¿å­˜ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SaveSnapshotDone</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨bthreadæ¥é¿å…é˜»å¡çŠ¶æ€æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Avoid blocking FSMCaller
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This continuation of snapshot saving is likely running inplace where the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on_snapshot_save is called (in the FSMCaller thread) and blocks all the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// following on_apply. As blocking is not necessary and the continuation is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not important, so we start a bthread to do this.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">bthread_t</span> <span class="n">tid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_start_urgent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">continue_run</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">PLOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to start bthread&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">continue_run</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span><span class="o">*</span> <span class="n">SaveSnapshotDone</span><span class="o">::</span><span class="n">continue_run</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SaveSnapshotDone</span><span class="o">*</span> <span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="n">SaveSnapshotDone</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SaveSnapshotDone</span><span class="o">&gt;</span> <span class="n">self_guard</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Must call on_snapshot_save_done to clear _saving_snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_se</span><span class="o">-&gt;</span><span class="n">on_snapshot_save_done</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">(),</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_meta</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">_writer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;node call on_snapshot_save_done failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//user done, need set error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">()</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">run_closure_in_bthread</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">_done</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„continue_runè°ƒç”¨ä¸‹é¢çš„å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">on_snapshot_save_done</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">butil</span><span class="o">::</span><span class="n">Status</span><span class="o">&amp;</span> <span class="n">st</span><span class="p">,</span> <span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">&amp;</span> <span class="n">meta</span><span class="p">,</span> <span class="n">SnapshotWriter</span><span class="o">*</span> <span class="n">writer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">error_code</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// InstallSnapshot can break SaveSnapshot, check InstallSnapshot when SaveSnapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because upstream Snapshot maybe newer than local Snapshot.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœleaderå‘é€çš„snapshotæ›´æ–°ï¼Œå¿½ç•¥æœ¬åœ°çš„snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">_last_snapshot_index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="n">ESTALE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">ESTALE</span><span class="p">,</span> <span class="s">&#34;Installing snapshot is older than local snapshot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">writer</span><span class="o">-&gt;</span><span class="n">save_meta</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">writer</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s">&#34;Fail to do snapshot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é»˜è®¤è°ƒç”¨LocalSnapshotStorageï¼Œä¿å­˜snapshot metaä¿¡æ¯åˆ°æ–‡ä»¶ï¼Œå°†snapshotç›®å½•ä»ä¸´æ—¶è·¯å¾„é‡å‘½åä¸ºæœ€ç»ˆè·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">EIO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;node &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_node</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; fail to close writer&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_last_snapshot_index</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_last_snapshot_term</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_term</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">_log_manager</span><span class="o">-&gt;</span><span class="n">set_snapshot</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">lck</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">report_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to save snapshot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_saving_snapshot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_running_jobs</span><span class="p">.</span><span class="n">signal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>set_snapshotæ›´æ–°LogManagerçš„çŠ¶æ€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LogManager</span><span class="o">::</span><span class="n">set_snapshot</span><span class="p">(</span><span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">*</span> <span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">raft_mutex_t</span><span class="o">&gt;</span> <span class="n">lck</span><span class="p">(</span><span class="n">_mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Configuration</span> <span class="n">conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">peers_size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">conf</span><span class="p">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">peers</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">Configuration</span> <span class="n">old_conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">old_peers_size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">old_conf</span><span class="p">.</span><span class="n">add_peer</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">old_peers</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ConfigurationEntry</span> <span class="n">entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">LogId</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">(),</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">entry</span><span class="p">.</span><span class="n">old_conf</span> <span class="o">=</span> <span class="n">old_conf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_config_manager</span><span class="o">-&gt;</span><span class="n">set_snapshot</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int64_t</span> <span class="n">term</span> <span class="o">=</span> <span class="n">unsafe_get_term</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">LogId</span> <span class="n">last_but_one_snapshot_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_last_snapshot_id</span><span class="p">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_last_snapshot_id</span> <span class="o">&gt;</span> <span class="n">_applied_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_applied_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// NOTICE: not to update disk_id here as we are not sure if this node really
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// has these logs on disk storage. Just leave disk_id as it was, which can keep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// these logs in memory all the time until they are flushed to disk. By this 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// way we can avoid some corner cases which failed to get logs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœtermç­‰äº0ï¼Œè¯´æ˜last_included_indexå¤§äºlast_indexï¼ˆä¸€èˆ¬å‘ç”Ÿåœ¨followerå¤„ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ™æŠŠç¼“å­˜å’Œæ–‡ä»¶é‡Œé¢çš„log entryä»å‰é¢æˆªæ–­åˆ°last_included_index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// last_included_index is larger than last_index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// FIXME: what if last_included_index is less than first_index?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">truncate_prefix</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_term</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœtermç­‰äº meta-&gt;last_included_termï¼Œè¯´æ˜log entryé‡Œé¢è¿˜å­˜åœ¨ç€è¿™æ¡è®°å½•ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å…ˆä¸ç€æ€¥æˆªæ–­ï¼ŒæŠŠå®ƒæˆªæ–­åˆ°ä¸Šä¸€ä¸ªå¿«ç…§å¤„(å¦‚æœæœ‰çš„è¯)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Truncating log to the index of the last snapshot.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// We don&#39;t truncate log before the latest snapshot immediately since
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// some log around last_snapshot_index is probably needed by some
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// followers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">last_but_one_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We have last snapshot index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">last_but_one_snapshot_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">truncate_prefix</span><span class="p">(</span><span class="n">last_but_one_snapshot_id</span><span class="p">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å…¶ä»–æƒ…å†µå¯¹åº”indexä¸Šçš„termä¸ç­‰äºmeta-&gt;last_included_termï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ™å¯èƒ½æ˜¯followerå¤„æ­£åœ¨å®‰è£…å¿«ç…§ï¼Œè¿™ç§æƒ…å†µï¼Œç›´æ¥resetï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è®©_first_log_indexæŒ‡å‘last_included_indexï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _last_log_indexæŒ‡å‘last_included_index-1ï¼ŒæŠŠentriesæ¸…ç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: check the result of reset.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">_virtual_first_log_id</span> <span class="o">=</span> <span class="n">_last_snapshot_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">reset</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">last_included_index</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lck</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Cannot reach here&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="installsnapshot">InstallSnapshot</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_send_entries</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="p">(</span><span class="n">_fill_common_fields</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">_next_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reset_next_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">_install_snapshot</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨_send_entrieså®ç°ä¸­ï¼Œå¦‚æœè¦å‘é€çš„entryåœ¨log_managerä¸­ä¸å­˜åœ¨ï¼ˆå·²ç»åˆå…¥snapshotå¹¶åœ¨æœ¬åœ°æ¸…ç†äº†æ—¥å¿—ï¼‰ï¼Œ_fill_common_fieldsè¿”å›é0å€¼ï¼Œæ­¤æ—¶ä¼šè°ƒç”¨_install_snapshotæ¥å®‰è£…å¿«ç…§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_install_snapshot</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pre-set replicator state to INSTALLING_SNAPSHOT, so replicator could be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// blocked if something is wrong, such as throttled for a period of time 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_st</span><span class="p">.</span><span class="n">st</span> <span class="o">=</span> <span class="n">INSTALLING_SNAPSHOT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›æœ€æ–°çš„å¿«ç…§readerï¼Œé»˜è®¤å®ç°ä¸ºLocalSnapshotReader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_reader</span> <span class="o">=</span> <span class="n">_options</span><span class="p">.</span><span class="n">snapshot_storage</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_reader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to open snapshot&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”Ÿæˆcopyçš„uriï¼Œæ ¼å¼ä¸º remote://host:port/reader_id_number
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡reader idå¯ä»¥åŒºåˆ†ä¸åŒçš„è¯»è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">_reader</span><span class="o">-&gt;</span><span class="n">generate_uri_for_copy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SnapshotMeta</span> <span class="n">meta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// report error on failure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">_reader</span><span class="o">-&gt;</span><span class="n">load_meta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">e</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to load meta from &#34;</span> <span class="o">+</span> <span class="n">snapshot_path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> 
</span></span><span class="line"><span class="cl">    <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_max_retry</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">set_timeout_ms</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstallSnapshotRequest</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InstallSnapshotResponse</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_group_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">group_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_server_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">server_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_peer_id</span><span class="p">(</span><span class="n">_options</span><span class="p">.</span><span class="n">peer_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®metaå’Œuri
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">request</span><span class="o">-&gt;</span><span class="n">mutable_meta</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">meta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">request</span><span class="o">-&gt;</span><span class="n">set_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">_install_snapshot_in_fly</span> <span class="o">=</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">call_id</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_install_snapshot_counter</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">_st</span><span class="p">.</span><span class="n">last_log_included</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_index</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_st</span><span class="p">.</span><span class="n">last_term_included</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">last_included_term</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span> <span class="o">=</span> <span class="n">brpc</span><span class="o">::</span><span class="n">NewCallback</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">                <span class="n">ReplicatorId</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">InstallSnapshotRequest</span><span class="o">*</span><span class="p">,</span> <span class="n">InstallSnapshotResponse</span><span class="o">*&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">_on_install_snapshot_returned</span><span class="p">,</span> <span class="n">_id</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">RaftService_Stub</span> <span class="nf">stub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_sending_channel</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">stub</span><span class="p">.</span><span class="n">install_snapshot</span><span class="p">(</span><span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK_EQ</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bthread_id_unlock</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to unlock &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>followerçš„å¤„ç†é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">NodeImpl</span><span class="o">::</span><span class="n">handle_install_snapshot_request</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="k">const</span> <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// check stale term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®©è¿‡æœŸçš„leaderé€€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">_current_term</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">_current_term</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">check_step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">(),</span> <span class="n">server_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ¥æ”¶åˆ°äº†å¦ä¸€ä¸ªpeerçš„install snapshotè¯·æ±‚ï¼ŒtermåŠ 1ï¼Œè®©ä¸¤ä¸ªleaderéƒ½é€€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server_id</span> <span class="o">!=</span> <span class="n">_leader_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Increase the term by 1 and make both leaders step down to minimize the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// loss of split brain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">butil</span><span class="o">::</span><span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">status</span><span class="p">.</span><span class="n">set_error</span><span class="p">(</span><span class="n">ELEADERCONFLICT</span><span class="p">,</span> <span class="s">&#34;More than one leader in the same term.&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="n">step_down</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_success</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="o">-&gt;</span><span class="n">set_term</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">clear_append_entries_cache</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">_snapshot_executor</span><span class="o">-&gt;</span><span class="n">install_snapshot</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">cntl</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>install_snapshotå®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">install_snapshot</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="k">const</span> <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                        <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Closure</span><span class="o">*</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SnapshotMeta</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">DownloadingSnapshot</span><span class="o">&gt;</span> <span class="n">ds</span><span class="p">(</span><span class="k">new</span> <span class="n">DownloadingSnapshot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span> <span class="o">=</span> <span class="n">cntl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ds</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨bthreadæ¥å¼€å§‹copyã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå·²ç»å­˜åœ¨ä»»åŠ¡ï¼Œè§†indexæ–°æ—§å–æ¶ˆåŸä»»åŠ¡æˆ–å¿½ç•¥æ–°ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="n">register_downloading_snapshot</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//    ^^^ DON&#39;T access request, response, done and cntl after this point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//        as the retry snapshot will replace this one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Release done first as this RPC might be replaced by the retry one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç­‰å¾…copyçš„bthreadæ‰§è¡Œå®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">join</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŠ è½½ä¸‹è½½çš„snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">load_downloading_snapshot</span><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">release</span><span class="p">(),</span> <span class="n">meta</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>LocalSnapshotCopieråˆ›å»ºåŠåˆå§‹åŒ–</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">SnapshotCopier</span><span class="o">*</span> <span class="n">LocalSnapshotStorage</span><span class="o">::</span><span class="n">start_to_copy_from</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LocalSnapshotCopier</span><span class="o">*</span> <span class="n">copier</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSnapshotCopier</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_storage</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_filter_before_copy_remote</span> <span class="o">=</span> <span class="n">_filter_before_copy_remote</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_fs</span> <span class="o">=</span> <span class="n">_fs</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">_throttle</span> <span class="o">=</span> <span class="n">_snapshot_throttle</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æleaderçš„ip:portä»¥åŠreader_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">copier</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Fail to init copier from &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">uri</span>
</span></span><span class="line"><span class="cl">                   <span class="o">&lt;&lt;</span> <span class="s">&#34; path: &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">_path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">delete</span> <span class="n">copier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">copier</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">copier</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‹·è´å®ç°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LocalSnapshotCopier</span><span class="o">::</span><span class="n">copy</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŠ è½½remote metaä¿¡æ¯ï¼Œå…·ä½“å®ç°ä¸ºå°†è¿œç¨‹çš„metaæ–‡ä»¶è¯»å–åˆ°å†…å­˜çš„IOBufï¼Œç„¶åè¿›è¡Œè§£æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">load_meta_table</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ ¹æ®å¼€å…³ï¼Œå…è®¸å¯¹å’Œæœ¬åœ°snapshotä¸­æ–‡ä»¶åå’Œæ ¡éªŒå’Œç›¸åŒçš„æ–‡ä»¶è·³è¿‡ä¸‹è½½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">filter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">files</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">_remote_snapshot</span><span class="p">.</span><span class="n">list_files</span><span class="p">(</span><span class="o">&amp;</span><span class="n">files</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€ä¸ªæ‹·è´æ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">files</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é€šè¿‡æ–‡ä»¶æ“ä½œRPCï¼Œå°†æ–‡ä»¶åˆ†æ®µæ‹·è´è¿‡æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">copy_file</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">_writer</span> <span class="o">&amp;&amp;</span> <span class="n">_writer</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_writer</span><span class="o">-&gt;</span><span class="n">set_error</span><span class="p">(</span><span class="n">error_code</span><span class="p">(),</span> <span class="n">error_cstr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">_writer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// set_error for copier only when failed to close writer and copier was 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ok before this moment 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">_writer</span><span class="p">,</span> <span class="n">_filter_before_copy_remote</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">set_error</span><span class="p">(</span><span class="n">EIO</span><span class="p">,</span> <span class="s">&#34;Fail to close writer&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">_writer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_reader</span> <span class="o">=</span> <span class="n">_storage</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨snapshotä¸‹è½½å®Œæˆåï¼Œè°ƒç”¨SnapshotExecutor::load_downloading_snapshotæ¥åŠ è½½</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SnapshotExecutor</span><span class="o">::</span><span class="n">load_downloading_snapshot</span><span class="p">(</span><span class="n">DownloadingSnapshot</span><span class="o">*</span> <span class="n">ds</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                 <span class="k">const</span> <span class="n">SnapshotMeta</span><span class="o">&amp;</span> <span class="n">meta</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">brpc</span><span class="o">::</span><span class="n">ClosureGuard</span> <span class="n">done_guard</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHECK</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SnapshotReader</span><span class="o">*</span> <span class="n">reader</span> <span class="o">=</span> <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">get_reader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">(),</span> <span class="s">&#34;%s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">_cur_copier</span><span class="o">-&gt;</span><span class="n">error_cstr</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">_snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">_cur_copier</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">_cur_copier</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">reader</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">reader</span><span class="o">-&gt;</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ds</span><span class="o">-&gt;</span><span class="n">cntl</span><span class="o">-&gt;</span><span class="n">SetFailed</span><span class="p">(</span><span class="n">brpc</span><span class="o">::</span><span class="n">EINTERNAL</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                           <span class="s">&#34;Fail to copy snapshot from %s&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">ds</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">uri</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The owner of ds is on_snapshot_load_done
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ds_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">done_guard</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">_loading_snapshot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//                ^ After this point, this installing cannot be interrupted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">_loading_snapshot_meta</span> <span class="o">=</span> <span class="n">meta</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">lck</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">InstallSnapshotDone</span><span class="o">*</span> <span class="n">install_snapshot_done</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">            <span class="k">new</span> <span class="n">InstallSnapshotDone</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">reader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ç”¨æˆ·çš„snapshot loadå®ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">_fsm_caller</span><span class="o">-&gt;</span><span class="n">on_snapshot_load</span><span class="p">(</span><span class="n">install_snapshot_done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">install_snapshot_done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">().</span><span class="n">set_error</span><span class="p">(</span><span class="n">EHOSTDOWN</span><span class="p">,</span> <span class="s">&#34;This raft node is down&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">install_snapshot_done</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Leaderå¯¹InstallSnapshotå“åº”çš„å¤„ç†é€»è¾‘</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">Replicator</span><span class="o">::</span><span class="n">_on_install_snapshot_returned</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">ReplicatorId</span> <span class="n">id</span><span class="p">,</span> <span class="n">brpc</span><span class="o">::</span><span class="n">Controller</span><span class="o">*</span> <span class="n">cntl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">InstallSnapshotRequest</span><span class="o">*</span> <span class="n">request</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">            <span class="n">InstallSnapshotResponse</span><span class="o">*</span> <span class="n">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Replicator</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bthread_id_t</span> <span class="n">dummy_id</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">succ</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bthread_id_lock</span><span class="p">(</span><span class="n">dummy_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å…³é—­reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_storage</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_reader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_throttle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">r</span><span class="o">-&gt;</span><span class="n">_options</span><span class="p">.</span><span class="n">snapshot_throttle</span><span class="o">-&gt;</span><span class="n">finish_one_task</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¤±è´¥ä¼šåœ¨åç»­çš„_send_entriesä¸­å†æ¬¡è°ƒç”¨InstallSnapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We don&#39;t retry installing the snapshot explicitly. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dummy_id is unlock in _send_entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">succ</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_block</span><span class="p">(</span><span class="n">butil</span><span class="o">::</span><span class="n">gettimeofday_us</span><span class="p">(),</span> <span class="n">cntl</span><span class="o">-&gt;</span><span class="n">ErrorCode</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_has_succeeded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">-&gt;</span><span class="n">_notify_on_caught_up</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_timeout_now_index</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_min_flying_index</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_timeout_now</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// dummy_id is unlock in _send_entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">_send_entries</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://github.com/baidu/braft/blob/master/docs/cn/server.md">braft/server.md at master Â· baidu/braft (github.com)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/169840204">braftæºç åˆ†æï¼ˆä¸€ï¼‰é€‰ä¸¾å’Œå¿ƒè·³ä¿æŒéƒ¨åˆ† - çŸ¥ä¹ (zhihu.com)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/169904153">braftæºç åˆ†æï¼ˆäºŒï¼‰æ—¥å¿—å¤åˆ¶ã€é…ç½®å˜æ›´å’Œå¿«ç…§ - çŸ¥ä¹ (zhihu.com)</a></li>
</ul>
]]></content:encoded>
    </item>
    
    <item>
      <title>è®ºæ–‡ç¬”è®°ï¼šPolarDB Serverless</title>
      <link>https://egolearner.github.io/post/polardb-serverless/</link>
      <pubDate>Sun, 21 Aug 2022 22:06:36 +0800</pubDate>
      
      <guid>https://egolearner.github.io/post/polardb-serverless/</guid>
      <description>&lt;ul&gt;
&lt;li&gt;Authors: Wei Cao, Yingqiang Zhang&lt;/li&gt;
&lt;li&gt;Created: August 21, 2022 7:46 AM&lt;/li&gt;
&lt;li&gt;PublishedAt: SIGMOD&lt;/li&gt;
&lt;li&gt;Tags: Database, serverless&lt;/li&gt;
&lt;li&gt;URL: &lt;a href=&#34;https://www.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf&#34;&gt;https://www.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Year: 2021&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&#34;summary&#34;&gt;&lt;strong&gt;Summary&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;é€šè¿‡è®¡ç®—ã€å†…å­˜å’Œå­˜å‚¨çš„åˆ†ç¦»ï¼Œæ¥æ”¯æŒserverlessæŒ‰éœ€åˆ†é…èµ„æºã€‚ç›¸å½“äºå°†å•æœºçš„å®ç°åŸè¯­æ‰©å±•åˆ°åˆ†å¸ƒå¼ç¯å¢ƒï¼Œä½¿ç”¨å„ç§æ–¹æ³•æ¥è§£å†³ç½‘ç»œä¼ è¾“å¼•å…¥çš„é—®é¢˜ï¼ˆå¦‚æ—¶å»¶ã€Bæ ‘ä¸€è‡´æ€§ï¼‰ã€‚&lt;/p&gt;</description>
      <content:encoded><![CDATA[<ul>
<li>Authors: Wei Cao, Yingqiang Zhang</li>
<li>Created: August 21, 2022 7:46 AM</li>
<li>PublishedAt: SIGMOD</li>
<li>Tags: Database, serverless</li>
<li>URL: <a href="https://www.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf">https://www.cs.utah.edu/~lifeifei/papers/polardbserverless-sigmod21.pdf</a></li>
<li>Year: 2021</li>
</ul>
<h1 id="summary"><strong>Summary</strong></h1>
<p>é€šè¿‡è®¡ç®—ã€å†…å­˜å’Œå­˜å‚¨çš„åˆ†ç¦»ï¼Œæ¥æ”¯æŒserverlessæŒ‰éœ€åˆ†é…èµ„æºã€‚ç›¸å½“äºå°†å•æœºçš„å®ç°åŸè¯­æ‰©å±•åˆ°åˆ†å¸ƒå¼ç¯å¢ƒï¼Œä½¿ç”¨å„ç§æ–¹æ³•æ¥è§£å†³ç½‘ç»œä¼ è¾“å¼•å…¥çš„é—®é¢˜ï¼ˆå¦‚æ—¶å»¶ã€Bæ ‘ä¸€è‡´æ€§ï¼‰ã€‚</p>
<h2 id="strength"><strong>Strength</strong></h2>
<ul>
<li>serverlessï¼Œè¿›ä¸€æ­¥è§£è€¦äº†èµ„æºåˆ†é…ã€‚</li>
</ul>
<h2 id="weakness"><strong>Weakness</strong></h2>
<ul>
<li>æ¯”è¾ƒå¤æ‚ã€‚</li>
<li>å¤æ‚åœºæ™¯çš„å®ç”¨æ€§ä¸€èˆ¬ï¼Œæ¯”å¦‚å·ç§°æ”¯æŒAuto Scalingï¼Œä½†æ˜¯ç±»ä¼¼åŒåä¸€çš„åœºæ™¯åº”è¯¥è¿˜æ”¯æŒä¸äº†ã€‚</li>
</ul>
<h2 id="take-away"><strong>Take Away</strong></h2>
<h1 id="è®ºæ–‡å†…å®¹">è®ºæ–‡å†…å®¹</h1>
<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>
<img src="/static/PolarDB%20Serverless%20A%20Cloud%20Native%20Database%20for%20Dis%207fe5181874d5494aa4df51b19b426dc3/Untitled.png">
<p>äº‘æ•°æ®åº“çš„å…¸å‹æ¶æ„ï¼Œæœ€å³ä¸ºPolarDB serverlessï¼ˆåé¢ç®€ç§°PS)ã€‚</p>
<p>å•ä½“æœºå’Œå­˜å‚¨è®¡ç®—åˆ†ç¦»æ¶æ„çš„é—®é¢˜æ˜¯ï¼Œèµ„æºå­˜åœ¨ç»‘å®šå…³ç³»ï¼Œä¸èƒ½æ–¹ä¾¿çš„æŒ‰éœ€æ‰©å±•ä¸€ç§èµ„æºè€Œä¸å¸¦æ¥å…¶ä»–èµ„æºçš„æµªè´¹ã€‚</p>
<p>åœ¨PSæ¶æ„ä¸­ï¼Œcpu, memoryå’Œå­˜å‚¨éƒ½å¯ä»¥ç‹¬ç«‹æå‡åˆ©ç”¨ç‡å’Œæ‰©å±•å®¹é‡ã€‚è€Œä¸”è¿œç¨‹å†…å­˜æ± çš„æ•°æ®é¡µå¯ä»¥è¢«å¤šä¸ªæ•°æ®åº“è¿›ç¨‹å…±äº«ã€‚å¢åŠ è¯»å‰¯æœ¬åªæœ‰å°‘é‡çš„æœ¬åœ°å†…å­˜å¼€é”€ã€‚</p>
<p>ä»æ¶æ„ä¸Šæ¥è¯´ï¼Œç±»ä¼¼äºå°†å•æœºçš„å„ç»„ä»¶åˆ†å¸ƒå¼åŒ–ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦ç”¨ç±»ä¼¼cache invalidationçš„æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡æ‰§è¡Œçš„æ­£ç¡®æ€§ã€‚åˆ†å¸ƒå¼åŒ–åæœ‰ç½‘ç»œå¼€é”€ï¼Œä¸ºäº†è®©äº‹åŠ¡æ‰§è¡Œæ›´å¿«ï¼Œä½¿ç”¨RDMAé«˜é€Ÿç½‘ç»œè¿æ¥å„ç»„ä»¶ï¼Œå¹¶ä½¿ç”¨RDMA verbæ¥åšä¼˜åŒ–ï¼Œä¾‹å¦‚ä½¿ç”¨RDMA CASæ¥ä¼˜åŒ–global latchçš„è·å–ã€‚</p>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<img src="/static/PolarDB%20Serverless%20A%20Cloud%20Native%20Database%20for%20Dis%207fe5181874d5494aa4df51b19b426dc3/Untitled%201.png">
<p>PolarDBçš„è®¡ç®—å±‚åŒ…æ‹¬ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼ˆRWï¼‰å’Œå¤šä¸ªè¯»èŠ‚ç‚¹ï¼ˆROï¼‰ï¼Œå­˜å‚¨å±‚ä½¿ç”¨PolarFSã€‚</p>
<p>å­˜å‚¨å±‚çš„æ¯ä¸ªchunkæœ‰ä¸‰å‰¯æœ¬ï¼Œé€šè¿‡Parallel Raftæ¥ä¿è¯linear serializableã€‚</p>
<p>RWå’ŒROé€šè¿‡redo logæ¥åŒæ­¥å†…å­˜çŠ¶æ€ï¼Œä½¿ç”¨LSNæ¥åè°ƒä¸€è‡´æ€§ã€‚RWå°†redo logåˆ·æ–°åˆ°PolarFSåâ‘¡ï¼Œäº‹åŠ¡å³å¯ä»¥æäº¤ã€‚RWå°†redo logå·²æ›´æ–°å’Œæœ€æ–°çš„LSN_RWå¼‚æ­¥å¹¿æ’­åˆ°æ‰€æœ‰çš„ROèŠ‚ç‚¹â‘£ã€‚ROæ”¶åˆ°é€šçŸ¥åï¼Œä»PolarFSæ‹‰å–redo logçš„æ›´æ–°ï¼Œåº”ç”¨åˆ°buffer poolä¸­ã€‚ROå°†æ¶ˆè´¹çš„redo log LSN_ROåœ¨å“åº”ä¸­å›å¤ç»™RWï¼Œç„¶åRWå¯ä»¥æ¸…é™¤å·²æ¶ˆè´¹çš„redo logï¼Œå°†æ¯”min{LSN_RO}æ›´è€çš„è„é¡µåœ¨åå°åˆ·æ–°åˆ°PolarFSâ‘§ã€‚è½åå¤ªå¤šçš„ROèŠ‚ç‚¹è¢«è¸¢å‡ºé›†ç¾¤ï¼Œé¿å…æ‹–æ…¢RWåˆ·æ–°è„é¡µã€‚</p>
<img src="/static/PolarDB%20Serverless%20A%20Cloud%20Native%20Database%20for%20Dis%207fe5181874d5494aa4df51b19b426dc3/Untitled%202.png">
<p>ä¸ºäº†ä¿è¯ä½å»¶è¿Ÿï¼Œä¸€ä¸ªæ•°æ®åº“å®ä¾‹çš„è®¡ç®—ã€å†…å­˜å’Œå­˜å‚¨èµ„æºåˆ†é…åœ¨åŒä¸€PoDä¸‹ï¼Œè®¡ç®—å’Œå­˜å‚¨å€¾å‘äºåˆ†é…åœ¨åŒä¸€ToRä¸‹é¢ã€‚</p>
<h2 id="è®¾è®¡">è®¾è®¡</h2>
<p>å’ŒPolarDBæ¶æ„ç±»ä¼¼ï¼Œæ¯ä¸ªPolarDB serverlesså®ä¾‹åŒæ ·ç”±å¤šä¸ªä»£ç†èŠ‚ç‚¹ï¼Œä¸€ä¸ªRWèŠ‚ç‚¹å’Œå¤šä¸ªROèŠ‚ç‚¹æ„æˆï¼Œä½¿ç”¨PolarFSä½œä¸ºåº•å±‚å­˜å‚¨æ± ã€‚</p>
<p>è¿œç¨‹å†…å­˜å¼•å…¥çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ</p>
<ul>
<li>è®¿é—®å»¶è¿Ÿã€‚å¼•å…¥åˆ†å±‚å†…å­˜ç³»ç»Ÿå’Œé¢„å–ç­‰ä¼˜åŒ–ã€‚</li>
<li>å†…å­˜é¡µå˜ä¸ºå…±äº«èµ„æºï¼Œéœ€è¦è·¨èŠ‚ç‚¹äº’æ–¥æœºåˆ¶ã€‚</li>
<li>é¡µçš„ä¼ è¾“é€ æˆç»™ç½‘ç»œå¸¦æ¥è´Ÿæ‹…ã€‚PSå°†redo logå†™å…¥å­˜å‚¨ï¼Œä»æ—¥å¿—å¼‚æ­¥ç‰©åŒ–pageã€‚</li>
</ul>
<h3 id="disaggregated-memory">Disaggregated Memory</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="line"><span class="cl"><span class="kr">int</span>  <span class="nx">page_register</span><span class="p">(</span><span class="nx">PageID</span> <span class="nx">page_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="kr">const</span> <span class="nx">Address</span> <span class="nx">local_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nx">Address</span><span class="o">&amp;</span> <span class="nx">remote_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nx">Address</span><span class="o">&amp;</span> <span class="nx">pl_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nx">bool</span><span class="o">&amp;</span> <span class="nx">exists</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">int</span>  <span class="nx">page_unregister</span><span class="p">(</span><span class="nx">PageID</span> <span class="nx">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">int</span>  <span class="nx">page_read</span><span class="p">(</span><span class="kr">const</span> <span class="nx">Address</span> <span class="nx">local_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="kr">const</span> <span class="nx">Address</span> <span class="nx">remote_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">int</span>  <span class="nx">page_write</span><span class="p">(</span><span class="kr">const</span> <span class="nx">Address</span> <span class="nx">local_addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="nx">Address</span> <span class="nx">remote_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">int</span>  <span class="nx">page_invalidate</span><span class="p">(</span><span class="nx">PageID</span> <span class="nx">page_id</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>page_invalidateç”¨äºRWæ¥invalidateæ‰€æœ‰ROèŠ‚ç‚¹æœ¬åœ°çš„å‰¯æœ¬ã€‚</p>
<ul>
<li>Page Address Table(PAT)è®°å½•æ¯ä¸ªé¡µçš„ä½ç½®ï¼ˆslab node idå’Œç‰©ç†åœ°å€ï¼‰å’Œå¼•ç”¨è®¡æ•°ã€‚
<ul>
<li>åœ¨page_registerä¸­ï¼Œhome nodeé€šè¿‡æŸ¥è¯¢PATæ¥ç¡®å®šé¡µæ˜¯å¦å·²å­˜åœ¨ã€‚æ–°åˆ›å»ºçš„é¡µåŠ å…¥PATä¸­ã€‚</li>
<li>åœ¨page_unregisterä¸­ï¼Œå½“ä¸€ä¸ªé¡µçš„å¼•ç”¨è®¡æ•°å˜ä¸º0æ—¶ï¼Œä»è¿œç¨‹å†…å­˜æ± ä¸­å¼¹å‡ºï¼Œå¹¶åˆ é™¤PATçš„ç›¸åº”é¡¹ã€‚</li>
</ul>
</li>
<li>Page Invalidation Bitmap(PIB)ã€‚å¯¹PATçš„æ¯ä¸ªé¡¹ï¼Œåœ¨PIBä¸­æœ‰ä¸€ä¸ªinvalidationä½ã€‚0æŒ‡æ˜¯æœ€æ–°çš„ï¼Œ1æŒ‡RWå·²æ›´æ–°ä½†æ²¡åˆ·æ–°åˆ°è¿œç¨‹å†…å­˜æ± ä¸­ã€‚æ¯ä¸ªROèŠ‚ç‚¹ä¸Šä¹Ÿæœ‰ä¸€ä¸ªæœ¬åœ°PIBã€‚</li>
<li>Page Reference Directory(PRD)ã€‚å¯¹PATçš„æ¯ä¸€é¡¹ï¼Œè®°å½•å¼•ç”¨è¿™ä¸ªé¡µçš„æ•°æ®åº“èŠ‚ç‚¹ã€‚PIBå’ŒPRDä¸€èµ·ç”¨äºå®ç°cache coherencyã€‚</li>
<li>Page Latch Table(PLT)ã€‚PATçš„æ¯ä¸€é¡¹æœ‰ä¸ªå…¨å±€çš„latchï¼Œç”¨äºä¿è¯B+æ ‘çš„å®Œæ•´æ€§ã€‚</li>
</ul>
<p>å­˜å‚¨æ”¯æŒé¡µç‰©åŒ–å¸è½½ï¼Œè„é¡µä¹Ÿå¯ä»¥é©¬ä¸Šå¼¹å‡ºè€Œä¸éœ€è¦å…ˆåˆ·æ–°ã€‚</p>
<p>ç”±äºç½‘ç»œå»¶è¿Ÿï¼Œéœ€è¦æœ¬åœ°cacheã€‚æœ¬åœ°cacheçš„å¤§å°é‡‡ç”¨äº†ç»éªŒå€¼è¿œç¨‹å†…å­˜å¤§å°/8ï¼Œ128GB.</p>
<p>å¦‚æœè®¿é—®çš„é¡µä¸åœ¨è¿œç¨‹å†…å­˜ä¸­ï¼Œä¼šä»PolarFSä¸­åŠ è½½ï¼Œç„¶åå†™å…¥åˆ°è¿œç¨‹å†…å­˜ä¸­ã€‚å¹¶éæ‰€æœ‰ä»PolarFSä¸­è¯»åˆ°çš„é¡µéƒ½éœ€è¦å†™å…¥åˆ°è¿œç¨‹å†…å­˜ä¸­ï¼Œä¾‹å¦‚å…¨è¡¨æ‰«æçš„æ—¶å€™ã€‚</p>
<img src="/static/PolarDB%20Serverless%20A%20Cloud%20Native%20Database%20for%20Dis%207fe5181874d5494aa4df51b19b426dc3/Untitled%203.png">
<p>åœ¨PSä¸­ï¼ŒRWå¯ä»¥å°†ä¿®æ”¹çš„é¡µå†™å›åˆ°è¿œç¨‹å†…å­˜ä¸­ï¼Œç„¶åROé©¬ä¸Šå°±å¯è§ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨PolarDBä¸­çš„redo logæœºåˆ¶ã€‚ä½†æ˜¯ï¼Œä¸ºäº†é™ä½ç½‘ç»œé€šä¿¡çš„å¼€é”€ï¼ŒRWçš„ä¿®æ”¹ä¼šç¼“å­˜åœ¨æœ¬åœ°è€Œä¸æ˜¯é©¬ä¸ŠåŒæ­¥åˆ°è¿œç¨‹å†…å­˜ã€‚å› æ­¤éœ€è¦cache invalidationæœºåˆ¶ã€‚</p>
<p>RWæ›´æ–°æœ¬åœ°cachedçš„é¡µåï¼Œè°ƒç”¨page_invalidateâ‘ ï¼Œå®ƒä¼šè®¾ç½®home nodeä¸Šçš„PIBçš„ç›¸åº”ä½ï¼Œé€šè¿‡æŸ¥è¯¢PRDå¾—åˆ°ROèŠ‚ç‚¹åˆ—è¡¨ï¼Œç„¶åè®¾ç½®è¿™äº›ROèŠ‚ç‚¹ä¸Šçš„PIBçš„ç›¸åº”ä½ã€‚page_invalidateæ˜¯åŒæ­¥é˜»å¡å‡½æ•°ã€‚å¦‚æœå¼‚å¸¸çš„ROèŠ‚ç‚¹è¶…æ—¶ä¸å“åº”ï¼Œä¼šè¢«å‰”å‡ºé›†ç¾¤ä»¥ä¿è¯page_invalidateæˆåŠŸã€‚</p>
<h3 id="bæ ‘ç»“æ„ä¸€è‡´æ€§">B+æ ‘ç»“æ„ä¸€è‡´æ€§</h3>
<p>åœ¨PSä¸­ï¼Œåªæœ‰RWå¯ä»¥ä¿®æ”¹é¡µï¼Œå› æ­¤ä¸éœ€è¦é˜²æ­¢å¤šä¸ªèŠ‚ç‚¹å¯¼è‡´çš„å†™å†²çªã€‚ä½†Structure Modification Operation(SMO)ä¼šåŒæ—¶ä¿®æ”¹å¤šä¸ªé¡µï¼Œå¯èƒ½å¯¼è‡´ROçœ‹åˆ°ä¸ä¸€è‡´çš„ç»“æ„ã€‚PSä½¿ç”¨PLæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æ‰€æœ‰SMOæ¶‰åŠçš„é¡µéœ€è¦ä¸ŠPL Xé”ç›´åˆ°SMOå®Œæˆã€‚å› æ­¤æ‰€æœ‰ROä¸Šçš„è¯»æ“ä½œéœ€è¦éœ€è¦æ£€æŸ¥PLTçœ‹è¯»çš„é¡µæ˜¯å¦æœ‰Xé”ï¼Œç„¶ååŠ ä¸ŠSé”ã€‚</p>
<p>å¯¹RW insert/deleteæ“ä½œï¼ŒPSé‡‡ç”¨ä¸¤æ­¥ä¼˜åŒ–ã€‚å‡å®šä¸éœ€è¦æœ‰SMOï¼Œåšä¹è§‚æ ‘éå†ï¼Œè¿™æ—¶åªéœ€è¦æœ¬åœ°latchã€‚å¦‚æœä¹è§‚éå†æ‰¾åˆ°çš„å¶èŠ‚ç‚¹é¡µç›¸å¯¹æ»¡æˆ–è€…ç©ºï¼Œæœ‰å¯èƒ½å‘ç”ŸSMOï¼Œåˆ™å†ä»rootå¼€å§‹ä¸€æ¬¡æ‚²è§‚éå†ï¼ŒåŒæ—¶åŠ ä¸ŠXé”å’ŒX-PLé”ã€‚</p>
<p>ä¸ºäº†é™ä½PLé”çš„æˆæœ¬ï¼ŒPLæœ‰ç²˜æ»å±æ€§ï¼Œæ²¡æœ‰è¯»èŠ‚ç‚¹çš„è¯·æ±‚æ—¶ä¸éœ€è¦åœ¨SMOå®Œæˆåé©¬ä¸Šé‡Šæ”¾ã€‚</p>
<p>ä¸ºäº†åŠ é€ŸPLè·å–æ“ä½œï¼Œå…ˆç”¨RDMA CASæ¥å°è¯•è·å–é”ã€‚å¦‚æœå¿«é€Ÿè·¯å¾„å¤±è´¥ï¼Œä¾‹å¦‚ç»™å·²ç»æœ‰Sé”çš„PLåŠ Xé”ï¼Œå†åœ¨home nodeå’Œæ•°æ®åº“èŠ‚ç‚¹é—´åè°ƒï¼Œè°ƒç”¨æ–¹éœ€è¦ç­‰å¾…åè°ƒå®Œæˆã€‚</p>
<h3 id="å¿«ç…§éš”ç¦»">å¿«ç…§éš”ç¦»</h3>
<p>PSåŸºäºMVCCæ¥å®ç°SI(å¿«ç…§éš”ç¦»ï¼‰ã€‚</p>
<p>RWä¸­ç»´æŠ¤è¢«ç§°ä¸ºCTSçš„ä¸­å¿ƒåŒ–çš„æ—¶é—´æˆ³ï¼ˆåºåˆ—å·ï¼‰ï¼Œè´Ÿè´£ç»™æ‰€æœ‰æ•°æ®åº“èŠ‚ç‚¹åˆ†é…é€’å¢çš„æ—¶é—´æˆ³ã€‚</p>
<ul>
<li>è¯»å†™æ“ä½œä»CTSè·å–ä¸¤æ¬¡æ—¶é—´æˆ³ï¼Œåœ¨äº‹åŠ¡å¼€å§‹æ—¶è·å–cts_commitï¼Œåœ¨äº‹åŠ¡ç»“æŸæ—¶è·å–cts_commitã€‚åœ¨äº‹åŠ¡æäº¤æ—¶å°†cts_commitå’Œä¿®æ”¹çš„è®°å½•ä¸€èµ·å†™å…¥ã€‚æ‰€æœ‰çš„è®°å½•å’Œundoè®°å½•é¢„ç•™äº†ä¸€åˆ—æ¥å­˜å‚¨ä¿®æ”¹å®ƒçš„äº‹åŠ¡çš„cts_commitã€‚äº‹åŠ¡ä¸­çš„è¯»æ€»æ˜¯è¿”å›cts_commitå°äºäº‹åŠ¡çš„cts_readçš„æœ€æ–°è®°å½•ã€‚æ¯ä¸ªç‰ˆæœ¬çš„è®°å½•è¿˜å­˜å‚¨äº†ä¿®æ”¹å®ƒçš„äº‹åŠ¡idï¼Œå› æ­¤äº‹åŠ¡è®¤è¯†è‡ªå·±çš„å†™ã€‚</li>
<li>åªè¯»äº‹åŠ¡åªéœ€è¦åœ¨å¼€å§‹æ—¶è·å–cts_readã€‚</li>
</ul>
<p>è®ºæ–‡åé¢è®²äº†å¦‚ä½•è§£å†³éƒ½äº‹åŠ¡ä¿®æ”¹çš„è¡Œå¾ˆå¤šæ— æ³•ç«‹å³æ›´æ–°cts_commitçš„é—®é¢˜ï¼Œé€šè¿‡æŸ¥æ‰¾RWä¸Šçš„CTSæ—¥å¿—ã€‚</p>
<p>ä¸ºäº†ä¼˜åŒ–ï¼Œä½¿ç”¨RDMA CASæ¥åŸå­çš„è·å–å’Œé€’å¢CTSæ—¶é—´æˆ³è®¡æ•°å™¨ã€‚</p>
<h3 id="é¡µç‰©åŒ–å¸è½½page-materialization-offloading">é¡µç‰©åŒ–å¸è½½(Page Materialization Offloading)</h3>
<p>ä¼ ç»Ÿå•ä½“DBä¼šå®šæœŸå°†è„é¡µåˆ·æ–°åˆ°æŒä¹…å­˜å‚¨ä¸Šï¼Œä½†åœ¨PSä¸Šè¿™ä¹ˆåšä¼šå¯¼è‡´å¤§é‡ç½‘ç»œé€šä¿¡ã€‚</p>
<p>è®ºæ–‡æ‰©å±•äº†PolarFSï¼Œå°†æ—¥å¿—å’Œé¡µåˆ†å¼€å­˜å‚¨ä¸ºlog trunkå’Œpage trunkã€‚Redo logå…ˆæŒä¹…åŒ–åˆ°log trunkï¼Œç„¶åå¼‚æ­¥å‘é€åˆ°page trunkï¼Œlogè¢«åº”ç”¨ä»¥æ›´æ–°é¡µã€‚ä¸ºäº†é‡ç”¨PolarFSçš„ç»„ä»¶å’Œæœ€å°åŒ–æ”¹åŠ¨ï¼Œæ—¥å¿—åªå‘é€åˆ°page trunkçš„leaderèŠ‚ç‚¹ï¼Œå†ç”±leaderèŠ‚ç‚¹ç‰©åŒ–é¡µå’Œé€šè¿‡ParallelRaftä¼ æ’­æ›´æ–°åˆ°å…¶ä»–å‰¯æœ¬ã€‚è™½ç„¶å¢åŠ äº†ApplyLogçš„å»¶è¿Ÿï¼Œä½†ApplyLogæœ¬èº«æ˜¯å¼‚æ­¥æ“ä½œä¸æ˜¯å…³é”®è·¯å¾„ã€‚</p>
<img src="/static/PolarDB%20Serverless%20A%20Cloud%20Native%20Database%20for%20Dis%207fe5181874d5494aa4df51b19b426dc3/Untitled%204.png">
<h3 id="auto-scaling">Auto-Scaling</h3>
<p>åœ¨ç‰ˆæœ¬å‡çº§æˆ–è·¨èŠ‚ç‚¹è¿ç§»æ—¶ï¼ŒproxyèŠ‚ç‚¹è´Ÿè´£ç»´æŠ¤å®¢æˆ·ç«¯è¿æ¥ã€‚æš‚åœäº‹åŠ¡æ‰§è¡Œï¼Œç­‰å¾…100msï¼Œè¶³ä»¥è®©è€çš„RWèŠ‚ç‚¹å®Œæˆå¤§éƒ¨åˆ†çš„è¿›è¡Œä¸­çš„è¯­å¥ã€‚ä¹‹åè€çš„èŠ‚ç‚¹åˆ·æ–°è„é¡µåˆ°å…±äº«å†…å­˜å¹¶å…³æœºã€‚åŒæ—¶ï¼ŒRWèŠ‚ç‚¹attachåˆ°å…±äº«å†…å­˜ï¼Œåˆå§‹åŒ–æœ¬åœ°å†…å­˜çŠ¶æ€ã€‚æœ€åï¼Œproxyè¿æ¥åˆ°æ–°çš„RWèŠ‚ç‚¹ï¼Œæ¢å¤ä¼šè¯çŠ¶æ€ï¼Œè½¬å‘ç­‰å¾…çš„è¯­å¥æ¥æ‰§è¡Œã€‚è€çš„RWèŠ‚ç‚¹æ²¡æ¥å¾—åŠå®Œæˆçš„é•¿æ‰§è¡Œçš„è¯­å¥ï¼Œå°†ä¼šåœ¨æ–°çš„RWèŠ‚ç‚¹å›æ»šåé‡æ–°æäº¤ã€‚</p>
<p>å¯¹äºé•¿æ‰§è¡Œçš„å¤šè¯­å¥äº‹åŠ¡ï¼Œå¦‚æ‰¹é‡æ’å…¥ï¼Œproxyå¯¹æ¯ä¸ªè¯­å¥è·Ÿè¸ªä¿å­˜ç‚¹ï¼Œå‘ç”Ÿåˆ‡æ¢æ—¶proxyå¯ä»¥è®©æ–°çš„RW nodeä»æœ€æ–°çš„ä¿å­˜ç‚¹ç»§ç»­æ‰§è¡Œã€‚</p>
<p>åˆ‡æ¢æ—¶æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡éœ€è¦æš‚åœï¼ŒPSä½¿ç”¨å…±äº«å†…å­˜ç›¸æ¯”ä¼ ç»Ÿçš„ä¾èµ–è¿œç¨‹å­˜å‚¨è¦å¿«ã€‚ç›®å‰æš‚åœæ—¶é—´ä¸º2-3ç§’ã€‚</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</h2>
<h3 id="ä¹è§‚é”">ä¹è§‚é”</h3>
<p>è¯»èŠ‚ç‚¹å‡å®šæ²¡æœ‰SMOã€‚RWç»´æŠ¤SMOè®¡æ•°å™¨ï¼ŒSMO_RWï¼ŒSMOå‘ç”Ÿæ—¶è®¡æ•°å™¨åŠ 1ï¼ŒSMOå‘ç”Ÿæ—¶SMO_RWçš„å¿«ç…§è®°å½•åˆ°SMOä¿®æ”¹çš„æ¯ä¸ªé¡µä¸­ï¼ˆè®°ä¸ºSMO_pageï¼‰ã€‚åœ¨queryçš„å¼€å§‹ï¼Œè·å–SMOè®¡æ•°å™¨çš„å€¼è®¡ä¸ºSMO_queryï¼ŒROä»rootéå†æ—¶å¦‚æœå‘ç°SMO_pageå¤§äºSMO_queryï¼Œæ„å‘³ç€queryè¿‡ç¨‹ä¸­å‘ç”Ÿäº†SMOï¼Œéœ€è¦é‡è¯•æˆ–è€…å›é€€åˆ°æ‚²è§‚é”ã€‚</p>
<h3 id="ç´¢å¼•æ„ŸçŸ¥é¢„å–">ç´¢å¼•æ„ŸçŸ¥é¢„å–</h3>
<p>Batched Key Prepare(BKP)çš„æ¥å£æ¥æ”¶è¦é¢„å–çš„ä¸€ç»„keyï¼Œæ¥å£è¢«è°ƒç”¨æ—¶ï¼Œå­˜å‚¨å¼•æ“å¼€å¯åå°é¢„å–ä»»åŠ¡ï¼Œä»ç›®æ ‡ç´¢å¼•ä¸­è·å–éœ€è¦çš„keyï¼Œå¹¶åœ¨å¿…è¦æ—¶ä»è¿œç¨‹å†…å­˜æˆ–å­˜å‚¨ä¸­è·å–ç›¸åº”çš„æ•°æ®é¡µã€‚</p>
<h2 id="å¯é æ€§å’Œé”™è¯¯æ¢å¤">å¯é æ€§å’Œé”™è¯¯æ¢å¤</h2>
<h3 id="æ•°æ®åº“èŠ‚ç‚¹æ¢å¤">æ•°æ®åº“èŠ‚ç‚¹æ¢å¤</h3>
<p>ROèŠ‚ç‚¹å¯ä»¥ç›´æ¥æ›¿æ¢ã€‚</p>
<p>RWèŠ‚ç‚¹åˆ†ä¸ºé¢„æœŸå’Œéé¢„æœŸçš„èŠ‚ç‚¹æ›¿æ¢ã€‚</p>
<p>**éé¢„æœŸçš„RWèŠ‚ç‚¹å¤±è´¥ã€‚**é›†ç¾¤ç®¡ç†è€…CMé€šè¿‡å¿ƒè·³åˆ¤æ–­RWèŠ‚ç‚¹å¤±è´¥æ—¶ï¼Œå‘èµ·ROèŠ‚ç‚¹å‡çº§æµç¨‹ã€‚</p>
<ol>
<li>CMé€šçŸ¥å†…å­˜å’Œå­˜å‚¨èŠ‚ç‚¹æ‹’ç»åŸRWèŠ‚ç‚¹ä¹‹åçš„å†™è¯·æ±‚ã€‚</li>
<li>CMé€‰ä¸€ä¸ªROèŠ‚ç‚¹ï¼Œé€šçŸ¥å®ƒå‡çº§äº†ï¼Œè®°ä¸ºRWâ€™ã€‚</li>
<li>RWâ€™ä»æ¯ä¸ªPolarFS page chunkæ”¶é›†æœ€æ–°ç‰ˆæœ¬ï¼ŒLSN_chunkï¼Œå…¶ä¸­çš„æœ€å°å€¼ä½œä¸ºæ£€æŸ¥ç‚¹ç‰ˆæœ¬LSN_cpã€‚</li>
<li>RWâ€™ä»æŒä¹…åŒ–PolarFS log chunkä¸Šè¯»å–redo logè®°å½•ï¼Œä»LSN_cpå¼€å§‹è¯»åˆ°ç»“æŸä½ç½®LSN_tailï¼Œå°†å®ƒä»¬åˆ†å‘åˆ°page chunkï¼Œç­‰å¾…page chunkæ¥æ¶ˆè´¹redo logå’Œå®Œæˆæ¢å¤ã€‚</li>
<li>RWâ€™æ‰«æè¿œç¨‹å†…å­˜æ± ï¼Œå¼¹å‡ºinvalidationä½ä¸º1çš„é¡µï¼Œä»¥åŠé¡µç‰ˆæœ¬LSN_pageå¤§äºLSN_tailçš„é¡µã€‚</li>
<li>RWâ€™é‡Šæ”¾æ‰€æœ‰åŸRWèŠ‚ç‚¹è·å–çš„PLé”ã€‚</li>
<li>RWâ€™æ‰«æundo headeræ¥æ„å»ºæ‰€æœ‰æ´»è·ƒäº‹åŠ¡åœ¨åŸRWèŠ‚ç‚¹å¤±è´¥æ—¶çš„çŠ¶æ€ã€‚</li>
<li>RWâ€™åœ¨é€šçŸ¥CMå®Œæˆå‡çº§åï¼Œå‡†å¤‡å¥½æ¥æ”¶æ–°è¯·æ±‚ã€‚</li>
<li>RWâ€™åœ¨åå°å›æ”¾undo logæ¥å›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚</li>
</ol>
<p>3ã€4ä¸¤æ­¥æ‰§è¡ŒARIESçš„REDOé˜¶æ®µï¼Œå¹¶å‘åœ¨è®¸å¤špage chunkèŠ‚ç‚¹ä¸Šæ‰§è¡Œã€‚</p>
<p>å¤§å¤šæ•°æ´»è·ƒæ•°æ®ä»ç„¶å­˜åœ¨åœ¨è¿œç¨‹å†…å­˜ä¸­ï¼Œå¯ä»¥é¿å…ä¼ ç»Ÿä¸»ä»å¤åˆ¶æ¶æ„çš„å†·æ•°æ®é—®é¢˜ã€‚</p>
<p>**è®¡åˆ’å†…èŠ‚ç‚¹é€€ä½ã€‚**RWèŠ‚ç‚¹ä¼šåšä¸€äº›æ¸…ç†ï¼Œä¾‹å¦‚åŒæ­¥redo logåˆ°page chunkï¼Œä¸»åŠ¨é‡Šæ”¾æ‰€æœ‰PLé”ï¼Œå†™è„é¡µåˆ°è¿œç¨‹å†…å­˜ï¼Œæœ€ç»ˆåˆ·æ–°redo logåˆ°PolarFSã€‚æ–°çš„RWèŠ‚ç‚¹å¯ä»¥çœå»4ã€5ã€6æ­¥ã€‚å¦å¤–ï¼Œæ–°èŠ‚ç‚¹å¯ä»¥æ¨è¿Ÿå³ä½ç›´åˆ°æ´»è·ƒäº‹åŠ¡æ•°å˜ä½ã€‚</p>
<h3 id="å†…å­˜èŠ‚ç‚¹æ¢å¤">å†…å­˜èŠ‚ç‚¹æ¢å¤</h3>
<p>home nodeä¿å­˜çš„å…ƒæ•°æ®ä»¥åŒæ­¥çš„æ–¹å¼ä¹Ÿä¿å­˜åˆ°slave replicaä¸­ã€‚home nodeè´Ÿè´£æ£€æµ‹slave nodeçš„å¤±è´¥ã€‚</p>
<h3 id="é›†ç¾¤æ¢å¤">é›†ç¾¤æ¢å¤</h3>
<p>æç«¯æƒ…å†µä¸‹ï¼Œæ‰€æœ‰home nodeçš„å‰¯æœ¬ä¸å¯ç”¨ï¼Œéœ€è¦åšé›†ç¾¤æ¢å¤ã€‚æ‰€æœ‰çš„æ•°æ®åº“èŠ‚ç‚¹å’Œå†…å­˜èŠ‚ç‚¹ä»å¹²å‡€çŠ¶æ€é‡å¯ï¼Œæ‰€æœ‰çš„å†…å­˜çŠ¶æ€ä»å­˜å‚¨é‡å»ºã€‚åˆå§‹åŒ–ä¹‹åï¼ŒRWèŠ‚ç‚¹æ‰§è¡Œå¹¶è¡ŒREDOæ¢å¤ï¼Œç„¶åæ‰«æundo headeræ¥æ‰¾åˆ°æ‰€æœ‰æœªå®Œæˆçš„äº‹åŠ¡ï¼Œä¹‹åå¼€å§‹æœåŠ¡ï¼Œå¹¶åœ¨åå°å›æ»šæœªæäº¤çš„äº‹åŠ¡ã€‚</p>
<p>é›†ç¾¤æ¢å¤æ—¶æœ‰cold cacheé—®é¢˜ã€‚</p>
<h1 id="å‚è€ƒ">å‚è€ƒ</h1>
<p><a href="https://zhuanlan.zhihu.com/p/382109937">å…¨æ–°å­˜ç®—åˆ†ç¦»æ¶æ„â€”â€”[SIGMOD2021] PolarDB Serverless: A Cloud Native Database for Disaggregated Data Centers ç¬”è®° - çŸ¥ä¹ (zhihu.com)</a></p>
<p><a href="https://nan01ab.github.io/2021/06/PolarDB-Serverless.html">PolarDB Serverless Â· Columba M71&rsquo;s Blog (nan01ab.github.io)</a></p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
